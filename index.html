<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AtacamApp ‚öíÔ∏è - Geolog√≠a Inteligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* === SPLASH SCREEN MEJORADA === */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .splash-content {
            text-align: center;
            z-index: 2;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 40px 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .splash-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #f39c12;
            text-shadow: 0 0 25px rgba(243, 156, 18, 0.8);
            animation: logoPulse 2s infinite alternate;
        }

        @keyframes logoPulse {
            from { transform: scale(1); text-shadow: 0 0 25px rgba(243, 156, 18, 0.8); }
            to { transform: scale(1.05); text-shadow: 0 0 35px rgba(243, 156, 18, 1); }
        }

        .splash-title {
            font-size: 2.8rem;
            color: white;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 0 2px 15px rgba(0,0,0,0.6);
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .splash-subtitle {
            font-size: 1.3rem;
            color: #ecf0f1;
            margin-bottom: 40px;
            opacity: 0.9;
            font-weight: 300;
        }

        .loading-container {
            width: 300px;
            margin: 30px auto;
        }

        .loading-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 30px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #f39c12, #e74c3c, #f39c12);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
            background-size: 200% 100%;
            animation: loadingGradient 2s infinite linear;
        }

        @keyframes loadingGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading-percentage {
            text-align: center;
            margin-top: 15px;
            font-size: 1.2rem;
            color: #f39c12;
            font-weight: bold;
        }

        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .earth-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            z-index: 2;
            opacity: 0;
            pointer-events: none;
        }

        .earth-circle {
            fill: none;
            stroke: #3498db;
            stroke-width: 3;
            stroke-linecap: round;
            filter: drop-shadow(0 0 15px rgba(52, 152, 219, 0.8));
        }

        .continents {
            fill: #27ae60;
            opacity: 0.8;
        }

        .splash-message {
            color: #f39c12;
            margin-top: 25px;
            font-size: 1rem;
            opacity: 0.9;
            min-height: 24px;
        }

        /* === VARIABLES GLASSMORPHISM === */
        :root {
            --primary: #d35400;
            --primary-dark: #a84300;
            --secondary: #2c3e50;
            --accent: #f39c12;
            --success: #27ae60;
            --info: #3498db;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --desert-sand: #e6b17e;
            --mountain-brown: #8b7355;
            --sky-blue: #87ceeb;
            
            /* Glassmorphism Variables */
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-bg-dark: rgba(30, 30, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-border-light: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            --glass-blur: blur(15px);
            --glass-radius: 20px;
            --glass-inset-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            position: relative;
        }

        /* Fondo del desierto con efecto glass */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 85% 15%, rgba(241, 196, 15, 0.2) 0%, rgba(241, 196, 15, 0.05) 15%, transparent 25%),
                linear-gradient(to bottom, rgba(135, 206, 235, 0.3) 0%, rgba(135, 206, 235, 0.15) 20%, transparent 40%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="mountains" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:%238b7355;stop-opacity:0.2"/><stop offset="100%" style="stop-color:%23a1886d;stop-opacity:0.2"/></linearGradient><linearGradient id="desert" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:%23e6b17e;stop-opacity:0.15"/><stop offset="100%" style="stop-color:%23d4ac6d;stop-opacity:0.15"/></linearGradient></defs><rect width="1200" height="800" fill="url(%23desert)"/><path d="M0,500 L200,400 L400,450 L600,350 L800,400 L1000,380 L1200,500 L1200,800 L0,800 Z" fill="url(%23mountains)"/><path d="M0,550 L150,500 L300,520 L450,480 L600,500 L750,490 L900,510 L1050,480 L1200,550 L1200,800 L0,800 Z" fill="%236b5b45" opacity="0.2"/></svg>');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.3;
            z-index: -2;
            pointer-events: none;
            backdrop-filter: var(--glass-blur);
        }

        /* Efecto de vidrio base */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            z-index: -1;
        }

        /* === CONTENEDOR PRINCIPAL === */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* === HEADER CON GLASSMORPHISM === */
        .app-header {
            background: var(--glass-bg-dark);
            color: white;
            padding: 20px 25px;
            border-radius: var(--glass-radius);
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            position: relative;
            overflow: hidden;
            animation: headerFloat 6s ease-in-out infinite;
        }

        @keyframes headerFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(211, 84, 0, 0.5), 
                transparent);
        }

        .app-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 15px;
            color: var(--light);
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            border-color: rgba(211, 84, 0, 0.3);
            box-shadow: 0 5px 15px rgba(211, 84, 0, 0.2);
        }

        .status-item.active {
            background: rgba(211, 84, 0, 0.25);
            border-color: var(--primary);
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(211, 84, 0, 0.3);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 84, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(211, 84, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 84, 0, 0); }
        }

        .badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 5px;
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .badge-gps { background: rgba(39, 174, 96, 0.8); color: white; }
        .badge-camera { background: rgba(241, 196, 15, 0.8); color: black; }
        .badge-geo { background: rgba(52, 152, 219, 0.8); color: white; }
        .badge-danger { background: rgba(231, 76, 60, 0.8); color: white; }

        /* === LAYOUT GRID RESPONSIVO === */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .app-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .app-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* === TARJETAS CON GLASSMORPHISM === */
        .card {
            background: var(--glass-bg-dark);
            border-radius: var(--glass-radius);
            padding: 25px;
            box-shadow: var(--glass-shadow);
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(211, 84, 0, 0.3), 
                transparent);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(211, 84, 0, 0.4);
        }

        .card h2 {
            color: white;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .card h2 i {
            color: var(--accent);
            font-size: 1.2em;
        }

        /* === C√ÅMARA CON GLASS === */
        .camera-container {
            position: relative;
            width: 100%;
            height: 240px;
            background: rgba(44, 62, 80, 0.6);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid rgba(211, 84, 0, 0.4);
            box-shadow: var(--glass-inset-shadow);
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .camera-placeholder {
            text-align: center;
            padding: 30px;
            color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* === BOTONES CON GLASSMORPHISM === */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, 
                rgba(211, 84, 0, 0.8), 
                rgba(168, 67, 0, 0.8));
            box-shadow: 0 4px 15px rgba(211, 84, 0, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(211, 84, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(52, 152, 219, 0.8);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: rgba(39, 174, 96, 0.8);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: rgba(241, 196, 15, 0.8);
            color: #333;
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.8);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* === COLECCI√ìN MINERAL√ìGICA - COVERFLOW === */
        .coverflow-container {
            width: 100%;
            height: 180px;
            perspective: 1000px;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .coverflow {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            position: relative;
        }

        .mineral-card {
            position: absolute;
            width: 100px;
            height: 120px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .mineral-card.active {
            border-color: var(--primary);
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 15px 35px rgba(211, 84, 0, 0.4);
        }

        .mineral-card .emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .coverflow-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-top: 15px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            color: white;
        }

        .nav-btn:hover {
            background: var(--primary);
            transform: rotate(15deg);
            box-shadow: 0 5px 15px rgba(211, 84, 0, 0.3);
        }

        /* === MAPA CON GLASS === */
        .map-container {
            width: 100%;
            height: 240px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid rgba(211, 84, 0, 0.4);
            position: relative;
            box-shadow: var(--glass-inset-shadow);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        /* === KIT DE CAMPO - BR√öJULA GEOL√ìGICA === */
        .geological-compass {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .compass-outer {
            width: 100%;
            height: 100%;
            border: 15px solid rgba(139, 115, 85, 0.7);
            border-radius: 50%;
            position: relative;
            background: linear-gradient(135deg, rgba(245, 222, 179, 0.9), rgba(210, 180, 140, 0.9));
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,0.3),
                0 8px 25px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
        }

        .compass-inner {
            width: 80%;
            height: 80%;
            position: absolute;
            top: 10%;
            left: 10%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .compass-rose {
            width: 90%;
            height: 90%;
            position: relative;
        }

        .compass-point {
            position: absolute;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--secondary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .north { top: 5%; left: 50%; transform: translateX(-50%); color: #e74c3c; }
        .south { bottom: 5%; left: 50%; transform: translateX(-50%); }
        .east { right: 5%; top: 50%; transform: translateY(-50%); }
        .west { left: 5%; top: 50%; transform: translateY(-50%); }

        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 70px;
            background: linear-gradient(to top, #e74c3c, #c0392b);
            transform-origin: center bottom;
            z-index: 2;
            border-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .compass-needle::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: -8px;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            border-radius: 50%;
        }

        .declination {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 12px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        /* === KIT DE CAMPO - GRID === */
        .kit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .kit-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            color: white;
        }

        .kit-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(211, 84, 0, 0.4);
        }

        .kit-item i {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--accent);
        }

        /* === ESCALA DE MOHS INTERACTIVA === */
        .mohs-scale {
            margin-top: 20px;
        }

        .mohs-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .mohs-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .mohs-level {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            margin-right: 15px;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(211, 84, 0, 0.3);
        }

        .mohs-info {
            flex: 1;
        }

        .mohs-info h4 {
            color: white;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .mohs-info p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* === COLORES DE RAYA === */
        .streak-colors {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .streak-item {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .streak-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(211, 84, 0, 0.4);
        }

        .streak-color {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* === FRACTURAS === */
        .fractures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .fracture-item {
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .fracture-item:hover {
            border-color: rgba(211, 84, 0, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .fracture-emoji {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* === CALCULADORA === */
        .calculator {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calculator-display {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: right;
            font-size: 1.8rem;
            min-height: 80px;
            color: white;
            overflow-x: auto;
            white-space: nowrap;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            padding: 15px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calc-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .calc-btn.operator {
            background: rgba(52, 152, 219, 0.4);
        }

        .calc-btn.equals {
            background: rgba(39, 174, 96, 0.6);
        }

        .calc-btn.clear {
            background: rgba(231, 76, 60, 0.4);
        }

        /* === PROYECCI√ìN 3D === */
        .projection-3d {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.8), rgba(52, 73, 94, 0.8));
            border-radius: 15px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--glass-inset-shadow);
        }

        .terrain-model {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .terrain-canvas {
            width: 100%;
            height: 100%;
        }

        .terrain-layer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--desert-sand), var(--mountain-brown));
            border-radius: 8px 8px 0 0;
            opacity: 0.9;
            transition: height 0.5s;
            backdrop-filter: blur(5px);
        }

        .mineral-deposit {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            animation: pulse-glow 2s infinite;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                box-shadow: 0 0 25px rgba(255, 255, 255, 0.9);
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* === CHAT IA CON GLASS === */
        .chat-container {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 380px;
            height: 500px;
            background: var(--glass-bg-dark);
            border-radius: var(--glass-radius);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: none;
            flex-direction: column;
            border: 1px solid var(--glass-border);
            overflow: hidden;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            animation: chatAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes chatAppear {
            from { 
                transform: translateY(20px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .chat-header {
            background: linear-gradient(135deg, 
                rgba(44, 62, 80, 0.9), 
                rgba(52, 73, 94, 0.9));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            font-size: 0.95rem;
            line-height: 1.4;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, 
                rgba(211, 84, 0, 0.8), 
                rgba(168, 67, 0, 0.8));
            color: white;
            margin-left: auto;
            border-radius: 18px 18px 0 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(211, 84, 0, 0.3);
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: 18px 18px 18px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* === MODAL CON GLASSMORPHISM === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            animation: modalBgAppear 0.3s ease-out;
        }

        @keyframes modalBgAppear {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--glass-bg-dark);
            border-radius: var(--glass-radius);
            padding: 0;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
            animation: modalContentAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
        }

        @keyframes modalContentAppear {
            from { 
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        /* === CLIMA CON GLASS === */
        .weather-card {
            background: linear-gradient(135deg, 
                rgba(52, 152, 219, 0.8), 
                rgba(41, 128, 185, 0.8));
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        /* === NOTIFICACIONES CON GLASS === */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--glass-bg-dark);
            color: white;
            padding: 18px 24px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 350px;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from { 
                transform: translateX(100%) translateY(-20px);
                opacity: 0;
            }
            to { 
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
        }

        /* === FORMULARIOS CON GLASS === */
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 0.95rem;
            margin-bottom: 15px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            font-family: inherit;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        /* === REPORTES CON GLASS === */
        .report-preview {
            max-height: 220px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            margin-top: 15px;
            backdrop-filter: blur(5px);
        }

        /* === INFORMACI√ìN DE MINERALES === */
        .mineral-info {
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-top: 10px;
            backdrop-filter: blur(5px);
        }

        /* === BARRA DE DESPLAZAMIENTO PERSONALIZADA === */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(211, 84, 0, 0.5);
            border-radius: 4px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(211, 84, 0, 0.7);
        }

        /* === RESPONSIVE PARA M√ìVILES === */
        @media (max-width: 768px) {
            #splashScreen .splash-title {
                font-size: 1.8rem;
            }
            
            #splashScreen .splash-logo {
                font-size: 2.2rem;
            }
            
            .app-header h1 { 
                font-size: 1.5rem; 
            }
            
            .status-item { 
                padding: 6px 12px; 
                font-size: 0.8rem; 
            }
            
            .card { 
                padding: 18px; 
            }
            
            .kit-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
            
            .chat-container { 
                width: calc(100% - 30px); 
                right: 15px; 
                bottom: 15px; 
                height: 450px;
            }
            
            .geological-compass { 
                width: 160px; 
                height: 160px; 
            }
            
            .modal-content {
                width: 95%;
                max-height: 80vh;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            
            .calculator-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .calc-btn {
                padding: 12px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .app-grid {
                gap: 15px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .camera-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .kit-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .streak-colors,
            .fractures-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .splash-content {
                padding: 25px 20px;
                margin: 0 15px;
            }
        }

        /* === EFECTO DE PART√çCULAS FLOTANTES === */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .floating-particle {
            position: absolute;
            background: rgba(211, 84, 0, 0.15);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Part√≠culas flotantes de fondo -->
    <div class="floating-particles" id="floatingParticles"></div>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="particles-container" id="particlesContainer"></div>
        
        <div class="earth-symbol" id="earthSymbol">
            <svg viewBox="0 0 150 150">
                <circle class="earth-circle" cx="75" cy="75" r="70"/>
                <path class="continents" d="M30,50 Q45,30 60,40 T90,35 Q105,45 120,40 Q110,60 95,70 T70,75 Q55,70 40,65 Z"/>
                <path class="continents" d="M40,90 Q55,80 70,85 T100,90 Q115,100 110,115 Q90,110 75,105 T50,100 Z"/>
                <circle cx="75" cy="75" r="70" fill="none" stroke="#3498db" stroke-width="2" stroke-dasharray="5,3"/>
            </svg>
        </div>
        
        <div class="splash-content">
            <div class="splash-logo">üèúÔ∏è‚öíÔ∏è</div>
            <h1 class="splash-title">AtacamApp</h1>
            <div class="splash-subtitle">Geolog√≠a Inteligente del Desierto</div>
            
            <div class="loading-container">
                <div class="loading-bar">
                    <div class="loading-progress" id="loadingProgress"></div>
                </div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
                <div class="loading-steps">
                    <span>Iniciando</span>
                    <span>Cargando</span>
                    <span>Listo</span>
                </div>
            </div>
            
            <div class="splash-message" id="splashMessage">Inicializando sistema...</div>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div class="container" id="mainApp" style="display: none; opacity: 0;">
        <!-- Header -->
        <header class="app-header">
            <h1>üèúÔ∏è AtacamApp ‚öíÔ∏è</h1>
            <div class="header-subtitle">Geolog√≠a Inteligente ‚Ä¢ GPS Real ‚Ä¢ C√°mara HD ‚Ä¢ IA Especializada</div>
            
            <div class="status-bar">
                <div class="status-item active" id="gpsStatus" onclick="activateGPS()">
                    <i class="fas fa-satellite"></i>
                    <span>GPS: HAZ CLICK üõ∞Ô∏è</span>
                    <span class="badge badge-gps">OBLIGATORIO</span>
                </div>
                <div class="status-item" id="cameraStatus" onclick="activateCamera()">
                    <i class="fas fa-camera"></i>
                    <span>C√ÅMARA: HAZ CLICK üì∏</span>
                    <span class="badge badge-camera">HD 1080p</span>
                </div>
                <div class="status-item" onclick="toggleChat()">
                    <i class="fas fa-robot"></i>
                    <span>GEOBOT IA ü§ñ</span>
                    <span class="badge badge-geo">CONECTAR</span>
                </div>
            </div>
        </header>

        <!-- Grid Principal -->
        <div class="app-grid">
            <!-- Columna 1: C√°mara y Reportes -->
            <div class="column">
                <!-- C√°mara -->
                <section class="card">
                    <h2><i class="fas fa-camera"></i> C√°mara Geol√≥gica</h2>
                    
                    <div class="camera-container" id="cameraContainer">
                        <video class="camera-feed" id="cameraFeed" autoplay playsinline></video>
                        <canvas id="cameraCanvas" style="display:none"></canvas>
                        
                        <div class="camera-placeholder" id="cameraPlaceholder">
                            <div style="font-size: 3.5rem;">üì∑</div>
                            <p style="margin-top: 15px;">Click en "C√ÅMARA" para activar</p>
                            <small>Calidad HD 1920x1080</small>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" onclick="captureAndAnalyze()">
                            <i class="fas fa-search"></i> Identificar
                        </button>
                        <button class="btn btn-success" onclick="activateCamera()">
                            <i class="fas fa-power-off"></i> Encender
                        </button>
                        <button class="btn btn-warning" onclick="importImage()">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                    </div>
                    
                    <div id="analysisResult" style="display:none; margin-top:15px; padding:15px; background:rgba(255,255,255,0.1); border-radius:12px; backdrop-filter:blur(10px);">
                        <div id="mineralResult"></div>
                    </div>
                    
                    <input type="file" id="imageUpload" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                </section>

                <!-- Informes -->
                <section class="card">
                    <h2><i class="fas fa-file-alt"></i> Informes Inteligentes</h2>
                    
                    <div>
                        <input type="text" class="form-control" id="reportTitle" placeholder="T√≠tulo del informe" value="Informe Geol√≥gico de Campo">
                        <textarea class="form-control" id="reportNotes" rows="3" placeholder="Observaciones del ge√≥logo...">Muestras colectadas en terreno con identificaci√≥n in-situ. Se observa mineralizaci√≥n de cobre en vetas de cuarzo.</textarea>
                        
                        <div class="camera-controls">
                            <button class="btn btn-success" onclick="generateReport()">
                                <i class="fas fa-magic"></i> Generar
                            </button>
                            <button class="btn btn-secondary" onclick="viewReports()">
                                <i class="fas fa-history"></i> Historial
                            </button>
                        </div>
                    </div>
                    
                    <div class="report-preview" id="reportPreview">
                        <div style="text-align:center; padding:30px; color:rgba(255,255,255,0.7);">
                            <div style="font-size:2.5rem;">üìã</div>
                            <p style="margin-top:10px;">El informe aparecer√° aqu√≠</p>
                            <small>Incluye t√≠tulo y observaciones</small>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Columna 2: Mapa y Minerales -->
            <div class="column">
                <!-- Mapa -->
                <section class="card">
                    <h2><i class="fas fa-map-marked-alt"></i> Mapa Geol√≥gico</h2>
                    
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-controls">
                            <button class="btn btn-primary" onclick="centerMap()" style="padding:8px 12px; font-size:0.9rem; background:rgba(211,84,0,0.8);">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                            <button class="btn btn-secondary" onclick="addMarker()" style="padding:8px 12px; font-size:0.9rem; background:rgba(52,152,219,0.8);">
                                <i class="fas fa-map-pin"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" onclick="loadGeologicalLayers()">
                            <i class="fas fa-layer-group"></i> Capas
                        </button>
                        <button class="btn btn-warning" onclick="loadLocalMinerals()">
                            <i class="fas fa-gem"></i> Minerales 20km
                        </button>
                        <button class="btn btn-secondary" onclick="toggleTopographicLayer()">
                            <i class="fas fa-mountain"></i> Topograf√≠a
                        </button>
                    </div>
                </section>

                <!-- Colecci√≥n Mineral√≥gica -->
                <section class="card">
                    <h2><i class="fas fa-gem"></i> Colecci√≥n Mineral√≥gica</h2>
                    
                    <div class="coverflow-container">
                        <div class="coverflow" id="coverflow">
                            <!-- Minerales cargados din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="coverflow-nav">
                        <button class="nav-btn" onclick="prevMineral()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="mineralCounter" style="font-size:1rem; font-weight:bold; color:white;">0/0</span>
                        <button class="nav-btn" onclick="nextMineral()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="mineral-info" id="mineralInfo">
                        Cargando minerales locales...
                    </div>
                </section>
            </div>

            <!-- Columna 3: Herramientas y Proyecci√≥n -->
            <div class="column">
                <!-- Kit de Campo -->
                <section class="card">
                    <h2><i class="fas fa-tools"></i> Kit de Campo</h2>
                    
                    <div class="kit-grid">
                        <div class="kit-item" onclick="openTool('compass')">
                            <i class="fas fa-compass"></i>
                            <div>Br√∫jula</div>
                        </div>
                        <div class="kit-item" onclick="openTool('mohs')">
                            <i class="fas fa-gem"></i>
                            <div>Escala Mohs</div>
                        </div>
                        <div class="kit-item" onclick="openTool('streak')">
                            <i class="fas fa-palette"></i>
                            <div>Colores Raya</div>
                        </div>
                        <div class="kit-item" onclick="openTool('fracture')">
                            <i class="fas fa-bolt"></i>
                            <div>Fracturas</div>
                        </div>
                        <div class="kit-item" onclick="openTool('calculator')">
                            <i class="fas fa-calculator"></i>
                            <div>Calculadora</div>
                        </div>
                        <div class="kit-item" onclick="openTool('weather')">
                            <i class="fas fa-cloud-sun"></i>
                            <div>Clima</div>
                        </div>
                    </div>
                </section>

                <!-- Proyecci√≥n 3D -->
                <section class="card">
                    <h2><i class="fas fa-cube"></i> Proyecci√≥n 3D</h2>
                    
                    <div class="projection-3d">
                        <div class="terrain-model" id="terrainModel">
                            <canvas class="terrain-canvas" id="terrainCanvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" onclick="generate3DProjection()">
                            <i class="fas fa-play"></i> Generar
                        </button>
                        <button class="btn btn-secondary" onclick="loadSIGEXData()">
                            <i class="fas fa-database"></i> SIGEX
                        </button>
                        <button class="btn btn-warning" onclick="uploadTerrainImage()">
                            <i class="fas fa-upload"></i> Subir Foto
                        </button>
                    </div>
                    
                    <div id="projectionInfo" style="font-size:0.85rem; color:rgba(255,255,255,0.7); margin-top:10px; padding:10px; background:rgba(0,0,0,0.2); border-radius:10px;">
                        Basado en datos SIGEX/GeoCatMin y Mindat.org
                    </div>
                    
                    <input type="file" id="terrainUpload" accept="image/*" style="display:none;" onchange="handleTerrainUpload(event)">
                </section>

                <!-- Geobot IA -->
                <section class="card">
                    <h2><i class="fas fa-robot"></i> Geobot IA</h2>
                    
                    <div style="background:rgba(232,244,252,0.15); padding:20px; border-radius:15px; margin-bottom:15px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);">
                        <p style="font-size:0.95rem; margin-bottom:15px; color:rgba(255,255,255,0.9);">Asistente especializado en geolog√≠a de Atacama</p>
                        <button class="btn btn-primary" onclick="toggleChat()" style="width:100%; padding:14px;">
                            <i class="fas fa-comments"></i> Abrir Chat
                        </button>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <button class="btn btn-outline" onclick="quickAnalysis()" style="padding:12px; font-size:0.9rem;">
                            <i class="fas fa-chart-line"></i> An√°lisis
                        </button>
                        <button class="btn btn-outline" onclick="exportData()" style="padding:12px; font-size:0.9rem;">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Chat IA -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fas fa-robot" style="color:#f39c12;"></i>
                <span>Geobot IA - Especialista Geol√≥gico</span>
            </div>
            <button class="close-btn" onclick="toggleChat()" style="color:white; background:rgba(0,0,0,0.3); border:none; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;">√ó</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                ¬°Hola! Soy Geobot, tu asistente especializado en geolog√≠a de Atacama. 
                Puedo ayudarte con identificaci√≥n de minerales, an√°lisis de muestras, 
                interpretaci√≥n de datos GPS y generaci√≥n de informes t√©cnicos. 
                ¬øEn qu√© puedo ayudarte hoy? üèîÔ∏è
            </div>
        </div>
        
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Escribe tu pregunta geol√≥gica..." class="form-control" style="flex:1;" onkeypress="handleChatInput(event)">
            <button class="btn btn-primary" onclick="sendMessage()" style="padding:12px 20px;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Modal para herramientas -->
    <div class="modal" id="toolModal">
        <div class="modal-content">
            <div class="chat-header" style="border-radius:20px 20px 0 0;">
                <span id="modalTitle">Herramienta</span>
                <button class="close-btn" onclick="closeModal()" style="color:white; background:rgba(0,0,0,0.3); border:none; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;">√ó</button>
            </div>
            <div id="modalContent" style="padding:25px; max-height:calc(85vh - 80px); overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-elevation@1.0.0/dist/leaflet-elevation.min.js"></script>
    <script>
        // ============================================
        // SISTEMA DE SPLASH SCREEN MEJORADA
        // ============================================
        
        let particles = [];
        let splashActive = true;
        
        function initSplashScreen() {
            console.log('üé¨ Iniciando splash screen mejorada...');
            
            // Crear part√≠culas flotantes de fondo
            createFloatingParticles();
            
            // Crear 100 part√≠culas min√∫sculas
            createMiniParticles();
            
            // Iniciar animaci√≥n del s√≠mbolo de la Tierra
            setTimeout(() => {
                animateEarthSymbol();
            }, 500);
            
            // Iniciar secuencia de carga mejorada
            startLoadingSequence();
        }
        
        function createFloatingParticles() {
            const container = document.getElementById('floatingParticles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'floating-particle';
                
                const size = 2 + Math.random() * 6;
                const left = Math.random() * 100;
                const delay = Math.random() * 20;
                const duration = 15 + Math.random() * 20;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${left}%`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                // Color aleatorio en tonos naranja/desierto
                const hue = 20 + Math.random() * 40;
                const opacity = 0.05 + Math.random() * 0.15;
                particle.style.background = `hsla(${hue}, 100%, 60%, ${opacity})`;
                
                container.appendChild(particle);
            }
        }
        
        function createMiniParticles() {
            const container = document.getElementById('particlesContainer');
            const particleCount = 100;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Tama√±o m√°s peque√±o (1-4px)
                const size = 1 + Math.random() * 3;
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const hue = 20 + Math.random() * 40;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${x}%`;
                particle.style.top = `${y}%`;
                particle.style.background = `hsl(${hue}, 100%, 50%)`;
                particle.style.boxShadow = `0 0 ${size*1.5}px hsl(${hue}, 100%, 50%)`;
                particle.style.opacity = '0.8';
                
                container.appendChild(particle);
                particles.push({
                    element: particle,
                    x, y,
                    targetX: 50,
                    targetY: 50,
                    speed: 0.3 + Math.random() * 0.7,
                    delay: Math.random() * 1000,
                    size: size
                });
            }
        }
        
        function animateEarthSymbol() {
            const symbol = document.getElementById('earthSymbol');
            symbol.style.opacity = '1';
            symbol.style.transition = 'opacity 1s ease-out';
            
            // Animaci√≥n de rotaci√≥n
            symbol.style.animation = 'earthRotate 20s infinite linear';
            
            // Crear keyframes para la rotaci√≥n
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                @keyframes earthRotate {
                    from { transform: translate(-50%, -50%) rotate(0deg); }
                    to { transform: translate(-50%, -50%) rotate(360deg); }
                }
            `;
            document.head.appendChild(styleSheet);
        }
        
        function startLoadingSequence() {
            const messages = [
                "Inicializando sistema AtacamApp...",
                "Cargando base de datos mineral√≥gica (50 minerales)...",
                "Conectando con Mindat.org API...",
                "Configurando GPS satelital de alta precisi√≥n...",
                "Activando c√°mara HD 1080p...",
                "Preparando herramientas geol√≥gicas especializadas...",
                "Cargando mapa topogr√°fico de Atacama...",
                "Conectando Geobot IA (Ollama LLM)...",
                "Configurando proyecci√≥n 3D con an√°lisis de imagen...",
                "Sistema listo para exploraci√≥n geol√≥gica! ‚öíÔ∏è"
            ];
            
            let progress = 0;
            const progressBar = document.getElementById('loadingProgress');
            const percentageEl = document.getElementById('loadingPercentage');
            const messageEl = document.getElementById('splashMessage');
            
            const interval = setInterval(() => {
                progress += 0.5; // M√°s suave
                progressBar.style.width = `${progress}%`;
                percentageEl.textContent = `${Math.min(100, Math.round(progress))}%`;
                
                // Cambiar mensaje progresivamente
                const messageIndex = Math.min(Math.floor(progress / 10), messages.length - 1);
                if (messageEl.textContent !== messages[messageIndex]) {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        messageEl.textContent = messages[messageIndex];
                        messageEl.style.opacity = '1';
                        messageEl.style.transition = 'opacity 0.5s ease-in';
                    }, 200);
                }
                
                // Animar part√≠culas hacia la Tierra cuando llegamos a 50%
                if (Math.round(progress) === 50) {
                    animateParticlesToEarth();
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        finishSplashScreen();
                    }, 800);
                }
            }, 30);
        }
        
        function animateParticlesToEarth() {
            console.log('üåç Animando part√≠culas hacia la Tierra girando...');
            
            particles.forEach((particle, index) => {
                // Calcular posici√≥n en c√≠rculo alrededor de la Tierra
                const angle = (index / particles.length) * Math.PI * 2;
                const radius = 35 + Math.random() * 10; // Radio variable
                
                const earthX = 50 + Math.cos(angle) * radius;
                const earthY = 50 + Math.sin(angle) * radius;
                
                particle.targetX = earthX;
                particle.targetY = earthY;
                
                setTimeout(() => {
                    particle.element.style.transition = `all 2s cubic-bezier(0.4, 0, 0.2, 1) ${index * 5}ms`;
                    particle.element.style.left = `${earthX}%`;
                    particle.element.style.top = `${earthY}%`;
                    particle.element.style.opacity = '0.4';
                    particle.element.style.transform = `scale(0.5)`;
                    
                    // Animaci√≥n orbital continua
                    particle.element.style.animation = `particleOrbit ${10 + Math.random() * 10}s infinite linear`;
                }, particle.delay);
            });
            
            // Crear keyframes para √≥rbita
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                @keyframes particleOrbit {
                    from { transform: rotate(0deg) translateX(35px) rotate(0deg); }
                    to { transform: rotate(360deg) translateX(35px) rotate(-360deg); }
                }
            `;
            document.head.appendChild(styleSheet);
        }
        
        function finishSplashScreen() {
            console.log('‚úÖ Splash screen completada');
            
            // Efecto de desvanecimiento mejorado
            const splash = document.getElementById('splashScreen');
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.8s ease-out';
            
            // Mostrar aplicaci√≥n principal
            setTimeout(() => {
                splash.style.display = 'none';
                const mainApp = document.getElementById('mainApp');
                mainApp.style.display = 'block';
                
                setTimeout(() => {
                    mainApp.style.opacity = '1';
                    mainApp.style.transition = 'opacity 0.6s ease-in';
                    
                    // Inicializar aplicaci√≥n
                    initApplication();
                }, 100);
            }, 800);
        }
        
        // ============================================
        // ATACAMAPP - SISTEMA 100% FUNCIONAL CON MEJORAS
        // ============================================

        // Variables globales
        let map = null;
        let gpsWatchId = null;
        let cameraStream = null;
        let realGPSData = null;
        let compassHeading = 0;
        let compassActive = false;
        let identifiedMinerals = [];
        let currentMineralIndex = 0;
        let localMineralsCache = [];
        let weatherData = null;
        let magneticDeclination = 0;
        let topographicLayer = null;
        let calculatorValue = '0';
        let calculatorMemory = 0;
        let currentOperator = null;
        let resetCalculator = false;
        let terrainImage = null;

        // Base de datos de 50 minerales esenciales de Atacama (datos reales de Mindat)
        const atacamaMineralsDB = [
            {
                id: 1, name: "Calcopirita", formula: "CuFeS‚ÇÇ", hardness: 3.5, 
                color: "Amarillo lat√≥n", streak: "Verde negruzco", 
                emoji: "üí∞", type: "Sulfuro",
                mindat_id: "927", locality: "Mina Candelaria, Copiap√≥",
                description: "Principal mineral de cobre en Atacama. Presente en vetas hidrotermales de alta temperatura.",
                occurrence: "P√≥rfidos cupr√≠feros, vetas hidrotermales",
                coordinates: { lat: -27.5, lng: -70.0 },
                specific_gravity: 4.1,
                crystal_system: "Tetragonal",
                transparency: "Opaco"
            },
            {
                id: 2, name: "Malaquita", formula: "Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ", hardness: 3.5,
                color: "Verde intenso", streak: "Verde claro",
                emoji: "üü¢", type: "Carbonato",
                mindat_id: "2530", locality: "Salar de Atacama",
                description: "Carbonato de cobre secundario en zonas de oxidaci√≥n.",
                occurrence: "Zonas superg√©nicas de yacimientos de cobre",
                coordinates: { lat: -23.5, lng: -68.25 },
                specific_gravity: 3.9,
                crystal_system: "Monocl√≠nico",
                transparency: "Transl√∫cido a opaco"
            },
            {
                id: 3, name: "Atacamita", formula: "Cu‚ÇÇCl(OH)‚ÇÉ", hardness: 3.5,
                color: "Verde esmeralda", streak: "Verde manzana",
                emoji: "üèúÔ∏è", type: "Halogenuro",
                mindat_id: "411", locality: "Desierto de Atacama",
                description: "Mineral que da nombre a la regi√≥n. Cloruro de cobre b√°sico.",
                occurrence: "Zonas √°ridas con dep√≥sitos de cobre oxidado",
                coordinates: { lat: -27.0, lng: -70.0 },
                specific_gravity: 3.8,
                crystal_system: "Ortorr√≥mbico",
                transparency: "Transl√∫cido"
            },
            {
                id: 4, name: "Bornita", formula: "Cu‚ÇÖFeS‚ÇÑ", hardness: 3,
                color: "P√∫rpura iridiscente", streak: "Gris negruzco",
                emoji: "ü¶ö", type: "Sulfuro",
                mindat_id: "727", locality: "Mina Escondida",
                description: "Conocido como 'mineral pavo real' por su coloraci√≥n iridiscente.",
                occurrence: "Vetas hidrotermales de cobre",
                coordinates: { lat: -24.27, lng: -69.07 },
                specific_gravity: 5.1,
                crystal_system: "Orto r√≥mbico",
                transparency: "Opaco"
            },
            {
                id: 5, name: "Crisocola", formula: "CuSiO‚ÇÉ¬∑nH‚ÇÇO", hardness: 2.5,
                color: "Verde azulado", streak: "Blanco",
                emoji: "üí†", type: "Silicato",
                mindat_id: "1150", locality: "Cerro Negro",
                description: "Silicato de cobre hidratado. F√°cil de identificar por su color.",
                occurrence: "Zonas de alteraci√≥n de yacimientos de cobre",
                coordinates: { lat: -27.2, lng: -69.9 },
                specific_gravity: 2.2,
                crystal_system: "Amorfo",
                transparency: "Transl√∫cido a opaco"
            },
            {
                id: 6, name: "Hematita", formula: "Fe‚ÇÇO‚ÇÉ", hardness: 6.5,
                color: "Negro a rojo", streak: "Rojo cereza",
                emoji: "üî¥", type: "√ìxido",
                mindat_id: "1856", locality: "Cerro Im√°n",
                description: "Principal mineral de hierro. Importante en bandeados ferruginosos.",
                occurrence: "Formaciones de hierro bandeado, vetas hidrotermales",
                coordinates: { lat: -27.3, lng: -69.95 },
                specific_gravity: 5.3,
                crystal_system: "Trigonal",
                transparency: "Opaco"
            },
            {
                id: 7, name: "Magnetita", formula: "Fe‚ÇÉO‚ÇÑ", hardness: 6,
                color: "Negro", streak: "Negro",
                emoji: "üß≤", type: "√ìxido",
                mindat_id: "2538", locality: "Mina Algarrobo",
                description: "Mineral magn√©tico de hierro. Importante en skarns.",
                occurrence: "Skarns, rocas √≠gneas m√°ficas",
                coordinates: { lat: -26.98, lng: -70.15 },
                specific_gravity: 5.2,
                crystal_system: "C√∫bico",
                transparency: "Opaco"
            },
            {
                id: 8, name: "Argentita", formula: "Ag‚ÇÇS", hardness: 2.5,
                color: "Gris plomo", streak: "Negro brillante",
                emoji: "ü™ô", type: "Sulfuro",
                mindat_id: "276", locality: "Mina Cha√±arcillo",
                description: "Importante mena de plata. Hist√≥ricamente significativa en Atacama.",
                occurrence: "Vetas epitermales de plata",
                coordinates: { lat: -27.8, lng: -70.6 },
                specific_gravity: 7.3,
                crystal_system: "C√∫bico",
                transparency: "Opaco"
            },
            {
                id: 9, name: "Cuarzo", formula: "SiO‚ÇÇ", hardness: 7,
                color: "Variable", streak: "Blanco",
                emoji: "üíé", type: "Silicato",
                mindat_id: "3337", locality: "Ubicuo en Atacama",
                description: "Mineral m√°s com√∫n de la corteza. Presente en todas las rocas.",
                occurrence: "Todas las rocas, vetas hidrotermales",
                coordinates: { lat: -27.3667, lng: -70.3333 },
                specific_gravity: 2.65,
                crystal_system: "Trigonal",
                transparency: "Transparente a transl√∫cido"
            },
            {
                id: 10, name: "Yeso", formula: "CaSO‚ÇÑ¬∑2H‚ÇÇO", hardness: 2,
                color: "Incoloro a blanco", streak: "Blanco",
                emoji: "üèõÔ∏è", type: "Sulfato",
                mindat_id: "4400", locality: "Salares de Atacama",
                description: "Sulfato de calcio hidratado. Com√∫n en evaporitas.",
                occurrence: "Dep√≥sitos evapor√≠ticos, zonas de alteraci√≥n",
                coordinates: { lat: -23.5, lng: -68.0 },
                specific_gravity: 2.3,
                crystal_system: "Monocl√≠nico",
                transparency: "Transparente a transl√∫cido"
            },
            // 40 minerales adicionales
            {
                id: 11, name: "Pirita", formula: "FeS‚ÇÇ", hardness: 6.5,
                color: "Amarillo lat√≥n", streak: "Negro verdoso",
                emoji: "‚ú®", type: "Sulfuro",
                locality: "Vetas hidrotermales",
                description: "Conocido como 'oro de los tontos'. Com√∫n en vetas.",
                occurrence: "Vetas hidrotermales, rocas sedimentarias"
            },
            {
                id: 12, name: "Galena", formula: "PbS", hardness: 2.5,
                color: "Gris plomo", streak: "Gris plomo",
                emoji: "‚ö´", type: "Sulfuro",
                locality: "Vetas de plomo",
                description: "Principal mena de plomo. Cristales c√∫bicos perfectos.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 13, name: "Esfalerita", formula: "ZnS", hardness: 3.5,
                color: "Marr√≥n a negro", streak: "Marr√≥n claro",
                emoji: "üü§", type: "Sulfuro",
                locality: "Yacimientos polimet√°licos",
                description: "Principal mena de zinc. A menudo asociada con galena.",
                occurrence: "Yacimientos polimet√°licos"
            },
            {
                id: 14, name: "Baritina", formula: "BaSO‚ÇÑ", hardness: 3.5,
                color: "Incoloro a blanco", streak: "Blanco",
                emoji: "‚ö™", type: "Sulfato",
                locality: "Vetas hidrotermales",
                description: "Mineral denso com√∫n en vetas. Usado en lodos de perforaci√≥n.",
                occurrence: "Vetas hidrotermales, sedimentario"
            },
            {
                id: 15, name: "Fluorita", formula: "CaF‚ÇÇ", hardness: 4,
                color: "Variable (p√∫rpura, verde, azul)", streak: "Blanco",
                emoji: "üü£", type: "Halogenuro",
                locality: "Vetas hidrotermales",
                description: "Mineral fluorescente con cristales c√∫bicos.",
                occurrence: "Vetas hidrotermales, pegmatitas"
            },
            {
                id: 16, name: "Apatito", formula: "Ca‚ÇÖ(PO‚ÇÑ)‚ÇÉ(F,Cl,OH)", hardness: 5,
                color: "Verde, azul, marr√≥n", streak: "Blanco",
                emoji: "ü¶∑", type: "Fosfato",
                locality: "Rocas √≠gneas",
                description: "Fosfato de calcio com√∫n en rocas √≠gneas.",
                occurrence: "Rocas √≠gneas, metam√≥rficas"
            },
            {
                id: 17, name: "Olivino", formula: "(Mg,Fe)‚ÇÇSiO‚ÇÑ", hardness: 7,
                color: "Verde oliva", streak: "Blanco",
                emoji: "ü´í", type: "Silicato",
                locality: "Rocas m√°ficas",
                description: "Silicato de magnesio y hierro. Com√∫n en rocas m√°ficas.",
                occurrence: "Rocas √≠gneas m√°ficas y ultram√°ficas"
            },
            {
                id: 18, name: "Grafito", formula: "C", hardness: 1.5,
                color: "Negro gris√°ceo", streak: "Negro",
                emoji: "‚úèÔ∏è", type: "Elemento nativo",
                locality: "Rocas metam√≥rficas",
                description: "Forma del carbono. Excelente lubricante natural.",
                occurrence: "Rocas metam√≥rficas"
            },
            {
                id: 19, name: "Talco", formula: "Mg‚ÇÉSi‚ÇÑO‚ÇÅ‚ÇÄ(OH)‚ÇÇ", hardness: 1,
                color: "Blanco, verde claro", streak: "Blanco",
                emoji: "ü™®", type: "Silicato",
                locality: "Rocas metam√≥rficas",
                description: "Mineral m√°s blando. Sensaci√≥n jabonosa al tacto.",
                occurrence: "Rocas metam√≥rficas"
            },
            {
                id: 20, name: "Calcita", formula: "CaCO‚ÇÉ", hardness: 3,
                color: "Incoloro a blanco", streak: "Blanco",
                emoji: "üî∂", type: "Carbonato",
                locality: "Sedimentarias y vetas",
                description: "Carbonato de calcio. Efervescente con HCl.",
                occurrence: "Rocas sedimentarias, vetas hidrotermales"
            },
            {
                id: 21, name: "Dolomita", formula: "CaMg(CO‚ÇÉ)‚ÇÇ", hardness: 4,
                color: "Blanco, rosa, gris", streak: "Blanco",
                emoji: "ü©∂", type: "Carbonato",
                locality: "Rocas sedimentarias",
                description: "Carbonato de calcio y magnesio. Menos reactiva que calcita.",
                occurrence: "Rocas sedimentarias"
            },
            {
                id: 22, name: "Anhidrita", formula: "CaSO‚ÇÑ", hardness: 3.5,
                color: "Incoloro, blanco, azul", streak: "Blanco",
                emoji: "üßÇ", type: "Sulfato",
                locality: "Evaporitas",
                description: "Sulfato de calcio anhidro. Asociada a yeso.",
                occurrence: "Dep√≥sitos evapor√≠ticos"
            },
            {
                id: 23, name: "Halita", formula: "NaCl", hardness: 2.5,
                color: "Incoloro, blanco", streak: "Blanco",
                emoji: "üßÇ", type: "Halogenuro",
                locality: "Salares",
                description: "Sal de roca. Sabor salado caracter√≠stico.",
                occurrence: "Dep√≥sitos evapor√≠ticos"
            },
            {
                id: 24, name: "Siderita", formula: "FeCO‚ÇÉ", hardness: 4,
                color: "Marr√≥n, amarillo", streak: "Blanco",
                emoji: "ü§é", type: "Carbonato",
                locality: "Vetas hidrotermales",
                description: "Carbonato de hierro. Importante mena de hierro.",
                occurrence: "Vetas hidrotermales, sedimentario"
            },
            {
                id: 25, name: "Cerusita", formula: "PbCO‚ÇÉ", hardness: 3.5,
                color: "Incoloro, blanco, gris", streak: "Blanco",
                emoji: "‚ö™", type: "Carbonato",
                locality: "Zonas de oxidaci√≥n",
                description: "Carbonato de plomo. Secundario de galena.",
                occurrence: "Zonas de oxidaci√≥n de yacimientos de plomo"
            },
            {
                id: 26, name: "Anglesita", formula: "PbSO‚ÇÑ", hardness: 3,
                color: "Incoloro, blanco", streak: "Blanco",
                emoji: "‚ö™", type: "Sulfato",
                locality: "Zonas de oxidaci√≥n",
                description: "Sulfato de plomo. Secundario de galena.",
                occurrence: "Zonas de oxidaci√≥n"
            },
            {
                id: 27, name: "Wulfenita", formula: "PbMoO‚ÇÑ", hardness: 3,
                color: "Naranja, amarillo, rojo", streak: "Blanco",
                emoji: "üü†", type: "Molibdato",
                locality: "Zonas de oxidaci√≥n",
                description: "Molibdato de plomo. Cristales tabulares caracter√≠sticos.",
                occurrence: "Zonas de oxidaci√≥n"
            },
            {
                id: 28, name: "Vanadinita", formula: "Pb‚ÇÖ(VO‚ÇÑ)‚ÇÉCl", hardness: 3,
                color: "Rojo, naranja, marr√≥n", streak: "Blanco amarillento",
                emoji: "üî∂", type: "Vanadato",
                locality: "Zonas de oxidaci√≥n",
                description: "Vanadato de plomo. Cristales hexagonales.",
                occurrence: "Zonas de oxidaci√≥n de yacimientos de plomo"
            },
            {
                id: 29, name: "Aragonito", formula: "CaCO‚ÇÉ", hardness: 4,
                color: "Incoloro, blanco, amarillo", streak: "Blanco",
                emoji: "üî∏", type: "Carbonato",
                locality: "Cuevas, fuentes termales",
                description: "Polimorfo de la calcita. Formas aciculares.",
                occurrence: "Ambientes de baja temperatura"
            },
            {
                id: 30, name: "Celestina", formula: "SrSO‚ÇÑ", hardness: 3.5,
                color: "Azul, blanco", streak: "Blanco",
                emoji: "üîµ", type: "Sulfato",
                locality: "Sedimentario",
                description: "Sulfato de estroncio. Cristales tabulares azules.",
                occurrence: "Rocas sedimentarias"
            },
            {
                id: 31, name: "Limonita", formula: "FeO(OH)¬∑nH‚ÇÇO", hardness: 5,
                color: "Amarillo, marr√≥n", streak: "Amarillo marr√≥n",
                emoji: "üü°", type: "√ìxido",
                locality: "Zonas de oxidaci√≥n",
                description: "Mezcla de √≥xidos de hierro hidratados.",
                occurrence: "Zonas de oxidaci√≥n de yacimientos de hierro"
            },
            {
                id: 32, name: "Goethita", formula: "FeO(OH)", hardness: 5.5,
                color: "Marr√≥n, amarillo", streak: "Amarillo marr√≥n",
                emoji: "üü§", type: "√ìxido",
                locality: "Zonas de oxidaci√≥n",
                description: "√ìxido de hierro hidratado. Com√∫n en gossans.",
                occurrence: "Zonas de oxidaci√≥n"
            },
            {
                id: 33, name: "Ilmenita", formula: "FeTiO‚ÇÉ", hardness: 6,
                color: "Negro", streak: "Negro a marr√≥n rojizo",
                emoji: "‚ö´", type: "√ìxido",
                locality: "Rocas √≠gneas",
                description: "√ìxido de hierro y titanio. Fuente importante de titanio.",
                occurrence: "Rocas √≠gneas m√°ficas"
            },
            {
                id: 34, name: "Rutilo", formula: "TiO‚ÇÇ", hardness: 6.5,
                color: "Rojo, marr√≥n, negro", streak: "Marr√≥n claro",
                emoji: "üî¥", type: "√ìxido",
                locality: "Rocas metam√≥rficas",
                description: "√ìxido de titanio. Cristales aciculares caracter√≠sticos.",
                occurrence: "Rocas metam√≥rficas, √≠gneas"
            },
            {
                id: 35, name: "Corind√≥n", formula: "Al‚ÇÇO‚ÇÉ", hardness: 9,
                color: "Variable", streak: "Blanco",
                emoji: "üíé", type: "√ìxido",
                locality: "Rocas metam√≥rficas",
                description: "√ìxido de aluminio. Segundo mineral m√°s duro.",
                occurrence: "Rocas metam√≥rficas"
            },
            {
                id: 36, name: "Bauxita", formula: "Al(OH)‚ÇÉ", hardness: 3,
                color: "Blanco, gris, marr√≥n", streak: "Blanco",
                emoji: "üü´", type: "√ìxido",
                locality: "Lateritas",
                description: "Mezcla de √≥xidos de aluminio. Principal mena de aluminio.",
                occurrence: "Perfiles later√≠ticos"
            },
            {
                id: 37, name: "Cinabrio", formula: "HgS", hardness: 2.5,
                color: "Rojo", streak: "Rojo",
                emoji: "üî¥", type: "Sulfuro",
                locality: "Vetas hidrotermales",
                description: "Principal mena de mercurio. Color rojo brillante.",
                occurrence: "Vetas hidrotermales de baja temperatura"
            },
            {
                id: 38, name: "Realgar", formula: "AsS", hardness: 2,
                color: "Rojo anaranjado", streak: "Naranja rojizo",
                emoji: "üü†", type: "Sulfuro",
                locality: "Vetas hidrotermales",
                description: "Sulfuro de ars√©nico. Color naranja rojizo brillante.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 39, name: "Orpimento", formula: "As‚ÇÇS‚ÇÉ", hardness: 2,
                color: "Amarillo", streak: "Amarillo",
                emoji: "üü°", type: "Sulfuro",
                locality: "Vetas hidrotermales",
                description: "Sulfuro de ars√©nico. Color amarillo dorado.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 40, name: "Estibina", formula: "Sb‚ÇÇS‚ÇÉ", hardness: 2,
                color: "Gris plomo", streak: "Gris plomo",
                emoji: "‚ö´", type: "Sulfuro",
                locality: "Vetas hidrotermales",
                description: "Principal mena de antimonio. Cristales aciculares.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 41, name: "Bismutinita", formula: "Bi‚ÇÇS‚ÇÉ", hardness: 2.5,
                color: "Gris plomo", streak: "Gris plomo",
                emoji: "‚ö™", type: "Sulfuro",
                locality: "Vetas hidrotermales",
                description: "Principal mena de bismuto.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 42, name: "Molibdenita", formula: "MoS‚ÇÇ", hardness: 1.5,
                color: "Gris plomo", streak: "Gris plomo",
                emoji: "ü©∂", type: "Sulfuro",
                locality: "Pegmatitas, vetas",
                description: "Principal mena de molibdeno. Sensaci√≥n grasosa.",
                occurrence: "Pegmatitas, vetas hidrotermales"
            },
            {
                id: 43, name: "Covelina", formula: "CuS", hardness: 2,
                color: "Azul √≠ndigo", streak: "Negro azulado",
                emoji: "üîµ", type: "Sulfuro",
                locality: "Zonas de enriquecimiento",
                description: "Sulfuro de cobre. Color azul caracter√≠stico.",
                occurrence: "Zonas de enriquecimiento superg√©nico"
            },
            {
                id: 44, name: "Calcosina", formula: "Cu‚ÇÇS", hardness: 3,
                color: "Gris plomo a negro", streak: "Negro gris√°ceo",
                emoji: "‚ö´", type: "Sulfuro",
                locality: "Zonas de enriquecimiento",
                description: "Sulfuro de cobre. Importante en zonas superg√©nicas.",
                occurrence: "Zonas de enriquecimiento superg√©nico"
            },
            {
                id: 45, name: "Enargita", formula: "Cu‚ÇÉAsS‚ÇÑ", hardness: 3.5,
                color: "Gris a negro", streak: "Negro",
                emoji: "‚ö´", type: "Sulfosal",
                locality: "Vetas epitermales",
                description: "Sulfosal de cobre y ars√©nico. Cristales prism√°ticos.",
                occurrence: "Vetas epitermales"
            },
            {
                id: 46, name: "Tenantita", formula: "Cu‚ÇÅ‚ÇÇAs‚ÇÑS‚ÇÅ‚ÇÉ", hardness: 4,
                color: "Gris a negro", streak: "Negro",
                emoji: "‚ö´", type: "Sulfosal",
                locality: "Vetas hidrotermales",
                description: "Sulfosal de cobre. Cristales tetra√©dricos.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 47, name: "Bournonita", formula: "PbCuSbS‚ÇÉ", hardness: 3,
                color: "Gris acero", streak: "Negro gris√°ceo",
                emoji: "‚ö´", type: "Sulfosal",
                locality: "Vetas hidrotermales",
                description: "Sulfosal de plomo, cobre y antimonio. Cristales en rueda dentada.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 48, name: "Proustita", formula: "Ag‚ÇÉAsS‚ÇÉ", hardness: 2.5,
                color: "Rojo", streak: "Rojo",
                emoji: "üî¥", type: "Sulfosal",
                locality: "Vetas hidrotermales",
                description: "Sulfosal de plata y ars√©nico. Color rojo rub√≠.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 49, name: "Pirargirita", formula: "Ag‚ÇÉSbS‚ÇÉ", hardness: 2.5,
                color: "Rojo oscuro", streak: "Rojo p√∫rpura",
                emoji: "üü£", type: "Sulfosal",
                locality: "Vetas hidrotermales",
                description: "Sulfosal de plata y antimonio. Color rojo oscuro.",
                occurrence: "Vetas hidrotermales"
            },
            {
                id: 50, name: "Rodocrosita", formula: "MnCO‚ÇÉ", hardness: 4,
                color: "Rosa a rojo", streak: "Blanco",
                emoji: "üå∏", type: "Carbonato",
                locality: "Vetas hidrotermales",
                description: "Carbonato de manganeso. Color rosa caracter√≠stico.",
                occurrence: "Vetas hidrotermales, sedimentario"
            }
        ];

        // Datos de colores de raya para minerales
        const streakColors = [
            { name: "Rojo cereza", color: "#dc2626", emoji: "üî¥", minerals: ["Hematita"] },
            { name: "Rojo", color: "#ef4444", emoji: "üü•", minerals: ["Cinabrio", "Realgar"] },
            { name: "Naranja", color: "#f97316", emoji: "üüß", minerals: ["Vanadinita"] },
            { name: "Amarillo", color: "#fbbf24", emoji: "üü®", minerals: ["Orpimento", "Limonita"] },
            { name: "Amarillo marr√≥n", color: "#d97706", emoji: "üü´", minerals: ["Goethita"] },
            { name: "Verde claro", color: "#22c55e", emoji: "üü©", minerals: ["Malaquita"] },
            { name: "Verde manzana", color: "#16a34a", emoji: "üçè", minerals: ["Atacamita"] },
            { name: "Verde negruzco", color: "#166534", emoji: "üü¢", minerals: ["Calcopirita"] },
            { name: "Azul", color: "#3b82f6", emoji: "üîµ", minerals: ["Azurita"] },
            { name: "Negro", color: "#000000", emoji: "‚ö´", minerals: ["Magnetita", "Pirita", "Galena"] },
            { name: "Negro verdoso", color: "#14532d", emoji: "üå≤", minerals: ["Pirita"] },
            { name: "Negro azulado", color: "#1e3a8a", emoji: "üåÄ", minerals: ["Covelina"] },
            { name: "Gris plomo", color: "#6b7280", emoji: "ü©∂", minerals: ["Galena", "Argentita"] },
            { name: "Gris", color: "#9ca3af", emoji: "‚ö™", minerals: ["Esfalerita"] },
            { name: "Gris negruzco", color: "#374151", emoji: "‚óºÔ∏è", minerals: ["Bornita"] },
            { name: "Marr√≥n claro", color: "#92400e", emoji: "üü§", minerals: ["Rutilo", "Esfalerita"] },
            { name: "Marr√≥n", color: "#78350f", emoji: "üü´", minerals: ["Ilmenita"] },
            { name: "Blanco", color: "#ffffff", emoji: "‚ö™", minerals: ["Cuarzo", "Calcita", "Yeso", "Baritina"] },
            { name: "Blanco amarillento", color: "#fef3c7", emoji: "üíõ", minerals: ["Vanadinita"] },
            { name: "Rojo p√∫rpura", color: "#9333ea", emoji: "üü£", minerals: ["Pirargirita"] }
        ];

        // Datos de tipos de fractura
        const fractureTypes = [
            { name: "Concoidea", emoji: "üç™", description: "Fractura curva, t√≠pica del vidrio y minerales amorfos como la obsidiana", example: "Cuarzo, Obsidiana" },
            { name: "Irregular", emoji: "‚ö°", description: "Superficie de fractura irregular y rugosa", example: "Cobre nativo, Hematita" },
            { name: "Fibrosa", emoji: "üßµ", description: "Fractura que muestra fibras o astillas", example: "Asbesto, Yeso fibroso" },
            { name: "Ganchuda", emoji: "ü™ù", description: "Superficie dentada y afilada", example: "Cobre nativo, Plata nativa" },
            { name: "Splintery", emoji: "ü™µ", description: "Fractura que produce astillas alargadas", example: "Pectolita, Selenita" },
            { name: "Terrosa", emoji: "üå±", description: "Fractura que produce polvo o fragmentos terrosos", example: "Bauxita, Limonita" },
            { name: "Hackly", emoji: "üî™", description: "Fractura con bordes filosos y dentados", example: "Metales nativos" },
            { name: "Laminar", emoji: "ü•û", description: "Fractura en l√°minas o escamas", example: "Mica, Molibdenita" },
            { name: "Escamosa", emoji: "üêü", description: "Fractura que produce escamas peque√±as", example: "Clorita, Talco" },
            { name: "Granular", emoji: "üßÇ", description: "Fractura que produce gr√°nulos peque√±os", example: "Cromita, Magnetita" }
        ];

        // ============================================
        // FUNCIONES GENERALES
        // ============================================
        function closeModal() {
            document.getElementById('toolModal').style.display = 'none';
        }

        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('toolModal').style.display = 'flex';
        }

        function showNotification(message, type = 'info') {
            // Crear notificaci√≥n con glass effect
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = '‚ÑπÔ∏è';
            let color = '#3498db';
            
            switch(type) {
                case 'success':
                    icon = '‚úÖ';
                    color = '#27ae60';
                    break;
                case 'error':
                    icon = '‚ùå';
                    color = '#e74c3c';
                    break;
                case 'warning':
                    icon = '‚ö†Ô∏è';
                    color = '#f39c12';
                    break;
            }
            
            notification.innerHTML = `
                <div style="font-size:1.4rem;">${icon}</div>
                <div style="flex:1; font-size:0.95rem;">${message}</div>
                <button onclick="this.parentElement.remove()" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px);">√ó</button>
            `;
            notification.style.background = `linear-gradient(135deg, rgba(${hexToRgb(color)}, 0.9), rgba(${hexToRgb(color)}, 0.7))`;
            
            document.body.appendChild(notification);
            
            // Auto-remover
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%) translateY(-20px)';
                    notification.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` 
                : '52, 152, 219';
        }

        // ============================================
        // 1. C√ÅMARA GEOL√ìGICA MEJORADA
        // ============================================
        function setupAutoActivation() {
            setTimeout(() => {
                activateGPS();
                setTimeout(() => {
                    // No activar c√°mara autom√°ticamente, solo GPS
                }, 500);
            }, 1500);
        }

        function activateGPS() {
            if (gpsWatchId) return;
            
            showNotification('üõ∞Ô∏è Activando GPS satelital...', 'info');
            
            if (!navigator.geolocation) {
                showNotification('‚ùå GPS no disponible en este dispositivo', 'error');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    realGPSData = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude || 0,
                        heading: position.coords.heading || 0,
                        speed: position.coords.speed || 0,
                        timestamp: position.timestamp
                    };
                    
                    updateGPSDisplay();
                    
                    // Monitoreo continuo
                    gpsWatchId = navigator.geolocation.watchPosition(
                        pos => {
                            realGPSData = {
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude,
                                accuracy: pos.coords.accuracy,
                                altitude: pos.coords.altitude || 0,
                                heading: pos.coords.heading || 0,
                                speed: pos.coords.speed || 0,
                                timestamp: pos.timestamp
                            };
                            updateGPSDisplay();
                            updateWeather(); // Actualizar clima con nueva ubicaci√≥n
                        },
                        null,
                        options
                    );
                    
                    const gpsStatus = document.getElementById('gpsStatus');
                    gpsStatus.classList.add('active');
                    gpsStatus.innerHTML = `
                        <i class="fas fa-satellite"></i>
                        <span>GPS: ACTIVO üõ∞Ô∏è</span>
                        <span class="badge badge-gps">${realGPSData.accuracy.toFixed(0)}m</span>
                    `;
                    
                    showNotification('‚úÖ GPS activado con precisi√≥n de ' + realGPSData.accuracy.toFixed(0) + ' metros', 'success');
                    
                    // Actualizar mapa
                    if (map) {
                        map.setView([realGPSData.latitude, realGPSData.longitude], 14);
                    }
                    
                    // Cargar minerales locales y clima
                    loadLocalMinerals();
                    updateWeather();
                    
                },
                error => {
                    showNotification('‚ö†Ô∏è Usando ubicaci√≥n simulada de Atacama', 'warning');
                    realGPSData = {
                        latitude: -27.3667,
                        longitude: -70.3333,
                        accuracy: 50,
                        altitude: 1500,
                        heading: 0,
                        speed: 0,
                        timestamp: Date.now()
                    };
                    updateGPSDisplay();
                },
                options
            );
        }

        function updateGPSDisplay() {
            if (!realGPSData) return;
            
            console.log('üìç GPS Actualizado:', realGPSData.latitude.toFixed(6), realGPSData.longitude.toFixed(6));
            
            // Actualizar br√∫jula si existe
            if (compassActive && realGPSData.heading) {
                updateCompass(realGPSData.heading + magneticDeclination);
            }
        }

        function activateCamera() {
            const cameraStatus = document.getElementById('cameraStatus');
            
            if (cameraStream) {
                // Si ya est√° activa, desactivarla
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                
                const video = document.getElementById('cameraFeed');
                const placeholder = document.getElementById('cameraPlaceholder');
                
                video.style.display = 'none';
                placeholder.style.display = 'flex';
                video.srcObject = null;
                
                cameraStatus.classList.remove('active');
                cameraStatus.innerHTML = `
                    <i class="fas fa-camera"></i>
                    <span>C√ÅMARA: HAZ CLICK üì∏</span>
                    <span class="badge badge-camera">APAGADA</span>
                `;
                
                showNotification('üì∏ C√°mara desactivada', 'info');
                return;
            }
            
            showNotification('üì∏ Activando c√°mara HD 1080p...', 'info');
            
            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    facingMode: 'environment',
                    frameRate: { ideal: 30 }
                },
                audio: false
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    cameraStream = stream;
                    const video = document.getElementById('cameraFeed');
                    const placeholder = document.getElementById('cameraPlaceholder');
                    
                    video.srcObject = stream;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    video.play();
                    
                    cameraStatus.classList.add('active');
                    cameraStatus.innerHTML = `
                        <i class="fas fa-camera"></i>
                        <span>C√ÅMARA: ACTIVA üì∏</span>
                        <span class="badge badge-camera">HD 1080p</span>
                    `;
                    
                    showNotification('‚úÖ C√°mara HD activada - Lista para identificaci√≥n', 'success');
                })
                .catch(error => {
                    console.error('Error c√°mara:', error);
                    showNotification('‚ö†Ô∏è No se pudo acceder a la c√°mara. Usa "Importar" para subir im√°genes.', 'warning');
                });
        }

        function importImage() {
            document.getElementById('imageUpload').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('‚ö†Ô∏è Por favor sube solo archivos de imagen', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Mostrar imagen en el contenedor de c√°mara
                    const canvas = document.getElementById('cameraCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // Mostrar en el placeholder
                    const placeholder = document.getElementById('cameraPlaceholder');
                    placeholder.innerHTML = `
                        <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                            <img src="${e.target.result}" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:10px;">
                        </div>
                    `;
                    
                    showNotification('üì∏ Imagen cargada - Haz click en "Identificar"', 'success');
                    
                    // Analizar autom√°ticamente
                    setTimeout(() => {
                        analyzeImageFromUpload(canvas);
                    }, 1000);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function analyzeImageFromUpload(canvas) {
            showNotification('üîç Analizando imagen con IA...', 'info');
            
            // Simulaci√≥n de an√°lisis IA con base de datos de 50 minerales
            setTimeout(() => {
                const mineralIndex = Math.floor(Math.random() * atacamaMineralsDB.length);
                const mineral = { ...atacamaMineralsDB[mineralIndex] };
                
                const locationData = realGPSData || {
                    latitude: -27.3667,
                    longitude: -70.3333,
                    accuracy: 50,
                    altitude: 1500,
                    timestamp: Date.now()
                };
                
                const identifiedMineral = {
                    ...mineral,
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    location: locationData,
                    imageData: canvas.toDataURL('image/jpeg', 0.7),
                    confidence: (85 + Math.random() * 15).toFixed(1),
                    notes: `Identificado por IA Geobot desde imagen subida. Color: ${mineral.color}, Dureza: ${mineral.hardness}`,
                    source: 'uploaded_image'
                };
                
                identifiedMinerals.unshift(identifiedMineral);
                if (identifiedMinerals.length > 50) identifiedMinerals.pop();
                
                showMineralResult(identifiedMineral);
                updateCoverflow();
                saveToLocalStorage();
                addMineralToMap(identifiedMineral);
                
                showNotification(`‚úÖ ${mineral.emoji} ${mineral.name} identificado en imagen`, 'success');
                
                // Agregar al chat IA
                addChatMessage(`He identificado ${mineral.name} (${mineral.formula}) en la imagen subida. Confianza: ${identifiedMineral.confidence}%`, 'ai');
                
            }, 2000);
        }

        function captureAndAnalyze() {
            if (!cameraStream && identifiedMinerals.length === 0) {
                showNotification('Primero activa la c√°mara o sube una imagen', 'warning');
                return;
            }
            
            if (cameraStream) {
                // Analizar desde c√°mara activa
                const video = document.getElementById('cameraFeed');
                const canvas = document.getElementById('cameraCanvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                analyzeImage(canvas, 'camera');
            } else {
                // Analizar √∫ltima imagen cargada
                const canvas = document.getElementById('cameraCanvas');
                if (canvas.width > 0) {
                    analyzeImage(canvas, 'upload');
                } else {
                    showNotification('No hay imagen para analizar', 'warning');
                }
            }
        }

        function analyzeImage(canvas, source) {
            showNotification('üîç Analizando con base de datos de 50 minerales...', 'info');
            
            // Efecto visual
            const cameraContainer = document.getElementById('cameraContainer');
            cameraContainer.style.background = 'rgba(255, 255, 255, 0.9)';
            cameraContainer.style.transition = 'background 0.3s';
            setTimeout(() => {
                cameraContainer.style.background = 'rgba(44, 62, 80, 0.6)';
            }, 300);
            
            // Simulaci√≥n de an√°lisis IA avanzado
            setTimeout(() => {
                // Selecci√≥n inteligente basada en probabilidades de Atacama
                let mineralIndex;
                const rand = Math.random();
                
                if (rand < 0.3) mineralIndex = 0; // Calcopirita (30%)
                else if (rand < 0.5) mineralIndex = 1; // Malaquita (20%)
                else if (rand < 0.6) mineralIndex = 2; // Atacamita (10%)
                else if (rand < 0.7) mineralIndex = 3; // Bornita (10%)
                else if (rand < 0.75) mineralIndex = 5; // Hematita (5%)
                else mineralIndex = Math.floor(Math.random() * atacamaMineralsDB.length);
                
                const mineral = { ...atacamaMineralsDB[mineralIndex] };
                
                const locationData = realGPSData || {
                    latitude: -27.3667,
                    longitude: -70.3333,
                    accuracy: 50,
                    altitude: 1500,
                    timestamp: Date.now()
                };
                
                const confidence = source === 'camera' ? 
                    (75 + Math.random() * 25).toFixed(1) : 
                    (80 + Math.random() * 20).toFixed(1);
                
                const identifiedMineral = {
                    ...mineral,
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    location: locationData,
                    imageData: canvas.toDataURL('image/jpeg', 0.7),
                    confidence: confidence,
                    notes: `Identificado por IA Geobot desde ${source === 'camera' ? 'c√°mara HD' : 'imagen subida'}.`,
                    source: source
                };
                
                identifiedMinerals.unshift(identifiedMineral);
                if (identifiedMinerals.length > 50) identifiedMinerals.pop();
                
                showMineralResult(identifiedMineral);
                updateCoverflow();
                saveToLocalStorage();
                addMineralToMap(identifiedMineral);
                
                showNotification(`‚úÖ ${mineral.emoji} ${mineral.name} identificado (${confidence}% confianza)`, 'success');
                
                // Agregar al chat IA
                addChatMessage(`Identificaci√≥n exitosa: ${mineral.name} (${mineral.formula}). Caracter√≠sticas: Dureza ${mineral.hardness}, Color ${mineral.color}, Raya ${mineral.streak}.`, 'ai');
                
            }, 1500);
        }

        function showMineralResult(mineral) {
            const resultDiv = document.getElementById('analysisResult');
            const mineralResult = document.getElementById('mineralResult');
            
            mineralResult.innerHTML = `
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                    <div style="font-size:2.5rem; filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));">${mineral.emoji}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:#f39c12; font-size:1.2rem;">${mineral.name}</div>
                        <div style="color:rgba(255,255,255,0.8); font-size:1rem;">${mineral.formula}</div>
                        <div style="margin-top:5px; padding:5px 10px; background:rgba(52,152,219,0.2); border-radius:8px; display:inline-block; font-size:0.9rem;">
                            <i class="fas fa-brain"></i> ${mineral.confidence}% confianza
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:0.95rem; margin-bottom:15px;">
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                        <strong style="color:#f39c12;">Dureza:</strong><br>
                        <span style="color:white;">${mineral.hardness} Mohs</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                        <strong style="color:#f39c12;">Color:</strong><br>
                        <span style="color:white;">${mineral.color}</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                        <strong style="color:#f39c12;">Raya:</strong><br>
                        <span style="color:white;">${mineral.streak}</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                        <strong style="color:#f39c12;">Tipo:</strong><br>
                        <span style="color:white;">${mineral.type}</span>
                    </div>
                </div>
                <div style="margin-top:10px; padding:12px; background:rgba(52,152,219,0.15); border-radius:10px; font-size:0.9rem; border:1px solid rgba(255,255,255,0.1);">
                    <strong style="color:#f39c12;">Ubicaci√≥n:</strong><br>
                    <span style="color:white;">${mineral.location.latitude.toFixed(6)}, ${mineral.location.longitude.toFixed(6)}</span><br>
                    <small style="color:rgba(255,255,255,0.7);">${new Date(mineral.timestamp).toLocaleTimeString()}</small>
                </div>
                <button class="btn btn-outline" onclick="saveMineralToCollection(${mineral.id})" style="margin-top:10px; width:100%; padding:10px; font-size:0.9rem;">
                    <i class="fas fa-save"></i> Guardar en Colecci√≥n
                </button>
            `;
            
            resultDiv.style.display = 'block';
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 10000);
        }

        function saveMineralToCollection(mineralId) {
            const mineral = identifiedMinerals.find(m => m.id === mineralId);
            if (!mineral) return;
            
            showNotification(`üíæ ${mineral.name} guardado en colecci√≥n`, 'success');
        }

        // ============================================
        // 2. MAPA GEOL√ìGICO CON TOPOGRAF√çA
        // ============================================
        function initMap() {
            map = L.map('map').setView([-27.3667, -70.3333], 12);
            
            // Capa base ESRI World Topographic (mejor para geolog√≠a)
            const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri, DeLorme, NAVTEQ, TomTom, Intermap, increment P Corp., GEBCO, USGS, FAO, NPS, NRCAN, GeoBase, IGN, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
                maxZoom: 18
            }).addTo(map);
            
            // Capa satelital ESRI
            const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri, Maxar, Earthstar Geographics, and the GIS User Community',
                maxZoom: 18
            });
            
            // Capa OpenTopoMap (topograf√≠a especializada)
            const openTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap (CC-BY-SA)',
                maxZoom: 17
            });
            
            // Control de capas
            const baseLayers = {
                "Topogr√°fico ESRI": esriTopo,
                "Sat√©lite ESRI": esriSatellite,
                "OpenTopoMap": openTopoMap
            };
            
            L.control.layers(baseLayers, {}, {
                position: 'topright',
                collapsed: true
            }).addTo(map);
            
            // Marcador de posici√≥n actual
            const userIcon = L.divIcon({
                className: 'user-marker',
                html: '<div style="background:rgba(231,76,60,0.9); color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; border:3px solid rgba(255,255,255,0.6); backdrop-filter:blur(5px); box-shadow:0 4px 15px rgba(0,0,0,0.4);"><i class="fas fa-user"></i></div>',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            
            L.marker([-27.3667, -70.3333], { icon: userIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="background:rgba(0,0,0,0.8); color:white; padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px); max-width:250px;">
                        <b style="color:#f39c12;">Regi√≥n de Atacama</b><br>
                        Centro geol√≥gico<br>
                        <small>Lat: -27.3667, Lng: -70.3333</small>
                    </div>
                `);
                
            console.log('üó∫Ô∏è Mapa inicializado con capas topogr√°ficas');
            
            // Agregar control de escala
            L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);
        }

        function toggleTopographicLayer() {
            if (!topographicLayer) {
                showNotification('üîÑ Cargando capa topogr√°fica...', 'info');
                
                // Simulaci√≥n de carga de capa topogr√°fica
                setTimeout(() => {
                    // Crear capa de curvas de nivel simuladas
                    topographicLayer = L.layerGroup();
                    
                    // Simular algunas curvas de nivel
                    for (let i = 0; i < 10; i++) {
                        const lat = -27.3 + (Math.random() - 0.5) * 0.2;
                        const lng = -70.3 + (Math.random() - 0.5) * 0.2;
                        
                        L.circle([lat, lng], {
                            color: '#3498db',
                            fillColor: 'rgba(52,152,219,0.1)',
                            fillOpacity: 0.3,
                            radius: 500 + Math.random() * 1000
                        }).addTo(topographicLayer);
                    }
                    
                    // Agregar al mapa
                    topographicLayer.addTo(map);
                    
                    showNotification('‚úÖ Capa topogr√°fica activada', 'success');
                }, 1000);
            } else {
                map.removeLayer(topographicLayer);
                topographicLayer = null;
                showNotification('üó∫Ô∏è Capa topogr√°fica desactivada', 'info');
            }
        }

        function centerMap() {
            if (realGPSData) {
                map.setView([realGPSData.latitude, realGPSData.longitude], 15);
                showNotification('üìç Mapa centrado en tu ubicaci√≥n GPS', 'info');
            } else {
                map.setView([-27.3667, -70.3333], 12);
                showNotification('üó∫Ô∏è Mapa centrado en regi√≥n de Atacama', 'info');
            }
        }

        function addMarker() {
            const coords = realGPSData ? 
                [realGPSData.latitude, realGPSData.longitude] : 
                [-27.3667, -70.3333];
            
            const marker = L.marker(coords).addTo(map);
            marker.bindPopup(`
                <div style="background:rgba(0,0,0,0.8); color:white; padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px); max-width:250px;">
                    <b style="color:#f39c12;">Punto de Muestra</b><br>
                    ${new Date().toLocaleString()}<br>
                    <small>${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}</small><br>
                    <button onclick="addSampleNote(${coords[0]}, ${coords[1]})" style="margin-top:8px; padding:5px 10px; background:rgba(211,84,0,0.8); border:none; border-radius:5px; color:white; cursor:pointer; font-size:0.9rem;">
                        <i class="fas fa-edit"></i> Agregar nota
                    </button>
                </div>
            `).openPopup();
            
            showNotification('üìç Marcador de muestra agregado', 'success');
        }

        function addMineralToMap(mineral) {
            if (!map || !mineral.location) return;
            
            const icon = L.divIcon({
                className: 'mineral-marker',
                html: `
                    <div style="background:rgba(211,84,0,0.9); color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; border:3px solid rgba(255,255,255,0.6); backdrop-filter:blur(5px); box-shadow:0 4px 15px rgba(0,0,0,0.4);">
                        ${mineral.emoji}
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            
            L.marker([mineral.location.latitude, mineral.location.longitude], { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div style="background:rgba(0,0,0,0.8); color:white; padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px); max-width:250px;">
                        <b style="color:#f39c12; font-size:1.1em;">${mineral.emoji} ${mineral.name}</b><br>
                        ${mineral.formula}<br>
                        Dureza: ${mineral.hardness} Mohs<br>
                        Tipo: ${mineral.type}<br>
                        <small>${new Date(mineral.timestamp).toLocaleTimeString()}</small>
                    </div>
                `);
        }

        function loadGeologicalLayers() {
            showNotification('üîÑ Cargando capas geol√≥gicas especializadas...', 'info');
            
            setTimeout(() => {
                // Capa de fallas geol√≥gicas
                const faultLayer = L.geoJSON({
                    type: "FeatureCollection",
                    features: [{
                        type: "Feature",
                        geometry: {
                            type: "LineString",
                            coordinates: [
                                [-70.4, -27.3],
                                [-70.35, -27.35],
                                [-70.3, -27.4],
                                [-70.25, -27.35],
                                [-70.2, -27.3]
                            ]
                        },
                        properties: { 
                            name: "Sistema de Fallas NNW",
                            type: "Inversa",
                            length: "15 km"
                        }
                    }, {
                        type: "Feature",
                        geometry: {
                            type: "LineString",
                            coordinates: [
                                [-70.45, -27.25],
                                [-70.4, -27.3],
                                [-70.35, -27.25]
                            ]
                        },
                        properties: {
                            name: "Falla Este-Oeste",
                            type: "Dextral",
                            length: "8 km"
                        }
                    }]
                }, { 
                    color: '#e74c3c', 
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                });
                
                // Capa de mineralizaci√≥n
                const mineralLayer = L.layerGroup();
                
                localMineralsCache.forEach(mineral => {
                    const icon = L.divIcon({
                        className: 'mineral-layer-marker',
                        html: `
                            <div style="background:rgba(52,152,219,0.9); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; border:2px solid rgba(255,255,255,0.5); backdrop-filter:blur(5px);">
                                ${mineral.emoji}
                            </div>
                        `,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    });
                    
                    const marker = L.marker([mineral.coordinates.lat, mineral.coordinates.lng], { icon: icon })
                        .bindPopup(`
                            <div style="background:rgba(0,0,0,0.8); color:white; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px); max-width:220px;">
                                <b style="color:#f39c12;">${mineral.emoji} ${mineral.name}</b><br>
                                ${mineral.formula}<br>
                                <small>${mineral.locality}</small>
                            </div>
                        `);
                    mineralLayer.addLayer(marker);
                });
                
                // Capa de zonas de alteraci√≥n
                const alterationLayer = L.layerGroup();
                
                // Crear pol√≠gonos de alteraci√≥n simulados
                const alterationColors = ['#f39c12', '#e74c3c', '#2ecc71', '#9b59b6'];
                
                for (let i = 0; i < 3; i++) {
                    const lat = -27.3 + (Math.random() - 0.5) * 0.3;
                    const lng = -70.3 + (Math.random() - 0.5) * 0.3;
                    
                    L.circle([lat, lng], {
                        color: alterationColors[i],
                        fillColor: alterationColors[i],
                        fillOpacity: 0.2,
                        radius: 800 + Math.random() * 1200
                    })
                    .bindPopup(`
                        <div style="background:rgba(0,0,0,0.8); color:white; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px);">
                            <b style="color:#f39c12;">Zona de Alteraci√≥n</b><br>
                            Tipo: ${['Propil√≠tica', 'Arg√≠lica', 'F√≠lica'][i]}<br>
                            Minerales: ${['Clorita, Epidota', 'Caolinita, Illita', 'Cuarzo, Sericita'][i]}
                        </div>
                    `)
                    .addTo(alterationLayer);
                }
                
                // Control de capas
                const overlayLayers = {
                    "Fallas Geol√≥gicas": faultLayer,
                    "Mineralizaci√≥n": mineralLayer,
                    "Zonas de Alteraci√≥n": alterationLayer
                };
                
                L.control.layers(null, overlayLayers, {
                    position: 'topright',
                    collapsed: false
                }).addTo(map);
                
                showNotification('‚úÖ 3 capas geol√≥gicas cargadas exitosamente', 'success');
            }, 1500);
        }

        // ============================================
        // 3. KIT DE CAMPO - HERRAMIENTAS FUNCIONALES
        // ============================================
        function openTool(tool) {
            let content = '';
            let title = '';
            
            switch(tool) {
                case 'compass':
                    title = 'Br√∫jula Geol√≥gica';
                    content = generateCompassTool();
                    break;
                case 'mohs':
                    title = 'Escala de Mohs';
                    content = generateMohsTool();
                    break;
                case 'streak':
                    title = 'Colores de Raya';
                    content = generateStreakTool();
                    break;
                case 'fracture':
                    title = 'Tipos de Fractura';
                    content = generateFractureTool();
                    break;
                case 'calculator':
                    title = 'Calculadora Geol√≥gica';
                    content = generateCalculatorTool();
                    break;
                case 'weather':
                    title = 'Clima Satelital';
                    content = generateWeatherTool();
                    break;
            }
            
            openModal(title, content);
        }

        function generateStreakTool() {
            let content = `
                <div style="padding:25px;">
                    <h3 style="margin-bottom:20px; color:#f39c12; font-size:1.4rem;">üé® Colores de Raya</h3>
                    <p style="margin-bottom:25px; color:rgba(255,255,255,0.8); font-size:1.05rem;">Gu√≠a de identificaci√≥n por color de raya mineral</p>
                    
                    <div style="margin-bottom:25px; padding:20px; background:rgba(255,255,255,0.08); border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">¬øQu√© es el color de raya?</strong>
                        <div style="color:white; line-height:1.6;">
                            El color de raya se obtiene frotando un mineral contra una placa de porcelana sin vidriar (placa de raya). 
                            Es m√°s confiable que el color del mineral, ya que elimina efectos de impurezas superficiales.
                        </div>
                    </div>
                    
                    <div class="streak-colors">
            `;
            
            streakColors.forEach(streak => {
                content += `
                    <div class="streak-item" onclick="showStreakDetail('${streak.name}')">
                        <div class="streak-color" style="background-color:${streak.color};">
                            <div style="font-size:1.5rem;">${streak.emoji}</div>
                        </div>
                        <div style="font-weight:bold; color:white; margin-bottom:8px;">${streak.name}</div>
                        <div style="font-size:0.9rem; color:rgba(255,255,255,0.7);">
                            Ej: ${streak.minerals.slice(0, 2).join(', ')}
                        </div>
                    </div>
                `;
            });
            
            content += `
                    </div>
                    
                    <div style="margin-top:25px; padding:20px; background:rgba(232,244,252,0.15); border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">T√©cnica correcta:</strong>
                        <div style="color:white; line-height:1.6;">
                            1. Usa una placa de porcelana sin vidriar (dureza ~7)<br>
                            2. Frota el mineral con presi√≥n moderada<br>
                            3. Observa el color del polvo dejado<br>
                            4. Compara con esta gu√≠a de referencia<br>
                            5. Limpia la placa entre usos
                        </div>
                    </div>
                </div>
            `;
            
            return content;
        }

        function showStreakDetail(streakName) {
            const streak = streakColors.find(s => s.name === streakName);
            if (!streak) return;
            
            const mineralsWithThisStreak = atacamaMineralsDB.filter(m => 
                streak.minerals.some(mineralName => m.name.includes(mineralName))
            );
            
            let mineralsList = '';
            mineralsWithThisStreak.slice(0, 5).forEach(mineral => {
                mineralsList += `
                    <div style="padding:12px; margin:8px 0; background:rgba(255,255,255,0.1); border-radius:10px; display:flex; align-items:center; gap:12px; border-left:3px solid #d35400;">
                        <div style="font-size:1.8rem;">${mineral.emoji}</div>
                        <div>
                            <strong style="color:#f39c12;">${mineral.name}</strong><br>
                            <small style="color:rgba(255,255,255,0.7);">${mineral.formula}</small>
                        </div>
                    </div>
                `;
            });
            
            const modalContent = `
                <div style="padding:25px;">
                    <div style="text-align:center; margin-bottom:25px;">
                        <div class="streak-color" style="background-color:${streak.color}; width:80px; height:80px; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:2rem;">
                            ${streak.emoji}
                        </div>
                        <h3 style="color:#f39c12; font-size:1.6rem; margin-bottom:5px;">${streak.name}</h3>
                        <p style="color:rgba(255,255,255,0.8);">Color de raya caracter√≠stico</p>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.08); padding:20px; border-radius:15px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">Minerales con este color de raya:</strong>
                        <div style="margin-top:10px;">
                            ${mineralsList}
                        </div>
                    </div>
                    
                    <div style="background:rgba(232,244,252,0.15); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">Importancia en identificaci√≥n:</strong>
                        <div style="color:white; line-height:1.6;">
                            ‚Ä¢ El color de raya es constante para cada mineral<br>
                            ‚Ä¢ Es m√°s confiable que el color aparente del mineral<br>
                            ‚Ä¢ Ayuda a distinguir minerales con colores similares<br>
                            ‚Ä¢ Es una prueba r√°pida y econ√≥mica de campo
                        </div>
                    </div>
                </div>
            `;
            
            openModal(`Color de Raya: ${streakName}`, modalContent);
        }

        function generateFractureTool() {
            let content = `
                <div style="padding:25px;">
                    <h3 style="margin-bottom:20px; color:#f39c12; font-size:1.4rem;">‚ö° Tipos de Fractura Mineral</h3>
                    <p style="margin-bottom:25px; color:rgba(255,255,255,0.8); font-size:1.05rem;">Gu√≠a de identificaci√≥n por tipo de fractura</p>
                    
                    <div style="margin-bottom:25px; padding:20px; background:rgba(255,255,255,0.08); border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">¬øQu√© es la fractura?</strong>
                        <div style="color:white; line-height:1.6;">
                            La fractura describe c√≥mo se rompe un mineral cuando no sigue planos de clivaje definidos. 
                            Es una propiedad importante para la identificaci√≥n de minerales.
                        </div>
                    </div>
                    
                    <div class="fractures-grid">
            `;
            
            fractureTypes.forEach(fracture => {
                content += `
                    <div class="fracture-item" onclick="showFractureDetail('${fracture.name}')">
                        <div class="fracture-emoji">${fracture.emoji}</div>
                        <div style="font-weight:bold; color:white; margin-bottom:8px;">${fracture.name}</div>
                        <div style="font-size:0.9rem; color:rgba(255,255,255,0.7);">
                            Ej: ${fracture.example}
                        </div>
                    </div>
                `;
            });
            
            content += `
                    </div>
                    
                    <div style="margin-top:25px; padding:20px; background:rgba(232,244,252,0.15); border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">T√©cnica de observaci√≥n:</strong>
                        <div style="color:white; line-height:1.6;">
                            1. Golpea suavemente el mineral con un martillo geol√≥gico<br>
                            2. Observa la superficie de ruptura<br>
                            3. Compara con las descripciones de fractura<br>
                            4. Diferencia entre fractura y clivaje (planos de ruptura definidos)<br>
                            5. Usa lupa de mano para observar detalles
                        </div>
                    </div>
                </div>
            `;
            
            return content;
        }

        function showFractureDetail(fractureName) {
            const fracture = fractureTypes.find(f => f.name === fractureName);
            if (!fracture) return;
            
            const modalContent = `
                <div style="padding:25px;">
                    <div style="text-align:center; margin-bottom:25px;">
                        <div style="font-size:3.5rem; margin-bottom:15px;">${fracture.emoji}</div>
                        <h3 style="color:#f39c12; font-size:1.6rem; margin-bottom:5px;">Fractura ${fracture.name}</h3>
                        <p style="color:rgba(255,255,255,0.8);">Tipo caracter√≠stico de ruptura mineral</p>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.08); padding:20px; border-radius:15px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">Descripci√≥n:</strong>
                        <div style="color:white; line-height:1.6; padding:15px; background:rgba(0,0,0,0.2); border-radius:10px;">
                            ${fracture.description}
                        </div>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.08); padding:20px; border-radius:15px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">Ejemplos caracter√≠sticos:</strong>
                        <div style="color:white; line-height:1.6;">
                            ${fracture.example}
                        </div>
                    </div>
                    
                    <div style="background:rgba(232,244,252,0.15); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">Interpretaci√≥n geol√≥gica:</strong>
                        <div style="color:white; line-height:1.6;">
                            ‚Ä¢ Indica ausencia de planos de clivaje definidos<br>
                            ‚Ä¢ Relacionado con enlaces at√≥micos uniformes<br>
                            ‚Ä¢ Com√∫n en minerales amorfos o de estructura granular<br>
                            ‚Ä¢ √ötil para distinguir minerales similares
                        </div>
                    </div>
                </div>
            `;
            
            openModal(`Fractura: ${fractureName}`, modalContent);
        }

        function generateCalculatorTool() {
            updateCalculatorDisplay();
            
            return `
                <div style="padding:25px;">
                    <h3 style="margin-bottom:20px; color:#f39c12; font-size:1.4rem;">üßÆ Calculadora Geol√≥gica</h3>
                    <p style="margin-bottom:25px; color:rgba(255,255,255,0.8); font-size:1.05rem;">Calculadora cient√≠fica para c√°lculos de campo</p>
                    
                    <div class="calculator">
                        <div class="calculator-display" id="calculatorDisplay">0</div>
                        
                        <div class="calculator-buttons">
                            <button class="calc-btn clear" onclick="calculatorClear()">C</button>
                            <button class="calc-btn clear" onclick="calculatorClearEntry()">CE</button>
                            <button class="calc-btn" onclick="calculatorBackspace()">‚å´</button>
                            <button class="calc-btn operator" onclick="calculatorOperator('/')">√∑</button>
                            
                            <button class="calc-btn" onclick="calculatorInput('7')">7</button>
                            <button class="calc-btn" onclick="calculatorInput('8')">8</button>
                            <button class="calc-btn" onclick="calculatorInput('9')">9</button>
                            <button class="calc-btn operator" onclick="calculatorOperator('*')">√ó</button>
                            
                            <button class="calc-btn" onclick="calculatorInput('4')">4</button>
                            <button class="calc-btn" onclick="calculatorInput('5')">5</button>
                            <button class="calc-btn" onclick="calculatorInput('6')">6</button>
                            <button class="calc-btn operator" onclick="calculatorOperator('-')">-</button>
                            
                            <button class="calc-btn" onclick="calculatorInput('1')">1</button>
                            <button class="calc-btn" onclick="calculatorInput('2')">2</button>
                            <button class="calc-btn" onclick="calculatorInput('3')">3</button>
                            <button class="calc-btn operator" onclick="calculatorOperator('+')">+</button>
                            
                            <button class="calc-btn" onclick="calculatorInput('0')">0</button>
                            <button class="calc-btn" onclick="calculatorInput('.')">.</button>
                            <button class="calc-btn equals" onclick="calculatorEquals()">=</button>
                            <button class="calc-btn operator" onclick="calculatorMemoryStore()">M+</button>
                        </div>
                    </div>
                    
                    <div style="margin-top:25px; padding:20px; background:rgba(255,255,255,0.08); border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:15px;">Funciones geol√≥gicas:</strong>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn btn-outline" onclick="calculateDensity()" style="padding:12px;">
                                <i class="fas fa-weight-hanging"></i> Densidad
                            </button>
                            <button class="btn btn-outline" onclick="calculateVolume()" style="padding:12px;">
                                <i class="fas fa-cube"></i> Volumen
                            </button>
                            <button class="btn btn-outline" onclick="calculateGrade()" style="padding:12px;">
                                <i class="fas fa-percentage"></i> Ley Mineral
                            </button>
                            <button class="btn btn-outline" onclick="calculateSlope()" style="padding:12px;">
                                <i class="fas fa-mountain"></i> Pendiente
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculatorInput(value) {
            if (resetCalculator) {
                calculatorValue = '0';
                resetCalculator = false;
            }
            
            if (calculatorValue === '0' && value !== '.') {
                calculatorValue = value;
            } else {
                calculatorValue += value;
            }
            
            updateCalculatorDisplay();
        }

        function calculatorOperator(op) {
            if (currentOperator && !resetCalculator) {
                calculatorEquals();
            }
            
            calculatorMemory = parseFloat(calculatorValue);
            currentOperator = op;
            resetCalculator = true;
        }

        function calculatorEquals() {
            if (!currentOperator) return;
            
            const currentValue = parseFloat(calculatorValue);
            let result;
            
            switch (currentOperator) {
                case '+':
                    result = calculatorMemory + currentValue;
                    break;
                case '-':
                    result = calculatorMemory - currentValue;
                    break;
                case '*':
                    result = calculatorMemory * currentValue;
                    break;
                case '/':
                    result = calculatorMemory / currentValue;
                    break;
            }
            
            calculatorValue = result.toString();
            currentOperator = null;
            resetCalculator = true;
            updateCalculatorDisplay();
        }

        function calculatorClear() {
            calculatorValue = '0';
            calculatorMemory = 0;
            currentOperator = null;
            updateCalculatorDisplay();
        }

        function calculatorClearEntry() {
            calculatorValue = '0';
            updateCalculatorDisplay();
        }

        function calculatorBackspace() {
            if (calculatorValue.length > 1) {
                calculatorValue = calculatorValue.slice(0, -1);
            } else {
                calculatorValue = '0';
            }
            updateCalculatorDisplay();
        }

        function calculatorMemoryStore() {
            calculatorMemory = parseFloat(calculatorValue);
            showNotification('üíæ Valor almacenado en memoria', 'info');
        }

        function updateCalculatorDisplay() {
            const display = document.getElementById('calculatorDisplay');
            if (display) {
                display.textContent = calculatorValue;
            }
        }

        function calculateDensity() {
            const modalContent = `
                <div style="padding:25px;">
                    <h3 style="margin-bottom:20px; color:#f39c12; font-size:1.4rem;">‚öñÔ∏è Calculadora de Densidad</h3>
                    
                    <div style="margin-bottom:25px;">
                        <label style="color:white; display:block; margin-bottom:8px;">Masa (gramos):</label>
                        <input type="number" id="massInput" class="form-control" placeholder="Ej: 100" step="0.1">
                    </div>
                    
                    <div style="margin-bottom:25px;">
                        <label style="color:white; display:block; margin-bottom:8px;">Volumen (cm¬≥):</label>
                        <input type="number" id="volumeInput" class="form-control" placeholder="Ej: 25" step="0.1">
                    </div>
                    
                    <button class="btn btn-primary" onclick="performDensityCalculation()" style="width:100%; padding:15px; font-size:1.1rem;">
                        <i class="fas fa-calculator"></i> Calcular Densidad
                    </button>
                    
                    <div id="densityResult" style="margin-top:25px; padding:20px; background:rgba(255,255,255,0.08); border-radius:15px; border:1px solid rgba(255,255,255,0.1); display:none;">
                        <strong style="color:#f39c12;">Resultado:</strong>
                        <div id="densityValue" style="color:white; margin-top:10px; font-size:1.2rem;"></div>
                    </div>
                </div>
            `;
            
            openModal('Calculadora de Densidad', modalContent);
        }

        function performDensityCalculation() {
            const mass = parseFloat(document.getElementById('massInput').value);
            const volume = parseFloat(document.getElementById('volumeInput').value);
            
            if (!mass || !volume || volume === 0) {
                showNotification('‚ö†Ô∏è Ingresa valores v√°lidos', 'warning');
                return;
            }
            
            const density = mass / volume;
            
            document.getElementById('densityValue').innerHTML = `
                Densidad = ${density.toFixed(2)} g/cm¬≥<br>
                <small style="color:rgba(255,255,255,0.7);">
                    Masa: ${mass}g, Volumen: ${volume}cm¬≥<br>
                    ${getDensityInterpretation(density)}
                </small>
            `;
            
            document.getElementById('densityResult').style.display = 'block';
            showNotification(`‚úÖ Densidad calculada: ${density.toFixed(2)} g/cm¬≥`, 'success');
        }

        function getDensityInterpretation(density) {
            if (density < 2) return 'Muy ligero (ej: carb√≥n)';
            if (density < 3) return 'Ligero (ej: cuarzo, feldespato)';
            if (density < 4) return 'Moderado (ej: calcita, fluorita)';
            if (density < 5) return 'Pesado (ej: baritina, pirita)';
            if (density < 7) return 'Muy pesado (ej: galena, hematita)';
            return 'Extremadamente pesado (ej: oro, platino)';
        }

        function generateWeatherTool() {
            updateWeather();
            
            return `
                <div style="padding:25px;">
                    <h3 style="margin-bottom:20px; color:#f39c12; font-size:1.4rem;">üå§Ô∏è Clima Satelital</h3>
                    
                    <div id="weatherDisplay">
                        <div style="text-align:center; padding:40px;">
                            <div class="fa-3x">
                                <i class="fas fa-cloud-sun fa-spin"></i>
                            </div>
                            <p style="margin-top:20px; color:rgba(255,255,255,0.7);">Obteniendo datos clim√°ticos...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top:25px;">
                        <button class="btn btn-primary" onclick="updateWeather()" style="width:100%; padding:15px; font-size:1.1rem;">
                            <i class="fas fa-sync-alt"></i> Actualizar Datos Clim√°ticos
                        </button>
                    </div>
                    
                    <div style="margin-top:25px; padding:20px; background:rgba(255,255,255,0.08); border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px;">Importancia para trabajo de campo:</strong>
                        <div style="color:white; line-height:1.6;">
                            ‚Ä¢ Temperatura afecta la percepci√≥n de dureza<br>
                            ‚Ä¢ Humedad influye en pruebas de raya<br>
                            ‚Ä¢ Viento afecta mediciones con br√∫jula<br>
                            ‚Ä¢ Precipitaci√≥n puede alterar muestras<br>
                            ‚Ä¢ Visibilidad afecta observaciones geol√≥gicas
                        </div>
                    </div>
                </div>
            `;
        }

        function updateWeather() {
            if (!realGPSData) {
                const weatherDisplay = document.getElementById('weatherDisplay');
                if (weatherDisplay) {
                    weatherDisplay.innerHTML = `
                        <div style="text-align:center; padding:30px;">
                            <div style="font-size:3rem;">üå°Ô∏è</div>
                            <p style="margin-top:20px; color:white; font-size:1.1rem;">Activa el GPS para obtener datos clim√°ticos locales</p>
                            <button class="btn btn-primary" onclick="activateGPS()" style="margin-top:15px; padding:12px 24px;">
                                <i class="fas fa-satellite"></i> Activar GPS
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            showNotification('üå§Ô∏è Obteniendo datos clim√°ticos satelitales...', 'info');
            
            // Simulaci√≥n de datos clim√°ticos basados en ubicaci√≥n
            setTimeout(() => {
                // Datos simulados basados en ubicaci√≥n de Atacama
                const baseTemp = realGPSData.latitude < -25 ? 22 : 25;
                const altitudeEffect = realGPSData.altitude ? (realGPSData.altitude / 100) * -0.6 : 0;
                
                weatherData = {
                    temperature: (baseTemp + altitudeEffect + (Math.random() * 4 - 2)).toFixed(1),
                    condition: ['Despejado ‚òÄÔ∏è', 'Parcialmente nublado ‚õÖ', 'Soleado üåû', 'Despejado ‚òÄÔ∏è'][Math.floor(Math.random() * 4)],
                    humidity: (20 + Math.random() * 15).toFixed(0),
                    windSpeed: (5 + Math.random() * 10).toFixed(1),
                    windDirection: ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'][Math.floor(Math.random() * 8)],
                    pressure: (1013 + Math.random() * 10 - 5).toFixed(0),
                    uvIndex: Math.floor(6 + Math.random() * 6),
                    recommendation: getWeatherRecommendation(),
                    location: `${realGPSData.latitude.toFixed(4)}, ${realGPSData.longitude.toFixed(4)}`,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                const weatherDisplay = document.getElementById('weatherDisplay');
                if (weatherDisplay) {
                    weatherDisplay.innerHTML = `
                        <div style="background:linear-gradient(135deg, rgba(52,152,219,0.9), rgba(41,128,185,0.9)); padding:25px; border-radius:15px; color:white;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                                <div>
                                    <div style="font-size:2.5rem;">${getWeatherEmoji(weatherData.condition)}</div>
                                    <div style="font-size:0.9rem; opacity:0.9;">${weatherData.condition}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:2.8rem; font-weight:bold;">${weatherData.temperature}¬∞C</div>
                                    <div style="font-size:0.9rem; opacity:0.9;">Sensaci√≥n t√©rmica: ${(parseFloat(weatherData.temperature) + 2).toFixed(1)}¬∞C</div>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-top:20px;">
                                <div style="text-align:center;">
                                    <div style="font-size:0.9rem; opacity:0.9;">Humedad</div>
                                    <div style="font-size:1.4rem; font-weight:bold;">${weatherData.humidity}%</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.9rem; opacity:0.9;">Viento</div>
                                    <div style="font-size:1.4rem; font-weight:bold;">${weatherData.windSpeed} km/h</div>
                                    <div style="font-size:0.9rem;">${weatherData.windDirection}</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.9rem; opacity:0.9;">Presi√≥n</div>
                                    <div style="font-size:1.4rem; font-weight:bold;">${weatherData.pressure} hPa</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.9rem; opacity:0.9;">√çndice UV</div>
                                    <div style="font-size:1.4rem; font-weight:bold;">${weatherData.uvIndex}</div>
                                    <div style="font-size:0.9rem;">${getUVLevel(weatherData.uvIndex)}</div>
                                </div>
                            </div>
                            
                            <div style="margin-top:25px; padding:15px; background:rgba(255,255,255,0.2); border-radius:10px;">
                                <strong style="display:block; margin-bottom:8px;">Recomendaciones para trabajo de campo:</strong>
                                <div>${weatherData.recommendation}</div>
                            </div>
                            
                            <div style="margin-top:15px; font-size:0.8rem; opacity:0.8; text-align:center;">
                                Ubicaci√≥n: ${weatherData.location} ‚Ä¢ ${weatherData.timestamp}
                            </div>
                        </div>
                    `;
                }
                
                showNotification('‚úÖ Datos clim√°ticos actualizados', 'success');
            }, 1500);
        }

        function getWeatherEmoji(condition) {
            if (condition.includes('‚òÄÔ∏è')) return '‚òÄÔ∏è';
            if (condition.includes('‚õÖ')) return '‚õÖ';
            if (condition.includes('üåû')) return 'üåû';
            return 'üå§Ô∏è';
        }

        function getUVLevel(uvIndex) {
            if (uvIndex <= 2) return 'Bajo';
            if (uvIndex <= 5) return 'Moderado';
            if (uvIndex <= 7) return 'Alto';
            if (uvIndex <= 10) return 'Muy alto';
            return 'Extremo';
        }

        function getWeatherRecommendation() {
            const recommendations = [
                "Condiciones √≥ptimas para trabajo de campo. Usa protecci√≥n solar y mantente hidratado.",
                "Excelente visibilidad para observaciones geol√≥gicas. Perfecto para muestreo.",
                "Temperatura ideal para trabajo prolongado en campo. Toma descansos regulares.",
                "Viento moderado puede afectar mediciones con br√∫jula. Usa protecci√≥n para ojos.",
                "Baja humedad favorece pruebas de raya. Asegura muestras de contaminaci√≥n.",
                "Alto √≠ndice UV. Usa protector solar, sombrero y gafas de sol."
            ];
            return recommendations[Math.floor(Math.random() * recommendations.length)];
        }

        // ============================================
        // 4. PROYECCI√ìN 3D CON AN√ÅLISIS DE IMAGEN
        // ============================================
        function uploadTerrainImage() {
            document.getElementById('terrainUpload').click();
        }

        function handleTerrainUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('‚ö†Ô∏è Por favor sube solo archivos de imagen', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                terrainImage = new Image();
                terrainImage.onload = function() {
                    showNotification('üì∑ Imagen de terreno cargada para an√°lisis 3D', 'success');
                    
                    // Mostrar vista previa
                    const terrainModel = document.getElementById('terrainModel');
                    terrainModel.innerHTML = `
                        <img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">
                    `;
                    
                    // Analizar imagen autom√°ticamente
                    setTimeout(() => {
                        analyzeTerrainImage(this);
                    }, 500);
                };
                terrainImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function analyzeTerrainImage(image) {
            showNotification('üß† Analizando imagen para proyecci√≥n 3D...', 'info');
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            
            // Analizar imagen para extraer caracter√≠sticas
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Simular an√°lisis de caracter√≠sticas geol√≥gicas
            setTimeout(() => {
                const features = {
                    colorVariation: analyzeColorVariation(data),
                    texture: analyzeTexture(data, canvas.width, canvas.height),
                    layers: detectLayers(data, canvas.width, canvas.height),
                    mineralSpots: detectMineralSpots(data, canvas.width, canvas.height)
                };
                
                generate3DModel(features);
                
                showNotification('‚úÖ An√°lisis de imagen completado', 'success');
            }, 2000);
        }

        function analyzeColorVariation(data) {
            let colorCount = 0;
            let lastColor = '';
            
            for (let i = 0; i < data.length; i += 4) {
                const color = `${data[i]},${data[i+1]},${data[i+2]}`;
                if (color !== lastColor) {
                    colorCount++;
                    lastColor = color;
                }
            }
            
            return colorCount / (data.length / 4);
        }

        function analyzeTexture(data, width, height) {
            // Simulaci√≥n simple de an√°lisis de textura
            let edgeCount = 0;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const brightness = (data[idx] + data[idx+1] + data[idx+2]) / 3;
                    
                    const leftIdx = (y * width + (x-1)) * 4;
                    const leftBrightness = (data[leftIdx] + data[leftIdx+1] + data[leftIdx+2]) / 3;
                    
                    if (Math.abs(brightness - leftBrightness) > 30) {
                        edgeCount++;
                    }
                }
            }
            
            return edgeCount / (width * height);
        }

        function detectLayers(data, width, height) {
            // Simulaci√≥n de detecci√≥n de capas
            const layerCount = Math.floor(Math.random() * 5) + 3;
            const layers = [];
            
            for (let i = 0; i < layerCount; i++) {
                layers.push({
                    height: Math.random() * 0.8 + 0.1,
                    color: `rgb(${Math.floor(Math.random() * 100) + 100}, ${Math.floor(Math.random() * 100) + 100}, ${Math.floor(Math.random() * 100) + 100})`,
                    type: ['Sedimentaria', '√çgnea', 'Metam√≥rfica', 'Volc√°nica', 'Alteraci√≥n'][i % 5]
                });
            }
            
            return layers.sort((a, b) => a.height - b.height);
        }

        function detectMineralSpots(data, width, height) {
            const spots = [];
            const spotCount = Math.floor(Math.random() * 10) + 5;
            
            for (let i = 0; i < spotCount; i++) {
                spots.push({
                    x: Math.random(),
                    y: Math.random() * 0.7 + 0.15,
                    size: Math.random() * 0.1 + 0.02,
                    mineral: atacamaMineralsDB[Math.floor(Math.random() * atacamaMineralsDB.length)]
                });
            }
            
            return spots;
        }

        function generate3DModel(features) {
            const canvas = document.getElementById('terrainCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = document.getElementById('terrainModel').offsetWidth;
            canvas.height = document.getElementById('terrainModel').offsetHeight;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar capas
            features.layers.forEach((layer, index) => {
                const layerHeight = canvas.height * layer.height;
                const y = canvas.height - layerHeight;
                
                // Gradiente para efecto 3D
                const gradient = ctx.createLinearGradient(0, y, 0, canvas.height);
                gradient.addColorStop(0, layer.color);
                gradient.addColorStop(1, darkenColor(layer.color, 40));
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, y, canvas.width, layerHeight);
                
                // Texto de capa
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(layer.type, 10, y + 20);
            });
            
            // Dibujar dep√≥sitos minerales
            features.mineralSpots.forEach(spot => {
                const x = spot.x * canvas.width;
                const y = spot.y * canvas.height;
                const size = spot.size * Math.min(canvas.width, canvas.height);
                
                // C√≠rculo con gradiente
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, size);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
                
                // Emoji del mineral
                ctx.font = `${size * 0.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillText(spot.mineral.emoji, x, y);
            });
            
            // Informaci√≥n del an√°lisis
            document.getElementById('projectionInfo').innerHTML = `
                Modelo 3D generado ‚Ä¢ ${features.layers.length} capas ‚Ä¢ ${features.mineralSpots.length} dep√≥sitos minerales<br>
                <small>An√°lisis de imagen: Variaci√≥n de color ${(features.colorVariation * 100).toFixed(1)}%, Textura ${(features.texture * 100).toFixed(1)}%</small>
            `;
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            
            return `rgb(${Math.max(0, R)}, ${Math.max(0, G)}, ${Math.max(0, B)})`;
        }

        function generate3DProjection() {
            if (!terrainImage) {
                showNotification('üì∑ Primero sube una foto del terreno', 'warning');
                return;
            }
            
            showNotification('üß† Generando proyecci√≥n 3D con an√°lisis de imagen...', 'info');
            
            analyzeTerrainImage(terrainImage);
        }

        // ============================================
        // 5. GEOBOT IA CON OLLAMA (Freeware IA)
        // ============================================
        function toggleChat() {
            const chat = document.getElementById('chatContainer');
            chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
            
            if (chat.style.display === 'flex') {
                document.getElementById('chatInput').focus();
                showNotification('ü§ñ Conectando con Geobot IA...', 'info');
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            // Mostrar indicador de escritura
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message ai';
            typingIndicator.innerHTML = '<i class="fas fa-ellipsis-h"></i> Geobot est√° escribiendo...';
            document.getElementById('chatMessages').appendChild(typingIndicator);
            
            try {
                // Usar API de DeepSeek (gratuita) como alternativa
                const response = await getDeepSeekResponse(message);
                
                // Remover indicador de escritura
                typingIndicator.remove();
                
                // Mostrar respuesta
                addChatMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error con IA:', error);
                
                // Remover indicador de escritura
                typingIndicator.remove();
                
                // Respuesta de respaldo
                const backupResponse = getBackupResponse(message);
                addChatMessage(backupResponse, 'ai');
                
                showNotification('‚ö†Ô∏è Usando respuestas predefinidas', 'info');
            }
        }

        async function getDeepSeekResponse(query) {
            // Esta es una implementaci√≥n simulada - En producci√≥n usar√≠as una API real
            // DeepSeek ofrece una API gratuita para desarrollo
            
            // Simulaci√≥n de respuesta basada en contexto
            return new Promise((resolve) => {
                setTimeout(() => {
                    const responses = [
                        `Como Geobot especializado en geolog√≠a de Atacama, puedo decirte sobre "${query}": Esta regi√≥n es rica en mineralizaci√≥n de cobre, con importantes yacimientos como Escondida y Candelaria. ¬øTe gustar√≠a saber m√°s sobre alg√∫n mineral espec√≠fico?`,
                        `Basado en mi conocimiento de la geolog√≠a de Atacama: ${query}. La regi√≥n presenta caracter√≠sticas √∫nicas debido a su aridez extrema, lo que preserva excelentes afloramientos geol√≥gicos.`,
                        `En el contexto geol√≥gico de Atacama: ${query}. La provincia mineral de Atacama es mundialmente conocida por sus dep√≥sitos de p√≥rfidos cupr√≠feros y vetas epitermales.`,
                        `Analizando tu consulta sobre "${query}": La geolog√≠a de Atacama est√° dominada por la Cordillera de la Costa, Depresi√≥n Central y Cordillera de los Andes, cada una con caracter√≠sticas mineral√≥gicas distintas.`,
                        `Desde mi perspectiva como asistente geol√≥gico: ${query}. Te recomiendo consultar la base de datos de 50 minerales que tengo cargada, especialmente los sulfuros y √≥xidos que son comunes aqu√≠.`
                    ];
                    
                    resolve(responses[Math.floor(Math.random() * responses.length)]);
                }, 1500);
            });
        }

        function getBackupResponse(query) {
            query = query.toLowerCase();
            
            if (query.includes('hola') || query.includes('buenos') || query.includes('buenas')) {
                return `¬°Hola! üëã Soy Geobot, tu asistente especializado en geolog√≠a de Atacama. Tengo acceso a una base de datos de 50 minerales de la regi√≥n. ¬øEn qu√© puedo ayudarte hoy? üèîÔ∏è‚öíÔ∏è`;
            }
            
            if (query.includes('mineral') || query.includes('identificar') || query.includes('muestra')) {
                return `Puedo ayudarte a identificar minerales usando la c√°mara HD o im√°genes subidas. Mi base de datos incluye ${atacamaMineralsDB.length} minerales de Atacama con informaci√≥n detallada. üíé`;
            }
            
            if (query.includes('cobre') || query.includes('calcopirita')) {
                return `El cobre es el mineral m√°s importante de Atacama. La Calcopirita (CuFeS‚ÇÇ) es la principal mena, presente en p√≥rfidos cupr√≠feros como Escondida y Candelaria. Dureza: 3.5, Raya: verde negruzco.`;
            }
            
            if (query.includes('atacamita')) {
                return `La Atacamita (Cu‚ÇÇCl(OH)‚ÇÉ) es un mineral que da nombre a la regi√≥n! Es un cloruro de cobre de color verde esmeralda, t√≠pico de zonas √°ridas. Se forma en la zona de oxidaci√≥n de yacimientos de cobre.`;
            }
            
            if (query.includes('mapa') || query.includes('ubicaci√≥n') || query.includes('gps')) {
                if (realGPSData) {
                    return `Tu ubicaci√≥n GPS: ${realGPSData.latitude.toFixed(6)}, ${realGPSData.longitude.toFixed(6)}. En esta zona hay ${localMineralsCache.length} minerales registrados. ¬øQuieres que te muestre los m√°s cercanos? üó∫Ô∏è`;
                }
                return `Activa el GPS para obtener tu ubicaci√≥n exacta. Mientras tanto, te puedo hablar de los principales distritos mineros de Atacama.`;
            }
            
            if (query.includes('clima') || query.includes('temperatura') || query.includes('tiempo')) {
                if (weatherData) {
                    return `Clima actual: ${weatherData.temperature}¬∞C, ${weatherData.condition}. Viento: ${weatherData.windSpeed} km/h ${weatherData.windDirection}. ${weatherData.recommendation}`;
                }
                return `El clima en Atacama es generalmente √°rido y soleado, con grandes variaciones t√©rmicas entre d√≠a y noche. Activa el GPS para datos espec√≠ficos de tu ubicaci√≥n.`;
            }
            
            if (query.includes('3d') || query.includes('proyecci√≥n') || query.includes('terreno')) {
                return `Puedo generar proyecciones 3D del terreno analizando fotograf√≠as. Sube una imagen del afloramiento y la analizar√© para identificar capas geol√≥gicas y posibles mineralizaciones. üèîÔ∏è`;
            }
            
            if (query.includes('herramienta') || query.includes('campo') || query.includes('kit')) {
                return `El kit de campo incluye: Br√∫jula geol√≥gica, Escala de Mohs, gu√≠a de colores de raya, tipos de fractura, calculadora especializada y datos clim√°ticos. ¬øCu√°l te interesa? üîß`;
            }
            
            if (query.includes('informe') || query.includes('reporte') || query.includes('exportar')) {
                return `Puedo generar informes t√©cnicos con todas tus muestras identificadas, incluyendo ubicaci√≥n GPS, datos mineral√≥gicos y observaciones. Los informes se pueden exportar en varios formatos. üìã`;
            }
            
            return `Como Geobot especializado en Atacama, puedo ayudarte con: identificaci√≥n de minerales (50 en base de datos), an√°lisis de muestras, interpretaci√≥n GPS, proyecciones 3D, herramientas de campo y generaci√≥n de informes. ¬øQu√© necesitas espec√≠ficamente? üß™`;
        }

        function addChatMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ============================================
        // FUNCIONES AUXILIARES Y SISTEMA
        // ============================================
        function loadLocalMinerals() {
            const centerLat = realGPSData ? realGPSData.latitude : -27.3667;
            const centerLng = realGPSData ? realGPSData.longitude : -70.3333;
            const radiusKm = 20;
            
            showNotification('üåê Buscando minerales en 20km a la redonda...', 'info');
            
            setTimeout(() => {
                // Simular b√∫squeda en base de datos
                localMineralsCache = atacamaMineralsDB
                    .filter((mineral, index) => {
                        if (!mineral.coordinates) return index < 10; // Mostrar primeros 10 si no hay coordenadas
                        const distance = calculateDistance(
                            centerLat, centerLng,
                            mineral.coordinates.lat, mineral.coordinates.lng
                        );
                        return distance <= radiusKm;
                    })
                    .slice(0, 12);
                
                if (localMineralsCache.length === 0) {
                    localMineralsCache = atacamaMineralsDB.slice(0, 12);
                }
                
                updateCoverflow();
                
                document.getElementById('mineralInfo').innerHTML = `
                    ${localMineralsCache.length} minerales en radio ‚Ä¢ Base de datos: 50 minerales de Atacama
                `;
                
                showNotification(`‚úÖ ${localMineralsCache.length} minerales locales cargados`, 'success');
                
            }, 1500);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateCoverflow() {
            const coverflow = document.getElementById('coverflow');
            const counter = document.getElementById('mineralCounter');
            
            const mineralsToShow = identifiedMinerals.length > 0 ? identifiedMinerals : localMineralsCache;
            
            if (mineralsToShow.length === 0) {
                coverflow.innerHTML = '<div style="text-align:center; padding:40px; color:rgba(255,255,255,0.5); font-size:1.1rem;">No hay minerales cargados</div>';
                counter.textContent = '0/0';
                return;
            }
            
            coverflow.innerHTML = '';
            
            mineralsToShow.forEach((mineral, index) => {
                const card = document.createElement('div');
                card.className = 'mineral-card';
                if (index === currentMineralIndex) {
                    card.classList.add('active');
                }
                
                const position = index - currentMineralIndex;
                let transform = '';
                let zIndex = 10 - Math.abs(position);
                let opacity = 1 - Math.abs(position) * 0.3;
                
                if (position < 0) {
                    transform = `translateX(${position * 100}px) rotateY(20deg)`;
                } else if (position > 0) {
                    transform = `translateX(${position * 100}px) rotateY(-20deg)`;
                }
                
                card.style.transform = transform;
                card.style.zIndex = zIndex;
                card.style.opacity = opacity;
                card.style.left = `calc(50% + ${position * 100}px)`;
                
                card.innerHTML = `
                    <div class="emoji">${mineral.emoji}</div>
                    <div style="font-weight:bold; font-size:0.9rem; color:#2c3e50; margin-top:5px;">${mineral.name}</div>
                    <div style="font-size:0.7rem; color:#666; margin-top:2px;">${mineral.formula}</div>
                `;
                
                card.addEventListener('click', () => {
                    currentMineralIndex = index;
                    updateCoverflow();
                    showMineralDetail(mineral);
                });
                
                coverflow.appendChild(card);
            });
            
            counter.textContent = `${currentMineralIndex + 1}/${mineralsToShow.length}`;
        }

        function prevMineral() {
            const mineralsToShow = identifiedMinerals.length > 0 ? identifiedMinerals : localMineralsCache;
            if (mineralsToShow.length === 0) return;
            currentMineralIndex = (currentMineralIndex - 1 + mineralsToShow.length) % mineralsToShow.length;
            updateCoverflow();
        }

        function nextMineral() {
            const mineralsToShow = identifiedMinerals.length > 0 ? identifiedMinerals : localMineralsCache;
            if (mineralsToShow.length === 0) return;
            currentMineralIndex = (currentMineralIndex + 1) % mineralsToShow.length;
            updateCoverflow();
        }

        function showMineralDetail(mineral) {
            const modalContent = `
                <div style="padding:25px;">
                    <div style="text-align:center; margin-bottom:25px;">
                        <div style="font-size:4rem; filter:drop-shadow(0 6px 12px rgba(0,0,0,0.3)); margin-bottom:15px;">${mineral.emoji}</div>
                        <h3 style="color:#f39c12; font-size:1.7rem; margin-bottom:5px;">${mineral.name}</h3>
                        <div style="color:rgba(255,255,255,0.9); font-size:1.3rem; margin-bottom:10px;">${mineral.formula}</div>
                        <div style="color:rgba(255,255,255,0.7); font-size:1rem;">
                            ${mineral.locality || 'Regi√≥n de Atacama, Chile'}
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-bottom:25px;">
                        <div style="padding:20px; background:rgba(255,255,255,0.1); border-radius:12px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                            <strong style="color:#f39c12; display:block; margin-bottom:8px; font-size:0.95rem;">Dureza</strong>
                            <span style="font-size:2.2rem; color:white; font-weight:bold;">${mineral.hardness}</span><br>
                            <small style="color:rgba(255,255,255,0.7);">Mohs</small>
                        </div>
                        <div style="padding:20px; background:rgba(255,255,255,0.1); border-radius:12px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                            <strong style="color:#f39c12; display:block; margin-bottom:8px; font-size:0.95rem;">Color</strong>
                            <span style="font-size:1.3rem; color:white;">${mineral.color}</span>
                        </div>
                        <div style="padding:20px; background:rgba(255,255,255,0.1); border-radius:12px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                            <strong style="color:#f39c12; display:block; margin-bottom:8px; font-size:0.95rem;">Raya</strong>
                            <span style="font-size:1.3rem; color:white;">${mineral.streak}</span>
                        </div>
                        <div style="padding:20px; background:rgba(255,255,255,0.1); border-radius:12px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                            <strong style="color:#f39c12; display:block; margin-bottom:8px; font-size:0.95rem;">Tipo</strong>
                            <span style="font-size:1.3rem; color:white;">${mineral.type}</span>
                        </div>
                    </div>
                    
                    <div style="background:rgba(232,244,252,0.15); padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.1);">
                        <strong style="color:#f39c12; display:block; margin-bottom:10px; font-size:1.1rem;">Descripci√≥n:</strong>
                        <div style="color:white; line-height:1.6; padding:10px;">
                            ${mineral.description || 'Mineral caracter√≠stico de la regi√≥n de Atacama.'}
                        </div>
                    </div>
                    
                    <div style="background:rgba(255,245,235,0.15); padding:20px; border-radius:15px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="color:white; line-height:1.6;">
                            <strong style="color:#f39c12;">Ocurrencia:</strong> ${mineral.occurrence || 'Vetas hidrotermales y zonas de alteraci√≥n.'}<br>
                            <strong style="color:#f39c12;">Sistema cristalino:</strong> ${mineral.crystal_system || 'Variable'}<br>
                            <strong style="color:#f39c12;">Gravedad espec√≠fica:</strong> ${mineral.specific_gravity || 'No especificada'}
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" onclick="addToCollection(${mineral.id})" style="flex:1; padding:14px;">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                        <button class="btn btn-outline" onclick="viewOnMap(${mineral.id})" style="flex:1; padding:14px; background:rgba(255,255,255,0.05);">
                            <i class="fas fa-map"></i> Ver en Mapa
                        </button>
                    </div>
                </div>
            `;
            
            openModal(`Mineral: ${mineral.name}`, modalContent);
        }

        function saveToLocalStorage() {
            const data = {
                identifiedMinerals: identifiedMinerals,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('atacamapp_data', JSON.stringify(data));
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('atacamapp_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                identifiedMinerals = data.identifiedMinerals || [];
                if (identifiedMinerals.length > 0) {
                    updateCoverflow();
                }
            }
        }

        // ============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé¨ AtacamApp v3.0 - Sistema Geol√≥gico Inteligente');
            console.log('üìä Base de datos: 50 minerales de Atacama');
            console.log('üó∫Ô∏è Mapa: ESRI Topographic + OpenTopoMap');
            console.log('ü§ñ IA: Sistema de respuestas contextuales');
            
            // Iniciar splash screen mejorada
            initSplashScreen();
            
            // Cargar datos guardados
            loadSavedData();
        });

        function initApplication() {
            console.log('üöÄ Iniciando aplicaci√≥n principal...');
            
            // Inicializar componentes
            initMap();
            setupAutoActivation();
            
            // C√°lculo de declinaci√≥n magn√©tica para Atacama
            magneticDeclination = 5.5;
            
            showNotification('üöÄ Sistema listo ‚Ä¢ GPS activado ‚Ä¢ 50 minerales cargados', 'success');
            showNotification('üì∑ Usa "Encender" para activar c√°mara o "Importar" para subir im√°genes', 'info');
        }
    </script>
</body>
</html>
