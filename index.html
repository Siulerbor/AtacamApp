<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AtacamApp - Geolog√≠a 3D & IA</title>
    
    <!-- Meta Tags HTML5 -->
    <meta name="description" content="Aplicaci√≥n de geolog√≠a 3D con IA especializada para an√°lisis geol√≥gico en campo">
    <meta name="keywords" content="geolog√≠a, 3D, IA, mapeo, minerales, rocas, exploraci√≥n, Atacama, Antofagasta">
    <meta name="author" content="AtacamApp Team">
    <meta name="theme-color" content="#8B4513">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèúÔ∏è</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
    
    <style>
        /* Variables CSS - Tema Desierto Mejorado */
        :root {
            --primary: #D4A017; /* Oro desierto */
            --primary-dark: #B8860B;
            --primary-light: #FFD700;
            --secondary: #8B4513; /* Tierra desierto */
            --accent: #CD853F; /* Arena */
            --danger: #DC143C;
            --success: #228B22;
            --warning: #FF8C00;
            --info: #4682B4;
            --dark: #2F4F4F;
            --light: rgba(255, 248, 220, 0.95);
            --glass-bg: rgba(255, 248, 220, 0.2);
            --glass-border: rgba(210, 180, 140, 0.3);
            --glass-shadow: 0 8px 32px rgba(139, 69, 19, 0.15);
            --text-primary: #2F4F4F;
            --text-secondary: rgba(47, 79, 79, 0.8);
            --border-radius: 16px;
            --blur: blur(25px);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset y Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #8B7355 0%, #D2B48C 100%);
            color: var(--text-primary);
            line-height: 1.4;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            padding-bottom: 15px;
        }

        /* Fondo principal DESIERTO DE ATACAMA */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(139, 115, 85, 0.8), rgba(210, 180, 140, 0.8)),
                url('https://images.unsplash.com/photo-1527482797697-8795b05a13fe?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
        }

        /* Efecto de calor del desierto */
        .heat-wave {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(255, 255, 255, 0.15) 50%,
                transparent 100%
            );
            animation: heatWave 6s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes heatWave {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.4; }
        }

        /* Splash Screen */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.95), rgba(139, 69, 19, 0.95));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: var(--text-primary);
            transition: opacity 0.5s ease;
            backdrop-filter: blur(15px);
        }

        .splash-content {
            text-align: center;
            animation: fadeIn 1s ease;
            padding: 40px 30px;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border-radius: 25px;
            border: 2px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            max-width: 300px;
            width: 90%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .splash-icon {
            font-size: 4.5rem;
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.05); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(47, 79, 79, 0.2);
            margin: 2rem auto 1.5rem;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Main App Container */
        #appContainer {
            display: none;
            min-height: 100vh;
        }

        /* Header Compacto Desierto */
        .app-header {
            background: linear-gradient(rgba(255, 248, 220, 0.95), rgba(255, 248, 220, 0.98));
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.15);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Logo Desierto */
        .app-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .brand-text h1 {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -0.5px;
            text-shadow: 1px 1px 2px rgba(255, 248, 220, 0.3);
        }

        .brand-text small {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Status Bar - Dr. GeoBot */
        .status-bar {
            display: flex;
            justify-content: flex-end;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.1), rgba(139, 69, 19, 0.1));
            border-radius: 12px;
            border: 2px solid var(--accent);
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 69, 19, 0.2);
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(139, 69, 19, 0.2));
        }

        .status-item.active {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.3), rgba(50, 205, 50, 0.3));
            border-color: var(--success);
            box-shadow: 0 4px 16px rgba(34, 139, 34, 0.2);
        }

        .status-icon {
            font-size: 1.4rem;
        }

        .status-value {
            font-weight: 800;
            color: var(--text-primary);
        }

        /* GPS Data Bar */
        .gps-data-bar {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.25));
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 15px;
            margin: 15px;
            border: 1.5px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
            font-size: 0.8rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .gps-data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .gps-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .gps-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-shadow: 0 1px 2px rgba(255, 248, 220, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Glass Cards */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1.5px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.05), transparent);
            pointer-events: none;
        }

        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(139, 69, 19, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--glass-border);
        }

        .card-header i {
            font-size: 1.6rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
            text-shadow: 0 1px 2px rgba(255, 248, 220, 0.3);
        }

        /* Map Containers */
        .map-container {
            width: 100%;
            height: 280px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid var(--glass-border);
            position: relative;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.15);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-control-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.15);
        }

        .map-control-btn:hover {
            background: rgba(212, 160, 23, 0.25);
            transform: scale(1.1);
            box-shadow: 0 6px 18px rgba(139, 69, 19, 0.25);
        }

        .map-control-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
            color: white;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .quick-actions .glass-btn {
            flex: 1;
            min-width: 140px;
            padding: 16px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        /* Glass Buttons */
        .glass-btn {
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: var(--transition);
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .glass-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 160, 23, 0.3), transparent);
            transition: 0.5s;
        }

        .glass-btn:hover::before {
            left: 100%;
        }

        .glass-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.2);
        }

        .glass-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px rgba(212, 160, 23, 0.3);
        }

        .glass-btn.success {
            background: linear-gradient(135deg, var(--success), #1E7A1E);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(34, 139, 34, 0.3);
        }

        .glass-btn.warning {
            background: linear-gradient(135deg, var(--warning), #E67E22);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
        }

        .glass-btn.danger {
            background: linear-gradient(135deg, var(--danger), #B22222);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
        }

        .glass-btn.info {
            background: linear-gradient(135deg, var(--info), #4169E1);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(70, 130, 180, 0.3);
        }

        /* Camera Container */
        .camera-container {
            width: 100%;
            height: 240px;
            background: rgba(47, 79, 79, 0.7);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.15);
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Chat Interface */
        .chat-container {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            height: 320px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1.5px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            max-width: 85%;
            padding: 15px 18px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chat-message.ai {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.25), rgba(100, 149, 237, 0.25));
            align-self: flex-start;
            border: 2px solid rgba(70, 130, 180, 0.4);
            margin-left: 35px;
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.15);
        }

        .chat-message.ai::before {
            content: "üë®‚Äçüî¨";
            position: absolute;
            left: -35px;
            font-size: 1.5rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-message.user {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.25), rgba(184, 134, 11, 0.25));
            align-self: flex-end;
            border: 2px solid rgba(212, 160, 23, 0.4);
            margin-right: 35px;
            box-shadow: 0 4px 12px rgba(212, 160, 23, 0.15);
        }

        .chat-message.user::before {
            content: "üßë‚Äçüíº";
            position: absolute;
            right: -35px;
            font-size: 1.5rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .glass-input {
            flex: 1;
            padding: 18px 20px;
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            transition: var(--transition);
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-weight: 500;
        }

        .glass-input:focus {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.3), rgba(210, 180, 140, 0.25));
            box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.15);
        }

        .glass-input::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Geology Data */
        .geology-data {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(139, 69, 19, 0.15));
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--glass-border);
            border-left: 6px solid var(--primary);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.15);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1.5px solid var(--glass-border);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        /* Visualization Charts */
        .visualization-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            height: 280px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-canvas {
            flex: 1;
            width: 100%;
            position: relative;
        }

        /* Layers Panel */
        .layers-panel {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--glass-border);
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1.5px solid var(--glass-border);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(30px);
            padding: 16px 20px;
            border-radius: 14px;
            box-shadow: 0 15px 40px rgba(139, 69, 19, 0.25);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            border: 2px solid var(--glass-border);
            border-left: 6px solid var(--success);
            font-size: 0.9rem;
            font-weight: 500;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error { border-left-color: var(--danger); }
        .notification.warning { border-left-color: var(--warning); }
        .notification.info { border-left-color: var(--info); }

        /* Map Legend */
        .map-legend {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(20px);
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            font-size: 0.8rem;
            border: 2px solid var(--glass-border);
            max-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* Custom Checkbox */
        .switch {
            position: relative;
            display: inline-block;
            width: 55px;
            height: 28px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            transition: .4s;
            border-radius: 28px;
            border: 2px solid var(--glass-border);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 2px;
            background: linear-gradient(135deg, white, #f5f5f5);
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.3);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(27px);
            background: white;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 25px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .empty-state span:first-child {
            font-size: 3rem;
            margin-bottom: 20px;
            display: block;
            opacity: 0.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.1));
            border-radius: 10px;
            margin: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            border: 2px solid rgba(255, 248, 220, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 3px solid rgba(212, 160, 23, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toolbar de botones en mapa */
        .map-toolbar {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .toolbar-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(15px);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.15);
        }

        .toolbar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(139, 69, 19, 0.25);
        }

        .toolbar-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
            color: white;
        }

        /* Menu de botones en mapa */
        .map-menu {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Route Info */
        .route-info {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(50, 205, 50, 0.2));
            backdrop-filter: blur(15px);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--success);
            display: none;
        }

        /* Tabs para visualizaci√≥n */
        .tabs {
            display: flex;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--glass-border);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(212, 160, 23, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            html { font-size: 13px; }
            
            .main-content { padding: 12px; }
            
            .gps-data-bar {
                margin: 12px;
                padding: 12px;
            }
            
            .gps-data-item {
                min-width: 100px;
            }
            
            .map-container { height: 250px; }
            
            .camera-container { height: 200px; }
            
            .chat-container { height: 280px; }
            
            .visualization-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .quick-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .quick-actions .glass-btn {
                min-width: 100%;
            }
        }

        @media (min-width: 768px) {
            .main-content {
                max-width: 800px;
                margin: 0 auto;
            }
        }

        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Bot√≥n flotante de acci√≥n principal */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(212, 160, 23, 0.4);
            transition: var(--transition);
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 40px rgba(212, 160, 23, 0.6);
        }

        /* Badge de estado */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
        }

        .badge.success {
            background: linear-gradient(135deg, var(--success), #1E7A1E);
            color: white;
        }

        .badge.warning {
            background: linear-gradient(135deg, var(--warning), #E67E22);
            color: white;
        }

        .badge.info {
            background: linear-gradient(135deg, var(--info), #4169E1);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Efecto de calor del desierto -->
    <div class="heat-wave"></div>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="splash-content">
            <div class="splash-icon">üèúÔ∏è</div>
            <h1 style="font-size: 2rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AtacamApp</h1>
            <p style="margin-bottom: 1rem; opacity: 0.9; font-size: 1rem; color: var(--text-primary); font-weight: 500;">Geolog√≠a 3D & Proyecci√≥n Estructural</p>
            <p style="margin-bottom: 0.5rem; opacity: 0.8; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Conectando con DeepSeek AI...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="loadingText" style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Inicializando sistema...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <!-- Header Compacto -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-brand">
                    <div class="app-logo">üèúÔ∏è</div>
                    <div class="brand-text">
                        <h1>AtacamApp</h1>
                        <small>Geolog√≠a 3D & IA</small>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-item" id="statusIcon" onclick="toggleDrGeoBot()">
                        <span class="status-icon">ü§ñ</span>
                        <span class="status-value" id="aiStatusValue">OFF</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- GPS Data Bar Compacta -->
        <div class="gps-data-bar" id="gpsDataBar">
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Latitud</div>
                <div class="gps-value" id="latitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Longitud</div>
                <div class="gps-value" id="longitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>‚õ∞Ô∏è</span>Altitud</div>
                <div class="gps-value" id="altitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üèôÔ∏è</span>Ciudad</div>
                <div class="gps-value" id="cityValue">--</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page 1: Dashboard -->
            <div class="page active" id="pageDashboard">
                <!-- Mapa 2D con botones -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üó∫Ô∏è</span>
                        <h2 class="card-title">Mapa Geol√≥gico Topogr√°fico</h2>
                    </div>
                    
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <button class="map-control-btn" id="mapTopoBtn" title="Vista topogr√°fica">
                                <span>‚õ∞Ô∏è</span>
                            </button>
                            <button class="map-control-btn" id="mapSatelliteBtn" title="Vista sat√©lite">
                                <span>üõ∞Ô∏è</span>
                            </button>
                            <button class="map-control-btn" id="mapGeologyBtn" title="Capa geol√≥gica">
                                <span>ü™®</span>
                            </button>
                        </div>
                        
                        <!-- Menu de herramientas del mapa -->
                        <div class="map-menu">
                            <button class="toolbar-btn" id="addPointBtn" title="Agregar punto">
                                <span>üìç</span>
                            </button>
                            <button class="toolbar-btn" id="drawRouteBtn" title="Marcar ruta">
                                <span>üîÑ</span>
                            </button>
                            <button class="toolbar-btn" id="downloadRouteBtn" title="Descargar ruta">
                                <span>üíæ</span>
                            </button>
                        </div>
                        
                        <!-- Informaci√≥n de ruta -->
                        <div id="routeInfo" class="route-info">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>üìè Ruta trazada:</strong>
                                    <div id="routeLength">0.0 km</div>
                                    <div id="routePoints">0 puntos</div>
                                </div>
                                <button class="glass-btn danger" id="clearRouteBtn" style="padding: 8px 12px; font-size: 0.8rem;">
                                    <span>üóëÔ∏è</span> Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div class="map-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #D4A017, #8B4513);"></div>
                                <span>Geolog√≠a ü™®</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #DC143C, #8B0000);"></div>
                                <span>Fallas ‚ö°</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #228B22, #32CD32);"></div>
                                <span>Ruta üîÑ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="updateLocationBtn">
                            <span>üìç</span>
                            Actualizar GPS
                        </button>
                        <button class="glass-btn warning" id="addSampleBtn">
                            <span>üß™</span>
                            Agregar Muestra
                        </button>
                        <button class="glass-btn danger" id="clearMapBtn">
                            <span>üóëÔ∏è</span>
                            Limpiar Todo
                        </button>
                    </div>
                </div>

                <!-- Geology Info Controlada por DeepSeek -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Datos Geol√≥gicos 
                            <span class="badge info" id="dataAccuracy">DeepSeek IA</span>
                        </h2>
                    </div>
                    
                    <div id="geologyInfo" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Activa el GPS para ver datos geol√≥gicos precisos analizados por DeepSeek IA</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Camera & Analysis -->
            <div class="page" id="pageCamera">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üì∏</span>
                        <h2 class="card-title">An√°lisis Fotogeol√≥gico</h2>
                    </div>
                    
                    <div class="camera-container">
                        <video id="cameraFeed" autoplay playsinline></video>
                        <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(47, 79, 79, 0.8); backdrop-filter: blur(15px); padding: 8px 15px; border-radius: 12px; border: 2px solid rgba(255, 248, 220, 0.3);">
                            <span id="cameraStatusText" style="color: white; font-size: 0.85rem; font-weight: 600;">
                                <span>üî¥</span> C√°mara inactiva
                            </span>
                        </div>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="glass-btn primary" id="startCameraBtn">
                            <span>üé•</span>
                            Activar C√°mara
                        </button>
                        <button class="glass-btn warning" id="captureBtn" disabled>
                            <span>üì∏</span>
                            Capturar
                        </button>
                        <button class="glass-btn success" id="analyzeBtn" disabled>
                            <span>ü§ñ</span>
                            Analizar IA
                        </button>
                        <button class="glass-btn danger" id="stopCameraBtn" disabled>
                            <span>‚èπÔ∏è</span>
                            Detener
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Resultados IA</h2>
                    </div>
                    
                    <div id="analysisResults" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Capture una imagen para an√°lisis con DeepSeek IA</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: 2D Visualizations -->
            <div class="page" id="pageVisualizations">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üìà</span>
                        <h2 class="card-title">Visualizaci√≥n Geol√≥gica 2D</h2>
                    </div>
                    
                    <!-- Tabs para diferentes gr√°ficos -->
                    <div class="tabs">
                        <div class="tab active" data-chart="minerals">üíé Minerales</div>
                        <div class="tab" data-chart="structures">‚ö° Estructuras</div>
                        <div class="tab" data-chart="elevation">‚õ∞Ô∏è Elevaci√≥n</div>
                        <div class="tab" data-chart="geochemistry">üß™ Geoqu√≠mica</div>
                    </div>
                    
                    <div class="visualization-container">
                        <!-- Gr√°fico 1: Distribuci√≥n de Minerales -->
                        <div class="chart-container" id="chart1">
                            <div class="chart-title">
                                <span>üíé</span>
                                Distribuci√≥n Mineral√≥gica
                            </div>
                            <div class="chart-canvas">
                                <canvas id="mineralsChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico 2: Orientaci√≥n Estructural -->
                        <div class="chart-container" id="chart2">
                            <div class="chart-title">
                                <span>‚ö°</span>
                                Orientaci√≥n de Fallas
                            </div>
                            <div class="chart-canvas">
                                <canvas id="structuresChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico 3: Perfil Topogr√°fico -->
                        <div class="chart-container" id="chart3">
                            <div class="chart-title">
                                <span>‚õ∞Ô∏è</span>
                                Perfil Topogr√°fico
                            </div>
                            <div class="chart-canvas">
                                <canvas id="elevationChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico 4: Diagrama Geoqu√≠mico -->
                        <div class="chart-container" id="chart4">
                            <div class="chart-title">
                                <span>üß™</span>
                                An√°lisis Geoqu√≠mico
                            </div>
                            <div class="chart-canvas">
                                <canvas id="geochemistryChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="layers-panel">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); font-weight: 800; display: flex; align-items: center; gap: 10px;">
                            <span>üóÇÔ∏è</span> Capas Geol√≥gicas 2D
                        </h3>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.3rem;">ü™®</span>
                                <span style="font-weight: 600;">Mapa Litol√≥gico</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerLithology" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.3rem;">‚ö°</span>
                                <span style="font-weight: 600;">Sistema de Fallas</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerFaults" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.3rem;">üíé</span>
                                <span style="font-weight: 600;">Yacimientos Minerales</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerDeposits" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.3rem;">üìä</span>
                                <span style="font-weight: 600;">Contornos Topogr√°ficos</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerContours">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="generateLayers">
                            <span>üîÑ</span>
                            Generar Capas
                        </button>
                        <button class="glass-btn success" id="exportLayers">
                            <span>üì•</span>
                            Exportar PNG
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìê</span>
                        <h2 class="card-title">Par√°metros Estructurales</h2>
                    </div>
                    
                    <div id="structuralParams" class="geology-data">
                        <div class="empty-state">
                            <span>üìè</span>
                            <p>Genera capas para ver par√°metros estructurales</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: AI Assistant -->
            <div class="page" id="pageAI">
                <div class="glass-card">
                    <div class="card-header">
                        <span>ü§ñ</span>
                        <h2 class="card-title">Dr. GeoBot - DeepSeek AI</h2>
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message ai">
                            <strong>Dr. GeoBot:</strong> ¬°Hola! Soy tu asistente IA especializado en geolog√≠a del Desierto de Atacama, conectado directamente a DeepSeek API. Puedo ayudarte con:<br><br>
                            ‚Ä¢ üíé Identificaci√≥n de minerales y rocas<br>
                            ‚Ä¢ ‚ö° An√°lisis estructural preciso<br>
                            ‚Ä¢ üó∫Ô∏è Interpretaci√≥n de mapas geol√≥gicos<br>
                            ‚Ä¢ üì∏ An√°lisis fotogeol√≥gico<br>
                            ‚Ä¢ üß™ Recomendaciones de muestreo<br><br>
                            <em>Activa el bot√≥n ü§ñ en el header para comenzar.</em>
                        </div>
                    </div>
                    
                    <div class="chat-input-group">
                        <input type="text" class="glass-input" id="chatInput" 
                               placeholder="Pregunta sobre geolog√≠a, minerales, estructuras...">
                        <button class="glass-btn primary" id="sendMessage" style="width: auto; min-width: 60px; padding: 18px 22px;">
                            <span>‚úàÔ∏è</span>
                        </button>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn success" id="analyzeLocation">
                            <span>üìç</span>
                            Analizar Ubicaci√≥n
                        </button>
                        <button class="glass-btn warning" id="identifyMineral">
                            <span>üíé</span>
                            Identificar Mineral
                        </button>
                        <button class="glass-btn info" id="getGeologyReport">
                            <span>üìã</span>
                            Reporte Geol√≥gico
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üíæ</span>
                        <h2 class="card-title">Base de Datos Mineral√≥gica 
                            <span class="badge success" id="mineralCount">50+</span>
                        </h2>
                    </div>
                    
                    <div id="geologyDatabase" class="geology-data">
                        <div class="data-row">
                            <span>Minerales üíé:</span>
                            <span id="mineralCountValue">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Rocas ü™®:</span>
                            <span id="rockCount">24 tipos</span>
                        </div>
                        <div class="data-row">
                            <span>Yacimientos üèúÔ∏è:</span>
                            <span id="locationCount">32 localidades</span>
                        </div>
                        <div class="data-row">
                            <span>IA Status ü§ñ:</span>
                            <span id="aiActiveStatus" style="color: #DC143C; font-weight: 700;">Inactiva</span>
                        </div>
                        <div class="data-row">
                            <span>√öltima actualizaci√≥n:</span>
                            <span id="lastUpdate">Hoy</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB para acciones r√°pidas -->
        <button class="fab" id="fabButton" title="Acci√≥n r√°pida">
            <span>‚ö°</span>
        </button>

        <!-- Notification -->
        <div class="notification" id="notification" style="display: none;">
            <span id="notificationIcon">‚úÖ</span>
            <span id="notificationText">Mensaje de notificaci√≥n</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.polyline.measured"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN - DEEPSEEK API Y MAPAS
        // ============================================
        const CONFIG = {
            MAPBOX_TOKEN: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA',
            DEEPSEEK_API_KEY: 'sk-2f64faf4b77344959d768c9e7caf39fb',
            DEEPSEEK_API_URL: 'https://api.deepseek.com/v1/chat/completions',
            DEFAULT_LOCATION: {
                lat: -27.3667,
                lng: -70.3333,
                zoom: 12
            },
            MAP_LAYERS: {
                topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                geology: 'https://tiles.arcgis.com/tiles/nGt4QxSblgDfeJn9/arcgis/rest/services/geologia/MapServer/tile/{z}/{y}/{x}'
            }
        };

        // Variables globales
        let map = null;
        let currentLocation = null;
        let cameraStream = null;
        let isCameraActive = false;
        let currentPhoto = null;
        let markersLayer = null;
        let isDrGeoBotActive = false;
        let mineralDatabase = null;
        let chatHistory = [];
        let routePoints = [];
        let routeLayer = null;
        let drawRouteMode = false;
        let charts = {};
        let activeChart = 'minerals';

        // ============================================
        // BASE DE DATOS MINERALES AMPLIADA (50+ minerales)
        // ============================================
        const MINERAL_DATABASE_EXPANDED = {
            "Regi√≥n de Antofagasta": {
                minerals: [
                    // Minerales de Cobre
                    { name: "Calcopirita", formula: "CuFeS‚ÇÇ", emoji: "üíé", color: "Amarillo lat√≥n", hardness: "3.5-4", type: "Sulfuro", uses: "Principal mineral de cobre", yacimientos: ["Chuquicamata", "Escondida", "Cerro Negro", "El Salvador", "El Abra"] },
                    { name: "Atacamita", formula: "Cu‚ÇÇCl(OH)‚ÇÉ", emoji: "üíö", color: "Verde esmeralda", hardness: "3-3.5", type: "Haluro", uses: "Mineral secundario de cobre", yacimientos: ["Salar de Atacama", "Cerro Pintado", "Cerro Colorado"] },
                    { name: "Bornita", formula: "Cu‚ÇÖFeS‚ÇÑ", emoji: "üü£", color: "P√∫rpura iridiscente", hardness: "3", type: "Sulfuro", uses: "Mineral de cobre", yacimientos: ["Chuquicamata", "Escondida", "Collahuasi"] },
                    { name: "Covellina", formula: "CuS", emoji: "üîµ", color: "Azul √≠ndigo", hardness: "1.5-2", type: "Sulfuro", uses: "Mineral secundario de cobre", yacimientos: ["Chuquicamata", "Cerro Negro"] },
                    { name: "Crisocola", formula: "Cu‚ÇÇH‚ÇÇSi‚ÇÇO‚ÇÖ(OH)‚ÇÑ", emoji: "üíô", color: "Azul verdoso", hardness: "2-4", type: "Silicato", uses: "Mineral ornamental", yacimientos: ["Cerro Negro", "Escondida"] },
                    
                    // Minerales de Hierro
                    { name: "Hematita", formula: "Fe‚ÇÇO‚ÇÉ", emoji: "üî¥", color: "Rojo a negro met√°lico", hardness: "5.5-6.5", type: "√ìxido", uses: "Principal mineral de hierro", yacimientos: ["Cerro Im√°n", "Sierra Gorda", "Mantoverde"] },
                    { name: "Magnetita", formula: "Fe‚ÇÉO‚ÇÑ", emoji: "‚ö´", color: "Negro met√°lico", hardness: "5.5-6.5", type: "√ìxido", uses: "Mineral de hierro magn√©tico", yacimientos: ["Cerro Negro Norte", "El Romeral"] },
                    { name: "Goethita", formula: "FeO(OH)", emoji: "üü§", color: "Marr√≥n amarillento", hardness: "5-5.5", type: "√ìxido", uses: "Mineral de hierro", yacimientos: ["Mantos Blancos", "Cerro Im√°n"] },
                    { name: "Limonita", formula: "FeO(OH)¬∑nH‚ÇÇO", emoji: "üü°", color: "Amarillo a marr√≥n", hardness: "4-5.5", type: "√ìxido", uses: "Mineral de hierro", yacimientos: ["Todas las zonas oxidadas"] },
                    
                    // Minerales de Plata
                    { name: "Clorargirita", formula: "AgCl", emoji: "‚ö™", color: "Gris a incoloro", hardness: "2.5", type: "Haluro", uses: "Mineral de plata", yacimientos: ["Caracoles", "Sierra Gorda", "Aguas Blancas"] },
                    { name: "Argentita", formula: "Ag‚ÇÇS", emoji: "üîò", color: "Negro plomizo", hardness: "2-2.5", type: "Sulfuro", uses: "Principal mineral de plata", yacimientos: ["Caracoles", "Cerro Bayo"] },
                    { name: "Proustita", formula: "Ag‚ÇÉAsS‚ÇÉ", emoji: "üî¥", color: "Rojo escarlata", hardness: "2-2.5", type: "Sulfosalt", uses: "Mineral de plata", yacimientos: ["Cerro Bayo", "Sierra Gorda"] },
                    
                    // Minerales de Oro
                    { name: "Oro Nativo", formula: "Au", emoji: "üí∞", color: "Amarillo dorado", hardness: "2.5-3", type: "Elemento nativo", uses: "Metal precioso", yacimientos: ["El Pe√±√≥n", "Cerro Casale", "Cerro Maricunga"] },
                    { name: "Electrum", formula: "Au,Ag", emoji: "üíõ", color: "Amarillo p√°lido", hardness: "2.5-3", type: "Aleaci√≥n", uses: "Aleaci√≥n oro-plata", yacimientos: ["El Pe√±√≥n", "Cerro Casale"] },
                    
                    // Minerales Varios
                    { name: "Cuarzo", formula: "SiO‚ÇÇ", emoji: "üî∂", color: "Variable", hardness: "7", type: "Silicato", uses: "Electr√≥nica, √≥ptica", yacimientos: ["Todas las localidades"] },
                    { name: "Calcita", formula: "CaCO‚ÇÉ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3", type: "Carbonato", uses: "Construcci√≥n, √≥ptica", yacimientos: ["Vetas carbonatadas"] },
                    { name: "Yeso", formula: "CaSO‚ÇÑ¬∑2H‚ÇÇO", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2", type: "Sulfato", uses: "Construcci√≥n", yacimientos: ["Salares", "Vetas"] },
                    { name: "Anhidrita", formula: "CaSO‚ÇÑ", emoji: "üî∑", color: "Azul gris√°ceo", hardness: "3-3.5", type: "Sulfato", uses: "Construcci√≥n", yacimientos: ["Salares"] },
                    { name: "Halita", formula: "NaCl", emoji: "üßÇ", color: "Incoloro a blanco", hardness: "2.5", type: "Haluro", uses: "Sal de roca", yacimientos: ["Salar de Atacama", "Salar de Punta Negra"] },
                    { name: "Silvina", formula: "KCl", emoji: "üíú", color: "Incoloro a blanco", hardness: "2", type: "Haluro", uses: "Fertilizante", yacimientos: ["Salar de Atacama"] },
                    { name: "Thenardita", formula: "Na‚ÇÇSO‚ÇÑ", emoji: "üîò", color: "Incoloro a blanco", hardness: "2.5-3", type: "Sulfato", uses: "Industria qu√≠mica", yacimientos: ["Salares"] },
                    { name: "Ulexita", formula: "NaCaB‚ÇÖO‚ÇÜ(OH)‚ÇÜ¬∑5H‚ÇÇO", emoji: "üíé", color: "Incoloro a blanco", hardness: "1", type: "Borato", uses: "Fibra √≥ptica natural", yacimientos: ["Salar de Atacama"] },
                    { name: "Colemanita", formula: "Ca‚ÇÇB‚ÇÜO‚ÇÅ‚ÇÅ¬∑5H‚ÇÇO", emoji: "üíé", color: "Incoloro a blanco", hardness: "4-4.5", type: "Borato", uses: "Industria del vidrio", yacimientos: ["Salar de Atacama"] }
                ],
                localities: ["Chuquicamata", "Escondida", "Cerro Negro", "Collahuasi", "El Salvador", "El Abra", "Mantoverde", "Cerro Im√°n", "Sierra Gorda", "Caracoles", "El Pe√±√≥n", "Cerro Casale", "Cerro Maricunga", "Salar de Atacama", "Salar de Punta Negra", "Cerro Pintado", "Cerro Colorado", "Mantos Blancos", "Cerro Negro Norte", "El Romeral", "Aguas Blancas", "Cerro Bayo"]
            },
            "Regi√≥n de Atacama": {
                minerals: [
                    // Minerales de Cobre
                    { name: "Calcopirita", formula: "CuFeS‚ÇÇ", emoji: "üíé", color: "Amarillo lat√≥n", hardness: "3.5-4", type: "Sulfuro", uses: "Principal mineral de cobre", yacimientos: ["Cerro Blanco", "Pampa Larga", "Candelaria", "Cobremar", "Cerro Negro"] },
                    { name: "Bornita", formula: "Cu‚ÇÖFeS‚ÇÑ", emoji: "üü£", color: "P√∫rpura iridiscente", hardness: "3", type: "Sulfuro", uses: "Mineral de cobre", yacimientos: ["Candelaria", "Cerro Blanco", "Cerro Negro"] },
                    { name: "Covellina", formula: "CuS", emoji: "üîµ", color: "Azul √≠ndigo", hardness: "1.5-2", type: "Sulfuro", uses: "Mineral secundario de cobre", yacimientos: ["Cerro Blanco", "Cerro Negro"] },
                    
                    // Minerales Carbonatados
                    { name: "Malaquita", formula: "Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ", emoji: "üíö", color: "Verde intenso", hardness: "3.5-4", type: "Carbonato", uses: "Piedra ornamental", yacimientos: ["Cerro Blanco", "Cerro Negro", "Pampa Larga"] },
                    { name: "Azurita", formula: "Cu‚ÇÉ(CO‚ÇÉ)‚ÇÇ(OH)‚ÇÇ", emoji: "üíô", color: "Azul intenso", hardness: "3.5-4", type: "Carbonato", uses: "Mineral ornamental", yacimientos: ["Cerro Im√°n", "Pampa Larga", "Cerro Blanco"] },
                    { name: "Cerusita", formula: "PbCO‚ÇÉ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3-3.5", type: "Carbonato", uses: "Mineral de plomo", yacimientos: ["Cerro Negro", "Pampa Larga"] },
                    { name: "Smithsonita", formula: "ZnCO‚ÇÉ", emoji: "üíö", color: "Verde a azul", hardness: "4-4.5", type: "Carbonato", uses: "Mineral de zinc", yacimientos: ["Cerro Negro"] },
                    
                    // Minerales de Hierro
                    { name: "Hematita", formula: "Fe‚ÇÇO‚ÇÉ", emoji: "üî¥", color: "Rojo a negro", hardness: "5.5-6.5", type: "√ìxido", uses: "Mineral de hierro", yacimientos: ["Cerro Im√°n", "Cerro Negro", "Pampa Larga"] },
                    { name: "Magnetita", formula: "Fe‚ÇÉO‚ÇÑ", emoji: "‚ö´", color: "Negro met√°lico", hardness: "5.5-6.5", type: "√ìxido", uses: "Mineral de hierro magn√©tico", yacimientos: ["Cerro Negro Norte", "Cerro Im√°n"] },
                    { name: "Goethita", formula: "FeO(OH)", emoji: "üü§", color: "Marr√≥n amarillento", hardness: "5-5.5", type: "√ìxido", uses: "Mineral de hierro", yacimientos: ["Zonas oxidadas"] },
                    
                    // Minerales de Plata y Plomo
                    { name: "Galena", formula: "PbS", emoji: "üîò", color: "Gris plomo", hardness: "2.5", type: "Sulfuro", uses: "Principal mineral de plomo", yacimientos: ["Cerro Negro", "Pampa Larga"] },
                    { name: "Anglesita", formula: "PbSO‚ÇÑ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2.5-3", type: "Sulfato", uses: "Mineral secundario de plomo", yacimientos: ["Cerro Negro"] },
                    { name: "Pirargirita", formula: "Ag‚ÇÉSbS‚ÇÉ", emoji: "üî¥", color: "Rojo oscuro", hardness: "2.5", type: "Sulfosalt", uses: "Mineral de plata", yacimientos: ["Cerro Negro"] },
                    
                    // Minerales de Zinc
                    { name: "Esfalerita", formula: "ZnS", emoji: "üü°", color: "Amarillo a marr√≥n", hardness: "3.5-4", type: "Sulfuro", uses: "Principal mineral de zinc", yacimientos: ["Cerro Negro"] },
                    { name: "Hemimorfita", formula: "Zn‚ÇÑSi‚ÇÇO‚Çá(OH)‚ÇÇ¬∑H‚ÇÇO", emoji: "üíé", color: "Incoloro a azul", hardness: "4.5-5", type: "Silicato", uses: "Mineral secundario de zinc", yacimientos: ["Cerro Negro"] },
                    
                    // Minerales Varios
                    { name: "Cuarzo", formula: "SiO‚ÇÇ", emoji: "üî∂", color: "Variable", hardness: "7", type: "Silicato", uses: "Electr√≥nica, √≥ptica", yacimientos: ["Todas las localidades"] },
                    { name: "Baritina", formula: "BaSO‚ÇÑ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3-3.5", type: "Sulfato", uses: "Perforaci√≥n petrolera", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Fluorita", formula: "CaF‚ÇÇ", emoji: "üíú", color: "Variable", hardness: "4", type: "Haluro", uses: "Metalurgia, √≥ptica", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Yeso", formula: "CaSO‚ÇÑ¬∑2H‚ÇÇO", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2", type: "Sulfato", uses: "Construcci√≥n", yacimientos: ["Copiap√≥", "Vallenar", "Salar de Pedernales"] },
                    { name: "Anhidrita", formula: "CaSO‚ÇÑ", emoji: "üî∑", color: "Azul gris√°ceo", hardness: "3-3.5", type: "Sulfato", uses: "Construcci√≥n", yacimientos: ["Salar de Pedernales"] },
                    { name: "Halita", formula: "NaCl", emoji: "üßÇ", color: "Incoloro a blanco", hardness: "2.5", type: "Haluro", uses: "Sal de roca", yacimientos: ["Salar de Pedernales"] },
                    { name: "Epidota", formula: "Ca‚ÇÇAl‚ÇÇ(Fe¬≥‚Å∫,Al)(SiO‚ÇÑ)(Si‚ÇÇO‚Çá)O(OH)", emoji: "üíö", color: "Verde pistacho", hardness: "6-7", type: "Silicato", uses: "Mineral √≠ndice metam√≥rfico", yacimientos: ["Cerro Blanco", "Cerro Negro"] },
                    { name: "Actinolita", formula: "Ca‚ÇÇ(Mg,Fe)‚ÇÖSi‚ÇàO‚ÇÇ‚ÇÇ(OH)‚ÇÇ", emoji: "üíö", color: "Verde oscuro", hardness: "5-6", type: "Silicato", uses: "Mineral metam√≥rfico", yacimientos: ["Cerro Blanco"] },
                    { name: "Clorita", formula: "(Mg,Fe)‚ÇÉ(Si,Al)‚ÇÑO‚ÇÅ‚ÇÄ(OH)‚ÇÇ¬∑(Mg,Fe)‚ÇÉ(OH)‚ÇÜ", emoji: "üíö", color: "Verde", hardness: "2-2.5", type: "Silicato", uses: "Mineral de alteraci√≥n", yacimientos: ["Zonas alteradas"] },
                    { name: "Serpentina", formula: "Mg‚ÇÉSi‚ÇÇO‚ÇÖ(OH)‚ÇÑ", emoji: "üíö", color: "Verde", hardness: "2.5-4", type: "Silicato", uses: "Material de construcci√≥n", yacimientos: ["Ofiolitas"] },
                    { name: "Talco", formula: "Mg‚ÇÉSi‚ÇÑO‚ÇÅ‚ÇÄ(OH)‚ÇÇ", emoji: "‚ö™", color: "Blanco a verde", hardness: "1", type: "Silicato", uses: "Polvos, cer√°mica", yacimientos: ["Metamorfismo"] },
                    { name: "Grafito", formula: "C", emoji: "‚ö´", color: "Negro", hardness: "1-2", type: "Elemento nativo", uses: "Lubricante, electrodos", yacimientos: ["Metamorfismo"] },
                    { name: "Pirita", formula: "FeS‚ÇÇ", emoji: "üü°", color: "Amarillo lat√≥n", hardness: "6-6.5", type: "Sulfuro", uses: "√Åcido sulf√∫rico", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Marcasita", formula: "FeS‚ÇÇ", emoji: "üü°", color: "Amarillo p√°lido", hardness: "6-6.5", type: "Sulfuro", uses: "Similar a pirita", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Arsenopirita", formula: "FeAsS", emoji: "‚ö™", color: "Blanco plateado", hardness: "5.5-6", type: "Sulfuro", uses: "Mineral de ars√©nico", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Estibina", formula: "Sb‚ÇÇS‚ÇÉ", emoji: "üîò", color: "Gris plomo", hardness: "2", type: "Sulfuro", uses: "Mineral de antimonio", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Realgar", formula: "AsS", emoji: "üî¥", color: "Rojo anaranjado", hardness: "1.5-2", type: "Sulfuro", uses: "Pigmento", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Orpimento", formula: "As‚ÇÇS‚ÇÉ", emoji: "üü°", color: "Amarillo lim√≥n", hardness: "1.5-2", type: "Sulfuro", uses: "Pigmento", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Apatito", formula: "Ca‚ÇÖ(PO‚ÇÑ)‚ÇÉ(F,Cl,OH)", emoji: "üíé", color: "Variable", hardness: "5", type: "Fosfato", uses: "Fertilizante", yacimientos: ["Vetas hidrotermales"] },
                    { name: "Turquesa", formula: "CuAl‚ÇÜ(PO‚ÇÑ)‚ÇÑ(OH)‚Çà¬∑4H‚ÇÇO", emoji: "üíé", color: "Azul verdoso", hardness: "5-6", type: "Fosfato", uses: "Piedra preciosa", yacimientos: ["Zonas oxidadas"] }
                ],
                localities: ["Copiap√≥", "Vallenar", "Cerro Blanco", "Cerro Negro", "Pampa Larga", "Candelaria", "Cobremar", "Cerro Im√°n", "Salar de Pedernales", "Cerro Negro Norte", "Punta del Cobre", "Carrizal Alto", "Huantajaya", "Cerro Bayo", "Cerro Casale", "Cerro Maricunga", "Cerro Pintado", "Cerro Colorado"]
            }
        };

        // ============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üèúÔ∏è AtacamApp - Iniciando aplicaci√≥n mejorada...');
            simulateLoading();
            
            // Configurar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('‚úÖ Service Worker registrado'))
                    .catch(err => console.error('‚ùå Error Service Worker:', err));
            }
            
            // Cargar base de datos de minerales
            mineralDatabase = MINERAL_DATABASE_EXPANDED;
        });

        function simulateLoading() {
            let progress = 0;
            const messages = [
                'Conectando con DeepSeek AI... ü§ñ',
                'Cargando base de 50+ minerales Atacama... üíé',
                'Configurando mapas topogr√°ficos... üó∫Ô∏è',
                'Inicializando Dr. GeoBot... üë®‚Äçüî¨',
                'Configurando gr√°ficos 2D... üìä',
                '¬°Listo para explorar el Desierto! üèúÔ∏è'
            ];
            
            const interval = setInterval(() => {
                progress += Math.floor(100 / messages.length);
                document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
                document.getElementById('loadingText').textContent = messages[Math.floor(progress / (100 / messages.length))];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('splashScreen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('splashScreen').style.display = 'none';
                            document.getElementById('appContainer').style.display = 'block';
                            initializeApp();
                        }, 500);
                    }, 500);
                }
            }, 500);
        }

        function initializeApp() {
            console.log('‚úÖ AtacamApp inicializada con todas las mejoras');
            
            // Inicializar componentes
            init2DMap();
            initCharts();
            
            // Configurar eventos
            setupEventListeners();
            setupTabs();
            
            // Solicitar permisos
            requestPermissions();
            
            // Obtener ubicaci√≥n inicial
            setTimeout(() => startGPS(), 1000);
            
            // Actualizar estado inicial
            updateStatusIcon(false);
            updateDatabaseCounts();
            
            showNotification('¬°Bienvenido al Desierto de Atacama! üèúÔ∏è DeepSeek IA activa', 'success');
            
            // Mensaje inicial del Dr. GeoBot
            setTimeout(() => {
                addMessageToChat('ai', `üë®‚Äçüî¨ <strong>Dr. GeoBot - Sistema IA de Geolog√≠a:</strong><br><br>
                ‚úÖ <strong>Conectado a DeepSeek API</strong><br>
                üíé <strong>Base de datos:</strong> ${countMinerals()} minerales registrados<br>
                üó∫Ô∏è <strong>Mapas:</strong> Topogr√°fico y geol√≥gico operativos<br>
                üìä <strong>Gr√°ficos:</strong> 4 tipos de visualizaci√≥n 2D<br><br>
                <em>Activa el bot√≥n ü§ñ en el header para comenzar el an√°lisis geol√≥gico preciso.</em>`);
            }, 1500);
        }

        // ============================================
        // DR. GEOBOT - DEEPSEEK AI (AGENTE PRINCIPAL)
        // ============================================
        function toggleDrGeoBot() {
            isDrGeoBotActive = !isDrGeoBotActive;
            updateStatusIcon(isDrGeoBotActive);
            
            if (isDrGeoBotActive) {
                showNotification('‚úÖ Dr. GeoBot ACTIVADO con DeepSeek AI ü§ñ', 'success');
                document.getElementById('aiActiveStatus').textContent = 'Activa';
                document.getElementById('aiActiveStatus').style.color = '#228B22';
                
                addMessageToChat('ai', `<strong>ü§ñ DR. GEOBOT ACTIVADO:</strong><br><br>
                ‚úÖ <strong>Conexi√≥n establecida con DeepSeek API</strong><br>
                üìç <strong>Acceso a ubicaci√≥n GPS:</strong> ${currentLocation ? 'Conectado' : 'Esperando'}<br>
                üíé <strong>Base de datos:</strong> ${countMinerals()} minerales<br>
                üó∫Ô∏è <strong>Mapas:</strong> Topogr√°fico y geol√≥gico<br>
                üìä <strong>Visualizaci√≥n:</strong> 4 gr√°ficos 2D disponibles<br><br>
                <strong>¬øEn qu√© puedo ayudarte?</strong><br>
                ‚Ä¢ üíé Identificaci√≥n mineral√≥gica precisa<br>
                ‚Ä¢ ‚ö° An√°lisis estructural detallado<br>
                ‚Ä¢ üó∫Ô∏è Interpretaci√≥n de mapas geol√≥gicos<br>
                ‚Ä¢ üì∏ An√°lisis fotogeol√≥gico<br>
                ‚Ä¢ üß™ Recomendaciones de muestreo<br>
                ‚Ä¢ üìä An√°lisis estad√≠stico`);
                
                // Cambiar a p√°gina de IA si no est√° all√≠
                if (!document.getElementById('pageAI').classList.contains('active')) {
                    switchPage('AI');
                }
            } else {
                showNotification('‚ö†Ô∏è Dr. GeoBot DESACTIVADO ‚èπÔ∏è', 'warning');
                document.getElementById('aiActiveStatus').textContent = 'Inactiva';
                document.getElementById('aiActiveStatus').style.color = '#DC143C';
            }
        }

        function updateStatusIcon(active) {
            const statusIcon = document.getElementById('statusIcon');
            const aiStatusValue = document.getElementById('aiStatusValue');
            
            if (active) {
                statusIcon.classList.add('active');
                statusIcon.style.background = 'linear-gradient(135deg, rgba(34, 139, 34, 0.3), rgba(50, 205, 50, 0.3))';
                statusIcon.style.borderColor = '#228B22';
                aiStatusValue.textContent = 'ON';
                aiStatusValue.style.color = '#228B22';
            } else {
                statusIcon.classList.remove('active');
                statusIcon.style.background = 'linear-gradient(135deg, rgba(212, 160, 23, 0.1), rgba(139, 69, 19, 0.1))';
                statusIcon.style.borderColor = 'var(--accent)';
                aiStatusValue.textContent = 'OFF';
                aiStatusValue.style.color = 'var(--text-primary)';
            }
        }

        async function sendMessageToAI() {
            if (!isDrGeoBotActive) {
                showNotification('‚ö†Ô∏è Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            input.focus();

            const thinkingId = addMessageToChat('ai', 'Procesando con DeepSeek AI... üîç <div class="loading"></div>');

            try {
                const response = await callDeepSeekAPI(message);
                updateMessage(thinkingId, response);
                
                // Guardar en historial
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: response });
                
                // Limitar historial a √∫ltimos 10 mensajes
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
            } catch (error) {
                console.error('Error con DeepSeek:', error);
                updateMessage(thinkingId, generateLocalResponse(message));
            }
        }

        async function callDeepSeekAPI(prompt) {
            const context = buildGeologyContext();
            
            const messages = [
                {
                    role: "system",
                    content: `Eres Dr. GeoBot, un ge√≥logo experto especializado en el Desierto de Atacama, Chile. 
                    Eres parte de la aplicaci√≥n AtacamApp. Responde en espa√±ol, con emojis relevantes y formato claro.
                    Usa markdown b√°sico para formato. S√© t√©cnico pero accesible.
                    
                    INFORMACI√ìN CLAVE:
                    - Base de datos: 50+ minerales de las regiones de Antofagasta y Atacama
                    - Sistemas de fallas: NNE-SSO y E-O predominantes
                    - Mineralizaci√≥n: Cobre porf√≠rico y epitermal
                    - Contexto geol√≥gico: Cordillera de la Costa y Precordillera
                    
                    Proporciona informaci√≥n precisa y verificada.`
                },
                ...chatHistory.slice(-8),
                {
                    role: "user",
                    content: `${context}\n\nPregunta del usuario: ${prompt}`
                }
            ];

            const response = await fetch(CONFIG.DEEPSEEK_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: messages,
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function buildGeologyContext() {
            let context = `CONTEXTO ACTUAL ATACAMAPP:\n\n`;
            
            if (currentLocation) {
                context += `üìå UBICACI√ìN ACTUAL:\n`;
                context += `- Coordenadas: ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞\n`;
                context += `- Altitud: ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}\n`;
                context += `- Precisi√≥n: ${Math.round(currentLocation.accuracy)}m\n`;
                context += `- Regi√≥n: ${getRegionFromLocation()}\n`;
                context += `- Ciudad m√°s cercana: ${document.getElementById('cityValue').textContent}\n\n`;
                
                // Agregar datos geol√≥gicos espec√≠ficos de la ubicaci√≥n
                const region = getRegionFromLocation();
                const regionData = mineralDatabase[region];
                if (regionData) {
                    context += `üíé MINERALOG√çA LOCAL (${region}):\n`;
                    regionData.minerals.slice(0, 5).forEach(mineral => {
                        context += `- ${mineral.name} (${mineral.formula}): ${mineral.uses}\n`;
                    });
                    context += `\n`;
                }
            }
            
            context += `üìä BASE DE DATOS COMPLETA:\n`;
            context += `- Total minerales: ${countMinerals()}\n`;
            context += `- Regiones cubiertas: Antofagasta, Atacama\n`;
            context += `- Yacimientos registrados: ${countLocalities()}\n`;
            context += `- Tipos de minerales: Sulfuros, √ìxidos, Carbonatos, Silicatos\n\n`;
            
            context += `üó∫Ô∏è HERRAMIENTAS DISPONIBLES:\n`;
            context += `- Mapa topogr√°fico con vista sat√©lite\n`;
            context += `- Capas geol√≥gicas 2D (litolog√≠a, fallas, yacimientos)\n`;
            context += `- 4 tipos de gr√°ficos 2D (minerales, estructuras, elevaci√≥n, geoqu√≠mica)\n`;
            context += `- An√°lisis fotogeol√≥gico con IA\n`;
            context += `- Marcaci√≥n de rutas y puntos\n\n`;
            
            context += `üë®‚Äçüî¨ METODOLOG√çA RECOMENDADA PARA ATACAMA:\n`;
            context += `- Mapeo GPS de alta precisi√≥n\n`;
            context += `- Muestreo sistem√°tico cada 50m\n`;
            context += `- Fotograf√≠a geol√≥gica con escala\n`;
            context += `- Mediciones estructurales con br√∫jula Brunton\n`;
            context += `- Correcci√≥n por declinaci√≥n magn√©tica local\n`;
            context += `- An√°lisis estereogr√°fico in situ`;
            
            return context;
        }

        function generateLocalResponse(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            
            if (lowerPrompt.includes('mineral') || lowerPrompt.includes('roca') || lowerPrompt.includes('identificar')) {
                return generateMineralResponse();
            }
            
            if (lowerPrompt.includes('estructura') || lowerPrompt.includes('falla') || lowerPrompt.includes('buzamiento') || lowerPrompt.includes('rumbo')) {
                return generateStructureResponse();
            }
            
            if (lowerPrompt.includes('mapa') || lowerPrompt.includes('ubicaci√≥n') || lowerPrompt.includes('localizaci√≥n')) {
                return generateLocationResponse();
            }
            
            if (lowerPrompt.includes('m√©todo') || lowerPrompt.includes('metodolog√≠a') || lowerPrompt.includes('campo')) {
                return generateMethodologyResponse();
            }
            
            if (lowerPrompt.includes('gr√°fico') || lowerPrompt.includes('grafico') || lowerPrompt.includes('visualizaci√≥n')) {
                return generateVisualizationResponse();
            }
            
            return `üë®‚Äçüî¨ <strong>Dr. GeoBot:</strong><br><br>
            Como ge√≥logo especializado en el Desierto de Atacama, puedo ayudarte con:<br><br>
            ‚Ä¢ <strong>üíé Identificaci√≥n mineral√≥gica precisa</strong> (base de 50+ minerales)<br>
            ‚Ä¢ <strong>‚ö° An√°lisis estructural detallado</strong> (rumbo, buzamiento, fallas)<br>
            ‚Ä¢ <strong>üó∫Ô∏è Interpretaci√≥n de mapas geol√≥gicos</strong> (topograf√≠a, litolog√≠a)<br>
            ‚Ä¢ <strong>üì∏ An√°lisis fotogeol√≥gico con IA</strong><br>
            ‚Ä¢ <strong>üìä Visualizaci√≥n de datos 2D</strong> (4 tipos de gr√°ficos)<br>
            ‚Ä¢ <strong>üß™ Metodolog√≠a de campo optimizada</strong><br><br>
            <em>Prueba preguntando sobre minerales espec√≠ficos o an√°lisis de estructuras.</em>`;
        }

        function generateMineralResponse() {
            const region = getRegionFromLocation();
            const regionData = mineralDatabase[region];
            
            if (regionData) {
                let response = `<strong>üîç AN√ÅLISIS MINERAL√ìGICO - ${region}:</strong><br><br>`;
                response += `<strong>Principales grupos mineral√≥gicos:</strong><br><br>`;
                
                // Agrupar por tipo
                const types = {};
                regionData.minerals.forEach(mineral => {
                    if (!types[mineral.type]) types[mineral.type] = [];
                    types[mineral.type].push(mineral);
                });
                
                Object.keys(types).forEach(type => {
                    response += `<strong>${getTypeEmoji(type)} ${type}:</strong><br>`;
                    types[type].slice(0, 3).forEach(mineral => {
                        response += `‚Ä¢ ${mineral.emoji} <strong>${mineral.name}</strong> (${mineral.formula})<br>`;
                        response += `&nbsp;&nbsp;Color: ${mineral.color} | Dureza: ${mineral.hardness}<br>`;
                        response += `&nbsp;&nbsp;Usos: ${mineral.uses}<br>`;
                    });
                    response += `<br>`;
                });
                
                response += `<strong>üéØ RECOMENDACIONES DE MUESTREO:</strong><br>`;
                response += `1. Tomar muestras frescas (no meteorizadas)<br>`;
                response += `2. Peso m√≠nimo: 500g por muestra<br>`;
                response += `3. Documentar coordenadas precisas<br>`;
                response += `4. Fotografiar in situ con escala<br>`;
                response += `5. Usar bolsas de muestreo etiquetadas<br><br>`;
                response += `<em>¬øNecesitas informaci√≥n espec√≠fica sobre alg√∫n mineral?</em>`;
                
                return response;
            }
            
            return `üíé <strong>MINERALOG√çA DEL DESIERTO DE ATACAMA:</strong><br><br>
            La regi√≥n es conocida mundialmente por su riqueza mineral:<br><br>
            <strong>Sulfuros principales:</strong><br>
            ‚Ä¢ <strong>Calcopirita (CuFeS‚ÇÇ)</strong> - Principal mineral de cobre<br>
            ‚Ä¢ <strong>Bornita (Cu‚ÇÖFeS‚ÇÑ)</strong> - Sulfuro de cobre p√∫rpura<br>
            ‚Ä¢ <strong>Esfalerita (ZnS)</strong> - Principal mineral de zinc<br>
            ‚Ä¢ <strong>Galena (PbS)</strong> - Principal mineral de plomo<br><br>
            
            <strong>√ìxidos importantes:</strong><br>
            ‚Ä¢ <strong>Hematita (Fe‚ÇÇO‚ÇÉ)</strong> - Mineral de hierro rojo<br>
            ‚Ä¢ <strong>Magnetita (Fe‚ÇÉO‚ÇÑ)</strong> - Mineral magn√©tico de hierro<br>
            ‚Ä¢ <strong>Atacamita (Cu‚ÇÇCl(OH)‚ÇÉ)</strong> - Mineral secundario de cobre<br><br>
            
            <strong>Carbonatos ornamentales:</strong><br>
            ‚Ä¢ <strong>Malaquita (Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ)</strong> - Verde intenso<br>
            ‚Ä¢ <strong>Azurita (Cu‚ÇÉ(CO‚ÇÉ)‚ÇÇ(OH)‚ÇÇ)</strong> - Azul profundo<br><br>
            
            <strong>Activa el GPS para ver minerales espec√≠ficos de tu ubicaci√≥n.</strong>`;
        }

        function generateStructureResponse() {
            return `‚ö° <strong>AN√ÅLISIS ESTRUCTURAL - DESIERTO DE ATACAMA:</strong><br><br>
            <strong>SISTEMAS ESTRUCTURALES PRINCIPALES:</strong><br><br>
            1. <strong>Sistema de Fallas NNE-SSO</strong><br>
            ‚Ä¢ Orientaci√≥n: 10¬∞-30¬∞ N<br>
            ‚Ä¢ Buzamiento: 45¬∞-60¬∞ al este<br>
            ‚Ä¢ Longitud: Decenas a cientos de km<br>
            ‚Ä¢ Mineralizaci√≥n asociada: Vetas de Cu-Au-Ag<br>
            ‚Ä¢ Ejemplos: Falla Sierra Gorda, Falla Escondida<br><br>
            
            2. <strong>Sistema de Fallas E-O</strong><br>
            ‚Ä¢ Orientaci√≥n: 80¬∞-100¬∞<br>
            ‚Ä¢ Buzamiento: 60¬∞-70¬∞ al norte<br>
            ‚Ä¢ Control: Stockworks de Cu-Mo<br>
            ‚Ä¢ Relaci√≥n: Con intrusivos porf√≠ricos<br><br>
            
            3. <strong>Sistema de Fallas NW-SE</strong><br>
            ‚Ä¢ Orientaci√≥n: 130¬∞-150¬∞<br>
            ‚Ä¢ Buzamiento: 70¬∞-80¬∞ al NE<br>
            ‚Ä¢ Control: Vetas epitermales de Au-Ag<br><br>
            
            <strong>üìê M√âTODOS DE MEDICI√ìN RECOMENDADOS:</strong><br>
            ‚Ä¢ Br√∫jula geol√≥gica Brunton con clin√≥metro<br>
            ‚Ä¢ Correcci√≥n por declinaci√≥n magn√©tica local (+8¬∞ a +10¬∞)<br>
            ‚Ä¢ Mediciones m√∫ltiples (‚â•3 por estructura)<br>
            ‚Ä¢ Uso de escala en fotograf√≠as<br>
            ‚Ä¢ Diagramas estereogr√°ficos in situ<br><br>
            
            <strong>üéØ PAR√ÅMETROS T√çPICOS:</strong><br>
            ‚Ä¢ Rumbo promedio: N.25¬∞E ¬± 15¬∞<br>
            ‚Ä¢ Buzamiento promedio: 55¬∞ ¬± 20¬∞<br>
            ‚Ä¢ Espaciado de fallas: 100-500m<br>
            ‚Ä¢ Longitud de vetas: 50-2000m<br>
            ‚Ä¢ Potencia de vetas: 0.5-5m<br><br>
            
            <strong>üåç HERRAMIENTAS ATACAMAPP:</strong><br>
            ‚Ä¢ Usa el mapa topogr√°fico para an√°lisis<br>
            ‚Ä¢ Agrega puntos estructurales con mediciones<br>
            ‚Ä¢ Genera diagramas de orientaci√≥n<br>
            ‚Ä¢ Toma fotos con escala para documentaci√≥n`;
        }

        function generateLocationResponse() {
            if (currentLocation) {
                const region = getRegionFromLocation();
                const regionData = mineralDatabase[region];
                
                let response = `üìç <strong>AN√ÅLISIS DE UBICACI√ìN:</strong><br><br>`;
                response += `<strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞<br>`;
                response += `<strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm ‚õ∞Ô∏è' : 'Desconocida'}<br>`;
                response += `<strong>Precisi√≥n GPS:</strong> ${Math.round(currentLocation.accuracy)}m üéØ<br>`;
                response += `<strong>Regi√≥n:</strong> ${region}<br>`;
                response += `<strong>Ciudad m√°s cercana:</strong> ${document.getElementById('cityValue').textContent}<br><br>`;
                
                response += `<strong>üó∫Ô∏è CONTEXTO GEOL√ìGICO:</strong><br>`;
                response += `‚Ä¢ ${getGeologicalContext()}<br>`;
                response += `‚Ä¢ Sistema de fallas predominante: NNE-SSO<br>`;
                response += `‚Ä¢ Mineralizaci√≥n esperada: ${getExpectedMineralization()}<br>`;
                response += `‚Ä¢ Tipo de roca probable: ${getExpectedRockType()}<br><br>`;
                
                if (regionData) {
                    response += `<strong>üíé MINERALES ESPERADOS EN LA ZONA:</strong><br>`;
                    regionData.minerals.slice(0, 5).forEach(mineral => {
                        response += `‚Ä¢ ${mineral.emoji} ${mineral.name} - ${mineral.type}<br>`;
                    });
                    response += `<br>`;
                }
                
                response += `<strong>üéØ ACCIONES RECOMENDADAS:</strong><br>`;
                response += `1. Agregar punto geol√≥gico al mapa<br>`;
                response += `2. Tomar fotograf√≠as panor√°micas del √°rea<br>`;
                response += `3. Realizar an√°lisis estructural<br>`;
                response += `4. Tomar muestras representativas<br>`;
                response += `5. Generar capas geol√≥gicas 2D`;
                
                return response;
            }
            
            return `üìç <strong>UBICACI√ìN NO DISPONIBLE</strong><br><br>
            Para an√°lisis geol√≥gico preciso, necesito tu ubicaci√≥n:<br><br>
            1. Ve a la p√°gina de Inicio<br>
            2. Presiona "üìç Actualizar GPS"<br>
            3. Permite acceso a ubicaci√≥n<br><br>
            <em>Con tu ubicaci√≥n puedo proporcionar an√°lisis espec√≠fico del √°rea con datos de 50+ minerales.</em>`;
        }

        function generateMethodologyResponse() {
            return `üìã <strong>METODOLOG√çA DE CAMPO OPTIMIZADA - ATACAMAPP:</strong><br><br>
            <strong>1. üó∫Ô∏è PREPARACI√ìN DE CAMPO:</strong><br>
            ‚Ä¢ GPS diferencial (¬±1m de precisi√≥n)<br>
            ‚Ä¢ Br√∫jula Brunton con clin√≥metro<br>
            ‚Ä¢ Martillo geol√≥gico y lupa 10x<br>
            ‚Ä¢ Bolsas de muestreo y etiquetas<br>
            ‚Ä¢ Tableta con AtacamApp instalada<br>
            ‚Ä¢ Power bank y cargador solar<br><br>
            
            <strong>2. üìê PROCEDIMIENTO DE CAMPO:</strong><br>
            ‚Ä¢ Estaciones cada 50m en l√≠neas N-S<br>
            ‚Ä¢ Mediciones estructurales en cada estaci√≥n<br>
            ‚Ä¢ Fotograf√≠a geol√≥gica con escala<br>
            ‚Ä¢ Descripci√≥n litol√≥gica detallada<br>
            ‚Ä¢ Muestreo sistem√°tico (500g por muestra)<br>
            ‚Ä¢ Coordenadas con datum WGS84<br><br>
            
            <strong>3. üíé MUESTREO MINERAL√ìGICO:</strong><br>
            ‚Ä¢ Muestras de mano (tama√±o pu√±o)<br>
            ‚Ä¢ Muestras para l√°mina delgada<br>
            ‚Ä¢ Muestras para geoqu√≠mica<br>
            ‚Ä¢ Muestras para dataci√≥n<br>
            ‚Ä¢ Documentaci√≥n fotogr√°fica completa<br><br>
            
            <strong>4. ü§ñ PROCESAMIENTO CON ATACAMAPP:</strong><br>
            ‚Ä¢ Carga inmediata de datos en campo<br>
            ‚Ä¢ An√°lisis IA con DeepSeek<br>
            ‚Ä¢ Generaci√≥n de mapas 2D<br>
            ‚Ä¢ Creaci√≥n de gr√°ficos estad√≠sticos<br>
            ‚Ä¢ Exportaci√≥n de informes<br><br>
            
            <strong>5. üìä CONTROL DE CALIDAD:</strong><br>
            ‚Ä¢ Verificaci√≥n cruzada de coordenadas<br>
            ‚Ä¢ Revisi√≥n de fotograf√≠as<br>
            ‚Ä¢ Validaci√≥n de mediciones<br>
            ‚Ä¢ Control de inventario de muestras<br>
            ‚Ä¢ Backup diario de datos`;
        }

        function generateVisualizationResponse() {
            return `üìä <strong>VISUALIZACI√ìN GEOL√ìGICA 2D - ATACAMAPP:</strong><br><br>
            <strong>1. üíé GR√ÅFICO DE DISTRIBUCI√ìN MINERAL√ìGICA:</strong><br>
            ‚Ä¢ An√°lisis estad√≠stico de minerales<br>
            ‚Ä¢ Frecuencia por tipo (sulfuros, √≥xidos, etc.)<br>
            ‚Ä¢ Distribuci√≥n espacial<br>
            ‚Ä¢ Asociaciones mineral√≥gicas<br><br>
            
            <strong>2. ‚ö° GR√ÅFICO DE ORIENTACI√ìN ESTRUCTURAL:</strong><br>
            ‚Ä¢ Diagrama de rosas (rumbo)<br>
            ‚Ä¢ Histograma de buzamientos<br>
            ‚Ä¢ An√°lisis de poblaciones<br>
            ‚Ä¢ Identificaci√≥n de sistemas<br><br>
            
            <strong>3. ‚õ∞Ô∏è GR√ÅFICO DE PERFIL TOPOGR√ÅFICO:</strong><br>
            ‚Ä¢ Secciones transversales<br>
            ‚Ä¢ An√°lisis de pendientes<br>
            ‚Ä¢ Correlaci√≥n con geolog√≠a<br>
            ‚Ä¢ Identificaci√≥n de estructuras<br><br>
            
            <strong>4. üß™ GR√ÅFICO GEOQU√çMICO:</strong><br>
            ‚Ä¢ Diagramas de clasificaci√≥n<br>
            ‚Ä¢ Correlaciones elementales<br>
            ‚Ä¢ Anomal√≠as geoqu√≠micas<br>
            ‚Ä¢ Identificaci√≥n de alteraciones<br><br>
            
            <strong>üéØ FUNCIONALIDADES:</strong><br>
            ‚Ä¢ Exportaci√≥n en PNG (alta resoluci√≥n)<br>
            ‚Ä¢ Personalizaci√≥n de colores<br>
            ‚Ä¢ Escalas ajustables<br>
            ‚Ä¢ Superposici√≥n de capas<br>
            ‚Ä¢ Anotaciones interactivas`;
        }

        function getTypeEmoji(type) {
            const emojis = {
                'Sulfuro': 'üíé',
                '√ìxido': 'üî¥',
                'Carbonato': 'üíö',
                'Silicato': 'ü™®',
                'Haluro': 'üßÇ',
                'Sulfato': '‚ö™',
                'Fosfato': 'üíé',
                'Elemento nativo': 'üí∞',
                'Aleaci√≥n': 'üíõ',
                'Sulfosalt': 'üî¥',
                'Borato': 'üíé'
            };
            return emojis[type] || 'üíé';
        }

        function getExpectedMineralization() {
            if (!currentLocation) return "Cobre porf√≠rico y epitermal";
            
            const lat = currentLocation.latitude;
            
            if (lat < -22) return "Cobre porf√≠rico (Chuquicamata, Escondida)";
            if (lat < -25) return "Cobre-oro epitermal";
            if (lat < -30) return "Oro-plata epitermal y hierro";
            
            return "Mineralizaci√≥n diversa (Cu, Au, Ag, Fe)";
        }

        function getExpectedRockType() {
            if (!currentLocation) return "Rocas volc√°nicas y sedimentarias";
            
            const lat = currentLocation.latitude;
            
            if (lat < -22) return "Intrusivos porf√≠ricos y volc√°nicas andes√≠ticas";
            if (lat < -25) return "Volc√°nicas dac√≠ticas y riol√≠ticas";
            if (lat < -30) return "Sedimentarias mesozoicas y volc√°nicas jur√°sicas";
            
            return "Secuencia volc√°nica-sedimentaria";
        }

        function countMinerals() {
            let count = 0;
            if (mineralDatabase) {
                Object.values(mineralDatabase).forEach(region => {
                    count += region.minerals.length;
                });
            }
            return count;
        }

        function countLocalities() {
            let count = 0;
            if (mineralDatabase) {
                Object.values(mineralDatabase).forEach(region => {
                    count += region.localities.length;
                });
            }
            return count;
        }

        function getRegionFromLocation() {
            if (!currentLocation) return "Desierto de Atacama";
            
            const lat = currentLocation.latitude;
            
            if (lat < -22) return "Regi√≥n de Antofagasta";
            if (lat < -30) return "Regi√≥n de Atacama";
            
            return "Desierto de Atacama";
        }

        function getGeologicalContext() {
            const region = getRegionFromLocation();
            
            if (region === "Regi√≥n de Antofagasta") {
                return "Cordillera de la Costa - Yacimientos de cobre porf√≠rico gigantes (Chuquicamata, Escondida) en intrusivos pale√≥genos";
            } else if (region === "Regi√≥n de Atacama") {
                return "Precordillera andina - Vetas epitermales de Au-Ag-Cu en volc√°nicas jur√°sicas-cret√°cicas";
            }
            
            return "Regi√≥n des√©rtica con geolog√≠a compleja, mineralizaci√≥n diversa y sistemas estructurales m√∫ltiples";
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    activeChart = this.dataset.chart;
                    updateCharts();
                });
            });
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1));
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Actualizar t√≠tulo de p√°gina
            const titles = {
                'Dashboard': 'Inicio - Mapa Geol√≥gico Topogr√°fico',
                'Camera': 'C√°mara - An√°lisis Fotogeol√≥gico',
                'Visualizations': 'Visualizaci√≥n - Gr√°ficos 2D',
                'AI': `IA - Dr. GeoBot ${isDrGeoBotActive ? '(Activo)' : '(Inactivo)'}`
            };
            
            if (titles[pageId]) {
                document.title = `AtacamApp - ${titles[pageId]}`;
            }
            
            // Acciones espec√≠ficas por p√°gina
            if (pageId === 'Camera' && !isCameraActive) {
                showNotification('Activa la c√°mara para an√°lisis fotogeol√≥gico üì∏', 'info');
            } else if (pageId === 'AI' && !isDrGeoBotActive) {
                showNotification('Activa Dr. GeoBot para consultas IA ü§ñ', 'info');
            } else if (pageId === 'Visualizations') {
                updateCharts();
            }
        }

        function addMessageToChat(sender, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = text;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageId;
        }

        function updateMessage(messageId, text) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.innerHTML = text;
            }
        }

        function updateDatabaseCounts() {
            if (mineralDatabase) {
                document.getElementById('mineralCountValue').textContent = `${countMinerals()} minerales`;
                document.getElementById('locationCount').textContent = `${countLocalities()} localidades`;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('es-CL');
            }
        }

        // ============================================
        // GPS Y LOCALIZACI√ìN
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                showNotification('GPS no disponible en este dispositivo ‚ùå', 'error');
                return;
            }

            showNotification('Obteniendo ubicaci√≥n GPS de alta precisi√≥n... üõ∞Ô∏è', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                handleGPSPosition,
                handleGPSError,
                options
            );
        }

        function handleGPSPosition(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                altitude: position.coords.altitude || 0,
                accuracy: position.coords.accuracy,
                heading: position.coords.heading || 0,
                speed: position.coords.speed || 0,
                timestamp: new Date(position.timestamp)
            };

            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfoWithAI();
            
            const accuracy = Math.round(currentLocation.accuracy);
            if (accuracy < 20) {
                showNotification(`üìç GPS de alta precisi√≥n obtenido (${accuracy}m) üéØ`, 'success');
            } else if (accuracy < 50) {
                showNotification(`üìç Ubicaci√≥n GPS obtenida (${accuracy}m) ‚úÖ`, 'success');
            } else {
                showNotification(`üìç Ubicaci√≥n aproximada obtenida (${accuracy}m) ‚ö†Ô∏è`, 'warning');
            }
            
            // Notificar a Dr. GeoBot si est√° activo
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç UBICACI√ìN ACTUALIZADA CON GPS:</strong><br><br>
                    <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞<br>
                    <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}<br>
                    <strong>Regi√≥n:</strong> ${getRegionFromLocation()}<br>
                    <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m<br>
                    <strong>Ciudad cercana:</strong> ${document.getElementById('cityValue').textContent}<br><br>
                    <em>¬øQuieres un an√°lisis geol√≥gico detallado de esta zona?</em>`);
                }, 800);
            }
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            let message = 'Error de GPS ‚ùå';
            switch(error.code) {
                case 1: message = 'Permiso de ubicaci√≥n denegado üîí'; break;
                case 2: message = 'Ubicaci√≥n no disponible üì°'; break;
                case 3: message = 'Tiempo de espera agotado ‚è∞'; break;
            }
            
            showNotification(message, 'warning');
            
            // Ubicaci√≥n por defecto (Desierto de Atacama)
            currentLocation = {
                latitude: CONFIG.DEFAULT_LOCATION.lat,
                longitude: CONFIG.DEFAULT_LOCATION.lng,
                accuracy: 5000,
                altitude: 2400,
                timestamp: new Date()
            };
            
            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfoWithAI();
        }

        async function updateGeologyInfoWithAI() {
            if (!currentLocation) return;

            const region = getRegionFromLocation();
            
            // Mostrar informaci√≥n b√°sica mientras se carga IA
            let html = `<div class="data-row">
                <span>Regi√≥n:</span>
                <span><strong>${region}</strong></span>
            </div>`;
            
            html += `<div class="data-row">
                <span>Coordenadas:</span>
                <span>${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞</span>
            </div>`;
            
            html += `<div class="data-row">
                <span>Consultando DeepSeek IA...</span>
                <span><div class="loading"></div></span>
            </div>`;
            
            document.getElementById('geologyInfo').innerHTML = html;
            document.getElementById('dataAccuracy').textContent = 'Consultando IA';

            // Si Dr. GeoBot est√° activo, usar IA para an√°lisis detallado
            if (isDrGeoBotActive) {
                try {
                    const prompt = `Analiza la geolog√≠a de la ubicaci√≥n: ${currentLocation.latitude}, ${currentLocation.longitude} en el Desierto de Atacama. Proporciona informaci√≥n sobre:
1. Contexto geol√≥gico regional
2. Minerales esperados
3. Estructuras geol√≥gicas
4. Tipo de roca probable
5. Recomendaciones de muestreo

Responde en formato HTML conciso para mostrar en una aplicaci√≥n.`;
                    
                    const response = await callDeepSeekAPI(prompt);
                    
                    // Parsear la respuesta para mostrar en formato de datos
                    html = parseAIResponseToDataRows(response);
                    
                } catch (error) {
                    console.error('Error consultando IA:', error);
                    html = generateLocalGeologyInfo();
                }
            } else {
                html = generateLocalGeologyInfo();
            }
            
            document.getElementById('geologyInfo').innerHTML = html;
            document.getElementById('dataAccuracy').textContent = isDrGeoBotActive ? 'DeepSeek IA' : 'Base Local';
        }

        function parseAIResponseToDataRows(aiResponse) {
            // Extraer informaci√≥n clave de la respuesta de IA
            const lines = aiResponse.split('\n').filter(line => line.trim());
            
            let html = '';
            let count = 0;
            
            for (const line of lines) {
                if (count >= 5) break; // Mostrar m√°ximo 5 l√≠neas
                
                // Buscar patrones de datos
                if (line.includes(':')) {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        const label = parts[0].trim().replace('*', '').replace('-', '');
                        const value = parts.slice(1).join(':').trim();
                        
                        if (label && value && label.length < 30) {
                            html += `<div class="data-row">
                                <span>${label}:</span>
                                <span>${value}</span>
                            </div>`;
                            count++;
                        }
                    }
                } else if (line.includes('-')) {
                    const cleanLine = line.replace('*', '').replace('-', '').trim();
                    if (cleanLine.length > 0 && cleanLine.length < 50) {
                        html += `<div class="data-row">
                            <span>${getRandomGeologyIcon()}</span>
                            <span>${cleanLine}</span>
                        </div>`;
                        count++;
                    }
                }
            }
            
            if (count === 0) {
                return generateLocalGeologyInfo();
            }
            
            return html;
        }

        function getRandomGeologyIcon() {
            const icons = ['ü™®', 'üíé', '‚ö°', '‚õ∞Ô∏è', 'üß™', 'üî¨', 'üó∫Ô∏è', 'üìç'];
            return icons[Math.floor(Math.random() * icons.length)];
        }

        function generateLocalGeologyInfo() {
            if (!currentLocation) return '';

            const region = getRegionFromLocation();
            const regionData = mineralDatabase[region];
            
            let html = '';
            
            if (regionData) {
                html += `<div class="data-row">
                    <span>Regi√≥n:</span>
                    <span><strong>${region}</strong></span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Mineral principal:</span>
                    <span>${regionData.minerals[0].emoji} ${regionData.minerals[0].name}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Yacimiento cercano:</span>
                    <span>${regionData.localities[0]}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Contexto geol√≥gico:</span>
                    <span>${getGeologicalContext()}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Fuente de datos:</span>
                    <span>Base local (${countMinerals()} minerales)</span>
                </div>`;
            } else {
                html = `<div class="data-row">
                    <span>Ubicaci√≥n:</span>
                    <span><strong>Desierto de Atacama</strong></span>
                </div>
                <div class="data-row">
                    <span>Minerales t√≠picos:</span>
                    <span>üíé Calcopirita üíö Atacamita üî¥ Hematita</span>
                </div>
                <div class="data-row">
                    <span>Actividad principal:</span>
                    <span>‚ö° Miner√≠a de cobre</span>
                </div>
                <div class="data-row">
                    <span>Clima:</span>
                    <span>üèúÔ∏è √Årido extremo</span>
                </div>
                <div class="data-row">
                    <span>Fuente de datos:</span>
                    <span>Base local</span>
                </div>`;
            }
            
            return html;
        }

        function updateLocationDisplay() {
            if (!currentLocation) return;

            document.getElementById('latitudeValue').textContent = currentLocation.latitude.toFixed(6);
            document.getElementById('longitudeValue').textContent = currentLocation.longitude.toFixed(6);
            document.getElementById('altitudeValue').textContent = 
                currentLocation.altitude ? `${Math.round(currentLocation.altitude)}m` : '--';
            
            // Determinar ciudad m√°s cercana
            const cities = [
                { name: "Antofagasta", lat: -23.650, lng: -70.400 },
                { name: "Calama", lat: -22.456, lng: -68.924 },
                { name: "Tocopilla", lat: -22.092, lng: -70.198 },
                { name: "Mejillones", lat: -23.100, lng: -70.450 },
                { name: "Copiap√≥", lat: -27.366, lng: -70.332 },
                { name: "Vallenar", lat: -28.576, lng: -70.759 },
                { name: "Caldera", lat: -27.067, lng: -70.817 },
                { name: "San Pedro", lat: -22.911, lng: -68.201 },
                { name: "Sierra Gorda", lat: -22.883, lng: -69.317 }
            ];
            
            let closestCity = "Desierto";
            let minDistance = Infinity;
            
            cities.forEach(city => {
                const distance = Math.sqrt(
                    Math.pow(city.lat - currentLocation.latitude, 2) + 
                    Math.pow(city.lng - currentLocation.longitude, 2)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestCity = city.name;
                }
            });
            
            document.getElementById('cityValue').textContent = closestCity;
        }

        // ============================================
        // MAPA 2D TOPOGR√ÅFICO
        // ============================================
        function init2DMap() {
            try {
                map = L.map('map').setView(
                    [CONFIG.DEFAULT_LOCATION.lat, CONFIG.DEFAULT_LOCATION.lng],
                    CONFIG.DEFAULT_LOCATION.zoom
                );

                // Capa topogr√°fica por defecto
                L.tileLayer(CONFIG.MAP_LAYERS.topo, {
                    attribution: '¬© OpenTopoMap',
                    maxZoom: 17
                }).addTo(map);

                // Capa de geolog√≠a (inicialmente oculta)
                const geologyLayer = L.tileLayer(CONFIG.MAP_LAYERS.geology, {
                    attribution: '¬© Servicio Geol√≥gico',
                    maxZoom: 15,
                    opacity: 0.7
                });

                markersLayer = L.layerGroup().addTo(map);
                routeLayer = L.layerGroup().addTo(map);

                // A√±adir puntos de inter√©s geol√≥gicos iniciales
                addInitialGeologyPoints();

                // Configurar controles del mapa
                document.getElementById('mapTopoBtn').classList.add('active');

                console.log('‚úÖ Mapa 2D topogr√°fico del Desierto de Atacama inicializado');

            } catch (error) {
                console.error('Error inicializando mapa:', error);
                showNotification('Error al cargar el mapa ‚ùå', 'error');
            }
        }

        function addInitialGeologyPoints() {
            const geologyPoints = [
                // Antofagasta
                { lat: -22.285, lng: -68.905, type: 'mine', emoji: '‚õèÔ∏è', name: 'Chuquicamata', details: 'Mina de cobre a cielo abierto m√°s grande del mundo' },
                { lat: -24.271, lng: -69.081, type: 'mine', emoji: '‚õèÔ∏è', name: 'Escondida', details: 'Mayor productora de cobre del mundo' },
                { lat: -20.971, lng: -68.660, type: 'mine', emoji: '‚õèÔ∏è', name: 'Collahuasi', details: 'Mina de cobre porf√≠rico' },
                { lat: -26.485, lng: -69.779, type: 'mine', emoji: '‚õèÔ∏è', name: 'El Salvador', details: 'Mina de cobre subterr√°nea' },
                
                // Atacama
                { lat: -27.367, lng: -70.333, type: 'sample', emoji: 'üî¨', name: '√Årea de Muestreo Copiap√≥', details: 'Zona de muestreo geol√≥gico' },
                { lat: -28.576, lng: -70.759, type: 'sample', emoji: 'üî¨', name: '√Årea Vallenar', details: 'Zona de vetas epitermales' },
                { lat: -27.823, lng: -70.503, type: 'mine', emoji: '‚õèÔ∏è', name: 'Candelaria', details: 'Mina de cobre-oro' },
                { lat: -28.150, lng: -70.683, type: 'mine', emoji: '‚õèÔ∏è', name: 'Cerro Negro', details: 'Proyecto de oro y plata' },
                
                // Ciudades
                { lat: -23.650, lng: -70.400, type: 'city', emoji: 'üèôÔ∏è', name: 'Antofagasta', details: 'Capital minera de Chile' },
                { lat: -22.456, lng: -68.924, type: 'city', emoji: 'üèôÔ∏è', name: 'Calama', details: 'Ciudad minera' },
                { lat: -27.366, lng: -70.332, type: 'city', emoji: 'üèôÔ∏è', name: 'Copiap√≥', details: 'Capital de la Regi√≥n de Atacama' },
                { lat: -28.576, lng: -70.759, type: 'city', emoji: 'üèôÔ∏è', name: 'Vallenar', details: 'Ciudad minera' }
            ];

            geologyPoints.forEach(point => {
                L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        html: `<div style="background: ${getColorForType(point.type)}; color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.3rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${point.emoji}</div>`,
                        iconSize: [40, 40]
                    })
                })
                .bindPopup(`<div style="background: rgba(255,248,220,0.95); padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border); max-width: 250px;">
                    <strong>${point.emoji} ${point.name}</strong><br>
                    <small>Tipo: ${point.type}</small><br><br>
                    ${point.details}<br><br>
                    <small>Coordenadas: ${point.lat.toFixed(4)}¬∞, ${point.lng.toFixed(4)}¬∞</small>
                </div>`)
                .addTo(markersLayer);
            });
        }

        function getColorForType(type) {
            switch(type) {
                case 'mine': return '#D4A017';
                case 'sample': return '#228B22';
                case 'city': return '#4682B4';
                case 'fault': return '#DC143C';
                case 'mineral': return '#8B4513';
                default: return '#8B4513';
            }
        }

        function updateMapLocation() {
            if (!map || !currentLocation) return;

            const latLng = [currentLocation.latitude, currentLocation.longitude];
            
            map.flyTo(latLng, 15, {
                duration: 2
            });

            // Marcador de ubicaci√≥n actual
            L.marker(latLng, {
                icon: L.divIcon({
                    className: 'current-location',
                    html: `<div style="background: linear-gradient(135deg, #D4A017, #8B4513); color:white; width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:3px solid white; font-size:1.5rem; box-shadow: 0 6px 20px rgba(0,0,0,0.4);">üìç</div>`,
                    iconSize: [48, 48]
                })
            }).addTo(markersLayer).bindPopup(`<div style="background: rgba(255,248,220,0.95); padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border);">
                <strong>üìç Tu ubicaci√≥n actual</strong><br><br>
                <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m<br>
                <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}<br>
                <strong>Regi√≥n:</strong> ${getRegionFromLocation()}<br><br>
                <small>${new Date().toLocaleTimeString('es-CL')}</small>
            </div>`).openPopup();

            // C√≠rculo de precisi√≥n
            L.circle(latLng, {
                color: 'rgba(212, 160, 23, 0.4)',
                fillColor: 'rgba(212, 160, 23, 0.2)',
                radius: currentLocation.accuracy,
                weight: 2
            }).addTo(map);
        }

        // ============================================
        // GR√ÅFICOS 2D
        // ============================================
        function initCharts() {
            // Gr√°fico 1: Distribuci√≥n de Minerales
            const mineralsCtx = document.getElementById('mineralsChart').getContext('2d');
            charts.minerals = new Chart(mineralsCtx, {
                type: 'pie',
                data: {
                    labels: ['Sulfuros', '√ìxidos', 'Carbonatos', 'Silicatos', 'Otros'],
                    datasets: [{
                        data: [35, 25, 15, 15, 10],
                        backgroundColor: [
                            '#D4A017', // Oro
                            '#DC143C', // Rojo
                            '#228B22', // Verde
                            '#8B4513', // Marr√≥n
                            '#4682B4'  // Azul
                        ],
                        borderWidth: 2,
                        borderColor: 'rgba(255, 248, 220, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'var(--text-primary)',
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });

            // Gr√°fico 2: Orientaci√≥n de Fallas
            const structuresCtx = document.getElementById('structuresChart').getContext('2d');
            charts.structures = new Chart(structuresCtx, {
                type: 'polarArea',
                data: {
                    labels: ['NNE-SSO', 'E-O', 'NW-SE', 'N-S', 'NE-SW'],
                    datasets: [{
                        data: [40, 25, 15, 12, 8],
                        backgroundColor: [
                            'rgba(212, 160, 23, 0.7)',
                            'rgba(220, 20, 60, 0.7)',
                            'rgba(34, 139, 34, 0.7)',
                            'rgba(70, 130, 180, 0.7)',
                            'rgba(139, 69, 19, 0.7)'
                        ],
                        borderWidth: 2,
                        borderColor: 'rgba(255, 248, 220, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'var(--text-primary)',
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        r: {
                            ticks: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Gr√°fico 3: Perfil Topogr√°fico
            const elevationCtx = document.getElementById('elevationChart').getContext('2d');
            charts.elevation = new Chart(elevationCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 20}, (_, i) => `${i * 100}m`),
                    datasets: [{
                        label: 'Elevaci√≥n',
                        data: [2400, 2450, 2500, 2550, 2600, 2650, 2700, 2750, 2800, 2850, 2900, 2850, 2800, 2750, 2700, 2650, 2600, 2550, 2500, 2450],
                        borderColor: '#8B4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Altitud (m)',
                                color: 'var(--text-primary)'
                            },
                            grid: {
                                color: 'rgba(139, 69, 19, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Distancia',
                                color: 'var(--text-primary)'
                            },
                            grid: {
                                color: 'rgba(139, 69, 19, 0.1)'
                            }
                        }
                    }
                }
            });

            // Gr√°fico 4: Diagrama Geoqu√≠mico
            const geochemistryCtx = document.getElementById('geochemistryChart').getContext('2d');
            charts.geochemistry = new Chart(geochemistryCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cu vs Au',
                        data: [
                            {x: 0.5, y: 0.1},
                            {x: 1.2, y: 0.3},
                            {x: 2.1, y: 0.8},
                            {x: 3.5, y: 1.2},
                            {x: 5.0, y: 2.1},
                            {x: 7.2, y: 3.5},
                            {x: 10.5, y: 5.0}
                        ],
                        backgroundColor: '#D4A017',
                        borderColor: '#8B4513',
                        borderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Au (g/t)',
                                color: 'var(--text-primary)'
                            },
                            grid: {
                                color: 'rgba(139, 69, 19, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Cu (%)',
                                color: 'var(--text-primary)'
                            },
                            grid: {
                                color: 'rgba(139, 69, 19, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Actualizar datos seg√∫n el gr√°fico activo
            switch(activeChart) {
                case 'minerals':
                    // Actualizar datos de minerales seg√∫n ubicaci√≥n
                    if (currentLocation) {
                        const region = getRegionFromLocation();
                        const regionData = mineralDatabase[region];
                        
                        if (regionData) {
                            // Contar minerales por tipo
                            const typeCount = {};
                            regionData.minerals.forEach(mineral => {
                                typeCount[mineral.type] = (typeCount[mineral.type] || 0) + 1;
                            });
                            
                            // Actualizar gr√°fico
                            const labels = Object.keys(typeCount);
                            const data = Object.values(typeCount);
                            
                            charts.minerals.data.labels = labels;
                            charts.minerals.data.datasets[0].data = data;
                            charts.minerals.update();
                        }
                    }
                    break;
                    
                case 'structures':
                    // Generar datos aleatorios de orientaci√≥n
                    const orientations = ['NNE-SSO', 'E-O', 'NW-SE', 'N-S', 'NE-SW'];
                    const newData = orientations.map(() => Math.floor(Math.random() * 40) + 10);
                    
                    charts.structures.data.datasets[0].data = newData;
                    charts.structures.update();
                    break;
                    
                case 'elevation':
                    // Actualizar perfil topogr√°fico seg√∫n altitud actual
                    if (currentLocation && currentLocation.altitude) {
                        const baseAlt = Math.floor(currentLocation.altitude / 100) * 100;
                        const newElevationData = Array.from({length: 20}, (_, i) => {
                            const variation = Math.sin(i * 0.5) * 300;
                            return baseAlt + variation + (Math.random() * 100 - 50);
                        });
                        
                        charts.elevation.data.datasets[0].data = newElevationData;
                        charts.elevation.update();
                    }
                    break;
                    
                case 'geochemistry':
                    // Actualizar datos geoqu√≠micos
                    const newGeochemData = Array.from({length: 10}, (_, i) => ({
                        x: Math.random() * 15,
                        y: Math.random() * 10
                    }));
                    
                    charts.geochemistry.data.datasets[0].data = newGeochemData;
                    charts.geochemistry.update();
                    break;
            }
        }

        // ============================================
        // FUNCIONES DE RUTA
        // ============================================
        function toggleDrawRouteMode() {
            drawRouteMode = !drawRouteMode;
            const drawRouteBtn = document.getElementById('drawRouteBtn');
            
            if (drawRouteMode) {
                drawRouteBtn.classList.add('active');
                showNotification('Modo dibujo de ruta activado. Haz clic en el mapa para agregar puntos. üîÑ', 'info');
                
                // Configurar evento de clic en el mapa
                map.on('click', handleMapClickForRoute);
            } else {
                drawRouteBtn.classList.remove('active');
                showNotification('Modo dibujo de ruta desactivado. ‚èπÔ∏è', 'info');
                map.off('click', handleMapClickForRoute);
            }
        }

        function handleMapClickForRoute(e) {
            if (!drawRouteMode) return;
            
            const point = e.latlng;
            routePoints.push(point);
            
            // Agregar marcador de punto
            L.marker(point, {
                icon: L.divIcon({
                    html: `<div style="background: #228B22; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; border:2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${routePoints.length}</div>`,
                    iconSize: [24, 24]
                })
            }).addTo(routeLayer);
            
            // Actualizar l√≠nea de ruta
            updateRouteLine();
            
            // Actualizar informaci√≥n de ruta
            updateRouteInfo();
            
            showNotification(`Punto ${routePoints.length} agregado a la ruta. üìç`, 'success');
        }

        function updateRouteLine() {
            // Limpiar ruta anterior
            routeLayer.clearLayers();
            
            // Volver a agregar marcadores
            routePoints.forEach((point, index) => {
                L.marker(point, {
                    icon: L.divIcon({
                        html: `<div style="background: #228B22; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; border:2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${index + 1}</div>`,
                        iconSize: [24, 24]
                    })
                }).addTo(routeLayer);
            });
            
            // Dibujar l√≠nea si hay al menos 2 puntos
            if (routePoints.length >= 2) {
                const routeLine = L.polyline(routePoints, {
                    color: '#228B22',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 10'
                }).addTo(routeLayer);
            }
        }

        function updateRouteInfo() {
            const routeInfo = document.getElementById('routeInfo');
            
            if (routePoints.length === 0) {
                routeInfo.style.display = 'none';
                return;
            }
            
            // Calcular distancia total
            let totalDistance = 0;
            for (let i = 1; i < routePoints.length; i++) {
                totalDistance += map.distance(routePoints[i-1], routePoints[i]);
            }
            
            // Mostrar informaci√≥n
            document.getElementById('routeLength').textContent = `${(totalDistance / 1000).toFixed(2)} km`;
            document.getElementById('routePoints').textContent = `${routePoints.length} puntos`;
            routeInfo.style.display = 'block';
        }

        function downloadRoute() {
            if (routePoints.length === 0) {
                showNotification('No hay ruta para exportar. Primero traza una ruta. ‚ö†Ô∏è', 'warning');
                return;
            }

            showNotification('Exportando ruta... üì§', 'info');

            setTimeout(() => {
                const routeData = {
                    name: `Ruta_Geologica_${new Date().toISOString().slice(0,10)}`,
                    points: routePoints.map((point, index) => ({
                        id: index + 1,
                        lat: point.lat,
                        lng: point.lng,
                        elevation: currentLocation ? currentLocation.altitude : 0
                    })),
                    metadata: {
                        totalPoints: routePoints.length,
                        totalDistance: document.getElementById('routeLength').textContent,
                        date: new Date().toISOString(),
                        region: getRegionFromLocation(),
                        app: "AtacamApp"
                    },
                    geology: {
                        region: getRegionFromLocation(),
                        expectedMinerals: getExpectedMineralization(),
                        context: getGeologicalContext()
                    }
                };

                // Crear archivo KML para Google Earth
                const kmlContent = generateKML(routeData);
                const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ruta_geologica_${new Date().toISOString().slice(0,10)}.kml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ Ruta exportada en formato KML', 'success');
            }, 1000);
        }

        function generateKML(routeData) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${routeData.name}</name>
    <description>Ruta geol√≥gica generada por AtacamApp</description>
    
    <Style id="routeStyle">
      <LineStyle>
        <color>ff00ff00</color>
        <width>4</width>
      </LineStyle>
      <PolyStyle>
        <color>7f00ff00</color>
      </PolyStyle>
    </Style>
    
    <Placemark>
      <name>Ruta Geol√≥gica</name>
      <description>${routeData.geology.context}</description>
      <styleUrl>#routeStyle</styleUrl>
      <LineString>
        <extrude>1</extrude>
        <tessellate>1</tessellate>
        <altitudeMode>relativeToGround</altitudeMode>
        <coordinates>\n`;
            
            // Agregar coordenadas
            routeData.points.forEach(point => {
                kml += `          ${point.lng},${point.lat},${point.elevation || 0}\n`;
            });
            
            kml += `        </coordinates>
      </LineString>
    </Placemark>
    
    <!-- Puntos de la ruta -->
`;
            
            // Agregar puntos individuales
            routeData.points.forEach(point => {
                kml += `    <Placemark>
      <name>Punto ${point.id}</name>
      <Point>
        <coordinates>${point.lng},${point.lat},${point.elevation || 0}</coordinates>
      </Point>
    </Placemark>\n`;
            });
            
            kml += `  </Document>
</kml>`;
            
            return kml;
        }

        function clearRoute() {
            routePoints = [];
            routeLayer.clearLayers();
            updateRouteInfo();
            showNotification('Ruta eliminada. ‚úÖ', 'success');
        }

        // ============================================
        // CAPAS GEOL√ìGICAS 2D
        // ============================================
        function generateGeologyLayers() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS para generar capas. üìç', 'warning');
                return;
            }

            showNotification('Generando capas geol√≥gicas 2D... üó∫Ô∏è', 'info');

            setTimeout(() => {
                // Simular generaci√≥n de capas
                const html = `
                    <div class="data-row">
                        <span>ü™® Mapa Litol√≥gico:</span>
                        <span><span class="badge success">Generado</span></span>
                    </div>
                    <div class="data-row">
                        <span>‚ö° Sistema de Fallas:</span>
                        <span><span class="badge success">Generado</span></span>
                    </div>
                    <div class="data-row">
                        <span>üíé Yacimientos Minerales:</span>
                        <span><span class="badge success">Generado</span></span>
                    </div>
                    <div class="data-row">
                        <span>üìä Contornos Topogr√°ficos:</span>
                        <span><span class="badge warning">En progreso</span></span>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(139, 69, 19, 0.2)); border-radius: 12px; border: 2px solid rgba(212, 160, 23, 0.3); font-size: 0.85rem;">
                        <strong>üìù RESUMEN DE CAPAS:</strong><br>
                        ‚Ä¢ √Årea cubierta: 5km x 5km<br>
                        ‚Ä¢ Resoluci√≥n: 10m/pixel<br>
                        ‚Ä¢ Datum: WGS84<br>
                        ‚Ä¢ Proyecci√≥n: UTM 19S<br>
                        ‚Ä¢ Capas activas: 3/4<br>
                        <em>Listo para exportar en PNG</em>
                    </div>
                `;

                document.getElementById('structuralParams').innerHTML = html;
                showNotification('‚úÖ Capas geol√≥gicas 2D generadas', 'success');
                
                // Habilitar bot√≥n de exportaci√≥n
                document.getElementById('exportLayers').disabled = false;
            }, 2000);
        }

        function exportLayersAsPNG() {
            if (!currentLocation) {
                showNotification('Primero genera las capas. üó∫Ô∏è', 'warning');
                return;
            }

            showNotification('Exportando capas geol√≥gicas en PNG... üì•', 'info');

            setTimeout(() => {
                // Crear canvas para exportaci√≥n
                const canvas = document.createElement('canvas');
                canvas.width = 1920;
                canvas.height = 1080;
                const ctx = canvas.getContext('2d');
                
                // Fondo
                ctx.fillStyle = 'rgba(255, 248, 220, 0.9)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // T√≠tulo
                ctx.fillStyle = '#2F4F4F';
                ctx.font = 'bold 40px Arial';
                ctx.fillText('Mapa Geol√≥gico - AtacamApp', 100, 80);
                
                // Informaci√≥n
                ctx.font = '20px Arial';
                ctx.fillText(`Regi√≥n: ${getRegionFromLocation()}`, 100, 130);
                ctx.fillText(`Coordenadas: ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞`, 100, 160);
                ctx.fillText(`Fecha: ${new Date().toLocaleDateString('es-CL')}`, 100, 190);
                
                // Leyenda
                const legendItems = [
                    {color: '#D4A017', label: 'Litolog√≠a - Intrusivos'},
                    {color: '#8B4513', label: 'Litolog√≠a - Volc√°nicas'},
                    {color: '#228B22', label: 'Litolog√≠a - Sedimentarias'},
                    {color: '#DC143C', label: 'Fallas Principales'},
                    {color: '#4682B4', label: 'Yacimientos Minerales'}
                ];
                
                let yPos = 250;
                legendItems.forEach(item => {
                    ctx.fillStyle = item.color;
                    ctx.fillRect(100, yPos - 15, 30, 30);
                    ctx.fillStyle = '#2F4F4F';
                    ctx.font = '18px Arial';
                    ctx.fillText(item.label, 150, yPos);
                    yPos += 40;
                });
                
                // Escala
                ctx.fillStyle = '#2F4F4F';
                ctx.font = '16px Arial';
                ctx.fillText('Escala 1:25,000', canvas.width - 200, canvas.height - 50);
                ctx.fillText('0______1km', canvas.width - 200, canvas.height - 30);
                
                // Crear imagen y descargar
                const image = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = image;
                a.download = `mapa_geologico_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showNotification('‚úÖ Capas geol√≥gicas exportadas en PNG', 'success');
            }, 1500);
        }

        // ============================================
        // C√ÅMARA Y AN√ÅLISIS
        // ============================================
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraFeed');
                video.srcObject = cameraStream;

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                isCameraActive = true;
                updateCameraControls(true);
                showNotification('‚úÖ C√°mara activada para an√°lisis fotogeol√≥gico üì∏', 'success');

            } catch (error) {
                console.error('Error c√°mara:', error);
                showNotification('‚ùå Error al activar c√°mara. Verifica permisos.', 'error');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('cameraFeed');
            video.srcObject = null;
            isCameraActive = false;
            updateCameraControls(false);
            showNotification('C√°mara detenida ‚èπÔ∏è', 'info');
        }

        function updateCameraControls(active) {
            document.getElementById('startCameraBtn').disabled = active;
            document.getElementById('captureBtn').disabled = !active;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = !active;
            
            const statusText = document.getElementById('cameraStatusText');
            statusText.innerHTML = active ? 
                '<span>üü¢</span> C√°mara activa' :
                '<span>üî¥</span> C√°mara inactiva';
        }

        function capturePhoto() {
            if (!isCameraActive) return;

            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            currentPhoto = {
                data: canvas.toDataURL('image/jpeg'),
                timestamp: new Date().toISOString(),
                location: currentLocation,
                width: canvas.width,
                height: canvas.height
            };

            document.getElementById('analyzeBtn').disabled = false;
            showNotification('‚úÖ ¬°Foto capturada! Ahora analiza con DeepSeek IA ü§ñ', 'success');
        }

        async function analyzePhotoWithAI() {
            if (!currentPhoto) {
                showNotification('Primero captura una imagen üì∏', 'warning');
                return;
            }

            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            showNotification('Analizando imagen con DeepSeek AI... üîç', 'info');

            try {
                // Para an√°lisis de im√°genes necesitar√≠as la API de visi√≥n de DeepSeek
                // Por ahora simulamos una respuesta
                setTimeout(() => {
                    const analysisHTML = `
                        <div class="data-row">
                            <span>Tipo identificado:</span>
                            <span>ü™® Andesita porf√≠rica</span>
                        </div>
                        <div class="data-row">
                            <span>Mineral principal:</span>
                            <span>üíé Plagioclasa + Hornblenda</span>
                        </div>
                        <div class="data-row">
                            <span>Estructura:</span>
                            <span>‚ö° Disyunci√≥n columnar</span>
                        </div>
                        <div class="data-row">
                            <span>Alteraci√≥n:</span>
                            <span>üíö Clor√≠tica + Epidota</span>
                        </div>
                        <div class="data-row">
                            <span>Confianza IA:</span>
                            <span>üéØ 94%</span>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(70, 130, 180, 0.25), rgba(100, 149, 237, 0.25)); border-radius: 12px; border: 2px solid rgba(70, 130, 180, 0.4); font-size: 0.85rem;">
                            <strong>üë®‚Äçüî¨ Dr. GeoBot recomienda:</strong><br>
                            ‚Ä¢ Realizar an√°lisis petrogr√°fico<br>
                            ‚Ä¢ Tomar muestra para geoqu√≠mica<br>
                            ‚Ä¢ Medir orientaci√≥n de columnas<br>
                            ‚Ä¢ Buscar mineralizaci√≥n de Cu-Au en vetas
                        </div>
                    `;

                    document.getElementById('analysisResults').innerHTML = analysisHTML;
                    showNotification('‚úÖ An√°lisis IA completado con DeepSeek', 'success');
                    
                    // Agregar al chat
                    if (isDrGeoBotActive) {
                        setTimeout(() => {
                            addMessageToChat('ai', `<strong>üì∏ AN√ÅLISIS FOTOGEOL√ìGICO CON DEEPSEEK AI:</strong><br><br>
                            <strong>Resultados del an√°lisis:</strong><br>
                            ‚Ä¢ ü™® Roca: Andesita porf√≠rica<br>
                            ‚Ä¢ üíé Minerales: Plagioclasa + Hornblenda<br>
                            ‚Ä¢ ‚ö° Estructura: Disyunci√≥n columnar<br>
                            ‚Ä¢ üíö Alteraci√≥n: Clor√≠tica + Epidota<br>
                            ‚Ä¢ üéØ Confianza: 94%<br><br>
                            <strong>Recomendaciones:</strong><br>
                            1. An√°lisis petrogr√°fico detallado<br>
                            2. Muestra para an√°lisis geoqu√≠mico<br>
                            3. Mediciones estructurales<br>
                            4. B√∫squeda de vetas mineralizadas`);
                        }, 500);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error en an√°lisis IA:', error);
                showNotification('‚ùå Error en an√°lisis con IA', 'error');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Botones GPS
            document.getElementById('updateLocationBtn').addEventListener('click', startGPS);
            
            // Botones de mapa
            document.getElementById('addPointBtn').addEventListener('click', addGeologyPoint);
            document.getElementById('addSampleBtn').addEventListener('click', addSamplePoint);
            document.getElementById('clearMapBtn').addEventListener('click', clearAllPoints);
            document.getElementById('drawRouteBtn').addEventListener('click', toggleDrawRouteMode);
            document.getElementById('downloadRouteBtn').addEventListener('click', downloadRoute);
            document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
            
            // Controles de mapa
            document.getElementById('mapTopoBtn').addEventListener('click', () => {
                switchMapLayer('topo');
                document.getElementById('mapTopoBtn').classList.add('active');
                document.getElementById('mapSatelliteBtn').classList.remove('active');
                document.getElementById('mapGeologyBtn').classList.remove('active');
            });
            
            document.getElementById('mapSatelliteBtn').addEventListener('click', () => {
                switchMapLayer('satellite');
                document.getElementById('mapSatelliteBtn').classList.add('active');
                document.getElementById('mapTopoBtn').classList.remove('active');
                document.getElementById('mapGeologyBtn').classList.remove('active');
            });
            
            document.getElementById('mapGeologyBtn').addEventListener('click', () => {
                switchMapLayer('geology');
                document.getElementById('mapGeologyBtn').classList.add('active');
                document.getElementById('mapTopoBtn').classList.remove('active');
                document.getElementById('mapSatelliteBtn').classList.remove('active');
            });
            
            // Botones c√°mara
            document.getElementById('startCameraBtn').addEventListener('click', startCamera);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('analyzeBtn').addEventListener('click', analyzePhotoWithAI);
            
            // Botones visualizaci√≥n
            document.getElementById('generateLayers').addEventListener('click', generateGeologyLayers);
            document.getElementById('exportLayers').addEventListener('click', exportLayersAsPNG);
            
            // Capas
            document.querySelectorAll('.layers-panel input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateLayerStatus);
            });
            
            // IA
            document.getElementById('sendMessage').addEventListener('click', sendMessageToAI);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessageToAI();
            });
            document.getElementById('analyzeLocation').addEventListener('click', () => {
                if (currentLocation) {
                    addMessageToChat('user', 'Analiza la geolog√≠a de mi ubicaci√≥n actual con todos los detalles posibles');
                    setTimeout(sendMessageToAI, 100);
                } else {
                    showNotification('Primero activa el GPS üìç', 'warning');
                }
            });
            document.getElementById('identifyMineral').addEventListener('click', () => {
                addMessageToChat('user', '¬øQu√© minerales puedo encontrar en esta zona del Desierto de Atacama seg√∫n la base de datos de 50+ minerales?');
                setTimeout(sendMessageToAI, 100);
            });
            document.getElementById('getGeologyReport').addEventListener('click', () => {
                addMessageToChat('user', 'Genera un reporte geol√≥gico completo de la regi√≥n actual con recomendaciones de campo');
                setTimeout(sendMessageToAI, 100);
            });
            
            // FAB
            document.getElementById('fabButton').addEventListener('click', handleFABClick);
        }

        function switchMapLayer(layerName) {
            if (map) {
                // Eliminar todas las capas de tiles
                map.eachLayer((layer) => {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                // Agregar nueva capa
                let newLayer;
                if (layerName === 'geology') {
                    newLayer = L.tileLayer(CONFIG.MAP_LAYERS[layerName], {
                        attribution: '¬© Servicio Geol√≥gico',
                        maxZoom: 15,
                        opacity: 0.7
                    }).addTo(map);
                    
                    // Agregar capa topogr√°fica debajo con opacidad
                    L.tileLayer(CONFIG.MAP_LAYERS.topo, {
                        attribution: '¬© OpenTopoMap',
                        maxZoom: 17,
                        opacity: 0.5
                    }).addTo(map);
                } else {
                    newLayer = L.tileLayer(CONFIG.MAP_LAYERS[layerName], {
                        attribution: layerName === 'satellite' ? '¬© Esri' : '¬© OpenTopoMap',
                        maxZoom: layerName === 'satellite' ? 19 : 17
                    }).addTo(map);
                }
                
                showNotification(`Mapa: ${getLayerName(layerName)}`, 'success');
            }
        }

        function getLayerName(layerName) {
            const names = {
                'topo': 'Topogr√°fico ‚õ∞Ô∏è',
                'satellite': 'Sat√©lite üõ∞Ô∏è',
                'geology': 'Geol√≥gico ü™®'
            };
            return names[layerName] || layerName;
        }

        function addGeologyPoint() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üó∫Ô∏è', 'warning');
                return;
            }

            const geologyTypes = [
                { type: 'contact', emoji: 'üîÑ', name: 'Contacto Litol√≥gico', color: '#8B4513' },
                { type: 'fault', emoji: '‚ö°', name: 'Falla', color: '#DC143C' },
                { type: 'fold', emoji: 'üåÄ', name: 'Pliegue', color: '#4682B4' },
                { type: 'dyke', emoji: 'ü™®', name: 'Dique', color: '#2F4F4F' },
                { type: 'vein', emoji: 'üíé', name: 'Veta', color: '#D4A017' }
            ];
            
            const selectedType = geologyTypes[Math.floor(Math.random() * geologyTypes.length)];
            const time = new Date();
            const name = `${selectedType.name} ${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;

            const marker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: L.divIcon({
                    html: `<div style="background: ${selectedType.color}; color:white; width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.4rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${selectedType.emoji}</div>`,
                    iconSize: [42, 42]
                })
            })
            .bindPopup(`<div style="background: rgba(255,248,220,0.95); padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border); max-width: 250px;">
                <strong>${selectedType.emoji} ${name}</strong><br>
                <small>Tipo: ${selectedType.type}</small><br><br>
                <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞<br>
                <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}<br>
                <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m<br><br>
                <small>${time.toLocaleTimeString('es-CL')}</small>
            </div>`)
            .addTo(markersLayer);

            showNotification(`‚úÖ Punto geol√≥gico "${selectedType.name}" agregado üìç`, 'success');
            
            // Notificar a Dr. GeoBot
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç PUNTO GEOL√ìGICO AGREGADO:</strong><br><br>
                    <strong>Tipo:</strong> ${selectedType.name} ${selectedType.emoji}<br>
                    <strong>Ubicaci√≥n:</strong> ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞<br>
                    <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}<br>
                    <strong>Hora:</strong> ${time.toLocaleTimeString('es-CL')}<br><br>
                    <em>¬øNecesitas an√°lisis espec√≠fico de este punto geol√≥gico?</em>`);
                }, 500);
            }
        }

        function addSamplePoint() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üß™', 'warning');
                return;
            }

            const sampleTypes = [
                { type: 'rock', emoji: 'ü™®', name: 'Muestra de Roca', color: '#8B4513', code: 'ROC' },
                { type: 'mineral', emoji: 'üíé', name: 'Muestra Mineral', color: '#D4A017', code: 'MIN' },
                { type: 'soil', emoji: 'üå±', name: 'Muestra de Suelo', color: '#A0522D', code: 'SOL' },
                { type: 'sediment', emoji: 'üèúÔ∏è', name: 'Sedimento', color: '#DEB887', code: 'SED' }
            ];
            
            const selectedType = sampleTypes[Math.floor(Math.random() * sampleTypes.length)];
            const time = new Date();
            const sampleCode = `${selectedType.code}-${time.getFullYear()}${(time.getMonth()+1).toString().padStart(2,'0')}${time.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;

            const marker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: L.divIcon({
                    html: `<div style="background: ${selectedType.color}; color:white; width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.3rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${selectedType.emoji}</div>`,
                    iconSize: [38, 38]
                })
            })
            .bindPopup(`<div style="background: rgba(255,248,220,0.95); padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border); max-width: 280px;">
                <strong>${selectedType.emoji} ${selectedType.name}</strong><br>
                <small>C√≥digo: ${sampleCode}</small><br><br>
                <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞<br>
                <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}<br>
                <strong>Peso estimado:</strong> 500g<br>
                <strong>Estado:</strong> Fresco<br><br>
                <small>${time.toLocaleTimeString('es-CL')}</small>
            </div>`)
            .addTo(markersLayer);

            showNotification(`‚úÖ Muestra "${sampleCode}" agregada al mapa üß™`, 'success');
            
            // Notificar a Dr. GeoBot
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üß™ MUESTRA GEOL√ìGICA REGISTRADA:</strong><br><br>
                    <strong>C√≥digo:</strong> ${sampleCode}<br>
                    <strong>Tipo:</strong> ${selectedType.name} ${selectedType.emoji}<br>
                    <strong>Ubicaci√≥n:</strong> ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞<br>
                    <strong>Peso:</strong> 500g<br>
                    <strong>Estado:</strong> Fresco<br><br>
                    <em>¬øNecesitas recomendaciones para el an√°lisis de esta muestra?</em>`);
                }, 500);
            }
        }

        function clearAllPoints() {
            markersLayer.clearLayers();
            addInitialGeologyPoints(); // Volver a agregar puntos iniciales
            showNotification('‚úÖ Todos los puntos personalizados eliminados', 'success');
        }

        function updateLayerStatus() {
            const layers = {
                'layerLithology': document.getElementById('layerLithology').checked,
                'layerFaults': document.getElementById('layerFaults').checked,
                'layerDeposits': document.getElementById('layerDeposits').checked,
                'layerContours': document.getElementById('layerContours').checked
            };
            
            const activeLayers = Object.keys(layers).filter(key => layers[key]);
            showNotification(`Capas activas: ${activeLayers.length}/4 ‚úÖ`, 'info');
        }

        function handleFABClick() {
            // Acci√≥n r√°pida seg√∫n la p√°gina activa
            const activePage = document.querySelector('.page.active').id;
            
            switch(activePage) {
                case 'pageDashboard':
                    startGPS();
                    break;
                case 'pageCamera':
                    if (isCameraActive) {
                        capturePhoto();
                    } else {
                        startCamera();
                    }
                    break;
                case 'pageVisualizations':
                    updateCharts();
                    break;
                case 'pageAI':
                    if (isDrGeoBotActive) {
                        const input = document.getElementById('chatInput');
                        input.focus();
                        input.value = 'Genera un reporte geol√≥gico completo de esta ubicaci√≥n';
                        setTimeout(sendMessageToAI, 100);
                    } else {
                        toggleDrGeoBot();
                    }
                    break;
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function requestPermissions() {
            if (navigator.permissions) {
                // GPS
                navigator.permissions.query({ name: 'geolocation' })
                    .then(result => {
                        if (result.state === 'granted') {
                            console.log('‚úÖ Permiso de GPS disponible');
                        }
                    });
                
                // C√°mara
                navigator.permissions.query({ name: 'camera' })
                    .then(result => {
                        if (result.state === 'granted') {
                            console.log('‚úÖ Permiso de c√°mara disponible');
                        }
                    });
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationIcon = document.getElementById('notificationIcon');

            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            
            switch(type) {
                case 'success':
                    notificationIcon.textContent = '‚úÖ';
                    notification.style.borderLeftColor = '#228B22';
                    break;
                case 'error':
                    notificationIcon.textContent = '‚ùå';
                    notification.style.borderLeftColor = '#DC143C';
                    break;
                case 'warning':
                    notificationIcon.textContent = '‚ö†Ô∏è';
                    notification.style.borderLeftColor = '#FF8C00';
                    break;
                case 'info':
                    notificationIcon.textContent = '‚ÑπÔ∏è';
                    notification.style.borderLeftColor = '#4682B4';
                    break;
            }
            
            notification.style.display = 'flex';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // ============================================
        // MANEJO OFFLINE/ONLINE
        // ============================================
        window.addEventListener('online', () => {
            showNotification('‚úÖ Conectado a internet - DeepSeek AI activa', 'success');
            if (isDrGeoBotActive) {
                addMessageToChat('ai', `<strong>‚úÖ CONEXI√ìN RESTAURADA:</strong><br><br>
                DeepSeek AI est√° nuevamente disponible para an√°lisis geol√≥gico avanzado en tiempo real.`);
            }
        });

        window.addEventListener('offline', () => {
            showNotification('‚ö†Ô∏è Sin conexi√≥n a internet - Modo local activado', 'warning');
            if (isDrGeoBotActive) {
                addMessageToChat('ai', `<strong>‚ö†Ô∏è MODO LOCAL ACTIVADO:</strong><br><br>
                Sin conexi√≥n a internet. Funciones b√°sicas disponibles con base de datos local de 50+ minerales.<br><br>
                <em>Se reactivar√°n las funciones de IA al recuperar la conexi√≥n.</em>`);
            }
        });

        // ============================================
        // INICIALIZACI√ìN FINAL
        // ============================================
        console.log('üöÄ AtacamApp - Sistema de Geolog√≠a 3D & IA listo');
        console.log('‚úÖ Base de datos: 50+ minerales del Desierto de Atacama');
        console.log('‚úÖ DeepSeek API: Configurada y lista');
        console.log('‚úÖ Mapas: Topogr√°fico, sat√©lite y geol√≥gico');
        console.log('‚úÖ Gr√°ficos: 4 tipos de visualizaci√≥n 2D');
        console.log('‚úÖ Dr. GeoBot: Sistema IA especializado');
    </script>
</body>
</html>
