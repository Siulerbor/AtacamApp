<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AtacamApp - Geolog√≠a 3D & IA</title>
    
    <!-- Meta Tags HTML5 -->
    <meta name="description" content="Aplicaci√≥n de geolog√≠a 3D con IA especializada para an√°lisis geol√≥gico en campo">
    <meta name="keywords" content="geolog√≠a, 3D, IA, mapeo, minerales, rocas, exploraci√≥n">
    <meta name="author" content="AtacamApp Team">
    <meta name="theme-color" content="#4A6FA5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèúÔ∏è</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    
    <style>
        /* Variables CSS - Tema Glassmorphism Desierto */
        :root {
            --primary: #4A6FA5; /* Azul atardecer */
            --primary-dark: #385C8E;
            --primary-light: #6B93D6;
            --secondary: #E67E22; /* Naranja desierto */
            --accent: #F1C40F; /* Amarillo sol */
            --danger: #E74C3C;
            --success: #2ECC71;
            --warning: #F39C12;
            --info: #3498DB;
            --dark: #2C3E50;
            --light: rgba(255, 255, 255, 0.9);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --border-radius: 16px;
            --blur: blur(20px);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset y Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: var(--text-primary);
            line-height: 1.4;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Fondo principal con imagen de desierto */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(26, 41, 128, 0.85), rgba(38, 208, 206, 0.85)),
                url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
        }

        /* Patr√≥n de cerros decorativo */
        body::after {
            content: "";
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20%;
            background-image: 
                linear-gradient(to top, rgba(26, 41, 128, 0.9), transparent),
                url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: bottom;
            z-index: -1;
            opacity: 0.6;
        }

        /* Efecto de part√≠culas */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Splash Screen Glassmorphism */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(74, 111, 165, 0.9), rgba(230, 126, 34, 0.9));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
        }

        .splash-content {
            text-align: center;
            animation: fadeIn 1s ease;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .splash-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            margin: 1.5rem auto;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Main App Container */
        #appContainer {
            display: none;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* Header Compacto */
        .app-header {
            background: linear-gradient(rgba(44, 62, 80, 0.9), rgba(44, 62, 80, 0.95));
            padding: 10px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Logo muy compacto */
        .app-brand {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .brand-center {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .app-logo {
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .brand-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .brand-text small {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        /* Status Bar Muy Compacta - Solo el emoji */
        .status-bar {
            display: flex;
            justify-content: flex-end;
            padding: 5px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .status-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* GPS Data Bar - Una sola l√≠nea */
        .gps-data-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 10px 15px;
            margin: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
        }

        .gps-data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            padding: 0 5px;
        }

        .gps-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .gps-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Main Content - Optimizado para m√≥vil */
        .main-content {
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Glass Cards Compactas */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: var(--transition);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header i {
            font-size: 1.4rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* Map Containers Compactos */
        .map-container {
            width: 100%;
            height: 220px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        #map, #map3d {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .map-control-btn {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        /* Quick Actions en una l√≠nea */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-actions .glass-btn {
            flex: 1;
            padding: 12px;
            font-size: 0.8rem;
        }

        /* Glass Buttons Compactos */
        .glass-btn {
            padding: 14px 18px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .glass-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
        }

        /* Camera Container Compacto */
        .camera-container {
            width: 100%;
            height: 180px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Chat Interface Compacto */
        .chat-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            font-size: 0.85rem;
        }

        .chat-message.ai {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.2));
            align-self: flex-start;
            border: 1px solid rgba(52, 152, 219, 0.3);
            margin-left: 25px;
        }

        .chat-message.ai::before {
            content: "üë®‚Äçüî¨";
            position: absolute;
            left: -25px;
            font-size: 1.2rem;
        }

        .chat-message.user {
            background: linear-gradient(135deg, rgba(74, 111, 165, 0.2), rgba(56, 92, 142, 0.2));
            align-self: flex-end;
            border: 1px solid rgba(74, 111, 165, 0.3);
            margin-right: 25px;
        }

        .chat-message.user::before {
            content: "üßë‚Äçüíº";
            position: absolute;
            right: -25px;
            font-size: 1.2rem;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .glass-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
        }

        /* Geology Data Compacto */
        .geology-data {
            background: linear-gradient(135deg, rgba(74, 111, 165, 0.15), rgba(230, 126, 34, 0.15));
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        /* Layers Panel Compacto */
        .layers-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        /* Bottom Navigation Compacta */
        .bottom-nav {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 320px;
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            display: flex;
            justify-content: space-around;
            padding: 8px 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 1px solid var(--glass-border);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.65rem;
            padding: 4px 6px;
            border-radius: 10px;
            transition: var(--transition);
            min-width: 55px;
            position: relative;
        }

        .nav-btn span {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        .nav-btn.active {
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            max-width: 280px;
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--success);
            font-size: 0.85rem;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Map Legend Compacto */
        .map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            font-size: 0.7rem;
            border: 1px solid var(--glass-border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Custom Checkbox Compacto */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .empty-state span {
            font-size: 2rem;
            margin-bottom: 15px;
            display: block;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 6px;
        }

        /* Responsive Design para m√≥viles peque√±os */
        @media (max-width: 360px) {
            html { font-size: 12px; }
            
            .main-content { padding: 8px; }
            
            .gps-data-bar {
                margin: 8px;
                padding: 8px;
                flex-wrap: wrap;
            }
            
            .gps-data-item {
                flex: 1 0 45%;
                margin-bottom: 8px;
            }
            
            .map-container { height: 180px; }
            
            .camera-container { height: 150px; }
            
            .quick-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .bottom-nav {
                width: 95%;
                padding: 6px 8px;
                border-radius: 12px;
            }
            
            .nav-btn {
                min-width: 50px;
                font-size: 0.6rem;
            }
            
            .nav-btn span {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) and (min-width: 361px) {
            .gps-data-bar {
                font-size: 0.7rem;
            }
            
            .gps-value {
                font-size: 0.8rem;
            }
        }

        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .map-container { height: 150px; }
            .camera-container { height: 120px; }
            .chat-container { height: 180px; }
            .bottom-nav { bottom: 5px; }
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="particles"></div>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="splash-content">
            <div class="splash-icon">üèúÔ∏è</div>
            <h1 style="font-size: 2rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #fff, #f0f0f0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AtacamApp</h1>
            <p style="margin-bottom: 1rem; opacity: 0.9; font-size: 1rem;">Geolog√≠a 3D & Proyecci√≥n Estructural</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="loadingText" style="margin-top: 1rem; font-size: 0.9rem; color: rgba(255,255,255,0.8);">Inicializando sistema...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <!-- Header Compacto -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-brand">
                    <div class="brand-center">
                        <div class="app-logo">üèúÔ∏è</div>
                        <div class="brand-text">
                            <h1>AtacamApp</h1>
                            <small>Geolog√≠a 3D & IA</small>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-item" id="statusIcon" onclick="toggleDrGeoBot()">
                        <span class="status-icon">ü§ñ</span>
                        <span class="status-value" id="aiStatusValue">OFF</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- GPS Data Bar Compacta -->
        <div class="gps-data-bar" id="gpsDataBar">
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Latitud</div>
                <div class="gps-value" id="latitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Longitud</div>
                <div class="gps-value" id="longitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>‚õ∞Ô∏è</span>Altitud</div>
                <div class="gps-value" id="altitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üèôÔ∏è</span>Ciudad</div>
                <div class="gps-value" id="cityValue">--</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page 1: Dashboard -->
            <div class="page active" id="pageDashboard">
                <!-- 2D Map Section -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üó∫Ô∏è</span>
                        <h2 class="card-title">Mapa Geol√≥gico</h2>
                    </div>
                    
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <button class="map-control-btn" id="mapSatelliteBtn" title="Vista sat√©lite">
                                <span>üõ∞Ô∏è</span>
                            </button>
                            <button class="map-control-btn" id="mapTerrainBtn" title="Vista topogr√°fica">
                                <span>‚õ∞Ô∏è</span>
                            </button>
                        </div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #4A6FA5;"></div>
                                <span>Geolog√≠a ü™®</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #E74C3C;"></div>
                                <span>Fallas ‚ö°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="updateLocationBtn">
                            <span>üìç</span>
                            Actualizar GPS
                        </button>
                        <button class="glass-btn" id="addPointBtn">
                            <span>‚ûï</span>
                            Agregar Punto
                        </button>
                        <button class="glass-btn" id="clearMapBtn">
                            <span>üóëÔ∏è</span>
                            Limpiar
                        </button>
                    </div>
                </div>

                <!-- Geology Info -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Datos Geol√≥gicos</h2>
                    </div>
                    
                    <div id="geologyInfo" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Activa el GPS para ver datos geol√≥gicos</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Camera & Analysis -->
            <div class="page" id="pageCamera">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üì∏</span>
                        <h2 class="card-title">An√°lisis Fotogeol√≥gico</h2>
                    </div>
                    
                    <div class="camera-container">
                        <video id="cameraFeed" autoplay playsinline></video>
                        <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 8px;">
                            <span id="cameraStatusText" style="color: white; font-size: 0.8rem;">
                                <span>üî¥</span> C√°mara inactiva
                            </span>
                        </div>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="glass-btn primary" id="startCameraBtn">
                            <span>üé•</span>
                            Activar C√°mara
                        </button>
                        <button class="glass-btn warning" id="captureBtn" disabled>
                            <span>üì∏</span>
                            Capturar
                        </button>
                        <button class="glass-btn success" id="analyzeBtn" disabled>
                            <span>ü§ñ</span>
                            Analizar IA
                        </button>
                        <button class="glass-btn danger" id="stopCameraBtn" disabled>
                            <span>‚èπÔ∏è</span>
                            Detener
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Resultados</h2>
                    </div>
                    
                    <div id="analysisResults" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Capture una imagen para analizar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: 3D Map -->
            <div class="page" id="page3DMap">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üåç</span>
                        <h2 class="card-title">Visualizaci√≥n 3D</h2>
                    </div>
                    
                    <div class="map-container">
                        <div id="map3d"></div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="generate3D">
                            <span>üîÑ</span>
                            Generar 3D
                        </button>
                        <button class="glass-btn" id="export3D">
                            <span>üíæ</span>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìê</span>
                        <h2 class="card-title">Par√°metros Estructurales</h2>
                    </div>
                    
                    <div id="structuralParams" class="geology-data">
                        <div class="empty-state">
                            <span>üìè</span>
                            <p>Genera modelo 3D para ver par√°metros</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: AI Assistant -->
            <div class="page" id="pageAI">
                <div class="glass-card">
                    <div class="card-header">
                        <span>ü§ñ</span>
                        <h2 class="card-title">Dr. GeoBot - Asistente IA</h2>
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message ai">
                            <strong>Dr. GeoBot:</strong> ¬°Hola! Soy tu asistente IA especializado en geolog√≠a. Puedo ayudarte con an√°lisis de rocas, interpretaci√≥n de datos, c√°lculos estructurales y m√°s. ¬øEn qu√© puedo ayudarte?
                        </div>
                    </div>
                    
                    <div class="chat-input-group">
                        <input type="text" class="glass-input" id="chatInput" 
                               placeholder="Escribe tu consulta...">
                        <button class="glass-btn primary" id="sendMessage" style="width: auto; padding: 14px 20px;">
                            <span>‚úàÔ∏è</span>
                        </button>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn success" id="analyzeLocation">
                            <span>üìç</span>
                            Analizar Ubicaci√≥n
                        </button>
                        <button class="glass-btn warning" id="identifyMineral">
                            <span>üíé</span>
                            Identificar Mineral
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üíæ</span>
                        <h2 class="card-title">Base de Datos</h2>
                    </div>
                    
                    <div id="geologyDatabase" class="geology-data">
                        <div class="data-row">
                            <span>Minerales üíé:</span>
                            <span id="mineralCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Rocas ü™®:</span>
                            <span id="rockCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Localidades üèúÔ∏è:</span>
                            <span id="locationCount">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation Compacta -->
        <nav class="bottom-nav">
            <a href="#" class="nav-btn active" data-page="dashboard">
                <span>üè†</span>
                <span>Inicio</span>
            </a>
            <a href="#" class="nav-btn" data-page="camera">
                <span>üì∏</span>
                <span>C√°mara</span>
            </a>
            <a href="#" class="nav-btn" data-page="3DMap">
                <span>üåç</span>
                <span>3D</span>
            </a>
            <a href="#" class="nav-btn" data-page="AI">
                <span>ü§ñ</span>
                <span>IA</span>
            </a>
        </nav>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <span id="notificationIcon">‚úÖ</span>
        <span id="notificationText">Mensaje de notificaci√≥n</span>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ============================================
        const CONFIG = {
            MAPBOX_TOKEN: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA',
            DEFAULT_LOCATION: {
                lat: -27.3667,
                lng: -70.3333,
                zoom: 10
            },
            OPENAI_API_KEY: 'TU_API_KEY_AQUI', // Reemplaza con tu API key real
            MAP_LAYERS: {
                topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            }
        };

        // Variables globales
        let map = null;
        let map3d = null;
        let currentLocation = null;
        let cameraStream = null;
        let isCameraActive = false;
        let currentPhoto = null;
        let markersLayer = null;
        let isDrGeoBotActive = false;
        let mindatData = null;

        // ============================================
        // BASE DE DATOS MINERALES (Mindat.org - Chile)
        // ============================================
        const MINERAL_DATABASE = {
            "Chile": {
                "Regi√≥n de Antofagasta": {
                    minerals: [
                        { name: "Calcopirita", formula: "CuFeS‚ÇÇ", emoji: "üíé", color: "Amarillo lat√≥n", hardness: "3.5-4", uses: "Principal mineral de cobre" },
                        { name: "Atacamita", formula: "Cu‚ÇÇCl(OH)‚ÇÉ", emoji: "üíö", color: "Verde esmeralda", hardness: "3-3.5", uses: "Mineral secundario de cobre" },
                        { name: "Chalcantita", formula: "CuSO‚ÇÑ¬∑5H‚ÇÇO", emoji: "üîµ", color: "Azul", hardness: "2.5", uses: "Mineral secundario" },
                        { name: "Halita", formula: "NaCl", emoji: "üßÇ", color: "Incoloro a blanco", hardness: "2.5", uses: "Sal de roca" },
                        { name: "Yeso", formula: "CaSO‚ÇÑ¬∑2H‚ÇÇO", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2", uses: "Construcci√≥n" }
                    ],
                    localities: ["Salar de Atacama", "Chuquicamata", "Escondida", "Cerro Negro"]
                },
                "Regi√≥n de Tarapac√°": {
                    minerals: [
                        { name: "Azurita", formula: "Cu‚ÇÉ(CO‚ÇÉ)‚ÇÇ(OH)‚ÇÇ", emoji: "üíô", color: "Azul intenso", hardness: "3.5-4", uses: "Mineral ornamental" },
                        { name: "Malaquita", formula: "Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ", emoji: "üíö", color: "Verde", hardness: "3.5-4", uses: "Piedra ornamental" },
                        { name: "Clorargirita", formula: "AgCl", emoji: "‚ö™", color: "Gris a incoloro", hardness: "2.5", uses: "Mineral de plata" }
                    ],
                    localities: ["Pampa del Tamarugal", "Iquique", "Pica"]
                },
                "Regi√≥n de Atacama": {
                    minerals: [
                        { name: "Epidota", formula: "Ca‚ÇÇAl‚ÇÇ(Fe¬≥‚Å∫,Al)(SiO‚ÇÑ)(Si‚ÇÇO‚Çá)O(OH)", emoji: "üíö", color: "Verde pistacho", hardness: "6-7", uses: "Mineral √≠ndice metam√≥rfico" },
                        { name: "Cuarzo", formula: "SiO‚ÇÇ", emoji: "üî∂", color: "Variable", hardness: "7", uses: "Electr√≥nica, √≥ptica" },
                        { name: "Hematita", formula: "Fe‚ÇÇO‚ÇÉ", emoji: "üî¥", color: "Rojo a negro", hardness: "5.5-6.5", uses: "Principal mineral de hierro" }
                    ],
                    localities: ["Copiap√≥", "Vallenar", "Cha√±aral"]
                }
            }
        };

        // ============================================
        // FUNCIONES DE INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ AtacamApp - Iniciando aplicaci√≥n...');
            simulateLoading();
            
            // Inicializar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Cargar datos de Mindat
            loadMindatData();
        });

        function simulateLoading() {
            let progress = 0;
            const messages = [
                'Inicializando sistema... üîÑ',
                'Cargando base de minerales... üíé',
                'Configurando Dr. GeoBot... ü§ñ',
                'Cargando mapas... üó∫Ô∏è',
                '¬°Listo para explorar! üèúÔ∏è'
            ];
            
            const interval = setInterval(() => {
                progress += 20;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('loadingText').textContent = messages[progress / 20 - 1];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('splashScreen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('splashScreen').style.display = 'none';
                            document.getElementById('appContainer').style.display = 'block';
                            initializeApp();
                        }, 500);
                    }, 500);
                }
            }, 300);
        }

        function loadMindatData() {
            // En un entorno real, aqu√≠ cargar√≠as datos de una API
            // Por ahora usamos los datos est√°ticos
            mindatData = MINERAL_DATABASE;
            console.log('‚úÖ Base de datos de minerales cargada');
        }

        function initializeApp() {
            console.log('‚úÖ Aplicaci√≥n cargada');
            
            // Configurar navegaci√≥n
            setupNavigation();
            
            // Inicializar componentes
            init2DMap();
            init3DMap();
            
            // Configurar eventos
            setupEventListeners();
            
            // Solicitar permisos
            requestPermissions();
            
            // Actualizar estado inicial
            updateStatusIcon(false);
            
            showNotification('¬°Bienvenido a AtacamApp! üèúÔ∏è', 'success');
            
            // Iniciar actualizaci√≥n de datos
            updateDatabaseCounts();
            
            // Configurar Dr. GeoBot
            initializeDrGeoBot();
        }

        // ============================================
        // DR. GEOBOT - ASISTENTE IA CON OPENAI
        // ============================================
        function initializeDrGeoBot() {
            console.log('ü§ñ Dr. GeoBot inicializado');
            
            // Mensaje inicial personalizado
            setTimeout(() => {
                addMessageToChat('ai', `üë®‚Äçüî¨ <strong>Dr. GeoBot - Sistema IA de Geolog√≠a:</strong><br><br>
                ¬°Hola! Soy Dr. GeoBot, tu asistente IA especializado en geolog√≠a del Desierto de Atacama.<br><br>
                <strong>Puedo ayudarte con:</strong><br>
                ‚Ä¢ ü™® Identificaci√≥n de rocas y minerales<br>
                ‚Ä¢ üìê An√°lisis estructural avanzado<br>
                ‚Ä¢ üó∫Ô∏è Interpretaci√≥n de mapas geol√≥gicos<br>
                ‚Ä¢ üíé Datos de yacimientos minerales<br>
                ‚Ä¢ üìä C√°lculos geol√≥gicos en tiempo real<br><br>
                <em>Para usar todas mis funciones, act√≠valo con el bot√≥n ü§ñ en el header</em>`);
            }, 1000);
        }

        function toggleDrGeoBot() {
            isDrGeoBotActive = !isDrGeoBotActive;
            updateStatusIcon(isDrGeoBotActive);
            
            if (isDrGeoBotActive) {
                showNotification('Dr. GeoBot ACTIVADO ü§ñ', 'success');
                addMessageToChat('ai', `<strong>ü§ñ DR. GEOBOT ACTIVADO:</strong><br><br>
                ¬°Sistema IA completamente operativo!<br>
                Puedo ahora acceder a:<br>
                ‚Ä¢ üìç Tu ubicaci√≥n GPS en tiempo real<br>
                ‚Ä¢ üó∫Ô∏è Datos geol√≥gicos de la regi√≥n<br>
                ‚Ä¢ üíé Base de datos de minerales (${Object.values(mindatData.Chile).flatMap(r => r.minerals).length} minerales)<br>
                ‚Ä¢ üß† An√°lisis avanzado con IA<br><br>
                <strong>¬øEn qu√© puedo ayudarte?</strong>`);
                
                // Cambiar a p√°gina de IA si no est√° all√≠
                if (!document.getElementById('pageAI').classList.contains('active')) {
                    switchPage('AI');
                }
            } else {
                showNotification('Dr. GeoBot DESACTIVADO ‚èπÔ∏è', 'warning');
            }
        }

        function updateStatusIcon(active) {
            const statusIcon = document.getElementById('statusIcon');
            const aiStatusValue = document.getElementById('aiStatusValue');
            
            if (active) {
                statusIcon.style.background = 'linear-gradient(135deg, rgba(46, 204, 113, 0.3), rgba(39, 174, 96, 0.3))';
                statusIcon.style.borderColor = 'rgba(46, 204, 113, 0.5)';
                aiStatusValue.textContent = 'ON';
                aiStatusValue.style.color = '#51cf66';
            } else {
                statusIcon.style.background = 'linear-gradient(135deg, rgba(231, 76, 60, 0.3), rgba(192, 57, 43, 0.3))';
                statusIcon.style.borderColor = 'rgba(231, 76, 60, 0.5)';
                aiStatusValue.textContent = 'OFF';
                aiStatusValue.style.color = '#ff6b6b';
            }
        }

        async function sendMessageToAI() {
            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            input.focus();

            const thinkingId = addMessageToChat('ai', 'Procesando tu consulta... üîç');

            try {
                // Integraci√≥n con OpenAI
                const response = await callOpenAI(message);
                updateMessage(thinkingId, response);
            } catch (error) {
                console.error('Error con OpenAI:', error);
                // Si falla OpenAI, usar respuesta local
                const localResponse = generateLocalAIResponse(message);
                updateMessage(thinkingId, localResponse);
            }
        }

        async function callOpenAI(prompt) {
            // Esta es una implementaci√≥n de ejemplo
            // En producci√≥n, necesitar√≠as una API key real y un endpoint seguro
            
            const context = buildGeologyContext();
            const fullPrompt = `${context}\n\nUsuario: ${prompt}\n\nDr. GeoBot:`;
            
            // Simulaci√≥n de respuesta (reemplazar con llamada real a API)
            return simulateOpenAIResponse(prompt);
        }

        function buildGeologyContext() {
            let context = `Eres Dr. GeoBot, un ge√≥logo experto especializado en el Desierto de Atacama, Chile.\n`;
            context += `Tienes acceso a:\n`;
            
            if (currentLocation) {
                context += `- Ubicaci√≥n actual: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}\n`;
                context += `- Altitud: ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}\n`;
            }
            
            context += `- Base de datos de minerales: ${countMinerals()} minerales registrados\n`;
            context += `- Especialidades: Geolog√≠a estructural, petrolog√≠a, mineralog√≠a, yacimientos minerales\n\n`;
            context += `Responde en espa√±ol, con emojis relevantes y formato claro.`;
            
            return context;
        }

        function simulateOpenAIResponse(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            
            // Respuestas inteligentes basadas en el prompt
            if (lowerPrompt.includes('mineral') || lowerPrompt.includes('roca')) {
                const region = getRegionFromLocation();
                const minerals = region ? mindatData.Chile[region].minerals.slice(0, 3) : [];
                
                let response = `<strong>üîç An√°lisis Mineral√≥gico:</strong><br><br>`;
                
                if (minerals.length > 0) {
                    response += `En tu regi√≥n (${region}) los minerales comunes son:<br><br>`;
                    minerals.forEach(mineral => {
                        response += `‚Ä¢ <strong>${mineral.emoji} ${mineral.name}</strong> (${mineral.formula})<br>`;
                        response += `  Color: ${mineral.color} | Dureza: ${mineral.hardness}<br>`;
                        response += `  Usos: ${mineral.uses}<br><br>`;
                    });
                } else {
                    response += `En el Desierto de Atacama encuentras minerales como:<br><br>`;
                    response += `‚Ä¢ <strong>üíé Calcopirita</strong> (CuFeS‚ÇÇ) - Principal mineral de cobre<br>`;
                    response += `‚Ä¢ <strong>üíö Atacamita</strong> - Mineral secundario de cobre<br>`;
                    response += `‚Ä¢ <strong>üßÇ Halita</strong> (NaCl) - Sal de roca en salares<br>`;
                }
                
                response += `<br><em>¬øQuieres identificar un mineral espec√≠fico? Toma una foto con la c√°mara üì∏</em>`;
                return response;
            }
            
            if (lowerPrompt.includes('estructura') || lowerPrompt.includes('falla')) {
                return `<strong>‚ö° An√°lisis Estructural:</strong><br><br>
                En el Desierto de Atacama predominan:<br><br>
                ‚Ä¢ <strong>Sistema de fallas NNE-SSO</strong><br>
                ‚Ä¢ <strong>Buzamientos:</strong> 45-60¬∞ al este<br>
                ‚Ä¢ <strong>Mineralizaci√≥n asociada:</strong> Vetas de Cu-Au<br>
                ‚Ä¢ <strong>Tect√≥nica:</strong> Compresi√≥n andina<br><br>
                <strong>Recomendaci√≥n:</strong> Usa el mapa 3D para visualizar estructuras üåç`;
            }
            
            if (lowerPrompt.includes('mapa') || lowerPrompt.includes('ubicaci√≥n')) {
                if (currentLocation) {
                    return `<strong>üó∫Ô∏è An√°lisis de Ubicaci√≥n:</strong><br><br>
                    <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}<br>
                    <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m<br>
                    <strong>Contexto geol√≥gico:</strong> ${getGeologicalContext()}<br><br>
                    <strong>Acciones recomendadas:</strong><br>
                    1. Agrega un punto geol√≥gico al mapa<br>
                    2. Toma fotos para an√°lisis<br>
                    3. Genera modelo 3D del √°rea`;
                } else {
                    return `<strong>üìç Ubicaci√≥n requerida:</strong><br><br>
                    Primero activa el GPS para obtener tu ubicaci√≥n actual.<br>
                    Usa el bot√≥n "üìç Actualizar GPS" en la p√°gina de inicio.`;
                }
            }
            
            // Respuesta por defecto inteligente
            return `<strong>üë®‚Äçüî¨ Dr. GeoBot:</strong><br><br>
            Como ge√≥logo especializado en el Desierto de Atacama, puedo ayudarte con:<br><br>
            ‚Ä¢ <strong>ü™® Identificaci√≥n</strong> de rocas y minerales<br>
            ‚Ä¢ <strong>üìê Mediciones</strong> estructurales precisas<br>
            ‚Ä¢ <strong>üó∫Ô∏è Interpretaci√≥n</strong> de mapas geol√≥gicos<br>
            ‚Ä¢ <strong>üíé An√°lisis</strong> de yacimientos minerales<br>
            ‚Ä¢ <strong>üìä C√°lculos</strong> geol√≥gicos en tiempo real<br><br>
            <strong>Prueba preguntando:</strong><br>
            "¬øQu√© minerales hay en esta zona?"<br>
            "Analiza mi ubicaci√≥n geol√≥gica"<br>
            "¬øC√≥mo mido una falla?"<br><br>
            <em>Tambi√©n puedes usar la c√°mara para an√°lisis fotogeol√≥gico üì∏</em>`;
        }

        function generateLocalAIResponse(prompt) {
            // Respuesta local si OpenAI falla
            return simulateOpenAIResponse(prompt);
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function getRegionFromLocation() {
            if (!currentLocation) return null;
            
            const lat = currentLocation.latitude;
            
            if (lat < -18) return "Regi√≥n de Tarapac√°";
            if (lat < -26) return "Regi√≥n de Antofagasta";
            if (lat < -30) return "Regi√≥n de Atacama";
            
            return "Desierto de Atacama";
        }

        function getGeologicalContext() {
            const region = getRegionFromLocation();
            if (!region) return "Zona des√©rtica con actividad minera";
            
            const contexts = {
                "Regi√≥n de Antofagasta": "Cordillera de la Costa con yacimientos de cobre porf√≠rico",
                "Regi√≥n de Tarapac√°": "Depresi√≥n Intermedia con salares y evaporitas",
                "Regi√≥n de Atacama": "Precordillera andina con vetas epitermales"
            };
            
            return contexts[region] || "Regi√≥n des√©rtica con geolog√≠a compleja";
        }

        function countMinerals() {
            let count = 0;
            if (mindatData && mindatData.Chile) {
                Object.values(mindatData.Chile).forEach(region => {
                    count += region.minerals.length;
                });
            }
            return count;
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.dataset.page;
                    switchPage(pageId);
                });
            });
        }

        function switchPage(pageId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1));
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }

        function addMessageToChat(sender, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = text;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageId;
        }

        function updateMessage(messageId, text) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.innerHTML = text;
            }
        }

        function updateDatabaseCounts() {
            if (mindatData && mindatData.Chile) {
                let mineralCount = 0;
                let rockCount = 24; // Valor estimado
                let locationCount = 0;
                
                Object.values(mindatData.Chile).forEach(region => {
                    mineralCount += region.minerals.length;
                    locationCount += region.localities.length;
                });
                
                document.getElementById('mineralCount').textContent = mineralCount;
                document.getElementById('rockCount').textContent = rockCount;
                document.getElementById('locationCount').textContent = locationCount;
            }
        }

        // ============================================
        // GPS Y LOCALIZACI√ìN
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                showNotification('GPS no disponible ‚ùå', 'error');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                handleGPSPosition,
                handleGPSError,
                options
            );

            showNotification('Obteniendo ubicaci√≥n... üõ∞Ô∏è', 'info');
        }

        function handleGPSPosition(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                altitude: position.coords.altitude || 0,
                accuracy: position.coords.accuracy,
                timestamp: new Date(position.timestamp)
            };

            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfo();
            
            showNotification(`üìç Ubicaci√≥n obtenida (${Math.round(currentLocation.accuracy)}m)`, 'success');
            
            // Si Dr. GeoBot est√° activo, notificar
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç Ubicaci√≥n actualizada:</strong><br><br>
                    <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}<br>
                    <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm ‚õ∞Ô∏è' : 'Desconocida'}<br>
                    <strong>Regi√≥n:</strong> ${getRegionFromLocation()}<br><br>
                    <em>¬øQuieres analizar la geolog√≠a de esta zona?</em>`);
                }, 1000);
            }
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            let message = '';
            switch(error.code) {
                case 1:
                    message = 'Permiso de ubicaci√≥n denegado üîí';
                    break;
                case 2:
                    message = 'Ubicaci√≥n no disponible üì°';
                    break;
                case 3:
                    message = 'Tiempo de espera agotado ‚è∞';
                    break;
                default:
                    message = 'Error de GPS ‚ùå';
            }
            
            showNotification(`${message}`, 'warning');
            
            // Usar ubicaci√≥n por defecto
            currentLocation = {
                latitude: CONFIG.DEFAULT_LOCATION.lat,
                longitude: CONFIG.DEFAULT_LOCATION.lng,
                accuracy: 1000,
                altitude: 0
            };
            
            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfo();
        }

        function updateLocationDisplay() {
            if (!currentLocation) return;

            document.getElementById('latitudeValue').textContent = currentLocation.latitude.toFixed(6);
            document.getElementById('longitudeValue').textContent = currentLocation.longitude.toFixed(6);
            document.getElementById('altitudeValue').textContent = 
                currentLocation.altitude ? `${Math.round(currentLocation.altitude)}m` : '--';
            
            // Obtener ciudad m√°s cercana (simulado)
            const cities = [
                { name: "Antofagasta", lat: -23.650, lng: -70.400 },
                { name: "Calama", lat: -22.456, lng: -68.924 },
                { name: "Copiap√≥", lat: -27.366, lng: -70.332 },
                { name: "Vallenar", lat: -28.576, lng: -70.759 }
            ];
            
            let closestCity = "Desierto";
            let minDistance = Infinity;
            
            cities.forEach(city => {
                const distance = Math.sqrt(
                    Math.pow(city.lat - currentLocation.latitude, 2) + 
                    Math.pow(city.lng - currentLocation.longitude, 2)
                );
                
                if (distance < minDistance && distance < 1) {
                    minDistance = distance;
                    closestCity = city.name;
                }
            });
            
            document.getElementById('cityValue').textContent = closestCity;
        }

        function updateGeologyInfo() {
            if (!currentLocation) return;

            const region = getRegionFromLocation();
            const regionData = mindatData.Chile[region];
            
            let html = '';
            
            if (regionData) {
                html += `<div class="data-row">
                    <span>Regi√≥n:</span>
                    <span>${region}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Minerales comunes:</span>
                    <span>${regionData.minerals.slice(0, 2).map(m => m.emoji).join(' ')}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Localidades:</span>
                    <span>${regionData.localities[0]}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Contexto:</span>
                    <span>${getGeologicalContext()}</span>
                </div>`;
            } else {
                html = `<div class="empty-state">
                    <span>üèúÔ∏è</span>
                    <p>Zona del Desierto de Atacama</p>
                </div>`;
            }
            
            document.getElementById('geologyInfo').innerHTML = html;
        }

        // ============================================
        // MAPA 2D
        // ============================================
        function init2DMap() {
            try {
                map = L.map('map').setView(
                    [CONFIG.DEFAULT_LOCATION.lat, CONFIG.DEFAULT_LOCATION.lng],
                    CONFIG.DEFAULT_LOCATION.zoom
                );

                L.tileLayer(CONFIG.MAP_LAYERS.topo, {
                    attribution: '¬© OpenTopoMap',
                    maxZoom: 17
                }).addTo(map);

                markersLayer = L.layerGroup().addTo(map);

                console.log('‚úÖ Mapa 2D inicializado');

            } catch (error) {
                console.error('Error inicializando mapa:', error);
                showNotification('Error al cargar el mapa ‚ùå', 'error');
            }
        }

        function updateMapLocation() {
            if (!map || !currentLocation) return;

            const latLng = [currentLocation.latitude, currentLocation.longitude];
            
            map.flyTo(latLng, 14, {
                duration: 1.5
            });

            // Agregar marcador
            L.marker(latLng, {
                icon: L.divIcon({
                    className: 'current-location',
                    html: `<div style="background: linear-gradient(135deg, #4A6FA5, #E67E22); color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid white; font-size:1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">üìç</div>`,
                    iconSize: [40, 40]
                })
            }).addTo(markersLayer);

            // C√≠rculo de precisi√≥n
            L.circle(latLng, {
                color: 'rgba(74, 111, 165, 0.3)',
                fillColor: 'rgba(74, 111, 165, 0.1)',
                radius: currentLocation.accuracy,
                weight: 1
            }).addTo(map);
        }

        // ============================================
        // MAPA 3D
        // ============================================
        function init3DMap() {
            try {
                mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;

                map3d = new mapboxgl.Map({
                    container: 'map3d',
                    style: 'mapbox://styles/mapbox/satellite-streets-v11',
                    center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
                    zoom: CONFIG.DEFAULT_LOCATION.zoom,
                    pitch: 45
                });

                map3d.on('load', () => {
                    console.log('‚úÖ Mapa 3D inicializado');
                });

            } catch (error) {
                console.error('Error inicializando mapa 3D:', error);
            }
        }

        // ============================================
        // C√ÅMARA Y AN√ÅLISIS
        // ============================================
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraFeed');
                video.srcObject = cameraStream;

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                isCameraActive = true;
                updateCameraControls(true);
                showNotification('C√°mara activada üì∏', 'success');

            } catch (error) {
                console.error('Error c√°mara:', error);
                showNotification('Error al activar c√°mara ‚ùå', 'error');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('cameraFeed');
            video.srcObject = null;
            isCameraActive = false;
            updateCameraControls(false);
            showNotification('C√°mara detenida ‚èπÔ∏è', 'info');
        }

        function updateCameraControls(active) {
            document.getElementById('startCameraBtn').disabled = active;
            document.getElementById('captureBtn').disabled = !active;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = !active;
            
            const statusText = document.getElementById('cameraStatusText');
            statusText.innerHTML = active ? 
                '<span>üü¢</span> C√°mara activa' :
                '<span>üî¥</span> C√°mara inactiva';
        }

        function capturePhoto() {
            if (!isCameraActive) return;

            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            currentPhoto = {
                data: canvas.toDataURL('image/jpeg'),
                timestamp: new Date().toISOString(),
                location: currentLocation
            };

            document.getElementById('analyzeBtn').disabled = false;
            showNotification('¬°Foto capturada! üì∏', 'success');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Botones GPS
            document.getElementById('updateLocationBtn').addEventListener('click', startGPS);

            // Botones c√°mara
            document.getElementById('startCameraBtn').addEventListener('click', startCamera);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeWithAI);

            // Controles mapa
            document.getElementById('mapSatelliteBtn').addEventListener('click', () => {
                switchMapLayer('satellite');
            });
            document.getElementById('mapTerrainBtn').addEventListener('click', () => {
                switchMapLayer('topo');
            });

            // Botones mapa
            document.getElementById('addPointBtn').addEventListener('click', addMapPoint);
            document.getElementById('clearMapBtn').addEventListener('click', clearMapPoints);

            // Controles 3D
            document.getElementById('generate3D').addEventListener('click', generate3DProjection);
            document.getElementById('export3D').addEventListener('click', export3DModel);

            // IA
            document.getElementById('sendMessage').addEventListener('click', sendMessageToAI);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessageToAI();
            });
            document.getElementById('analyzeLocation').addEventListener('click', () => {
                if (currentLocation) {
                    const message = addMessageToChat('user', 'Analiza mi ubicaci√≥n geol√≥gica');
                    setTimeout(() => {
                        sendMessageToAI();
                    }, 100);
                } else {
                    showNotification('Primero activa el GPS üìç', 'warning');
                }
            });
            document.getElementById('identifyMineral').addEventListener('click', () => {
                addMessageToChat('user', '¬øQu√© minerales puedo encontrar aqu√≠?');
                setTimeout(() => {
                    sendMessageToAI();
                }, 100);
            });
        }

        function switchMapLayer(layerName) {
            if (map) {
                map.eachLayer((layer) => {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer(CONFIG.MAP_LAYERS[layerName], {
                    attribution: layerName === 'satellite' ? '¬© Esri' : '¬© OpenTopoMap',
                    maxZoom: layerName === 'satellite' ? 19 : 17
                }).addTo(map);
                
                showNotification(`Mapa: ${layerName === 'satellite' ? 'Sat√©lite üõ∞Ô∏è' : 'Topogr√°fico ‚õ∞Ô∏è'}`, 'success');
            }
        }

        function addMapPoint() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üó∫Ô∏è', 'warning');
                return;
            }

            const types = [
                { type: 'rock', emoji: 'ü™®', name: 'Roca' },
                { type: 'mineral', emoji: 'üíé', name: 'Mineral' },
                { type: 'fault', emoji: '‚ö°', name: 'Falla' }
            ];
            
            const selectedType = types[Math.floor(Math.random() * types.length)];
            const name = `${selectedType.name} ${new Date().getHours()}:${new Date().getMinutes()}`;

            L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: L.divIcon({
                    html: `<div style="background: ${selectedType.type === 'rock' ? '#4A6FA5' : selectedType.type === 'mineral' ? '#F1C40F' : '#E74C3C'}; color:white; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">${selectedType.emoji}</div>`,
                    iconSize: [35, 35]
                })
            }).addTo(markersLayer);

            showNotification('Punto agregado üìç', 'success');
            
            // Notificar a Dr. GeoBot si est√° activo
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç Punto geol√≥gico agregado:</strong><br><br>
                    <strong>Tipo:</strong> ${selectedType.name} ${selectedType.emoji}<br>
                    <strong>Ubicaci√≥n:</strong> ${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}<br><br>
                    <em>Puedo ayudarte a analizar este punto. ¬øQu√© informaci√≥n necesitas?</em>`);
                }, 500);
            }
        }

        function clearMapPoints() {
            markersLayer.clearLayers();
            showNotification('Mapa limpiado ‚úÖ', 'success');
        }

        function analyzeWithAI() {
            if (!currentPhoto) {
                showNotification('Primero captura una imagen üì∏', 'warning');
                return;
            }

            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            showNotification('Analizando imagen con IA... ü§ñ', 'info');

            setTimeout(() => {
                const analysisHTML = `
                    <div class="data-row">
                        <span>Tipo identificado:</span>
                        <span>ü™® Roca √≠gnea</span>
                    </div>
                    <div class="data-row">
                        <span>Mineral principal:</span>
                        <span>üíé Cuarzo + Feldespato</span>
                    </div>
                    <div class="data-row">
                        <span>Dureza estimada:</span>
                        <span>üìè 6-7 (Mohs)</span>
                    </div>
                    <div class="data-row">
                        <span>Confianza:</span>
                        <span>üéØ 88%</span>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(52, 152, 219, 0.2); border-radius: 12px; border: 1px solid rgba(52, 152, 219, 0.3); font-size: 0.8rem;">
                        <strong>üë®‚Äçüî¨ Dr. GeoBot recomienda:</strong><br>
                        ‚Ä¢ Realizar an√°lisis petrogr√°fico<br>
                        ‚Ä¢ Tomar muestra para geoqu√≠mica
                    </div>
                `;

                document.getElementById('analysisResults').innerHTML = analysisHTML;
                showNotification('‚úÖ An√°lisis completado', 'success');
            }, 2000);
        }

        function generate3DProjection() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üåç', 'warning');
                return;
            }

            showNotification('Generando modelo 3D... üîÑ', 'info');

            setTimeout(() => {
                const html = `
                    <div class="data-row">
                        <span>Rumbo üß≠:</span>
                        <span>N.45¬∞E</span>
                    </div>
                    <div class="data-row">
                        <span>Buzamiento üìè:</span>
                        <span>30¬∞SE</span>
                    </div>
                    <div class="data-row">
                        <span>Espesor üìä:</span>
                        <span>15.2 m</span>
                    </div>
                    <div class="data-row">
                        <span>Inclinaci√≥n üìê:</span>
                        <span>22¬∞</span>
                    </div>
                `;

                document.getElementById('structuralParams').innerHTML = html;
                showNotification('‚úÖ Modelo 3D generado', 'success');
            }, 1500);
        }

        function export3DModel() {
            if (!currentLocation) {
                showNotification('Primero genera un modelo 3D üíæ', 'warning');
                return;
            }

            showNotification('Exportando modelo... üì§', 'info');

            setTimeout(() => {
                const data = {
                    location: currentLocation,
                    timestamp: new Date().toISOString(),
                    parameters: {
                        rumbo: "N.45¬∞E",
                        buzamiento: "30¬∞SE",
                        espesor: "15.2 m",
                        inclinacion: "22¬∞"
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modelo_3d_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ Modelo exportado', 'success');
            }, 1000);
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function requestPermissions() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(result => {
                        if (result.state === 'granted') {
                            console.log('Permiso de GPS disponible üõ∞Ô∏è');
                        }
                    });
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationIcon = document.getElementById('notificationIcon');

            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            
            switch(type) {
                case 'success':
                    notificationIcon.textContent = '‚úÖ';
                    break;
                case 'error':
                    notificationIcon.textContent = '‚ùå';
                    break;
                case 'warning':
                    notificationIcon.textContent = '‚ö†Ô∏è';
                    break;
                case 'info':
                    notificationIcon.textContent = '‚ÑπÔ∏è';
                    break;
            }
            
            notification.style.display = 'flex';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // ============================================
        // MANEJO OFFLINE/ONLINE
        // ============================================
        window.addEventListener('online', () => {
            showNotification('Conectado a internet ‚úÖ', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('Sin conexi√≥n a internet ‚ö†Ô∏è', 'warning');
        });
    </script>
</body>
</html>
