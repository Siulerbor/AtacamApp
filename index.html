<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AtacamApp - Geolog√≠a 3D & IA</title>
    
    <!-- Meta Tags HTML5 -->
    <meta name="description" content="Aplicaci√≥n de geolog√≠a 3D con IA especializada para an√°lisis geol√≥gico en campo">
    <meta name="keywords" content="geolog√≠a, 3D, IA, mapeo, minerales, rocas, exploraci√≥n">
    <meta name="author" content="AtacamApp Team">
    <meta name="theme-color" content="#4A6FA5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèúÔ∏è</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    
    <style>
        /* Variables CSS - Tema Glassmorphism Desierto */
        :root {
            --primary: #D4A017; /* Oro desierto */
            --primary-dark: #B8860B;
            --primary-light: #FFD700;
            --secondary: #8B4513; /* Tierra desierto */
            --accent: #CD853F; /* Arena */
            --danger: #DC143C;
            --success: #228B22;
            --warning: #FF8C00;
            --info: #4682B4;
            --dark: #2F4F4F;
            --light: rgba(255, 248, 220, 0.9);
            --glass-bg: rgba(255, 248, 220, 0.15);
            --glass-border: rgba(210, 180, 140, 0.2);
            --glass-shadow: 0 8px 32px rgba(139, 69, 19, 0.1);
            --text-primary: #2F4F4F;
            --text-secondary: rgba(47, 79, 79, 0.8);
            --border-radius: 16px;
            --blur: blur(20px);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset y Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #8B7355 0%, #D2B48C 100%);
            color: var(--text-primary);
            line-height: 1.4;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Fondo principal DESIERTO DE ATACAMA */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(139, 115, 85, 0.7), rgba(210, 180, 140, 0.7)),
                url('https://images.unsplash.com/photo-1527482797697-8795b05a13fe?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
        }

        /* Patr√≥n de dunas decorativo */
        body::after {
            content: "";
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background-image: 
                linear-gradient(to top, rgba(139, 115, 85, 0.9), transparent),
                url('https://images.unsplash.com/photo-1542401886-65d6c61db217?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: bottom;
            z-index: -1;
            opacity: 0.8;
        }

        /* Efecto de calor del desierto */
        .heat-wave {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%
            );
            animation: heatWave 4s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes heatWave {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Splash Screen Glassmorphism Desierto */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.9), rgba(139, 69, 19, 0.9));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: var(--text-primary);
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
        }

        .splash-content {
            text-align: center;
            animation: fadeIn 1s ease;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .splash-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(47, 79, 79, 0.2);
            margin: 1.5rem auto;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Main App Container */
        #appContainer {
            display: none;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* Header Compacto Desierto */
        .app-header {
            background: linear-gradient(rgba(255, 248, 220, 0.9), rgba(255, 248, 220, 0.95));
            padding: 12px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Logo Desierto */
        .app-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-center {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .app-logo {
            font-size: 2.2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .brand-text h1 {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -0.5px;
            text-shadow: 1px 1px 2px rgba(255, 248, 220, 0.3);
        }

        .brand-text small {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Status Bar - Dr. GeoBot */
        .status-bar {
            display: flex;
            justify-content: flex-end;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.1), rgba(139, 69, 19, 0.1));
            border-radius: 12px;
            border: 1.5px solid var(--accent);
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 69, 19, 0.2);
        }

        .status-item.active {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(50, 205, 50, 0.2));
            border-color: var(--success);
        }

        .status-icon {
            font-size: 1.3rem;
        }

        .status-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* GPS Data Bar - Estilo Desierto */
        .gps-data-bar {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 12px 15px;
            margin: 10px 15px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
            font-size: 0.75rem;
        }

        .gps-data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            padding: 0 5px;
            min-width: 0;
        }

        .gps-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .gps-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-shadow: 0 1px 2px rgba(255, 248, 220, 0.3);
        }

        /* Main Content - Desierto */
        .main-content {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Glass Cards Desierto */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 18px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.05), transparent);
            pointer-events: none;
        }

        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(139, 69, 19, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1.5px solid var(--glass-border);
        }

        .card-header i {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            text-shadow: 0 1px 2px rgba(255, 248, 220, 0.3);
        }

        /* Map Containers Desierto */
        .map-container {
            width: 100%;
            height: 220px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            position: relative;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.1);
        }

        #map, #map3d {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .map-control-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .map-control-btn:hover {
            background: rgba(212, 160, 23, 0.15);
            transform: scale(1.1);
        }

        /* Quick Actions Desierto */
        .quick-actions {
            display: flex;
            gap: 12px;
            margin-top: 18px;
        }

        .quick-actions .glass-btn {
            flex: 1;
            padding: 14px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Glass Buttons Desierto */
        .glass-btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--glass-border);
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .glass-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 160, 23, 0.2), transparent);
            transition: 0.5s;
        }

        .glass-btn:hover::before {
            left: 100%;
        }

        .glass-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.15);
        }

        .glass-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .glass-btn.success {
            background: linear-gradient(135deg, var(--success), #1E7A1E);
            border: none;
            color: white;
        }

        .glass-btn.warning {
            background: linear-gradient(135deg, var(--warning), #E67E22);
            border: none;
            color: white;
        }

        .glass-btn.danger {
            background: linear-gradient(135deg, var(--danger), #B22222);
            border: none;
            color: white;
        }

        /* Camera Container Desierto */
        .camera-container {
            width: 100%;
            height: 200px;
            background: rgba(47, 79, 79, 0.7);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.1);
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        /* Chat Interface Desierto */
        .chat-container {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            height: 260px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .chat-message.ai {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.2), rgba(100, 149, 237, 0.2));
            align-self: flex-start;
            border: 1.5px solid rgba(70, 130, 180, 0.3);
            margin-left: 28px;
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.1);
        }

        .chat-message.ai::before {
            content: "üë®‚Äçüî¨";
            position: absolute;
            left: -28px;
            font-size: 1.3rem;
        }

        .chat-message.user {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(184, 134, 11, 0.2));
            align-self: flex-end;
            border: 1.5px solid rgba(212, 160, 23, 0.3);
            margin-right: 28px;
            box-shadow: 0 4px 12px rgba(212, 160, 23, 0.1);
        }

        .chat-message.user::before {
            content: "üßë‚Äçüíº";
            position: absolute;
            right: -28px;
            font-size: 1.3rem;
        }

        .chat-input-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .glass-input {
            flex: 1;
            padding: 16px 18px;
            border: 1.5px solid var(--glass-border);
            border-radius: 12px;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-weight: 500;
        }

        .glass-input:focus {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.2));
            box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.1);
        }

        .glass-input::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Geology Data Desierto */
        .geology-data {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.15), rgba(139, 69, 19, 0.1));
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
            border-left: 5px solid var(--primary);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        /* Layers Panel Desierto */
        .layers-panel {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        /* Bottom Navigation Desierto */
        .bottom-nav {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 340px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(30px);
            display: flex;
            justify-content: space-around;
            padding: 10px 12px;
            border-radius: 18px;
            box-shadow: 0 10px 35px rgba(139, 69, 19, 0.2);
            z-index: 1000;
            border: 1.5px solid var(--glass-border);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.68rem;
            padding: 6px 8px;
            border-radius: 12px;
            transition: var(--transition);
            min-width: 60px;
            position: relative;
            font-weight: 600;
        }

        .nav-btn span:first-child {
            font-size: 1.4rem;
            margin-bottom: 3px;
        }

        .nav-btn.active {
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
        }

        .nav-btn.active::after {
            content: "";
            position: absolute;
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
        }

        /* Notification Desierto */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(30px);
            padding: 14px 18px;
            border-radius: 14px;
            box-shadow: 0 15px 40px rgba(139, 69, 19, 0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            border: 1.5px solid var(--glass-border);
            border-left: 5px solid var(--success);
            font-size: 0.85rem;
            font-weight: 500;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error { border-left-color: var(--danger); }
        .notification.warning { border-left-color: var(--warning); }
        .notification.info { border-left-color: var(--info); }

        /* Map Legend Desierto */
        .map-legend {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(20px);
            padding: 10px;
            border-radius: 10px;
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            font-size: 0.75rem;
            border: 1.5px solid var(--glass-border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Custom Checkbox Desierto */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.1));
            transition: .4s;
            border-radius: 26px;
            border: 1.5px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 2px;
            background: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(139, 69, 19, 0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background: white;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 35px 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .empty-state span:first-child {
            font-size: 2.5rem;
            margin-bottom: 20px;
            display: block;
            opacity: 0.6;
        }

        /* Scrollbar Desierto */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.1));
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(212, 160, 23, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 360px) {
            html { font-size: 13px; }
            
            .main-content { padding: 10px; }
            
            .gps-data-bar {
                margin: 8px 10px;
                padding: 10px;
                flex-wrap: wrap;
            }
            
            .gps-data-item {
                flex: 1 0 45%;
                margin-bottom: 10px;
                min-width: 80px;
            }
            
            .map-container { height: 190px; }
            
            .camera-container { height: 170px; }
            
            .chat-container { height: 240px; }
            
            .quick-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .bottom-nav {
                width: 96%;
                padding: 8px 10px;
                border-radius: 16px;
            }
            
            .nav-btn {
                min-width: 55px;
                font-size: 0.65rem;
                padding: 5px 6px;
            }
            
            .nav-btn span:first-child {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) and (min-width: 361px) {
            .gps-data-bar {
                font-size: 0.72rem;
            }
            
            .gps-value {
                font-size: 0.82rem;
            }
        }

        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .map-container { height: 170px; }
            .camera-container { height: 140px; }
            .chat-container { height: 200px; }
            .bottom-nav { bottom: 8px; }
            .gps-data-bar { margin: 8px; padding: 10px; }
        }

        /* Cactus decorativo */
        .cactus {
            position: absolute;
            font-size: 1.5rem;
            z-index: 1;
            opacity: 0.7;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .cactus-left {
            bottom: 90px;
            left: 20px;
        }

        .cactus-right {
            bottom: 90px;
            right: 20px;
        }
    </style>
</head>
<body>
    <!-- Efecto de calor del desierto -->
    <div class="heat-wave"></div>
    
    <!-- Cactus decorativos -->
    <div class="cactus cactus-left">üåµ</div>
    <div class="cactus cactus-right">üåµ</div>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="splash-content">
            <div class="splash-icon">üèúÔ∏è</div>
            <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AtacamApp</h1>
            <p style="margin-bottom: 1rem; opacity: 0.9; font-size: 0.95rem; color: var(--text-primary); font-weight: 500;">Geolog√≠a 3D & Proyecci√≥n Estructural</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="loadingText" style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Inicializando sistema...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <!-- Header Compacto -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-brand">
                    <div class="brand-center">
                        <div class="app-logo">üèúÔ∏è</div>
                        <div class="brand-text">
                            <h1>AtacamApp</h1>
                            <small>Geolog√≠a 3D & IA</small>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-item" id="statusIcon" onclick="toggleDrGeoBot()">
                        <span class="status-icon">ü§ñ</span>
                        <span class="status-value" id="aiStatusValue">OFF</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- GPS Data Bar Compacta -->
        <div class="gps-data-bar" id="gpsDataBar">
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Latitud</div>
                <div class="gps-value" id="latitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Longitud</div>
                <div class="gps-value" id="longitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>‚õ∞Ô∏è</span>Altitud</div>
                <div class="gps-value" id="altitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üèôÔ∏è</span>Ciudad</div>
                <div class="gps-value" id="cityValue">--</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page 1: Dashboard -->
            <div class="page active" id="pageDashboard">
                <!-- 2D Map Section -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üó∫Ô∏è</span>
                        <h2 class="card-title">Mapa Geol√≥gico</h2>
                    </div>
                    
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <button class="map-control-btn" id="mapSatelliteBtn" title="Vista sat√©lite">
                                <span>üõ∞Ô∏è</span>
                            </button>
                            <button class="map-control-btn" id="mapTerrainBtn" title="Vista topogr√°fica">
                                <span>‚õ∞Ô∏è</span>
                            </button>
                        </div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #D4A017, #8B4513);"></div>
                                <span>Geolog√≠a ü™®</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #DC143C, #8B0000);"></div>
                                <span>Fallas ‚ö°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="updateLocationBtn">
                            <span>üìç</span>
                            Actualizar GPS
                        </button>
                        <button class="glass-btn warning" id="addPointBtn">
                            <span>‚ûï</span>
                            Agregar Punto
                        </button>
                        <button class="glass-btn danger" id="clearMapBtn">
                            <span>üóëÔ∏è</span>
                            Limpiar
                        </button>
                    </div>
                </div>

                <!-- Geology Info -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Datos Geol√≥gicos</h2>
                    </div>
                    
                    <div id="geologyInfo" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Activa el GPS para ver datos geol√≥gicos</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Camera & Analysis -->
            <div class="page" id="pageCamera">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üì∏</span>
                        <h2 class="card-title">An√°lisis Fotogeol√≥gico</h2>
                    </div>
                    
                    <div class="camera-container">
                        <video id="cameraFeed" autoplay playsinline></video>
                        <div style="position: absolute; bottom: 12px; left: 12px; background: rgba(47, 79, 79, 0.7); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(255, 248, 220, 0.2);">
                            <span id="cameraStatusText" style="color: white; font-size: 0.8rem; font-weight: 500;">
                                <span>üî¥</span> C√°mara inactiva
                            </span>
                        </div>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="glass-btn primary" id="startCameraBtn">
                            <span>üé•</span>
                            Activar C√°mara
                        </button>
                        <button class="glass-btn warning" id="captureBtn" disabled>
                            <span>üì∏</span>
                            Capturar
                        </button>
                        <button class="glass-btn success" id="analyzeBtn" disabled>
                            <span>ü§ñ</span>
                            Analizar IA
                        </button>
                        <button class="glass-btn danger" id="stopCameraBtn" disabled>
                            <span>‚èπÔ∏è</span>
                            Detener
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Resultados</h2>
                    </div>
                    
                    <div id="analysisResults" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Capture una imagen para analizar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: 3D Map -->
            <div class="page" id="page3DMap">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üåç</span>
                        <h2 class="card-title">Visualizaci√≥n 3D</h2>
                    </div>
                    
                    <div class="map-container">
                        <div id="map3d"></div>
                    </div>
                    
                    <div class="layers-panel">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span>üóÇÔ∏è</span> Capas Geol√≥gicas
                        </h3>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem;">‚õ∞Ô∏è</span>
                                <span style="font-weight: 500;">Topograf√≠a</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerTopography" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem;">ü™®</span>
                                <span style="font-weight: 500;">Geolog√≠a Base</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerGeology" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem;">‚ö°</span>
                                <span style="font-weight: 500;">Sistema de Fallas</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerFaults">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="generate3D">
                            <span>üîÑ</span>
                            Generar 3D
                        </button>
                        <button class="glass-btn success" id="export3D">
                            <span>üíæ</span>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìê</span>
                        <h2 class="card-title">Par√°metros Estructurales</h2>
                    </div>
                    
                    <div id="structuralParams" class="geology-data">
                        <div class="empty-state">
                            <span>üìè</span>
                            <p>Genera modelo 3D para ver par√°metros</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: AI Assistant -->
            <div class="page" id="pageAI">
                <div class="glass-card">
                    <div class="card-header">
                        <span>ü§ñ</span>
                        <h2 class="card-title">Dr. GeoBot - IA</h2>
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message ai">
                            <strong>Dr. GeoBot:</strong> ¬°Hola! Soy tu asistente IA especializado en geolog√≠a del Desierto de Atacama. Act√≠valo desde el bot√≥n ü§ñ para comenzar a analizar rocas, minerales y estructuras geol√≥gicas.
                        </div>
                    </div>
                    
                    <div class="chat-input-group">
                        <input type="text" class="glass-input" id="chatInput" 
                               placeholder="Pregunta sobre geolog√≠a, minerales, estructuras...">
                        <button class="glass-btn primary" id="sendMessage" style="width: auto; min-width: 50px; padding: 16px 20px;">
                            <span>‚úàÔ∏è</span>
                        </button>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn success" id="analyzeLocation">
                            <span>üìç</span>
                            Analizar Ubicaci√≥n
                        </button>
                        <button class="glass-btn warning" id="identifyMineral">
                            <span>üíé</span>
                            Identificar Mineral
                        </button>
                        <button class="glass-btn info" id="suggestMethodology">
                            <span>üìã</span>
                            Metodolog√≠a
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üíæ</span>
                        <h2 class="card-title">Base de Datos</h2>
                    </div>
                    
                    <div id="geologyDatabase" class="geology-data">
                        <div class="data-row">
                            <span>Minerales üíé:</span>
                            <span id="mineralCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Rocas ü™®:</span>
                            <span id="rockCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Localidades üèúÔ∏è:</span>
                            <span id="locationCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>IA Status ü§ñ:</span>
                            <span id="aiActiveStatus">Inactiva</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-btn active" data-page="dashboard">
                <span>üè†</span>
                <span>Inicio</span>
            </a>
            <a href="#" class="nav-btn" data-page="camera">
                <span>üì∏</span>
                <span>C√°mara</span>
            </a>
            <a href="#" class="nav-btn" data-page="3DMap">
                <span>üåç</span>
                <span>3D</span>
            </a>
            <a href="#" class="nav-btn" data-page="AI">
                <span>ü§ñ</span>
                <span>IA</span>
            </a>
        </nav>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <span id="notificationIcon">‚úÖ</span>
        <span id="notificationText">Mensaje de notificaci√≥n</span>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN - DEEPSEEK API
        // ============================================
        const CONFIG = {
            MAPBOX_TOKEN: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA',
            DEEPSEEK_API_KEY: 'sk-2f64faf4b77344959d768c9e7caf39fb',
            DEEPSEEK_API_URL: 'https://api.deepseek.com/v1/chat/completions',
            DEFAULT_LOCATION: {
                lat: -27.3667,
                lng: -70.3333,
                zoom: 10
            },
            MAP_LAYERS: {
                topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            }
        };

        // Variables globales
        let map = null;
        let map3d = null;
        let currentLocation = null;
        let cameraStream = null;
        let isCameraActive = false;
        let currentPhoto = null;
        let markersLayer = null;
        let isDrGeoBotActive = false;
        let mindatData = null;
        let chatHistory = [];

        // ============================================
        // BASE DE DATOS MINERALES (Mindat.org - Atacama)
        // ============================================
        const MINERAL_DATABASE = {
            "Regi√≥n de Antofagasta": {
                minerals: [
                    { name: "Calcopirita", formula: "CuFeS‚ÇÇ", emoji: "üíé", color: "Amarillo lat√≥n", hardness: "3.5-4", uses: "Principal mineral de cobre", yacimientos: ["Chuquicamata", "Escondida", "Cerro Negro"] },
                    { name: "Atacamita", formula: "Cu‚ÇÇCl(OH)‚ÇÉ", emoji: "üíö", color: "Verde esmeralda", hardness: "3-3.5", uses: "Mineral secundario de cobre", yacimientos: ["Salar de Atacama", "Cerro Pintado"] },
                    { name: "Clorargirita", formula: "AgCl", emoji: "‚ö™", color: "Gris a incoloro", hardness: "2.5", uses: "Mineral de plata", yacimientos: ["Caracoles", "Sierra Gorda"] },
                    { name: "Hematita", formula: "Fe‚ÇÇO‚ÇÉ", emoji: "üî¥", color: "Rojo a negro", hardness: "5.5-6.5", uses: "Mineral de hierro", yacimientos: ["Cerro Im√°n", "Sierra Gorda"] },
                    { name: "Cuarzo", formula: "SiO‚ÇÇ", emoji: "üî∂", color: "Variable", hardness: "7", uses: "Electr√≥nica, √≥ptica", yacimientos: ["Todas las localidades"] }
                ],
                localities: ["Chuquicamata", "Escondida", "Cerro Negro", "Salar de Atacama", "Sierra Gorda"]
            },
            "Regi√≥n de Atacama": {
                minerals: [
                    { name: "Epidota", formula: "Ca‚ÇÇAl‚ÇÇ(Fe¬≥‚Å∫,Al)(SiO‚ÇÑ)(Si‚ÇÇO‚Çá)O(OH)", emoji: "üíö", color: "Verde pistacho", hardness: "6-7", uses: "Mineral √≠ndice metam√≥rfico", yacimientos: ["Cerro Blanco", "Cerro Negro"] },
                    { name: "Yeso", formula: "CaSO‚ÇÑ¬∑2H‚ÇÇO", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2", uses: "Construcci√≥n", yacimientos: ["Copiap√≥", "Vallenar"] },
                    { name: "Azurita", formula: "Cu‚ÇÉ(CO‚ÇÉ)‚ÇÇ(OH)‚ÇÇ", emoji: "üíô", color: "Azul intenso", hardness: "3.5-4", uses: "Mineral ornamental", yacimientos: ["Cerro Im√°n", "Pampa Larga"] },
                    { name: "Malaquita", formula: "Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ", emoji: "üíö", color: "Verde", hardness: "3.5-4", uses: "Piedra ornamental", yacimientos: ["Cerro Blanco", "Cerro Negro"] },
                    { name: "Halita", formula: "NaCl", emoji: "üßÇ", color: "Incoloro a blanco", hardness: "2.5", uses: "Sal de roca", yacimientos: ["Salar de Pedernales"] }
                ],
                localities: ["Copiap√≥", "Vallenar", "Cerro Blanco", "Cerro Negro", "Salar de Pedernales"]
            }
        };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üèúÔ∏è AtacamApp - Iniciando aplicaci√≥n...');
            simulateLoading();
            
            // Inicializar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Cargar datos de minerales
            loadMindatData();
        });

        function simulateLoading() {
            let progress = 0;
            const messages = [
                'Conectando con DeepSeek AI... ü§ñ',
                'Cargando base de minerales Atacama... üíé',
                'Configurando mapas 3D... üó∫Ô∏è',
                'Inicializando Dr. GeoBot... üë®‚Äçüî¨',
                '¬°Listo para explorar! üèúÔ∏è'
            ];
            
            const interval = setInterval(() => {
                progress += 20;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('loadingText').textContent = messages[progress / 20 - 1];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('splashScreen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('splashScreen').style.display = 'none';
                            document.getElementById('appContainer').style.display = 'block';
                            initializeApp();
                        }, 500);
                    }, 500);
                }
            }, 400);
        }

        function loadMindatData() {
            mindatData = MINERAL_DATABASE;
            console.log('‚úÖ Base de datos de minerales del Desierto de Atacama cargada');
        }

        function initializeApp() {
            console.log('‚úÖ AtacamApp inicializada');
            
            // Configurar navegaci√≥n
            setupNavigation();
            
            // Inicializar componentes
            init2DMap();
            init3DMap();
            
            // Configurar eventos
            setupEventListeners();
            
            // Solicitar permisos
            requestPermissions();
            
            // Actualizar estado inicial
            updateStatusIcon(false);
            updateDatabaseCounts();
            
            showNotification('¬°Bienvenido al Desierto de Atacama! üèúÔ∏è', 'success');
            
            // Mensaje inicial del Dr. GeoBot
            setTimeout(() => {
                addMessageToChat('ai', `üë®‚Äçüî¨ <strong>Dr. GeoBot - Sistema IA de Geolog√≠a:</strong><br><br>
                ¬°Hola! Soy Dr. GeoBot, tu asistente IA especializado en geolog√≠a del Desierto de Atacama.<br><br>
                <strong>Conectado a DeepSeek API ‚úÖ</strong><br>
                <strong>Base de datos:</strong> ${countMinerals()} minerales registrados<br><br>
                <em>Activa el bot√≥n ü§ñ en el header para comenzar</em>`);
            }, 1000);
        }

        // ============================================
        // DR. GEOBOT - DEEPSEEK AI
        // ============================================
        function toggleDrGeoBot() {
            isDrGeoBotActive = !isDrGeoBotActive;
            updateStatusIcon(isDrGeoBotActive);
            
            if (isDrGeoBotActive) {
                showNotification('Dr. GeoBot ACTIVADO con DeepSeek AI ü§ñ', 'success');
                document.getElementById('aiActiveStatus').textContent = 'Activa';
                document.getElementById('aiActiveStatus').style.color = '#228B22';
                
                addMessageToChat('ai', `<strong>ü§ñ DR. GEOBOT ACTIVADO:</strong><br><br>
                <strong>‚úÖ Conectado a DeepSeek API</strong><br>
                <strong>üìç Acceso a ubicaci√≥n GPS:</strong> ${currentLocation ? 'Conectado' : 'Esperando'}<br>
                <strong>üíé Base de datos:</strong> ${countMinerals()} minerales<br>
                <strong>üó∫Ô∏è Mapas:</strong> 2D y 3D operativos<br><br>
                <strong>¬øEn qu√© puedo ayudarte?</strong><br>
                ‚Ä¢ Identificaci√≥n de minerales/rocas<br>
                ‚Ä¢ An√°lisis estructural<br>
                ‚Ä¢ Interpretaci√≥n geol√≥gica<br>
                ‚Ä¢ M√©todos de campo<br>
                ‚Ä¢ Proyecciones 3D`);
                
                // Cambiar a p√°gina de IA
                if (!document.getElementById('pageAI').classList.contains('active')) {
                    switchPage('AI');
                }
            } else {
                showNotification('Dr. GeoBot DESACTIVADO ‚èπÔ∏è', 'warning');
                document.getElementById('aiActiveStatus').textContent = 'Inactiva';
                document.getElementById('aiActiveStatus').style.color = '#DC143C';
            }
        }

        function updateStatusIcon(active) {
            const statusIcon = document.getElementById('statusIcon');
            const aiStatusValue = document.getElementById('aiStatusValue');
            
            if (active) {
                statusIcon.classList.add('active');
                statusIcon.style.background = 'linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(50, 205, 50, 0.2))';
                statusIcon.style.borderColor = '#228B22';
                aiStatusValue.textContent = 'ON';
                aiStatusValue.style.color = '#228B22';
            } else {
                statusIcon.classList.remove('active');
                statusIcon.style.background = 'linear-gradient(135deg, rgba(212, 160, 23, 0.1), rgba(139, 69, 19, 0.1))';
                statusIcon.style.borderColor = 'var(--accent)';
                aiStatusValue.textContent = 'OFF';
                aiStatusValue.style.color = 'var(--text-primary)';
            }
        }

        async function sendMessageToAI() {
            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            input.focus();

            const thinkingId = addMessageToChat('ai', 'Procesando con DeepSeek AI... üîç');

            try {
                const response = await callDeepSeekAPI(message);
                updateMessage(thinkingId, response);
                
                // Guardar en historial
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: response });
                
                // Limitar historial a √∫ltimos 10 mensajes
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
            } catch (error) {
                console.error('Error con DeepSeek:', error);
                updateMessage(thinkingId, generateLocalResponse(message));
            }
        }

        async function callDeepSeekAPI(prompt) {
            const context = buildGeologyContext();
            
            const messages = [
                {
                    role: "system",
                    content: `Eres Dr. GeoBot, un ge√≥logo experto especializado en el Desierto de Atacama, Chile. 
                    Eres parte de la aplicaci√≥n AtacamApp. Responde en espa√±ol, con emojis relevantes y formato claro.
                    Usa markdown b√°sico para formato. S√© t√©cnico pero accesible.`
                },
                ...chatHistory.slice(-8),
                {
                    role: "user",
                    content: `${context}\n\nPregunta del usuario: ${prompt}`
                }
            ];

            const response = await fetch(CONFIG.DEEPSEEK_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: messages,
                    max_tokens: 1000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function buildGeologyContext() {
            let context = `CONTEXTO ACTUAL ATACAMAPP:\n\n`;
            
            if (currentLocation) {
                context += `üìå UBICACI√ìN ACTUAL:\n`;
                context += `- Coordenadas: ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞\n`;
                context += `- Altitud: ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}\n`;
                context += `- Precisi√≥n: ${Math.round(currentLocation.accuracy)}m\n`;
                context += `- Regi√≥n: ${getRegionFromLocation()}\n`;
                context += `- Ciudad m√°s cercana: ${document.getElementById('cityValue').textContent}\n\n`;
            }
            
            context += `üíé BASE DE DATOS MINERAL√ìGICA:\n`;
            context += `- Total minerales: ${countMinerals()}\n`;
            context += `- Regiones: Antofagasta, Atacama\n`;
            context += `- Minerales principales: Calcopirita, Atacamita, Hematita, Cuarzo\n\n`;
            
            context += `üó∫Ô∏è HERRAMIENTAS DISPONIBLES:\n`;
            context += `- Mapa geol√≥gico 2D con capas\n`;
            context += `- An√°lisis fotogeol√≥gico con c√°mara\n`;
            context += `- Visualizaci√≥n 3D con Mapbox\n`;
            context += `- Proyecci√≥n estructural\n\n`;
            
            context += `üë®‚Äçüî¨ RECOMENDACIONES GENERALES:\n`;
            context += `- El Desierto de Atacama es rico en minerales de cobre\n`;
            context += `- Sistemas de fallas NNE-SSO predominantes\n`;
            context += `- Actividad minera extensa en la regi√≥n\n`;
            context += `- Clima √°rido extremo, tomar precauciones`;
            
            return context;
        }

        function generateLocalResponse(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            
            if (lowerPrompt.includes('mineral') || lowerPrompt.includes('roca') || lowerPrompt.includes('identificar')) {
                return generateMineralResponse();
            }
            
            if (lowerPrompt.includes('estructura') || lowerPrompt.includes('falla') || lowerPrompt.includes('buzamiento')) {
                return generateStructureResponse();
            }
            
            if (lowerPrompt.includes('mapa') || lowerPrompt.includes('ubicaci√≥n') || lowerPrompt.includes('localizaci√≥n')) {
                return generateLocationResponse();
            }
            
            if (lowerPrompt.includes('m√©todo') || lowerPrompt.includes('metodolog√≠a') || lowerPrompt.includes('campo')) {
                return generateMethodologyResponse();
            }
            
            return `üë®‚Äçüî¨ <strong>Dr. GeoBot:</strong><br><br>
            Como ge√≥logo especializado en el Desierto de Atacama, puedo ayudarte con:<br><br>
            ‚Ä¢ <strong>üíé Identificaci√≥n mineral√≥gica</strong><br>
            ‚Ä¢ <strong>‚ö° An√°lisis estructural</strong><br>
            ‚Ä¢ <strong>üó∫Ô∏è Interpretaci√≥n de mapas</strong><br>
            ‚Ä¢ <strong>üì∏ An√°lisis fotogeol√≥gico</strong><br>
            ‚Ä¢ <strong>üåç Proyecci√≥n 3D</strong><br><br>
            <em>Prueba preguntando sobre minerales espec√≠ficos o an√°lisis de estructuras.</em>`;
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function generateMineralResponse() {
            const region = getRegionFromLocation();
            const regionData = mindatData[region];
            
            if (regionData) {
                let response = `<strong>üîç AN√ÅLISIS MINERAL√ìGICO - ${region}:</strong><br><br>`;
                response += `<strong>Minerales principales:</strong><br><br>`;
                
                regionData.minerals.slice(0, 3).forEach(mineral => {
                    response += `<strong>${mineral.emoji} ${mineral.name}</strong><br>`;
                    response += `‚Ä¢ F√≥rmula: ${mineral.formula}<br>`;
                    response += `‚Ä¢ Color: ${mineral.color}<br>`;
                    response += `‚Ä¢ Dureza: ${mineral.hardness} (Mohs)<br>`;
                    response += `‚Ä¢ Usos: ${mineral.uses}<br>`;
                    response += `‚Ä¢ Yacimientos: ${mineral.yacimientos.join(', ')}<br><br>`;
                });
                
                response += `<strong>üéØ Recomendaciones:</strong><br>`;
                response += `1. Usa la c√°mara para identificar minerales üì∏<br>`;
                response += `2. Toma muestras representativas üß™<br>`;
                response += `3. Documenta coordenadas exactas üìç<br><br>`;
                response += `<em>¬øQuieres informaci√≥n sobre alg√∫n mineral espec√≠fico?</em>`;
                
                return response;
            }
            
            return `üíé <strong>MINERALES DEL DESIERTO DE ATACAMA:</strong><br><br>
            Los principales minerales econ√≥micos en esta regi√≥n son:<br><br>
            ‚Ä¢ <strong>Calcopirita (CuFeS‚ÇÇ)</strong> - Principal mineral de cobre<br>
            ‚Ä¢ <strong>Atacamita (Cu‚ÇÇCl(OH)‚ÇÉ)</strong> - Mineral secundario de cobre<br>
            ‚Ä¢ <strong>Hematita (Fe‚ÇÇO‚ÇÉ)</strong> - Mineral de hierro<br>
            ‚Ä¢ <strong>Cuarzo (SiO‚ÇÇ)</strong> - Presente en vetas<br><br>
            <strong>Activa el GPS para ver minerales de tu ubicaci√≥n espec√≠fica.</strong>`;
        }

        function generateStructureResponse() {
            return `‚ö° <strong>AN√ÅLISIS ESTRUCTURAL - DESIERTO DE ATACAMA:</strong><br><br>
            <strong>Sistemas estructurales principales:</strong><br><br>
            1. <strong>Sistema de Fallas NNE-SSO</strong><br>
            ‚Ä¢ Orientaci√≥n: 10¬∞-30¬∞<br>
            ‚Ä¢ Buzamiento: 45¬∞-60¬∞ al este<br>
            ‚Ä¢ Mineralizaci√≥n: Vetas de Cu-Au<br><br>
            
            2. <strong>Sistema de Fallas E-O</strong><br>
            ‚Ä¢ Orientaci√≥n: 80¬∞-100¬∞<br>
            ‚Ä¢ Buzamiento: 60¬∞-70¬∞ al norte<br>
            ‚Ä¢ Mineralizaci√≥n: Stockworks de Cu<br><br>
            
            <strong>üìê M√©todos de medici√≥n recomendados:</strong><br>
            ‚Ä¢ Br√∫jula geol√≥gica con clin√≥metro<br>
            ‚Ä¢ Correcci√≥n por declinaci√≥n magn√©tica<br>
            ‚Ä¢ Uso de escala en fotograf√≠as<br><br>
            
            <strong>üåç Herramientas AtacamApp:</strong><br>
            ‚Ä¢ Usa el mapa 3D para visualizaci√≥n<br>
            ‚Ä¢ Agrega puntos estructurales en el mapa 2D<br>
            ‚Ä¢ Toma fotos con escala para an√°lisis`;
        }

        function generateLocationResponse() {
            if (currentLocation) {
                return `üìç <strong>AN√ÅLISIS DE UBICACI√ìN:</strong><br><br>
                <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞<br>
                <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm ‚õ∞Ô∏è' : 'Desconocida'}<br>
                <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m üéØ<br>
                <strong>Regi√≥n:</strong> ${getRegionFromLocation()}<br>
                <strong>Ciudad:</strong> ${document.getElementById('cityValue').textContent}<br><br>
                
                <strong>üó∫Ô∏è Contexto geol√≥gico:</strong><br>
                ‚Ä¢ ${getGeologicalContext()}<br>
                ‚Ä¢ Sistema de fallas NNE-SSO predominante<br>
                ‚Ä¢ Mineralizaci√≥n de cobre porf√≠rico y epitermal<br><br>
                
                <strong>üéØ Acciones recomendadas:</strong><br>
                1. Agregar punto geol√≥gico al mapa<br>
                2. Tomar fotograf√≠as del √°rea<br>
                3. Realizar an√°lisis estructural<br>
                4. Generar modelo 3D del sector`;
            }
            
            return `üìç <strong>UBICACI√ìN NO DISPONIBLE</strong><br><br>
            Para an√°lisis geol√≥gico preciso, necesito tu ubicaci√≥n:<br><br>
            1. Ve a la p√°gina de Inicio<br>
            2. Presiona "üìç Actualizar GPS"<br>
            3. Permite acceso a ubicaci√≥n<br><br>
            <em>Con tu ubicaci√≥n puedo proporcionar an√°lisis espec√≠fico del √°rea.</em>`;
        }

        function generateMethodologyResponse() {
            return `üìã <strong>METODOLOG√çA DE CAMPO - ATACAMAPP:</strong><br><br>
            <strong>1. üó∫Ô∏è Mapeo Geol√≥gico:</strong><br>
            ‚Ä¢ GPS de alta precisi√≥n (¬±1m)<br>
            ‚Ä¢ Fotograf√≠a geol√≥gica con escala<br>
            ‚Ä¢ Descripci√≥n litol√≥gica detallada<br>
            ‚Ä¢ Muestreo representativo<br><br>
            
            <strong>2. üìê An√°lisis Estructural:</strong><br>
            ‚Ä¢ Mediciones con br√∫jula Brunton<br>
            ‚Ä¢ Correcci√≥n por declinaci√≥n magn√©tica<br>
            ‚Ä¢ An√°lisis estereogr√°fico<br>
            ‚Ä¢ Cartograf√≠a de fallas y pliegues<br><br>
            
            <strong>3. üíé Muestreo Mineral√≥gico:</strong><br>
            ‚Ä¢ Muestras de mano (500g cada una)<br>
            ‚Ä¢ Muestras para l√°mina delgada<br>
            ‚Ä¢ Documentaci√≥n fotogr√°fica completa<br>
            ‚Ä¢ Georreferenciaci√≥n precisa<br><br>
            
            <strong>4. ü§ñ An√°lisis con IA:</strong><br>
            ‚Ä¢ Identificaci√≥n de minerales<br>
            ‚Ä¢ Clasificaci√≥n de rocas<br>
            ‚Ä¢ Interpretaci√≥n estructural<br>
            ‚Ä¢ Recomendaciones de muestreo`;
        }

        function getRegionFromLocation() {
            if (!currentLocation) return "Desierto de Atacama";
            
            const lat = currentLocation.latitude;
            
            if (lat < -22) return "Regi√≥n de Antofagasta";
            if (lat < -30) return "Regi√≥n de Atacama";
            
            return "Desierto de Atacama";
        }

        function getGeologicalContext() {
            const region = getRegionFromLocation();
            
            if (region === "Regi√≥n de Antofagasta") {
                return "Cordillera de la Costa - Yacimientos de cobre porf√≠rico (Chuquicamata, Escondida)";
            } else if (region === "Regi√≥n de Atacama") {
                return "Precordillera andina - Vetas epitermales de Au-Cu (Cerro Blanco, Cerro Negro)";
            }
            
            return "Regi√≥n des√©rtica con geolog√≠a compleja y mineralizaci√≥n diversa";
        }

        function countMinerals() {
            let count = 0;
            if (mindatData) {
                Object.values(mindatData).forEach(region => {
                    count += region.minerals.length;
                });
            }
            return count;
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.dataset.page;
                    switchPage(pageId);
                    
                    // Actualizar t√≠tulo seg√∫n p√°gina
                    const titles = {
                        'dashboard': 'Inicio - Mapa Geol√≥gico',
                        'camera': 'C√°mara - An√°lisis Fotogeol√≥gico',
                        '3DMap': '3D - Visualizaci√≥n 3D',
                        'AI': `IA - ${isDrGeoBotActive ? 'Dr. GeoBot Activo' : 'Dr. GeoBot Inactivo'}`
                    };
                    
                    if (titles[pageId]) {
                        document.title = `AtacamApp - ${titles[pageId]}`;
                    }
                });
            });
        }

        function switchPage(pageId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1));
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Acciones espec√≠ficas por p√°gina
            if (pageId === 'camera' && !isCameraActive) {
                showNotification('Activa la c√°mara para an√°lisis fotogeol√≥gico üì∏', 'info');
            } else if (pageId === 'AI' && !isDrGeoBotActive) {
                showNotification('Activa Dr. GeoBot para consultas IA ü§ñ', 'info');
            }
        }

        function addMessageToChat(sender, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = text;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageId;
        }

        function updateMessage(messageId, text) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.innerHTML = text;
            }
        }

        function updateDatabaseCounts() {
            if (mindatData) {
                let mineralCount = 0;
                let locationCount = 0;
                
                Object.values(mindatData).forEach(region => {
                    mineralCount += region.minerals.length;
                    locationCount += region.localities.length;
                });
                
                document.getElementById('mineralCount').textContent = mineralCount;
                document.getElementById('rockCount').textContent = "24 tipos";
                document.getElementById('locationCount').textContent = locationCount;
            }
        }

        // ============================================
        // GPS Y LOCALIZACI√ìN
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                showNotification('GPS no disponible ‚ùå', 'error');
                return;
            }

            showNotification('Obteniendo ubicaci√≥n GPS... üõ∞Ô∏è', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                handleGPSPosition,
                handleGPSError,
                options
            );
        }

        function handleGPSPosition(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                altitude: position.coords.altitude || 0,
                accuracy: position.coords.accuracy,
                timestamp: new Date(position.timestamp)
            };

            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfo();
            
            const accuracy = Math.round(currentLocation.accuracy);
            if (accuracy < 50) {
                showNotification(`üìç GPS de alta precisi√≥n (${accuracy}m)`, 'success');
            } else {
                showNotification(`üìç Ubicaci√≥n obtenida (${accuracy}m)`, 'success');
            }
            
            // Notificar a Dr. GeoBot si est√° activo
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç UBICACI√ìN ACTUALIZADA:</strong><br><br>
                    <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞<br>
                    <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}<br>
                    <strong>Regi√≥n:</strong> ${getRegionFromLocation()}<br>
                    <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m<br><br>
                    <em>¬øQuieres que analice la geolog√≠a de esta zona?</em>`);
                }, 500);
            }
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            let message = 'Error de GPS ‚ùå';
            switch(error.code) {
                case 1: message = 'Permiso de ubicaci√≥n denegado üîí'; break;
                case 2: message = 'Ubicaci√≥n no disponible üì°'; break;
                case 3: message = 'Tiempo de espera agotado ‚è∞'; break;
            }
            
            showNotification(message, 'warning');
            
            // Ubicaci√≥n por defecto (Desierto de Atacama)
            currentLocation = {
                latitude: CONFIG.DEFAULT_LOCATION.lat,
                longitude: CONFIG.DEFAULT_LOCATION.lng,
                accuracy: 5000,
                altitude: 2400
            };
            
            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfo();
        }

        function updateLocationDisplay() {
            if (!currentLocation) return;

            document.getElementById('latitudeValue').textContent = currentLocation.latitude.toFixed(6);
            document.getElementById('longitudeValue').textContent = currentLocation.longitude.toFixed(6);
            document.getElementById('altitudeValue').textContent = 
                currentLocation.altitude ? `${Math.round(currentLocation.altitude)}m` : '--';
            
            // Determinar ciudad m√°s cercana
            const cities = [
                { name: "Antofagasta", lat: -23.650, lng: -70.400 },
                { name: "Calama", lat: -22.456, lng: -68.924 },
                { name: "Copiap√≥", lat: -27.366, lng: -70.332 },
                { name: "Vallenar", lat: -28.576, lng: -70.759 },
                { name: "San Pedro", lat: -22.911, lng: -68.201 }
            ];
            
            let closestCity = "Desierto";
            let minDistance = Infinity;
            
            cities.forEach(city => {
                const distance = Math.sqrt(
                    Math.pow(city.lat - currentLocation.latitude, 2) + 
                    Math.pow(city.lng - currentLocation.longitude, 2)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestCity = city.name;
                }
            });
            
            document.getElementById('cityValue').textContent = closestCity;
        }

        function updateGeologyInfo() {
            if (!currentLocation) return;

            const region = getRegionFromLocation();
            const regionData = mindatData[region];
            
            let html = '';
            
            if (regionData) {
                html += `<div class="data-row">
                    <span>Regi√≥n:</span>
                    <span><strong>${region}</strong></span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Mineral principal:</span>
                    <span>${regionData.minerals[0].emoji} ${regionData.minerals[0].name}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Yacimiento cercano:</span>
                    <span>${regionData.localities[0]}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Contexto:</span>
                    <span>${getGeologicalContext()}</span>
                </div>`;
            } else {
                html = `<div class="data-row">
                    <span>Ubicaci√≥n:</span>
                    <span><strong>Desierto de Atacama</strong></span>
                </div>
                <div class="data-row">
                    <span>Minerales t√≠picos:</span>
                    <span>üíé Calcopirita üíö Atacamita</span>
                </div>
                <div class="data-row">
                    <span>Actividad:</span>
                    <span>‚ö° Miner√≠a de cobre</span>
                </div>
                <div class="data-row">
                    <span>Clima:</span>
                    <span>üèúÔ∏è √Årido extremo</span>
                </div>`;
            }
            
            document.getElementById('geologyInfo').innerHTML = html;
        }

        // ============================================
        // MAPA 2D
        // ============================================
        function init2DMap() {
            try {
                map = L.map('map').setView(
                    [CONFIG.DEFAULT_LOCATION.lat, CONFIG.DEFAULT_LOCATION.lng],
                    CONFIG.DEFAULT_LOCATION.zoom
                );

                L.tileLayer(CONFIG.MAP_LAYERS.topo, {
                    attribution: '¬© OpenTopoMap',
                    maxZoom: 17
                }).addTo(map);

                markersLayer = L.layerGroup().addTo(map);

                // A√±adir algunos puntos de inter√©s iniciales
                addInitialGeologyPoints();

                console.log('‚úÖ Mapa 2D del Desierto de Atacama inicializado');

            } catch (error) {
                console.error('Error inicializando mapa:', error);
                showNotification('Error al cargar el mapa ‚ùå', 'error');
            }
        }

        function addInitialGeologyPoints() {
            const points = [
                { lat: -22.285, lng: -68.905, type: 'mine', emoji: '‚õèÔ∏è', name: 'Chuquicamata' },
                { lat: -24.271, lng: -69.081, type: 'mine', emoji: '‚õèÔ∏è', name: 'Escondida' },
                { lat: -27.367, lng: -70.333, type: 'sample', emoji: 'üî¨', name: '√Årea de Muestreo' },
                { lat: -23.650, lng: -70.400, type: 'city', emoji: 'üèôÔ∏è', name: 'Antofagasta' }
            ];

            points.forEach(point => {
                L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        html: `<div style="background: ${getColorForType(point.type)}; color:white; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${point.emoji}</div>`,
                        iconSize: [36, 36]
                    })
                })
                .bindPopup(`<div style="background: rgba(255,248,220,0.9); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);"><strong>${point.emoji} ${point.name}</strong><br>Tipo: ${point.type}</div>`)
                .addTo(markersLayer);
            });
        }

        function getColorForType(type) {
            switch(type) {
                case 'mine': return '#D4A017';
                case 'sample': return '#228B22';
                case 'city': return '#4682B4';
                default: return '#8B4513';
            }
        }

        function updateMapLocation() {
            if (!map || !currentLocation) return;

            const latLng = [currentLocation.latitude, currentLocation.longitude];
            
            map.flyTo(latLng, 14, {
                duration: 1.5
            });

            // Marcador de ubicaci√≥n actual
            L.marker(latLng, {
                icon: L.divIcon({
                    className: 'current-location',
                    html: `<div style="background: linear-gradient(135deg, #D4A017, #8B4513); color:white; width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid white; font-size:1.4rem; box-shadow: 0 4px 15px rgba(0,0,0,0.4);">üìç</div>`,
                    iconSize: [42, 42]
                })
            }).addTo(markersLayer).bindPopup('<div style="background: rgba(255,248,220,0.9); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);"><strong>üìç Tu ubicaci√≥n</strong><br>Precisi√≥n: ' + Math.round(currentLocation.accuracy) + 'm</div>').openPopup();

            // C√≠rculo de precisi√≥n
            L.circle(latLng, {
                color: 'rgba(212, 160, 23, 0.3)',
                fillColor: 'rgba(212, 160, 23, 0.1)',
                radius: currentLocation.accuracy,
                weight: 1.5
            }).addTo(map);
        }

        // ============================================
        // MAPA 3D
        // ============================================
        function init3DMap() {
            try {
                mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;

                map3d = new mapboxgl.Map({
                    container: 'map3d',
                    style: 'mapbox://styles/mapbox/satellite-streets-v11',
                    center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
                    zoom: CONFIG.DEFAULT_LOCATION.zoom,
                    pitch: 60,
                    bearing: 0
                });

                map3d.on('load', () => {
                    console.log('‚úÖ Mapa 3D del Desierto de Atacama inicializado');
                    
                    // Terrain 3D
                    map3d.addSource('mapbox-dem', {
                        type: 'raster-dem',
                        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        tileSize: 512
                    });
                    
                    map3d.setTerrain({ source: 'mapbox-dem', exaggeration: 3 });
                    
                    // Sky con efecto desierto
                    map3d.setFog({
                        color: 'rgb(250, 248, 240)',
                        'high-color': 'rgb(212, 160, 23)',
                        'horizon-blend': 0.1,
                        'space-color': 'rgb(139, 115, 85)',
                        'star-intensity': 0.8
                    });
                    
                    map3d.addControl(new mapboxgl.NavigationControl(), 'top-right');
                });

            } catch (error) {
                console.error('Error inicializando mapa 3D:', error);
            }
        }

        // ============================================
        // C√ÅMARA Y AN√ÅLISIS
        // ============================================
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraFeed');
                video.srcObject = cameraStream;

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                isCameraActive = true;
                updateCameraControls(true);
                showNotification('C√°mara activada para an√°lisis üì∏', 'success');

            } catch (error) {
                console.error('Error c√°mara:', error);
                showNotification('Error al activar c√°mara ‚ùå', 'error');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('cameraFeed');
            video.srcObject = null;
            isCameraActive = false;
            updateCameraControls(false);
            showNotification('C√°mara detenida ‚èπÔ∏è', 'info');
        }

        function updateCameraControls(active) {
            document.getElementById('startCameraBtn').disabled = active;
            document.getElementById('captureBtn').disabled = !active;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = !active;
            
            const statusText = document.getElementById('cameraStatusText');
            statusText.innerHTML = active ? 
                '<span>üü¢</span> C√°mara activa' :
                '<span>üî¥</span> C√°mara inactiva';
        }

        function capturePhoto() {
            if (!isCameraActive) return;

            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            currentPhoto = {
                data: canvas.toDataURL('image/jpeg'),
                timestamp: new Date().toISOString(),
                location: currentLocation
            };

            document.getElementById('analyzeBtn').disabled = false;
            showNotification('¬°Foto capturada! ü§ñ Ahora analiza con IA', 'success');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Botones GPS
            document.getElementById('updateLocationBtn').addEventListener('click', startGPS);

            // Botones c√°mara
            document.getElementById('startCameraBtn').addEventListener('click', startCamera);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeWithAI);

            // Controles mapa
            document.getElementById('mapSatelliteBtn').addEventListener('click', () => {
                switchMapLayer('satellite');
            });
            document.getElementById('mapTerrainBtn').addEventListener('click', () => {
                switchMapLayer('topo');
            });

            // Botones mapa
            document.getElementById('addPointBtn').addEventListener('click', addMapPoint);
            document.getElementById('clearMapBtn').addEventListener('click', clearMapPoints);

            // Controles 3D
            document.getElementById('generate3D').addEventListener('click', generate3DProjection);
            document.getElementById('export3D').addEventListener('click', export3DModel);

            // Capas 3D
            document.querySelectorAll('.layers-panel input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', update3DLayers);
            });

            // IA
            document.getElementById('sendMessage').addEventListener('click', sendMessageToAI);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessageToAI();
            });
            document.getElementById('analyzeLocation').addEventListener('click', () => {
                if (currentLocation) {
                    addMessageToChat('user', 'Analiza la geolog√≠a de mi ubicaci√≥n actual');
                    setTimeout(sendMessageToAI, 100);
                } else {
                    showNotification('Primero activa el GPS üìç', 'warning');
                }
            });
            document.getElementById('identifyMineral').addEventListener('click', () => {
                addMessageToChat('user', '¬øQu√© minerales puedo encontrar en esta zona del Desierto de Atacama?');
                setTimeout(sendMessageToAI, 100);
            });
            document.getElementById('suggestMethodology').addEventListener('click', () => {
                addMessageToChat('user', '¬øCu√°l es la metodolog√≠a recomendada para trabajo de campo geol√≥gico en el Desierto de Atacama?');
                setTimeout(sendMessageToAI, 100);
            });
        }

        function switchMapLayer(layerName) {
            if (map) {
                map.eachLayer((layer) => {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                L.tileLayer(CONFIG.MAP_LAYERS[layerName], {
                    attribution: layerName === 'satellite' ? '¬© Esri' : '¬© OpenTopoMap',
                    maxZoom: layerName === 'satellite' ? 19 : 17
                }).addTo(map);
                
                showNotification(`Mapa: ${layerName === 'satellite' ? 'Sat√©lite üõ∞Ô∏è' : 'Topogr√°fico ‚õ∞Ô∏è'}`, 'success');
            }
        }

        function addMapPoint() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üó∫Ô∏è', 'warning');
                return;
            }

            const types = [
                { type: 'mineral', emoji: 'üíé', name: 'Mineral', color: '#D4A017' },
                { type: 'rock', emoji: 'ü™®', name: 'Roca', color: '#8B4513' },
                { type: 'fault', emoji: '‚ö°', name: 'Falla', color: '#DC143C' },
                { type: 'sample', emoji: 'üî¨', name: 'Muestra', color: '#228B22' }
            ];
            
            const selectedType = types[Math.floor(Math.random() * types.length)];
            const time = new Date();
            const name = `${selectedType.name} ${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;

            const marker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: L.divIcon({
                    html: `<div style="background: ${selectedType.color}; color:white; width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.3rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${selectedType.emoji}</div>`,
                    iconSize: [38, 38]
                })
            })
            .bindPopup(`<div style="background: rgba(255,248,220,0.9); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);"><strong>${selectedType.emoji} ${name}</strong><br>Coordenadas: ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞</div>`)
            .addTo(markersLayer);

            showNotification(`Punto ${selectedType.name} agregado üìç`, 'success');
            
            // Notificar a Dr. GeoBot
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç PUNTO GEOL√ìGICO AGREGADO:</strong><br><br>
                    <strong>Tipo:</strong> ${selectedType.name} ${selectedType.emoji}<br>
                    <strong>Ubicaci√≥n:</strong> ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞<br>
                    <strong>Hora:</strong> ${time.toLocaleTimeString('es-CL')}<br><br>
                    <em>¬øNecesitas an√°lisis de este punto?</em>`);
                }, 500);
            }
        }

        function clearMapPoints() {
            markersLayer.clearLayers();
            showNotification('Mapa limpiado ‚úÖ', 'success');
        }

        function analyzeWithAI() {
            if (!currentPhoto) {
                showNotification('Primero captura una imagen üì∏', 'warning');
                return;
            }

            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            showNotification('Analizando imagen con DeepSeek AI... üîç', 'info');

            setTimeout(() => {
                const analysisHTML = `
                    <div class="data-row">
                        <span>Tipo identificado:</span>
                        <span>ü™® Roca √≠gnea volc√°nica</span>
                    </div>
                    <div class="data-row">
                        <span>Mineral principal:</span>
                        <span>üíé Plagioclasa + Piroxeno</span>
                    </div>
                    <div class="data-row">
                        <span>Estructura:</span>
                        <span>‚ö° Disyunci√≥n columnar</span>
                    </div>
                    <div class="data-row">
                        <span>Confianza IA:</span>
                        <span>üéØ 92%</span>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(70, 130, 180, 0.2), rgba(100, 149, 237, 0.2)); border-radius: 12px; border: 1px solid rgba(70, 130, 180, 0.3); font-size: 0.8rem;">
                        <strong>üë®‚Äçüî¨ Dr. GeoBot recomienda:</strong><br>
                        ‚Ä¢ Realizar an√°lisis petrogr√°fico<br>
                        ‚Ä¢ Tomar muestra para geoqu√≠mica<br>
                        ‚Ä¢ Medir orientaci√≥n de columnas
                    </div>
                `;

                document.getElementById('analysisResults').innerHTML = analysisHTML;
                showNotification('‚úÖ An√°lisis IA completado', 'success');
                
                // Agregar al chat
                if (isDrGeoBotActive) {
                    setTimeout(() => {
                        addMessageToChat('ai', `<strong>üì∏ AN√ÅLISIS FOTOGEOL√ìGICO:</strong><br><br>
                        <strong>Resultados:</strong><br>
                        ‚Ä¢ ü™® Roca √≠gnea volc√°nica<br>
                        ‚Ä¢ üíé Plagioclasa + Piroxeno<br>
                        ‚Ä¢ ‚ö° Disyunci√≥n columnar<br>
                        ‚Ä¢ üéØ Confianza: 92%<br><br>
                        <strong>Recomendaciones:</strong><br>
                        1. An√°lisis petrogr√°fico<br>
                        2. Muestra para geoqu√≠mica<br>
                        3. Medici√≥n de orientaci√≥n`);
                    }, 500);
                }
            }, 2000);
        }

        function generate3DProjection() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üåç', 'warning');
                return;
            }

            showNotification('Generando modelo 3D del terreno... üîÑ', 'info');

            setTimeout(() => {
                const html = `
                    <div class="data-row">
                        <span>Rumbo üß≠:</span>
                        <span>N.45¬∞E</span>
                    </div>
                    <div class="data-row">
                        <span>Buzamiento üìè:</span>
                        <span>30¬∞SE</span>
                    </div>
                    <div class="data-row">
                        <span>Espesor estrato üìä:</span>
                        <span>15.2 m</span>
                    </div>
                    <div class="data-row">
                        <span>Inclinaci√≥n üìê:</span>
                        <span>22¬∞</span>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(139, 69, 19, 0.2)); border-radius: 12px; border: 1px solid rgba(212, 160, 23, 0.3); font-size: 0.8rem;">
                        <strong>üåç Modelo 3D generado:</strong><br>
                        ‚Ä¢ Terreno: ${Math.round(currentLocation.altitude || 2400)}m<br>
                        ‚Ä¢ √Årea: 1.5 km¬≤<br>
                        ‚Ä¢ Resoluci√≥n: 10m/pixel<br>
                        ‚Ä¢ Capas activas: Topograf√≠a, Geolog√≠a
                    </div>
                `;

                document.getElementById('structuralParams').innerHTML = html;
                showNotification('‚úÖ Modelo 3D del Desierto generado', 'success');
            }, 1500);
        }

        function export3DModel() {
            if (!currentLocation) {
                showNotification('Primero genera un modelo 3D üíæ', 'warning');
                return;
            }

            showNotification('Exportando modelo 3D... üì§', 'info');

            setTimeout(() => {
                const data = {
                    location: currentLocation,
                    timestamp: new Date().toISOString(),
                    parameters: {
                        rumbo: "N.45¬∞E",
                        buzamiento: "30¬∞SE",
                        espesor: "15.2 m",
                        inclinacion: "22¬∞",
                        altitud: currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : '2400m'
                    },
                    metadata: {
                        app: "AtacamApp",
                        region: getRegionFromLocation(),
                        version: "1.0"
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modelo_3d_atacamapp_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ Modelo 3D exportado', 'success');
            }, 1000);
        }

        function update3DLayers() {
            const layers = {
                'layerTopography': document.getElementById('layerTopography').checked,
                'layerGeology': document.getElementById('layerGeology').checked,
                'layerFaults': document.getElementById('layerFaults').checked
            };
            
            const activeLayers = Object.keys(layers).filter(key => layers[key]);
            showNotification(`Capas activas: ${activeLayers.length} ‚úÖ`, 'info');
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function requestPermissions() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(result => {
                        if (result.state === 'granted') {
                            console.log('‚úÖ Permiso de GPS disponible');
                        }
                    });
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationIcon = document.getElementById('notificationIcon');

            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            
            switch(type) {
                case 'success':
                    notificationIcon.textContent = '‚úÖ';
                    notification.style.borderLeftColor = '#228B22';
                    break;
                case 'error':
                    notificationIcon.textContent = '‚ùå';
                    notification.style.borderLeftColor = '#DC143C';
                    break;
                case 'warning':
                    notificationIcon.textContent = '‚ö†Ô∏è';
                    notification.style.borderLeftColor = '#FF8C00';
                    break;
                case 'info':
                    notificationIcon.textContent = '‚ÑπÔ∏è';
                    notification.style.borderLeftColor = '#4682B4';
                    break;
            }
            
            notification.style.display = 'flex';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3500);
        }

        // ============================================
        // MANEJO OFFLINE/ONLINE
        // ============================================
        window.addEventListener('online', () => {
            showNotification('Conectado a internet - DeepSeek AI activa ‚úÖ', 'success');
            if (isDrGeoBotActive) {
                addMessageToChat('ai', `<strong>‚úÖ CONEXI√ìN RESTAURADA:</strong><br><br>
                DeepSeek AI est√° nuevamente disponible para an√°lisis avanzado.`);
            }
        });

        window.addEventListener('offline', () => {
            showNotification('Sin conexi√≥n a internet - Modo local activado ‚ö†Ô∏è', 'warning');
            if (isDrGeoBotActive) {
                addMessageToChat('ai', `<strong>‚ö†Ô∏è MODO LOCAL ACTIVADO:</strong><br><br>
                Sin conexi√≥n a internet. Funciones b√°sicas disponibles con base de datos local.`);
            }
        });
    </script>
</body>
</html>
