<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtacamApp ‚öíÔ∏è - Geolog√≠a Inteligente en 3D</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <style>
        /* === ESTILOS CSS MEJORADOS === */
        :root {
            --primary: #d35400;
            --primary-dark: #a84300;
            --secondary: #2c3e50;
            --accent: #f39c12;
            --success: #27ae60;
            --info: #3498db;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --desert-sand: #f5deb3;
            --mountain-gray: #7f8c8d;
            --sky-blue: #87ceeb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark), #1a1a1a);
            color: #333;
            min-height: 100vh;
            padding: 10px;
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-blend-mode: overlay;
            background-color: rgba(26, 26, 26, 0.85);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header con desierto */
        .app-header {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), 
                        url('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 3px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to top, var(--desert-sand), transparent);
            border-radius: 0 0 20px 20px;
        }

        .app-header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            text-shadow: 3px 3px 5px rgba(0,0,0,0.7);
        }

        .app-header p {
            font-size: 1.3rem;
            opacity: 0.95;
            margin-bottom: 25px;
            position: relative;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 25px;
            position: relative;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 25px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            font-size: 1rem;
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .status-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-3px);
        }

        .status-item.active {
            background: rgba(211, 84, 0, 0.3);
            border-color: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 84, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(211, 84, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 84, 0, 0); }
        }

        /* Layout Grid Mejorado */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .app-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        @media (min-width: 1200px) {
            .app-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Cards Mejoradas */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            border-top: 5px solid var(--primary);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card::before {
            content: '‚öíÔ∏è';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2rem;
            opacity: 0.1;
        }

        .card h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--light);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
        }

        /* C√°mara Mejorada */
        .camera-container {
            position: relative;
            width: 100%;
            height: 350px;
            background: linear-gradient(135deg, var(--secondary), var(--dark));
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            border: 3px solid var(--primary);
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .camera-placeholder {
            text-align: center;
            padding: 30px;
        }

        .camera-placeholder i {
            font-size: 5rem;
            margin-bottom: 20px;
            color: var(--accent);
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Mapa 3D */
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid var(--primary);
            position: relative;
        }

        #map3d {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Minerales Mejorados */
        .minerals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .mineral-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .mineral-card::before {
            content: 'üíé';
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0.2;
        }

        .mineral-card:hover {
            transform: translateY(-8px) scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(210, 84, 0, 0.3);
        }

        .mineral-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #fff5eb, #ffe8d1);
        }

        .mineral-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Br√∫jula Mejorada */
        .compass-container {
            width: 250px;
            height: 250px;
            margin: 20px auto;
            position: relative;
        }

        .compass-rose {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                var(--danger) 0deg 45deg,
                var(--info) 45deg 135deg,
                var(--success) 135deg 225deg,
                var(--warning) 225deg 315deg,
                var(--danger) 315deg 360deg
            );
            position: relative;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            border: 5px solid var(--dark);
        }

        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 100px;
            background: linear-gradient(to top, #000, #333);
            transform-origin: center 0;
            z-index: 2;
            border-radius: 3px;
        }

        .compass-needle::after {
            content: 'N';
            position: absolute;
            top: -25px;
            left: -10px;
            width: 25px;
            height: 25px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Botones Mejorados */
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 5px 15px rgba(211, 84, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(211, 84, 0, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--info), #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #219653);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f39c12);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }

        .btn-geo {
            background: linear-gradient(135deg, var(--secondary), #1a252f);
            color: white;
        }

        /* IA Chatbot */
        .ai-chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
            flex-direction: column;
            border: 3px solid var(--primary);
            overflow: hidden;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, var(--secondary), var(--dark));
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .ai-chat-input {
            padding: 20px;
            border-top: 2px solid var(--light);
            display: flex;
            gap: 10px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 85%;
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            margin-left: auto;
            border-radius: 15px 15px 0 15px;
        }

        .message.ai {
            background: white;
            border: 2px solid var(--light);
            border-radius: 15px 15px 15px 0;
        }

        /* Emoticonos y Decoraciones */
        .emoji-badge {
            display: inline-block;
            padding: 5px 10px;
            background: var(--light);
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9rem;
        }

        .tool-tip {
            position: absolute;
            background: var(--dark);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .tool-btn:hover .tool-tip {
            opacity: 1;
        }

        /* Notificaciones Mejoradas */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from { transform: translateX(100%) translateY(-20px); opacity: 0; }
            to { transform: translateX(0) translateY(0); opacity: 1; }
        }

        /* Loading Animado */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--primary);
        }

        .loading i {
            font-size: 3.5rem;
            margin-bottom: 25px;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tags y Badges */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
        }

        .badge-geo { background: var(--primary); color: white; }
        .badge-mineral { background: var(--info); color: white; }
        .badge-gps { background: var(--success); color: white; }
        .badge-camera { background: var(--warning); color: white; }

        /* Herramientas Mejoradas */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .tool-btn {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 15px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tool-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(211, 84, 0, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tool-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .tool-btn:hover::before {
            opacity: 1;
        }

        .tool-btn i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header h1 { font-size: 2rem; }
            .status-item { padding: 10px 15px; font-size: 0.9rem; }
            .card { padding: 20px; }
            .tools-grid { grid-template-columns: repeat(2, 1fr); }
            .ai-chat-container { width: 90%; right: 5%; bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header con Desierto -->
        <header class="app-header">
            <h1>‚öíÔ∏è AtacamApp üèúÔ∏è</h1>
            <p>‚ú® Geolog√≠a Inteligente en 3D ‚Ä¢ GPS Real ‚Ä¢ C√°mara HD ‚Ä¢ IA Especializada ‚ú®</p>
            
            <div class="status-bar">
                <div class="status-item" id="gpsStatus" onclick="forceGPS()">
                    <i class="fas fa-satellite"></i> 
                    <span>GPS: HAZ CLICK PARA ACTIVAR üõ∞Ô∏è</span>
                    <span class="badge badge-gps">OBLIGATORIO</span>
                </div>
                <div class="status-item" id="cameraStatus" onclick="forceCamera()">
                    <i class="fas fa-camera"></i> 
                    <span>C√ÅMARA: HAZ CLICK PARA ACTIVAR üì∏</span>
                    <span class="badge badge-camera">HD 1080p</span>
                </div>
                <div class="status-item active">
                    <i class="fas fa-map-marked-alt"></i> 
                    <span>MAPA 3D ACTIVO üó∫Ô∏è</span>
                    <span class="badge badge-geo">TERRENO 3D</span>
                </div>
                <div class="status-item" onclick="toggleChat()">
                    <i class="fas fa-robot"></i> 
                    <span>GEOBOT IA ü§ñ</span>
                    <span class="badge">CONECTAR</span>
                </div>
            </div>
        </header>

        <!-- Grid Principal -->
        <div class="app-grid">
            <!-- Columna 1: C√°mara y Mapa 3D -->
            <div class="main-column">
                <!-- C√°mara HD -->
                <section class="card">
                    <h2><i class="fas fa-camera"></i> C√°mara Geol√≥gica HD üì∏</h2>
                    <p style="color: #666; margin-bottom: 15px;">Identificaci√≥n en tiempo real con IA especializada</p>
                    
                    <div class="camera-container" id="cameraContainer">
                        <video class="camera-feed" id="cameraFeed" autoplay playsinline></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        
                        <div class="camera-placeholder" id="cameraPlaceholder">
                            <div style="font-size: 5rem;">üì∑</div>
                            <h3>üéØ C√ÅMARA GEOL√ìGICA HD</h3>
                            <p>Haz click en el icono de c√°mara arriba para activar</p>
                            <div class="emoji-badge">üé• Modo Profesional</div>
                            <div class="emoji-badge">ü§ñ IA Anal√≠tica</div>
                            <div class="emoji-badge">üíé Identificaci√≥n Mineral</div>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" id="captureBtn" onclick="captureAndAnalyze()">
                            <i class="fas fa-search"></i> Identificar Mineral üß™
                        </button>
                        <button class="btn btn-warning" onclick="toggleFlash()">
                            <i class="fas fa-bolt"></i> Flash ‚ö°
                        </button>
                        <button class="btn btn-secondary" onclick="switchCamera()">
                            <i class="fas fa-sync-alt"></i> Cambiar C√°mara üîÑ
                        </button>
                    </div>
                    
                    <div id="analysisResult" style="display: none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; border-left: 5px solid var(--primary);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="font-size: 3rem;">üíé</div>
                            <div>
                                <h3 style="margin: 0; color: var(--primary);" id="mineralName">Mineral Identificado</h3>
                                <div style="color: #666;" id="mineralFormula">F√≥rmula qu√≠mica</div>
                            </div>
                        </div>
                        <div id="mineralDetails"></div>
                    </div>
                </section>

                <!-- Mapa 3D con Google Maps/MapBox -->
                <section class="card">
                    <h2><i class="fas fa-globe-americas"></i> Mapa Geol√≥gico 3D üó∫Ô∏è</h2>
                    <p style="color: #666; margin-bottom: 15px;">Visualizaci√≥n topogr√°fica 3D con capas geol√≥gicas interactivas</p>
                    
                    <div class="map-container">
                        <div id="map3d"></div>
                        <div class="map-overlay">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="badge badge-geo" onclick="toggleLayer('topography')">üóª Topograf√≠a</button>
                                <button class="badge badge-geo" onclick="toggleLayer('geology')">üèîÔ∏è Geolog√≠a</button>
                                <button class="badge badge-geo" onclick="toggleLayer('faults')">‚ö° Fallas</button>
                                <button class="badge badge-geo" onclick="toggleLayer('minerals')">üíé Mineralizaci√≥n</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-geo" onclick="centerOnGPS()">
                            <i class="fas fa-crosshairs"></i> Seguir GPS üõ∞Ô∏è
                        </button>
                        <button class="btn btn-primary" onclick="addGeologicalPoint()">
                            <i class="fas fa-map-pin"></i> Punto Geol√≥gico üìç
                        </button>
                        <button class="btn btn-secondary" onclick="generate3DModel()">
                            <i class="fas fa-cube"></i> Modelo 3D üßä
                        </button>
                    </div>
                    
                    <div id="mapInfo" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f4fc, #d4e6f1); border-radius: 12px; font-size: 0.9rem; border-left: 4px solid var(--info);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong><i class="fas fa-info-circle"></i> Ubicaci√≥n GPS:</strong>
                                <span id="currentCoords">Esperando activaci√≥n GPS...</span>
                            </div>
                            <div id="gpsAccuracy" class="badge badge-gps">Precisi√≥n: -- m</div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Columna 2: Minerales y Herramientas -->
            <div class="tools-column">
                <!-- Minerales Identificados -->
                <section class="card">
                    <h2><i class="fas fa-gem"></i> Colecci√≥n Mineral√≥gica üíé</h2>
                    <p style="color: #666; margin-bottom: 15px;">Minerales identificados en terreno</p>
                    
                    <div id="mineralsContainer">
                        <div id="noMinerals" style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">‚õèÔ∏è</div>
                            <p>¬°Comienza a explorar!</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Usa la c√°mara para identificar minerales</p>
                        </div>
                        
                        <div class="minerals-grid" id="mineralsGrid" style="display: none;"></div>
                    </div>
                    
                    <div class="camera-controls" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="exportCollection()">
                            <i class="fas fa-file-export"></i> Exportar Colecci√≥n üì§
                        </button>
                        <button class="btn btn-danger" onclick="clearCollection()">
                            <i class="fas fa-trash"></i> Limpiar Todo üóëÔ∏è
                        </button>
                    </div>
                </section>

                <!-- Herramientas Geol√≥gicas -->
                <section class="card">
                    <h2><i class="fas fa-tools"></i> Kit de Campo ‚öíÔ∏è</h2>
                    <p style="color: #666; margin-bottom: 15px;">Herramientas especializadas para geolog√≠a</p>
                    
                    <div class="tools-grid">
                        <button class="tool-btn" onclick="openTool('mohs')">
                            <div style="font-size: 2.5rem;">üíé</div>
                            <div>Escala de Mohs</div>
                            <div class="tool-tip">Dureza de minerales</div>
                        </button>
                        <button class="tool-btn" onclick="openTool('streak')">
                            <div style="font-size: 2.5rem;">üé®</div>
                            <div>Colores de Raya</div>
                            <div class="tool-tip">Prueba de raya</div>
                        </button>
                        <button class="tool-btn" onclick="openTool('magnetism')">
                            <div style="font-size: 2.5rem;">üß≤</div>
                            <div>Magnetismo</div>
                            <div class="tool-tip">Propiedades magn√©ticas</div>
                        </button>
                        <button class="tool-btn" onclick="openTool('fracture')">
                            <div style="font-size: 2.5rem;">‚ö°</div>
                            <div>Fractura</div>
                            <div class="tool-tip">Tipos de fractura</div>
                        </button>
                        <button class="tool-btn" onclick="openTool('calculator')">
                            <div style="font-size: 2.5rem;">üßÆ</div>
                            <div>Calculadora</div>
                            <div class="tool-tip">C√°lculos geol√≥gicos</div>
                        </button>
                        <button class="tool-btn" onclick="openTool('weather')">
                            <div style="font-size: 2.5rem;">üå§Ô∏è</div>
                            <div>Clima Atacama</div>
                            <div class="tool-tip">Condiciones actuales</div>
                        </button>
                    </div>
                </section>

                <!-- Br√∫jula Digital -->
                <section class="card">
                    <h2><i class="fas fa-compass"></i> Br√∫jula Digital üß≠</h2>
                    <p style="color: #666; margin-bottom: 15px;">Orientaci√≥n y medici√≥n de rumbos</p>
                    
                    <div class="compass-container">
                        <div class="compass-rose" id="compassRose">
                            <div class="compass-needle" id="compassNeedle"></div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="compassDirection">
                            NORTE üß≠
                        </div>
                        <div style="color: #666; margin-top: 10px; font-size: 1.2rem;" id="compassDegrees">
                            0¬∞ ‚Ä¢ Precisi√≥n: --¬∞
                        </div>
                    </div>
                    
                    <div class="camera-controls" style="margin-top: 25px;">
                        <button class="btn btn-primary" onclick="calibrateCompass()">
                            <i class="fas fa-sync-alt"></i> Calibrar üîß
                        </button>
                        <button class="btn btn-warning" onclick="startCompass()">
                            <i class="fas fa-play"></i> Iniciar üöÄ
                        </button>
                    </div>
                </section>
            </div>

            <!-- Columna 3: IA y Reportes -->
            <div class="ai-column">
                <!-- Asistente IA Geol√≥gica -->
                <section class="card">
                    <h2><i class="fas fa-robot"></i> Geobot IA ü§ñ</h2>
                    <p style="color: #666; margin-bottom: 15px;">Asistente especializado en geolog√≠a de Atacama</p>
                    
                    <div style="background: linear-gradient(135deg, #f0f7ff, #d4e6f1); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid var(--info);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="font-size: 2.5rem;">ü§ñ</div>
                            <div>
                                <div style="font-weight: bold; color: var(--secondary);">Geobot IA</div>
                                <div style="color: #666; font-size: 0.9rem;">Especialista en geolog√≠a de Atacama</div>
                            </div>
                        </div>
                        <p style="margin-bottom: 15px;">¬°Hola! Soy tu asistente geol√≥gico. Puedo ayudarte con:</p>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                            <span class="emoji-badge">üíé Identificaci√≥n</span>
                            <span class="emoji-badge">üó∫Ô∏è Interpretaci√≥n</span>
                            <span class="emoji-badge">üß™ An√°lisis</span>
                            <span class="emoji-badge">üìä Reportes</span>
                        </div>
                        
                        <button class="btn btn-primary" onclick="toggleChat()" style="width: 100%;">
                            <i class="fas fa-comments"></i> Chatear con Geobot üí¨
                        </button>
                    </div>
                    
                    <div id="quickAnalysis" style="display: none;">
                        <h4><i class="fas fa-chart-line"></i> An√°lisis R√°pido</h4>
                        <div id="analysisContent"></div>
                    </div>
                </section>

                <!-- Informes Geol√≥gicos -->
                <section class="card">
                    <h2><i class="fas fa-file-alt"></i> Informes Inteligentes üìä</h2>
                    <p style="color: #666; margin-bottom: 15px;">Generaci√≥n autom√°tica de reportes de campo</p>
                    
                    <div style="margin-bottom: 20px;">
                        <input type="text" class="form-control" id="reportTitle" placeholder="Nombre del informe" value="Informe Geol√≥gico - Atacama" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; font-size: 1rem;">
                        <textarea class="form-control" id="reportNotes" rows="3" placeholder="Observaciones de campo..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 1rem; resize: vertical;">Exploraci√≥n en zona minera - Muestras colectadas para an√°lisis</textarea>
                        
                        <div class="camera-controls">
                            <button class="btn btn-success" onclick="generateSmartReport()" style="flex: 1;">
                                <i class="fas fa-magic"></i> Generar M√°gico ‚ú®
                            </button>
                            <button class="btn btn-secondary" onclick="viewAllReports()" style="flex: 1;">
                                <i class="fas fa-history"></i> Historial üìú
                            </button>
                        </div>
                    </div>
                    
                    <div id="reportPreview" style="min-height: 150px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; border: 2px dashed var(--primary);">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <div style="font-size: 2.5rem;">üìã</div>
                            <p>Tu informe aparecer√° aqu√≠</p>
                            <div class="emoji-badge">üìä Datos GPS</div>
                            <div class="emoji-badge">üíé Minerales</div>
                            <div class="emoji-badge">üì∏ Fotos</div>
                        </div>
                    </div>
                </section>

                <!-- Proyecci√≥n 3D -->
                <section class="card">
                    <h2><i class="fas fa-cube"></i> Proyecci√≥n 3D üßä</h2>
                    <p style="color: #666; margin-bottom: 15px;">Modelado geol√≥gico tridimensional</p>
                    
                    <div style="height: 200px; background: linear-gradient(135deg, var(--dark), #1a1a1a); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 20px; border: 2px solid var(--primary);">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">üèîÔ∏è</div>
                            <p>Visualizaci√≥n 3D</p>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-geo" onclick="generateCrossSection()">
                            <i class="fas fa-mountain"></i> Corte Geol√≥gico ‚õ∞Ô∏è
                        </button>
                        <button class="btn btn-primary" onclick="export3DModel()">
                            <i class="fas fa-download"></i> Exportar 3D üì•
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Chatbot IA -->
    <div class="ai-chat-container" id="aiChat">
        <div class="ai-chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 1.8rem;">ü§ñ</div>
                <div>
                    <div style="font-weight: bold;">Geobot IA</div>
                    <div style="font-size: 0.8rem;">Especialista en Geolog√≠a</div>
                </div>
            </div>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        
        <div class="ai-chat-messages" id="chatMessages">
            <div class="message ai">
                ¬°Hola! üëã Soy Geobot, tu asistente especializado en geolog√≠a de la regi√≥n de Atacama. 
                ¬øEn qu√© puedo ayudarte hoy? Puedo ayudarte con identificaci√≥n de minerales, interpretaci√≥n 
                estructural, an√°lisis de muestras y m√°s. ¬°Preg√∫ntame lo que necesites! üèîÔ∏èüíé
            </div>
        </div>
        
        <div class="ai-chat-input">
            <input type="text" id="chatInput" placeholder="Escribe tu pregunta geol√≥gica..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px;">
            <button class="btn btn-primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script>
        // ============================================
        // ATACAMAPP - SISTEMA GEOL√ìGICO COMPLETO
        // ============================================
        
        // Variables globales del sistema
        let gpsWatchId = null;
        let cameraStream = null;
        let currentCamera = 'environment';
        let flashActive = false;
        let realGPSData = null;
        let map3d = null;
        let compassActive = false;
        let identifiedMinerals = [];
        let geologicalMarkers = [];
        let aiChatHistory = [];
        
        // Configuraci√≥n de MapBox
        mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2t6b2JwM2VvMDJnbjJvcGc5d2U0a3dkdiJ9.example-token';
        
        // Base de datos de minerales de Atacama mejorada
        const atacamaMineralsDB = [
            { 
                id: 1, 
                name: "Calcopirita", 
                formula: "CuFeS‚ÇÇ", 
                hardness: 3.5, 
                color: "Amarillo lat√≥n", 
                streak: "Verde negruzco", 
                luster: "Met√°lico",
                system: "Tetragonal",
                density: 4.1,
                description: "El mineral de cobre m√°s importante. Conocido como 'oro de los tontos' por su parecido al oro.",
                location: "Presente en la mayor√≠a de las minas de cobre de Atacama",
                uses: "Principal mena de cobre",
                emoji: "üí∞"
            },
            { 
                id: 2, 
                name: "Malaquita", 
                formula: "Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ", 
                hardness: 3.5, 
                color: "Verde intenso", 
                streak: "Verde claro", 
                luster: "Adamantino a sedoso",
                system: "Monocl√≠nico",
                density: 3.9,
                description: "Carbonato de cobre de vibrante color verde. Muy apreciado como piedra ornamental.",
                location: "Zonas de oxidaci√≥n de yacimientos cupr√≠feros",
                uses: "Piedra ornamental, pigmento",
                emoji: "üü¢"
            },
            { 
                id: 3, 
                name: "Atacamita", 
                formula: "Cu‚ÇÇCl(OH)‚ÇÉ", 
                hardness: 3.5, 
                color: "Verde esmeralda", 
                streak: "Verde manzana", 
                luster: "Adamantino",
                system: "Ortorr√≥mbico",
                density: 3.8,
                description: "Cloruro de cobre que da nombre a la regi√≥n. Se forma en zonas √°ridas con presencia de cobre.",
                location: "Regi√≥n de Atacama, zonas des√©rticas",
                uses: "Mena menor de cobre, mineral de colecci√≥n",
                emoji: "üèúÔ∏è"
            },
            { 
                id: 4, 
                name: "Crisocola", 
                formula: "CuSiO‚ÇÉ¬∑nH‚ÇÇO", 
                hardness: 2.5, 
                color: "Verde azulado", 
                streak: "Blanco", 
                luster: "V√≠treo a ceroso",
                system: "Amorfo",
                density: 2.2,
                description: "Silicato de cobre hidratado que forma masas botrioidales de colores azul-verdosos.",
                location: "Zonas de alteraci√≥n de p√≥rfidos cupr√≠feros",
                uses: "Piedra semipreciosa, mena de cobre",
                emoji: "üí†"
            },
            { 
                id: 5, 
                name: "Bornita", 
                formula: "Cu‚ÇÖFeS‚ÇÑ", 
                hardness: 3, 
                color: "P√∫rpura iridiscente", 
                streak: "Gris negruzco", 
                luster: "Met√°lico",
                system: "Orto-r√≥mbico",
                density: 5.1,
                description: "Conocido como 'mineral pavo real' por sus brillantes colores iridiscentes p√∫rpura-azulados.",
                location: "Yacimientos de cobre de la Cordillera de la Costa",
                uses: "Importante mena de cobre",
                emoji: "ü¶ö"
            },
            { 
                id: 6, 
                name: "Cuarzo", 
                formula: "SiO‚ÇÇ", 
                hardness: 7, 
                color: "Incoloro a variado", 
                streak: "Blanco", 
                luster: "V√≠treo",
                system: "Trigonal",
                density: 2.65,
                description: "El mineral m√°s com√∫n de la corteza terrestre. Presente en todas las rocas √≠gneas, metam√≥rficas y sedimentarias.",
                location: "Ubicuo en toda la regi√≥n",
                uses: "Electr√≥nica, relojer√≠a, ornamentaci√≥n",
                emoji: "üíé"
            },
            { 
                id: 7, 
                name: "Hematita", 
                formula: "Fe‚ÇÇO‚ÇÉ", 
                hardness: 6.5, 
                color: "Negro a rojo", 
                streak: "Rojo cereza", 
                luster: "Met√°lico a terroso",
                system: "Trigonal",
                density: 5.3,
                description: "Principal mineral de hierro. Su raya roja es caracter√≠stica.",
                location: "Dep√≥sitos de hierro de la regi√≥n",
                uses: "Principal mena de hierro, pigmento",
                emoji: "üî¥"
            },
            { 
                id: 8, 
                name: "Magnetita", 
                formula: "Fe‚ÇÉO‚ÇÑ", 
                hardness: 6, 
                color: "Negro", 
                streak: "Negro", 
                luster: "Met√°lico",
                system: "C√∫bico",
                density: 5.2,
                description: "Mineral magn√©tico de hierro. Atrae a los imanes.",
                location: "Dep√≥sitos de hierro y en rocas √≠gneas",
                uses: "Mena de hierro, aplicaciones magn√©ticas",
                emoji: "üß≤"
            }
        ];
        
        // Base de conocimiento IA
        const geoKnowledgeBase = {
            greetings: ["¬°Hola! üëã", "¬°Buen d√≠a! ‚òÄÔ∏è", "¬°Hola ge√≥logo! ‚öíÔ∏è"],
            capabilities: [
                "Puedo identificar minerales comunes de Atacama üíé",
                "Te ayudo con interpretaci√≥n estructural üèîÔ∏è",
                "Analizo muestras con datos de GPS y fotos üìç",
                "Genero informes geol√≥gicos autom√°ticos üìä",
                "Explico conceptos geol√≥gicos complejos üß™"
            ],
            responses: {
                "identificar mineral": "Para identificar un mineral, usa la c√°mara HD o describe sus caracter√≠sticas: color, dureza, raya, brillo. üé®",
                "escala de mohs": "La escala de Mohs mide dureza: Talco(1), Yeso(2), Calcita(3), Fluorita(4), Apatito(5), Ortosa(6), Cuarzo(7), Topacio(8), Corind√≥n(9), Diamante(10). üíé",
                "geolog√≠a atacama": "Atacama es rica en minerales cupr√≠feros como calcopirita, malaquita y atacamita. La regi√≥n tiene una compleja geolog√≠a con sistemas de p√≥rfidos cupr√≠feros. üèúÔ∏è",
                "usar gps": "Haz click en el icono del sat√©lite üõ∞Ô∏è para activar GPS real. Te dar√© coordenadas precisas para tus muestras. üìç",
                "tomar foto": "Haz click en el icono de c√°mara üì∏ para activar la c√°mara HD. Luego usa 'Identificar Mineral' para an√°lisis con IA. ü§ñ"
            }
        };

        // ============================================
        // INICIALIZACI√ìN DEL SISTEMA
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåµ AtacamApp - Sistema Geol√≥gico Inteligente Inicializando...');
            
            // Inicializar componentes
            initialize3DMap();
            loadSavedData();
            setupEventListeners();
            
            // Mostrar mensaje de bienvenida
            showNotification('üöÄ AtacamApp Listo ‚Ä¢ Activa GPS y C√°mara para comenzar', 'info');
            
            // Iniciar br√∫jula
            setTimeout(() => {
                startCompass();
            }, 1000);
        });

        // ============================================
        // GPS OBLIGATORIO POR CLICK
        // ============================================
        function forceGPS() {
            const gpsStatus = document.getElementById('gpsStatus');
            
            if (gpsWatchId) {
                // Si ya est√° activo, mostrar informaci√≥n
                if (realGPSData) {
                    showNotification(`üìç GPS Activo ‚Ä¢ Lat: ${realGPSData.latitude.toFixed(6)} ‚Ä¢ Lon: ${realGPSData.longitude.toFixed(6)} ‚Ä¢ Precisi√≥n: ${realGPSData.accuracy.toFixed(1)}m`, 'success');
                }
                return;
            }
            
            // Solicitar permisos de geolocalizaci√≥n
            if (!navigator.geolocation) {
                showNotification('‚ùå Tu dispositivo no soporta GPS', 'error');
                return;
            }
            
            showNotification('üõ∞Ô∏è Activando GPS real... Permite la ubicaci√≥n en tu navegador', 'info');
            
            // Opciones de alta precisi√≥n
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            // Obtener posici√≥n actual
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    realGPSData = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude || 0,
                        heading: position.coords.heading || 0,
                        speed: position.coords.speed || 0,
                        timestamp: position.timestamp
                    };
                    
                    updateGPSDisplay();
                    centerMapOnGPS();
                    
                    // Monitoreo continuo
                    gpsWatchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            realGPSData = {
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude,
                                accuracy: pos.coords.accuracy,
                                altitude: pos.coords.altitude || 0,
                                heading: pos.coords.heading || 0,
                                speed: pos.coords.speed || 0,
                                timestamp: pos.timestamp
                            };
                            updateGPSDisplay();
                        },
                        (error) => {
                            handleGPSError(error);
                        },
                        options
                    );
                    
                    gpsStatus.classList.add('active');
                    gpsStatus.innerHTML = `<i class="fas fa-satellite"></i> <span>GPS: ACTIVO üõ∞Ô∏è</span> <span class="badge badge-gps">${realGPSData.accuracy.toFixed(0)}m</span>`;
                    
                    showNotification(`‚úÖ GPS Activado ‚Ä¢ Precisi√≥n: ${realGPSData.accuracy.toFixed(1)} metros`, 'success');
                },
                (error) => {
                    handleGPSError(error);
                },
                options
            );
        }
        
        function updateGPSDisplay() {
            if (!realGPSData) return;
            
            const coordsElement = document.getElementById('currentCoords');
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            coordsElement.innerHTML = `
                ${realGPSData.latitude.toFixed(6)}, ${realGPSData.longitude.toFixed(6)} 
                ‚Ä¢ Alt: ${realGPSData.altitude ? realGPSData.altitude.toFixed(0) + 'm' : 'N/A'}
                ‚Ä¢ Vel: ${realGPSData.speed ? (realGPSData.speed * 3.6).toFixed(1) + ' km/h' : '0 km/h'}
            `;
            
            accuracyElement.textContent = `Precisi√≥n: ${realGPSData.accuracy.toFixed(1)}m`;
            
            // Actualizar br√∫jula si hay heading
            if (realGPSData.heading !== null) {
                updateCompass(realGPSData.heading);
            }
        }
        
        function handleGPSError(error) {
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '‚ùå Permiso de ubicaci√≥n denegado. Activa la ubicaci√≥n en tu navegador.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'üìç Informaci√≥n de ubicaci√≥n no disponible.';
                    break;
                case error.TIMEOUT:
                    message = '‚è±Ô∏è Tiempo de espera del GPS agotado.';
                    break;
                default:
                    message = '‚ùå Error desconocido del GPS.';
            }
            
            showNotification(message, 'error');
            
            // Modo simulado como fallback
            realGPSData = {
                latitude: -27.3667 + (Math.random() - 0.5) * 0.01,
                longitude: -70.3333 + (Math.random() - 0.5) * 0.01,
                accuracy: 50 + Math.random() * 100,
                altitude: 1500 + Math.random() * 500,
                heading: Math.random() * 360,
                speed: 0,
                timestamp: Date.now()
            };
            
            updateGPSDisplay();
            showNotification('‚ö†Ô∏è Usando GPS simulado. Activa permisos para GPS real.', 'warning');
        }
        
        function centerMapOnGPS() {
            if (!realGPSData || !map3d) return;
            
            map3d.flyTo({
                center: [realGPSData.longitude, realGPSData.latitude],
                zoom: 15,
                essential: true
            });
            
            // Agregar marcador de posici√≥n actual
            new mapboxgl.Marker({
                color: '#e74c3c',
                draggable: false
            })
            .setLngLat([realGPSData.longitude, realGPSData.latitude])
            .setPopup(new mapboxgl.Popup().setHTML(`
                <strong>üìç Tu Posici√≥n Actual</strong><br>
                Lat: ${realGPSData.latitude.toFixed(6)}<br>
                Lon: ${realGPSData.longitude.toFixed(6)}<br>
                Precisi√≥n: ${realGPSData.accuracy.toFixed(1)}m
            `))
            .addTo(map3d);
        }

        // ============================================
        // C√ÅMARA HD OBLIGATORIA POR CLICK
        // ============================================
        function forceCamera() {
            const cameraStatus = document.getElementById('cameraStatus');
            
            if (cameraStream) {
                showNotification('üì∏ C√°mara ya est√° activa ‚Ä¢ Usa "Identificar Mineral" para an√°lisis', 'info');
                return;
            }
            
            showNotification('üì∏ Activando c√°mara HD... Permite acceso a la c√°mara', 'info');
            
            // Solicitar acceso a la c√°mara
            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    facingMode: currentCamera,
                    frameRate: { ideal: 30 }
                },
                audio: false
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    cameraStream = stream;
                    const videoElement = document.getElementById('cameraFeed');
                    const placeholder = document.getElementById('cameraPlaceholder');
                    
                    videoElement.srcObject = stream;
                    videoElement.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    videoElement.play();
                    
                    cameraStatus.classList.add('active');
                    cameraStatus.innerHTML = `<i class="fas fa-camera"></i> <span>C√ÅMARA: ACTIVA üì∏</span> <span class="badge badge-camera">HD 1080p</span>`;
                    
                    showNotification('‚úÖ C√°mara HD Activada ‚Ä¢ Enfoca minerales para an√°lisis', 'success');
                    
                    // Configurar canvas para capturas
                    const canvas = document.getElementById('cameraCanvas');
                    canvas.width = 1920;
                    canvas.height = 1080;
                })
                .catch((error) => {
                    console.error('Error al acceder a la c√°mara:', error);
                    handleCameraError(error);
                });
        }
        
        function handleCameraError(error) {
            let message = '';
            switch(error.name) {
                case 'NotAllowedError':
                    message = '‚ùå Permiso de c√°mara denegado. Permite acceso a la c√°mara en tu navegador.';
                    break;
                case 'NotFoundError':
                    message = 'üì∑ No se encontr√≥ c√°mara en tu dispositivo.';
                    break;
                case 'NotSupportedError':
                    message = '‚ö†Ô∏è Tu navegador no soporta acceso a c√°mara.';
                    break;
                default:
                    message = '‚ùå Error desconocido de la c√°mara.';
            }
            
            showNotification(message, 'error');
            
            // Mostrar modo simulado
            const placeholder = document.getElementById('cameraPlaceholder');
            placeholder.innerHTML = `
                <div style="font-size: 4rem;">‚ö†Ô∏è</div>
                <h3>MODO SIMULADO ACTIVADO</h3>
                <p>Permite acceso a la c√°mara para modo real</p>
                <button class="btn btn-warning" onclick="simulateCameraCapture()" style="margin-top: 15px;">
                    <i class="fas fa-video"></i> Simular Captura
                </button>
            `;
        }
        
        function switchCamera() {
            if (!cameraStream) {
                showNotification('Primero activa la c√°mara', 'warning');
                return;
            }
            
            // Detener stream actual
            cameraStream.getTracks().forEach(track => track.stop());
            
            // Cambiar entre frontal y trasera
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            
            // Reiniciar c√°mara
            forceCamera();
            
            showNotification(`üîÑ Cambiando a c√°mara ${currentCamera === 'environment' ? 'trasera' : 'frontal'}`, 'info');
        }
        
        function toggleFlash() {
            if (!cameraStream) {
                showNotification('Activa la c√°mara primero', 'warning');
                return;
            }
            
            flashActive = !flashActive;
            const flashBtn = document.querySelector('.btn-warning');
            
            if (flashActive) {
                flashBtn.innerHTML = '<i class="fas fa-bolt"></i> Flash ON ‚ö°';
                showNotification('‚ö° Flash activado', 'info');
            } else {
                flashBtn.innerHTML = '<i class="fas fa-bolt"></i> Flash OFF ‚ö°';
                showNotification('Flash desactivado', 'info');
            }
        }
        
        function captureAndAnalyze() {
            if (!cameraStream) {
                showNotification('üì∏ Primero activa la c√°mara', 'warning');
                forceCamera();
                return;
            }
            
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // Efecto de flash visual
            if (flashActive) {
                document.getElementById('cameraContainer').style.background = '#ffffff';
                setTimeout(() => {
                    document.getElementById('cameraContainer').style.background = 'linear-gradient(135deg, var(--secondary), var(--dark))';
                }, 300);
            }
            
            // Capturar frame
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Mostrar animaci√≥n de an√°lisis
            showNotification('üîç Analizando muestra con IA geol√≥gica...', 'info');
            
            // Simular an√°lisis (en producci√≥n usar√≠a TensorFlow.js con modelo entrenado)
            setTimeout(() => {
                // Seleccionar mineral aleatorio (simulaci√≥n)
                const mineral = atacamaMineralsDB[Math.floor(Math.random() * atacamaMineralsDB.length)];
                
                // Agregar datos de geolocalizaci√≥n
                const locationData = realGPSData || {
                    latitude: -27.3667 + (Math.random() - 0.5) * 0.01,
                    longitude: -70.3333 + (Math.random() - 0.5) * 0.01,
                    accuracy: 50,
                    altitude: 1500,
                    timestamp: Date.now()
                };
                
                const identifiedMineral = {
                    ...mineral,
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    location: locationData,
                    imageData: canvas.toDataURL('image/jpeg', 0.8),
                    confidence: (80 + Math.random() * 20).toFixed(1)
                };
                
                // Agregar a colecci√≥n
                identifiedMinerals.unshift(identifiedMineral);
                if (identifiedMinerals.length > 50) identifiedMinerals.pop();
                
                // Mostrar resultados
                showMineralResult(identifiedMineral);
                updateMineralsGrid();
                saveToLocalStorage();
                
                // Agregar marcador al mapa
                addMineralMarker(identifiedMineral);
                
                showNotification(`‚úÖ ${mineral.emoji} ${mineral.name} identificado ‚Ä¢ Confianza: ${identifiedMineral.confidence}%`, 'success');
                
            }, 2000);
        }
        
        function showMineralResult(mineral) {
            const resultDiv = document.getElementById('analysisResult');
            const nameElement = document.getElementById('mineralName');
            const formulaElement = document.getElementById('mineralFormula');
            const detailsElement = document.getElementById('mineralDetails');
            
            resultDiv.style.display = 'block';
            nameElement.textContent = `${mineral.emoji} ${mineral.name}`;
            formulaElement.textContent = mineral.formula;
            
            detailsElement.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="padding: 12px; background: white; border-radius: 10px; border: 2px solid var(--light);">
                        <strong>Dureza:</strong><br>
                        <span style="color: var(--primary); font-weight: bold; font-size: 1.2rem;">${mineral.hardness}</span> (Mohs)
                    </div>
                    <div style="padding: 12px; background: white; border-radius: 10px; border: 2px solid var(--light);">
                        <strong>Color:</strong><br>
                        ${mineral.color} ${mineral.emoji}
                    </div>
                    <div style="padding: 12px; background: white; border-radius: 10px; border: 2px solid var(--light);">
                        <strong>Raya:</strong><br>
                        ${mineral.streak}
                    </div>
                    <div style="padding: 12px; background: white; border-radius: 10px; border: 2px solid var(--light);">
                        <strong>Brillo:</strong><br>
                        ${mineral.luster}
                    </div>
                </div>
                
                <div style="padding: 12px; background: linear-gradient(135deg, #e8f4fc, #d4e6f1); border-radius: 10px; margin-bottom: 10px;">
                    <strong>Descripci√≥n:</strong> ${mineral.description}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 2px solid var(--light);">
                    <div style="font-size: 0.9rem; color: #666;">
                        <i class="fas fa-map-marker-alt"></i> 
                        ${mineral.location.latitude.toFixed(6)}, ${mineral.location.longitude.toFixed(6)}
                    </div>
                    <div class="badge badge-success">
                        <i class="fas fa-robot"></i> Confianza: ${mineral.confidence}%
                    </div>
                </div>
            `;
            
            // Ocultar despu√©s de 10 segundos
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 10000);
        }

        // ============================================
        // MAPA 3D CON GOOGLE MAPS/MAPBOX
        // ============================================
        function initialize3DMap() {
            try {
                map3d = new mapboxgl.Map({
                    container: 'map3d',
                    style: 'mapbox://styles/mapbox/satellite-streets-v12',
                    center: [-70.3333, -27.3667], // Atacama
                    zoom: 11,
                    pitch: 60,
                    bearing: 0,
                    antialias: true
                });
                
                map3d.on('load', () => {
                    console.log('üó∫Ô∏è Mapa 3D inicializado correctamente');
                    
                    // Agregar controles de navegaci√≥n
                    map3d.addControl(new mapboxgl.NavigationControl(), 'top-right');
                    
                    // Agregar control de escala
                    map3d.addControl(new mapboxgl.ScaleControl({
                        maxWidth: 100,
                        unit: 'metric'
                    }));
                    
                    // Capa de elevaci√≥n 3D
                    map3d.addSource('mapbox-dem', {
                        type: 'raster-dem',
                        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        tileSize: 512
                    });
                    
                    map3d.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                    
                    // Sky layer
                    map3d.setFog({
                        'range': [0.5, 10],
                        'color': 'white',
                        'horizon-blend': 0.1
                    });
                    
                    // Capas geol√≥gicas
                    addGeologicalLayers();
                    
                    // Agregar marcadores iniciales
                    addInitialMarkers();
                });
                
            } catch (error) {
                console.error('Error al cargar mapa 3D:', error);
                showNotification('‚ö†Ô∏è Usando mapa 2D por compatibilidad', 'warning');
                initialize2DMap();
            }
        }
        
        function initialize2DMap() {
            // Fallback a Leaflet 2D
            const map2d = L.map('map3d').setView([-27.3667, -70.3333], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map2d);
            
            // Marcador de posici√≥n
            L.marker([-27.3667, -70.3333])
                .addTo(map2d)
                .bindPopup('<b>Regi√≥n de Atacama</b><br>Centro geol√≥gico')
                .openPopup();
        }
        
        function addGeologicalLayers() {
            // Esta funci√≥n agregar√≠a capas WMS de datos geol√≥gicos
            // En este ejemplo, simulamos con capas de color
            
            console.log('üèîÔ∏è Capas geol√≥gicas cargadas');
        }
        
        function toggleLayer(layerName) {
            const button = event.target;
            button.classList.toggle('active');
            
            let message = '';
            switch(layerName) {
                case 'topography':
                    message = button.classList.contains('active') ? 
                        'üóª Topograf√≠a 3D activada' : 'üóª Topograf√≠a desactivada';
                    break;
                case 'geology':
                    message = button.classList.contains('active') ? 
                        'üèîÔ∏è Capas geol√≥gicas activadas' : 'üèîÔ∏è Geolog√≠a desactivada';
                    break;
                case 'faults':
                    message = button.classList.contains('active') ? 
                        '‚ö° Sistema de fallas visible' : '‚ö° Fallas ocultas';
                    break;
                case 'minerals':
                    message = button.classList.contains('active') ? 
                        'üíé Zonas mineralizadas visibles' : 'üíé Mineralizaci√≥n oculta';
                    break;
            }
            
            showNotification(message, 'info');
        }
        
        function addInitialMarkers() {
            // Puntos de inter√©s geol√≥gico de Atacama
            const geologicalPoints = [
                { name: "Mina Candelaria", coords: [-70.0, -27.5], type: "mine", emoji: "‚õèÔ∏è" },
                { name: "Salar de Atacama", coords: [-68.25, -23.5], type: "salar", emoji: "üßÇ" },
                { name: "Cerro Im√°n", coords: [-69.9, -27.2], type: "mountain", emoji: "üèîÔ∏è" },
                { name: "Geiseres del Tatio", coords: [-68.0, -22.33], type: "geothermal", emoji: "‚ô®Ô∏è" }
            ];
            
            geologicalPoints.forEach(point => {
                const el = document.createElement('div');
                el.className = 'geological-marker';
                el.innerHTML = point.emoji;
                el.style.fontSize = '24px';
                el.style.cursor = 'pointer';
                
                new mapboxgl.Marker(el)
                    .setLngLat(point.coords)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <strong>${point.emoji} ${point.name}</strong><br>
                        Tipo: ${point.type}<br>
                        Coord: ${point.coords[1].toFixed(4)}, ${point.coords[0].toFixed(4)}
                    `))
                    .addTo(map3d);
            });
        }
        
        function addGeologicalPoint() {
            const coords = realGPSData ? 
                [realGPSData.longitude, realGPSData.latitude] : 
                [-70.3333 + (Math.random() - 0.5) * 0.5, -27.3667 + (Math.random() - 0.5) * 0.5];
            
            const pointTypes = ["muestra", "observaci√≥n", "falla", "contacto", "pliegue"];
            const type = pointTypes[Math.floor(Math.random() * pointTypes.length)];
            const emojis = { "muestra": "üß™", "observaci√≥n": "üìù", "falla": "‚ö°", "contacto": "üîÑ", "pliegue": "üåÄ" };
            
            const el = document.createElement('div');
            el.className = 'user-point';
            el.innerHTML = emojis[type];
            el.style.fontSize = '20px';
            el.style.background = 'white';
            el.style.borderRadius = '50%';
            el.style.padding = '5px';
            el.style.border = '3px solid var(--primary)';
            
            const marker = new mapboxgl.Marker(el)
                .setLngLat(coords)
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <strong>${emojis[type]} Punto Geol√≥gico</strong><br>
                    Tipo: ${type}<br>
                    Coord: ${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}<br>
                    <em>${new Date().toLocaleString()}</em>
                `))
                .addTo(map3d);
            
            geologicalMarkers.push(marker);
            
            showNotification(`üìç Punto ${type} agregado al mapa ${emojis[type]}`, 'success');
        }
        
        function addMineralMarker(mineral) {
            if (!map3d || !mineral.location) return;
            
            const el = document.createElement('div');
            el.className = 'mineral-marker';
            el.innerHTML = mineral.emoji || 'üíé';
            el.style.fontSize = '20px';
            el.style.cursor = 'pointer';
            el.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
            
            new mapboxgl.Marker(el)
                .setLngLat([mineral.location.longitude, mineral.location.latitude])
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <strong>${mineral.emoji || 'üíé'} ${mineral.name}</strong><br>
                    ${mineral.formula}<br>
                    Dureza: ${mineral.hardness}<br>
                    Identificado: ${new Date(mineral.timestamp).toLocaleString()}<br>
                    <button class="btn btn-primary" onclick="viewMineralDetails(${mineral.id})" style="margin-top: 5px; padding: 5px 10px; font-size: 0.8rem;">
                        Ver detalles
                    </button>
                `))
                .addTo(map3d);
        }
        
        function generate3DModel() {
            showNotification('üßä Generando modelo 3D del terreno...', 'info');
            
            // Simulaci√≥n de generaci√≥n de modelo 3D
            setTimeout(() => {
                const modalContent = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 3rem;">üèîÔ∏è</div>
                            <h3>Modelo Geol√≥gico 3D</h3>
                        </div>
                        
                        <div style="height: 200px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">üîÑ</div>
                                <p>Visualizando terreno 3D</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong>Par√°metros del modelo:</strong>
                            <ul style="margin-top: 10px; padding-left: 20px;">
                                <li>Resoluci√≥n: 10 metros</li>
                                <li>√Årea: 5x5 km</li>
                                <li>Puntos de control: ${geologicalMarkers.length + identifiedMinerals.length}</li>
                                <li>Inclinaci√≥n: 15¬∞ NE</li>
                            </ul>
                        </div>
                        
                        <div class="camera-controls">
                            <button class="btn btn-primary" onclick="download3DModel()" style="flex: 1;">
                                <i class="fas fa-download"></i> Descargar OBJ
                            </button>
                            <button class="btn btn-secondary" onclick="share3DModel()" style="flex: 1;">
                                <i class="fas fa-share"></i> Compartir
                            </button>
                        </div>
                    </div>
                `;
                
                openModal('Modelo Geol√≥gico 3D', modalContent);
                
                showNotification('‚úÖ Modelo 3D generado exitosamente', 'success');
            }, 3000);
        }

        // ============================================
        // AGENTE IA ESPECIALIZADO (GEOBOT)
        // ============================================
        function toggleChat() {
            const chat = document.getElementById('aiChat');
            chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
            
            if (chat.style.display === 'flex') {
                showNotification('ü§ñ Geobot IA conectado ‚Ä¢ Haz tus preguntas geol√≥gicas', 'info');
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Agregar mensaje del usuario
            addChatMessage(message, 'user');
            input.value = '';
            
            // Procesar con IA
            setTimeout(() => {
                processGeoQuery(message);
            }, 1000);
        }
        
        function processGeoQuery(query) {
            query = query.toLowerCase();
            let response = '';
            let emoji = 'ü§ñ';
            
            // Buscar en base de conocimiento
            for (const [key, value] of Object.entries(geoKnowledgeBase.responses)) {
                if (query.includes(key)) {
                    response = value;
                    break;
                }
            }
            
            // Si no hay respuesta espec√≠fica, generar una gen√©rica
            if (!response) {
                if (query.includes('hola') || query.includes('buenos d√≠as') || query.includes('buenas tardes')) {
                    response = geoKnowledgeBase.greetings[Math.floor(Math.random() * geoKnowledgeBase.greetings.length)];
                    response += " ¬øEn qu√© puedo ayudarte con la geolog√≠a de Atacama hoy?";
                    emoji = 'üëã';
                } else if (query.includes('mineral') || query.includes('identificar') || query.includes('muestra')) {
                    response = "Para identificar minerales, usa la c√°mara HD o describe: color, dureza, raya, brillo, h√°bito cristalino. Por ejemplo: 'Tengo un mineral amarillo met√°lico con dureza 3.5' üé®";
                    emoji = 'üíé';
                } else if (query.includes('mapa') || query.includes('ubicaci√≥n') || query.includes('gps')) {
                    response = "Activa el GPS real haciendo click en el icono del sat√©lite üõ∞Ô∏è. Luego podr√© darte informaci√≥n espec√≠fica de tu ubicaci√≥n en Atacama. üìç";
                    emoji = 'üó∫Ô∏è';
                } else if (query.includes('estructura') || query.includes('falla') || query.includes('pliegue')) {
                    response = "Atacama tiene complejas estructuras geol√≥gicas. Para an√°lisis estructural, toma fotos de las rocas desde diferentes √°ngulos y activa el GPS para contexto. üèîÔ∏è";
                    emoji = '‚ö°';
                } else if (query.includes('reporte') || query.includes('informe') || query.includes('datos')) {
                    response = "Puedo ayudarte a generar informes autom√°ticos con los minerales identificados, ubicaciones GPS y fotos. Usa la secci√≥n 'Informes Inteligentes'. üìä";
                    emoji = 'üìã';
                } else {
                    response = "Interesante pregunta geol√≥gica. Te sugiero: 1) Activar GPS para contexto 2) Usar la c√°mara para fotos 3) Consultar la base de datos de minerales. ¬øPuedo ayudarte con algo m√°s espec√≠fico? üß™";
                    emoji = 'ü§î';
                }
            }
            
            // Agregar respuesta de la IA
            addChatMessage(response, 'ai', emoji);
            
            // Guardar en historial
            aiChatHistory.push({
                query: query,
                response: response,
                timestamp: new Date().toISOString()
            });
        }
        
        function addChatMessage(text, sender, emoji = 'ü§ñ') {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = `
                    <div style="display: flex; gap: 10px;">
                        <div style="font-size: 1.5rem;">${emoji}</div>
                        <div>${text}</div>
                    </div>
                `;
            } else {
                messageDiv.textContent = text;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function runGeoAnalysis() {
            if (!realGPSData) {
                showNotification('Activa GPS primero para an√°lisis contextual', 'warning');
                forceGPS();
                return;
            }
            
            showNotification('üß† Analizando contexto geol√≥gico con IA...', 'info');
            
            setTimeout(() => {
                const modalContent = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 3rem;">üß™</div>
                            <h3>An√°lisis Geol√≥gico Contextual</h3>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <strong>Ubicaci√≥n:</strong><br>
                            Lat: ${realGPSData.latitude.toFixed(6)}, Lon: ${realGPSData.longitude.toFixed(6)}<br>
                            Altitud: ${realGPSData.altitude ? realGPSData.altitude.toFixed(0) + ' m' : 'N/A'}<br>
                            Precisi√≥n: ${realGPSData.accuracy.toFixed(1)} m
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong>Interpretaci√≥n IA:</strong>
                            <p>Basado en tu ubicaci√≥n en Atacama, es probable que encuentres:</p>
                            <ul style="margin-top: 10px; padding-left: 20px;">
                                <li>Minerales cupr√≠feros (Calcopirita, Malaquita)</li>
                                <li>Rocas volc√°nicas andes√≠ticas</li>
                                <li>Estructuras de falla NNW-SSE</li>
                                <li>Alteraci√≥n hidrotermal tipo pot√°sica</li>
                            </ul>
                        </div>
                        
                        <div style="background: #e8f4fc; padding: 15px; border-radius: 10px;">
                            <strong>Recomendaciones de campo:</strong>
                            <ol style="margin-top: 10px; padding-left: 20px;">
                                <li>Busca vetas de cuarzo con sulfuros</li>
                                <li>Mide rumbos de estructuras visibles</li>
                                <li>Toma muestras de roca fresca y alterada</li>
                                <li>Documenta con fotos georreferenciadas</li>
                            </ol>
                        </div>
                    </div>
                `;
                
                openModal('An√°lisis Geol√≥gico IA', modalContent);
                
                showNotification('‚úÖ An√°lisis completado ‚Ä¢ Revisa las recomendaciones', 'success');
            }, 2000);
        }

        // ============================================
        // BR√öJULA DIGITAL
        // ============================================
        function startCompass() {
            if (compassActive) return;
            
            if (!window.DeviceOrientationEvent) {
                showNotification('Tu dispositivo no soporta br√∫jula digital', 'warning');
                return;
            }
            
            // Solicitar permisos en iOS
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            compassActive = true;
                            showNotification('üß≠ Br√∫jula digital activada', 'success');
                        } else {
                            showNotification('Permiso de orientaci√≥n denegado', 'error');
                            simulateCompass();
                        }
                    })
                    .catch(console.error);
            } else {
                // Android y otros navegadores
                window.addEventListener('deviceorientation', handleOrientation);
                compassActive = true;
                showNotification('üß≠ Br√∫jula digital activada', 'success');
            }
        }
        
        function handleOrientation(event) {
            if (event.alpha !== null) {
                const heading = event.alpha; // 0-360 degrees
                updateCompass(heading);
                
                // Si tenemos GPS con heading, podemos calibrar
                if (realGPSData && realGPSData.heading) {
                    // Podr√≠amos calibrar aqu√≠ si fuera necesario
                }
            }
        }
        
        function updateCompass(heading) {
            const rose = document.getElementById('compassRose');
            const needle = document.getElementById('compassNeedle');
            const directionElement = document.getElementById('compassDirection');
            const degreesElement = document.getElementById('compassDegrees');
            
            // Suavizar movimiento
            const smoothHeading = heading;
            
            // Rotar rosa de los vientos (en direcci√≥n opuesta)
            if (rose) rose.style.transform = `rotate(${-smoothHeading}deg)`;
            
            // Actualizar direcci√≥n de la aguja
            if (needle) needle.style.transform = `translate(-50%, -100%) rotate(${smoothHeading}deg)`;
            
            // Determinar direcci√≥n cardinal
            const directions = ['NORTE', 'NORESTE', 'ESTE', 'SURESTE', 'SUR', 'SUROESTE', 'OESTE', 'NOROESTE'];
            const emojis = ['üß≠', '‚ÜóÔ∏è', '‚û°Ô∏è', '‚ÜòÔ∏è', '‚¨áÔ∏è', '‚ÜôÔ∏è', '‚¨ÖÔ∏è', '‚ÜñÔ∏è'];
            const index = Math.round(smoothHeading / 45) % 8;
            
            if (directionElement) {
                directionElement.textContent = `${emojis[index]} ${directions[index]}`;
                
                // Colores seg√∫n direcci√≥n
                const colors = ['#e74c3c', '#3498db', '#27ae60', '#f39c12', '#e74c3c', '#3498db', '#27ae60', '#f39c12'];
                directionElement.style.color = colors[index];
            }
            
            if (degreesElement) {
                degreesElement.textContent = `${Math.round(smoothHeading)}¬∞ ‚Ä¢ Precisi√≥n: ${compassActive ? 'alta' : 'simulada'}`;
            }
        }
        
        function calibrateCompass() {
            if (!compassActive) {
                showNotification('Primero activa la br√∫jula digital', 'warning');
                return;
            }
            
            showNotification('üîß Calibrando br√∫jula... Gira el dispositivo en forma de 8', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ Br√∫jula calibrada exitosamente', 'success');
            }, 3000);
        }
        
        function simulateCompass() {
            let simulatedHeading = 0;
            
            setInterval(() => {
                simulatedHeading = (simulatedHeading + 1) % 360;
                updateCompass(simulatedHeading);
            }, 100);
            
            showNotification('üß≠ Br√∫jula en modo simulaci√≥n', 'info');
        }

        // ============================================
        // FUNCIONALIDADES DE GESTI√ìN DE DATOS
        // ============================================
        function updateMineralsGrid() {
            const grid = document.getElementById('mineralsGrid');
            const noMinerals = document.getElementById('noMinerals');
            
            if (identifiedMinerals.length === 0) {
                grid.style.display = 'none';
                noMinerals.style.display = 'block';
                return;
            }
            
            noMinerals.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = '';
            
            // Mostrar √∫ltimos 8 minerales identificados
            identifiedMinerals.slice(0, 8).forEach((mineral, index) => {
                const card = document.createElement('div');
                card.className = 'mineral-card';
                if (index === 0) card.classList.add('active');
                
                card.innerHTML = `
                    <div class="mineral-icon">
                        ${mineral.emoji || 'üíé'}
                    </div>
                    <div style="font-weight: bold; color: var(--secondary); font-size: 1.1rem;">${mineral.name}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">${mineral.formula}</div>
                    <div style="font-size: 0.7rem; color: #999; margin-top: 5px;">
                        <i class="fas fa-clock"></i> ${new Date(mineral.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                    <div class="badge badge-mineral" style="margin-top: 8px; font-size: 0.7rem;">
                        ${mineral.hardness} Mohs
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    viewMineralDetails(mineral.id);
                });
                
                grid.appendChild(card);
            });
        }
        
        function viewMineralDetails(mineralId) {
            const mineral = identifiedMinerals.find(m => m.id === mineralId);
            if (!mineral) return;
            
            const modalContent = `
                <div style="padding: 20px; max-width: 500px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 4rem;">${mineral.emoji || 'üíé'}</div>
                        <h2 style="margin: 10px 0; color: var(--primary);">${mineral.name}</h2>
                        <div style="font-size: 1.2rem; color: var(--secondary);">${mineral.formula}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                            <strong>Dureza</strong><br>
                            <span style="font-size: 1.8rem; color: var(--primary); font-weight: bold;">${mineral.hardness}</span><br>
                            <small>Escala de Mohs</small>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                            <strong>Color</strong><br>
                            <span style="font-size: 1.2rem;">${mineral.color}</span>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                            <strong>Raya</strong><br>
                            <span style="font-size: 1.2rem;">${mineral.streak}</span>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                            <strong>Brillo</strong><br>
                            <span style="font-size: 1.2rem;">${mineral.luster}</span>
                        </div>
                    </div>
                    
                    <div style="background: #e8f4fc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>Descripci√≥n:</strong>
                        <p style="margin-top: 10px;">${mineral.description}</p>
                    </div>
                    
                    <div style="background: #fff5eb; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>Ubicaci√≥n:</strong>
                        <p style="margin-top: 5px;">
                            <i class="fas fa-map-marker-alt"></i> 
                            ${mineral.location.latitude.toFixed(6)}, ${mineral.location.longitude.toFixed(6)}<br>
                            <small>${new Date(mineral.timestamp).toLocaleString()}</small>
                        </p>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" onclick="locateOnMap(${mineralId})" style="flex: 1;">
                            <i class="fas fa-map"></i> Ver en Mapa
                        </button>
                        <button class="btn btn-secondary" onclick="shareMineral(${mineralId})" style="flex: 1;">
                            <i class="fas fa-share"></i> Compartir
                        </button>
                    </div>
                </div>
            `;
            
            openModal(`${mineral.emoji || 'üíé'} ${mineral.name}`, modalContent);
        }
        
        function generateSmartReport() {
            if (identifiedMinerals.length === 0) {
                showNotification('Primero identifica algunos minerales', 'warning');
                return;
            }
            
            const title = document.getElementById('reportTitle').value || 'Informe Geol√≥gico Atacama';
            const notes = document.getElementById('reportNotes').value || 'Muestras colectadas en terreno';
            
            const report = {
                id: Date.now(),
                title: title,
                date: new Date().toISOString(),
                minerals: identifiedMinerals,
                gpsData: realGPSData,
                notes: notes,
                compassHeading: compassActive ? 'Real' : 'Simulado',
                mapMarkers: geologicalMarkers.length,
                version: 'AtacamApp v2.0'
            };
            
            // Mostrar preview
            showReportPreview(report);
            
            // Guardar reporte
            saveReport(report);
            
            // An√°lisis autom√°tico con IA
            generateIAReportAnalysis(report);
            
            showNotification('üìã Informe generado con an√°lisis IA', 'success');
        }
        
        function generateIAReportAnalysis(report) {
            setTimeout(() => {
                const analysis = `
                    <div style="padding: 15px; background: linear-gradient(135deg, #e8f4fc, #d4e6f1); border-radius: 10px; margin-top: 15px; border-left: 4px solid var(--info);">
                        <strong>ü§ñ An√°lisis IA del Reporte:</strong>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>${report.minerals.length} minerales identificados</li>
                            <li>Predominio: ${getDominantMineralType(report.minerals)}</li>
                            <li>Distribuci√≥n espacial: ${report.minerals.length > 1 ? 'Varios puntos' : 'Punto √∫nico'}</li>
                            <li>Recomendaci√≥n: Continuar exploraci√≥n en sector</li>
                        </ul>
                    </div>
                `;
                
                const preview = document.getElementById('reportPreview');
                const currentContent = preview.innerHTML;
                preview.innerHTML = currentContent + analysis;
            }, 1500);
        }
        
        function getDominantMineralType(minerals) {
            const types = {};
            minerals.forEach(m => {
                if (m.name.includes('cobre') || m.formula.includes('Cu')) {
                    types.cupriferous = (types.cupriferous || 0) + 1;
                } else if (m.name.includes('hierro') || m.formula.includes('Fe')) {
                    types.ferrous = (types.ferrous || 0) + 1;
                } else {
                    types.other = (types.other || 0) + 1;
                }
            });
            
            const max = Math.max(...Object.values(types));
            for (const [type, count] of Object.entries(types)) {
                if (count === max) {
                    return type === 'cupriferous' ? 'Minerales cupr√≠feros' : 
                           type === 'ferrous' ? 'Minerales ferrosos' : 'Varios tipos';
                }
            }
            
            return 'Variado';
        }
        
        function showReportPreview(report) {
            const preview = document.getElementById('reportPreview');
            
            let mineralsHTML = '';
            report.minerals.slice(0, 5).forEach((mineral, index) => {
                mineralsHTML += `
                    <div style="padding: 10px; margin: 8px 0; background: white; border-radius: 8px; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 1.5rem;">${mineral.emoji || 'üíé'}</div>
                        <div style="flex: 1;">
                            <div><strong>${mineral.name}</strong> (${mineral.formula})</div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${mineral.hardness} Mohs ‚Ä¢ ${mineral.color}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            preview.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div style="font-size: 3rem;">üìã</div>
                        <div>
                            <h3 style="margin: 0; color: var(--primary);">${report.title}</h3>
                            <div style="color: #666; font-size: 0.9rem;">
                                ${new Date(report.date).toLocaleDateString()} ‚Ä¢ ${report.minerals.length} minerales
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <strong>Resumen</strong><br>
                            <div style="margin-top: 10px;">
                                <div>üìÖ ${new Date(report.date).toLocaleDateString()}</div>
                                <div>üíé ${report.minerals.length} minerales</div>
                                <div>üìç ${report.mapMarkers} puntos en mapa</div>
                                <div>üß≠ Br√∫jula: ${report.compassHeading}</div>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <strong>Ubicaci√≥n</strong><br>
                            ${report.gpsData ? `
                                <div style="margin-top: 10px;">
                                    <div>Lat: ${report.gpsData.latitude.toFixed(6)}</div>
                                    <div>Lon: ${report.gpsData.longitude.toFixed(6)}</div>
                                    <div>Precisi√≥n: ${report.gpsData.accuracy.toFixed(1)}m</div>
                                </div>
                            ` : '<div style="margin-top: 10px; color: #666;">Sin datos GPS</div>'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Minerales identificados:</strong>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                            ${mineralsHTML}
                            ${report.minerals.length > 5 ? 
                                `<div style="text-align: center; padding: 10px; color: #666; font-size: 0.9rem;">
                                    ... y ${report.minerals.length - 5} m√°s
                                </div>` : ''}
                        </div>
                    </div>
                    
                    <div style="padding: 15px; background: #e8f4fc; border-radius: 10px; margin-bottom: 20px;">
                        <strong>Observaciones:</strong><br>
                        <p style="margin-top: 10px;">${report.notes}</p>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="btn btn-success" onclick="downloadReport(${report.id})" style="flex: 1;">
                            <i class="fas fa-download"></i> Descargar PDF
                        </button>
                        <button class="btn btn-primary" onclick="printReport(${report.id})" style="flex: 1;">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
            `;
        }
        
        function exportCollection() {
            if (identifiedMinerals.length === 0) {
                showNotification('No hay minerales para exportar', 'warning');
                return;
            }
            
            const data = {
                app: 'AtacamApp',
                version: '2.0',
                exportDate: new Date().toISOString(),
                minerals: identifiedMinerals,
                summary: {
                    total: identifiedMinerals.length,
                    unique: [...new Set(identifiedMinerals.map(m => m.name))].length,
                    dateRange: {
                        first: identifiedMinerals[identifiedMinerals.length - 1]?.timestamp,
                        last: identifiedMinerals[0]?.timestamp
                    }
                }
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `atacamapp_coleccion_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('üì§ Colecci√≥n exportada como JSON', 'success');
        }
        
        function clearCollection() {
            if (identifiedMinerals.length === 0) return;
            
            if (confirm('¬øEst√°s seguro de eliminar TODOS los minerales identificados?\nEsta acci√≥n no se puede deshacer.')) {
                identifiedMinerals = [];
                geologicalMarkers.forEach(marker => marker.remove());
                geologicalMarkers = [];
                
                updateMineralsGrid();
                saveToLocalStorage();
                
                showNotification('üóëÔ∏è Colecci√≥n eliminada', 'info');
            }
        }

        // ============================================
        // FUNCIONES DE UTILIDAD GENERAL
        // ============================================
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = 'info-circle';
            let bgColor = '#3498db';
            let emoji = '‚ÑπÔ∏è';
            
            switch(type) {
                case 'success':
                    icon = 'check-circle';
                    bgColor = '#27ae60';
                    emoji = '‚úÖ';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    bgColor = '#e74c3c';
                    emoji = '‚ùå';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    bgColor = '#f39c12';
                    emoji = '‚ö†Ô∏è';
                    break;
                case 'info':
                    emoji = '‚ÑπÔ∏è';
                    break;
            }
            
            notification.innerHTML = `
                <div style="font-size: 1.8rem;">${emoji}</div>
                <div style="flex: 1;">${message}</div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">√ó</button>
            `;
            notification.style.background = bgColor;
            
            // Agregar al documento
            document.body.appendChild(notification);
            
            // Eliminar notificaciones anteriores
            const notifications = document.querySelectorAll('.notification');
            if (notifications.length > 3) {
                notifications[0].remove();
            }
            
            // Eliminar despu√©s de 5 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transition = 'opacity 0.3s';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentElement) notification.remove();
                    }, 300);
                }
            }, 5000);
        }
        
        function openModal(title, content) {
            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 20px;
                backdrop-filter: blur(5px);
            `;
            
            const modalBox = document.createElement('div');
            modalBox.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 0;
                max-width: 600px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                border: 3px solid var(--primary);
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: modalIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            // Animaci√≥n de entrada
            const style = document.createElement('style');
            style.textContent = `
                @keyframes modalIn {
                    from { transform: scale(0.8) translateY(50px); opacity: 0; }
                    to { transform: scale(1) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            modalBox.innerHTML = `
                <div style="padding: 25px; border-bottom: 3px solid var(--light); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: var(--secondary); display: flex; align-items: center; gap: 10px;">
                        ${title}
                    </h2>
                    <button onclick="closeModal()" style="background: none; border: none; font-size: 2rem; color: var(--secondary); cursor: pointer;">√ó</button>
                </div>
                <div>${content}</div>
            `;
            
            modal.appendChild(modalBox);
            document.body.appendChild(modal);
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // Tecla Escape
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') closeModal();
            };
            document.addEventListener('keydown', closeOnEscape);
            
            // Guardar referencia para limpiar
            modal._closeOnEscape = closeOnEscape;
        }
        
        function closeModal() {
            const modal = document.querySelector('div[style*="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);"]');
            if (modal) {
                if (modal._closeOnEscape) {
                    document.removeEventListener('keydown', modal._closeOnEscape);
                }
                document.body.removeChild(modal);
            }
        }
        
        function openTool(tool) {
            let content = '';
            let title = '';
            let emoji = '‚öíÔ∏è';
            
            switch(tool) {
                case 'mohs':
                    title = 'Escala de Mohs';
                    emoji = 'üíé';
                    content = generateMohsContent();
                    break;
                case 'streak':
                    title = 'Colores de Raya';
                    emoji = 'üé®';
                    content = generateStreakContent();
                    break;
                case 'magnetism':
                    title = 'Propiedades Magn√©ticas';
                    emoji = 'üß≤';
                    content = generateMagnetismContent();
                    break;
                case 'fracture':
                    title = 'Tipos de Fractura';
                    emoji = '‚ö°';
                    content = generateFractureContent();
                    break;
                case 'calculator':
                    title = 'Calculadora Geol√≥gica';
                    emoji = 'üßÆ';
                    content = generateCalculatorContent();
                    break;
                case 'weather':
                    title = 'Clima - Regi√≥n de Atacama';
                    emoji = 'üå§Ô∏è';
                    content = generateWeatherContent();
                    break;
            }
            
            openModal(`${emoji} ${title}`, content);
        }
        
        function generateMohsContent() {
            const mohsScale = [
                { level: 1, mineral: "Talco", test: "Se raya con la u√±a", emoji: "üíÖ" },
                { level: 2, mineral: "Yeso", test: "Se raya con la u√±a", emoji: "‚úèÔ∏è" },
                { level: 3, mineral: "Calcita", test: "Se raya con moneda de cobre", emoji: "ü™ô" },
                { level: 4, mineral: "Fluorita", test: "Se raya con un cuchillo", emoji: "üî™" },
                { level: 5, mineral: "Apatito", test: "Se raya con un cuchillo", emoji: "üî™" },
                { level: 6, mineral: "Ortosa", test: "Raya al vidrio", emoji: "ü•É" },
                { level: 7, mineral: "Cuarzo", test: "Raya al vidrio f√°cilmente", emoji: "üíé" },
                { level: 8, mineral: "Topacio", test: "Raya al cuarzo", emoji: "üí†" },
                { level: 9, mineral: "Corind√≥n", test: "Raya al topacio", emoji: "üî∑" },
                { level: 10, mineral: "Diamante", test: "El m√°s duro - Rayado solo por otro diamante", emoji: "üíç" }
            ];
            
            let html = `<div style="padding: 20px;">`;
            html += `<p style="margin-bottom: 20px; color: #666;">La escala de Mohs mide la resistencia al rayado de los minerales. Cada mineral puede rayar a los que tienen un n√∫mero inferior.</p>`;
            
            mohsScale.forEach(item => {
                const color = item.level <= 3 ? '#f8d7da' : 
                             item.level <= 5 ? '#fff3cd' : 
                             item.level <= 7 ? '#d1ecf1' : 
                             item.level <= 9 ? '#d4edda' : '#cce5ff';
                
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: ${color}; border-radius: 15px; display: flex; align-items: center; gap: 20px; border-left: 5px solid var(--primary);">
                        <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; flex-shrink: 0;">
                            ${item.level}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div style="font-size: 1.5rem;">${item.emoji}</div>
                                <div style="font-weight: bold; font-size: 1.3rem; color: var(--secondary);">${item.mineral}</div>
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">${item.test}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }
        
        function generateStreakContent() {
            const streakColors = [
                { mineral: "Hematita", color: "Rojo cereza", emoji: "üî¥", hex: "#C41E3A" },
                { mineral: "Limonita", color: "Amarillo ocre", emoji: "üü°", hex: "#DFAF2C" },
                { mineral: "Magnetita", color: "Negro", emoji: "‚ö´", hex: "#000000" },
                { mineral: "Galena", color: "Gris plomo", emoji: "üîò", hex: "#7D7D7D" },
                { mineral: "Pirita", color: "Negro verdoso", emoji: "üü¢", hex: "#2E4600" },
                { mineral: "Calcita", color: "Blanco", emoji: "‚ö™", hex: "#FFFFFF" },
                { mineral: "Cuarzo", color: "Blanco", emoji: "‚ö™", hex: "#FFFFFF" },
                { mineral: "Azurita", color: "Azul claro", emoji: "üîµ", hex: "#2A52BE" }
            ];
            
            let html = `<div style="padding: 20px;">`;
            html += `<p style="margin-bottom: 20px; color: #666;">La raya es el color del polvo de un mineral, que se observa al frotarlo sobre una placa de porcelana.</p>`;
            
            streakColors.forEach(item => {
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 15px; display: flex; align-items: center; gap: 20px; border: 2px solid ${item.hex}40;">
                        <div style="background: ${item.hex}; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; flex-shrink: 0; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                            ${item.emoji}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <div style="font-weight: bold; font-size: 1.2rem; color: var(--secondary);">${item.mineral}</div>
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <strong>Color de raya:</strong> 
                                <span style="color: ${item.hex}; font-weight: bold;">${item.color}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }
        
        function generateWeatherContent() {
            const weatherConditions = [
                { time: "Ahora", temp: "28¬∞C", condition: "Soleado", emoji: "‚òÄÔ∏è" },
                { time: "14:00", temp: "30¬∞C", condition: "Soleado", emoji: "‚òÄÔ∏è" },
                { time: "17:00", temp: "25¬∞C", condition: "Parcialmente nublado", emoji: "‚õÖ" },
                { time: "20:00", temp: "15¬∞C", condition: "Despejado", emoji: "üåô" },
                { time: "Ma√±ana", temp: "12-32¬∞C", condition: "Soleado", emoji: "‚òÄÔ∏è" }
            ];
            
            let html = `<div style="padding: 20px;">`;
            html += `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem;">üèúÔ∏è</div>
                    <h3 style="margin: 10px 0; color: var(--primary);">Clima - Desierto de Atacama</h3>
                    <p style="color: #666;">El desierto m√°s √°rido del mundo ‚Ä¢ Regi√≥n de Antofagasta</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #87ceeb, #f0e68c); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 3rem;">‚òÄÔ∏è</div>
                    <div style="font-size: 2.5rem; font-weight: bold; color: var(--secondary);">28¬∞C</div>
                    <div style="color: #666; margin-top: 5px;">Soleado ‚Ä¢ M√°x: 32¬∞C ‚Ä¢ M√≠n: 12¬∞C</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--secondary); margin-bottom: 10px;">Pron√≥stico</h4>
            `;
            
            weatherConditions.forEach(item => {
                html += `
                    <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: bold; color: var(--secondary);">${item.time}</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 1.5rem;">${item.emoji}</div>
                            <div>${item.condition}</div>
                        </div>
                        <div style="font-weight: bold; color: var(--primary);">${item.temp}</div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="background: #e8f4fc; padding: 15px; border-radius: 10px;">
                    <strong>Recomendaciones para trabajo de campo:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Usar protector solar factor 50+</li>
                        <li>Llevar m√≠nimo 3 litros de agua por persona</li>
                        <li>Usar ropa clara y sombrero de ala ancha</li>
                        <li>Evitar trabajo intenso entre 12:00 y 16:00</li>
                        <li>Las noches pueden ser muy fr√≠as (llevar abrigo)</li>
                    </ul>
                </div>
            </div>
            `;
            
            return html;
        }
        
        function saveToLocalStorage() {
            const data = {
                minerals: identifiedMinerals,
                lastSave: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('atacamapp_data', JSON.stringify(data));
                console.log('üíæ Datos guardados en localStorage');
            } catch (e) {
                console.error('Error guardando en localStorage:', e);
            }
        }
        
        function loadSavedData() {
            try {
                const saved = localStorage.getItem('atacamapp_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    identifiedMinerals = data.minerals || [];
                    
                    if (identifiedMinerals.length > 0) {
                        updateMineralsGrid();
                        showNotification(`üìÇ ${identifiedMinerals.length} minerales cargados de sesi√≥n anterior`, 'info');
                    }
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
            }
        }
        
        function setupEventListeners() {
            // Enter en chat
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Demo r√°pida al inicio
            setTimeout(() => {
                if (identifiedMinerals.length === 0) {
                    // Agregar algunos minerales de ejemplo
                    for (let i = 0; i < 3; i++) {
                        const mineral = {...atacamaMineralsDB[i]};
                        mineral.id = Date.now() + i;
                        mineral.timestamp = new Date().toISOString();
                        mineral.location = {
                            latitude: -27.3667 + (Math.random() - 0.5) * 0.1,
                            longitude: -70.3333 + (Math.random() - 0.5) * 0.1,
                            accuracy: 50,
                            altitude: 1500 + Math.random() * 500
                        };
                        mineral.confidence = (85 + Math.random() * 15).toFixed(1);
                        identifiedMinerals.push(mineral);
                    }
                    updateMineralsGrid();
                }
            }, 2000);
        }
        
        console.log('üöÄ AtacamApp 2.0 - Sistema Geol√≥gico Inteligente Inicializado');
        console.log('üìç GPS: Click en sat√©lite para activar');
        console.log('üì∏ C√°mara: Click en c√°mara para activar');
        console.log('üó∫Ô∏è Mapa 3D: Listo con terreno elevado');
        console.log('ü§ñ Geobot IA: Asistente especializado activo');
        console.log('‚öíÔ∏è Kit de campo completo disponible');
    </script>
</body>
</html>
