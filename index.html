<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AtacamApp - Geolog√≠a 3D & IA</title>
    
    <!-- Meta Tags HTML5 -->
    <meta name="description" content="Aplicaci√≥n de geolog√≠a 3D con IA especializada para an√°lisis geol√≥gico en campo">
    <meta name="keywords" content="geolog√≠a, 3D, IA, mapeo, minerales, rocas, exploraci√≥n">
    <meta name="author" content="AtacamApp Team">
    <meta name="theme-color" content="#4A6FA5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèúÔ∏è</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    
    <style>
        /* Variables CSS - Tema Glassmorphism Desierto */
        :root {
            --primary: #D4A017; /* Oro desierto */
            --primary-dark: #B8860B;
            --primary-light: #FFD700;
            --secondary: #8B4513; /* Tierra desierto */
            --accent: #CD853F; /* Arena */
            --danger: #DC143C;
            --success: #228B22;
            --warning: #FF8C00;
            --info: #4682B4;
            --dark: #2F4F4F;
            --light: rgba(255, 248, 220, 0.9);
            --glass-bg: rgba(255, 248, 220, 0.15);
            --glass-border: rgba(210, 180, 140, 0.2);
            --glass-shadow: 0 8px 32px rgba(139, 69, 19, 0.1);
            --text-primary: #2F4F4F;
            --text-secondary: rgba(47, 79, 79, 0.8);
            --border-radius: 16px;
            --blur: blur(20px);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset y Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #8B7355 0%, #D2B48C 100%);
            color: var(--text-primary);
            line-height: 1.4;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Fondo principal DESIERTO DE ATACAMA */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(139, 115, 85, 0.7), rgba(210, 180, 140, 0.7)),
                url('https://images.unsplash.com/photo-1527482797697-8795b05a13fe?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
        }

        /* Patr√≥n de dunas decorativo */
        body::after {
            content: "";
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background-image: 
                linear-gradient(to top, rgba(139, 115, 85, 0.9), transparent),
                url('https://images.unsplash.com/photo-1542401886-65d6c61db217?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: bottom;
            z-index: -1;
            opacity: 0.8;
        }

        /* Efecto de calor del desierto */
        .heat-wave {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%
            );
            animation: heatWave 4s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes heatWave {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Splash Screen Glassmorphism Desierto */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.9), rgba(139, 69, 19, 0.9));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: var(--text-primary);
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
        }

        .splash-content {
            text-align: center;
            animation: fadeIn 1s ease;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .splash-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(47, 79, 79, 0.2);
            margin: 1.5rem auto;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Main App Container */
        #appContainer {
            display: none;
            min-height: 100vh;
        }

        /* Header Compacto Desierto */
        .app-header {
            background: linear-gradient(rgba(255, 248, 220, 0.9), rgba(255, 248, 220, 0.95));
            padding: 12px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Logo Desierto */
        .app-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-center {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .app-logo {
            font-size: 2.2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .brand-text h1 {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -0.5px;
            text-shadow: 1px 1px 2px rgba(255, 248, 220, 0.3);
        }

        .brand-text small {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Status Bar - Dr. GeoBot */
        .status-bar {
            display: flex;
            justify-content: flex-end;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.1), rgba(139, 69, 19, 0.1));
            border-radius: 12px;
            border: 1.5px solid var(--accent);
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 69, 19, 0.2);
        }

        .status-item.active {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(50, 205, 50, 0.2));
            border-color: var(--success);
        }

        .status-icon {
            font-size: 1.3rem;
        }

        .status-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* GPS Data Bar - Estilo Desierto */
        .gps-data-bar {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 12px 15px;
            margin: 10px 15px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
            font-size: 0.75rem;
        }

        .gps-data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            padding: 0 5px;
            min-width: 0;
        }

        .gps-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .gps-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-shadow: 0 1px 2px rgba(255, 248, 220, 0.3);
        }

        /* Main Content - Desierto */
        .main-content {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Glass Cards Desierto */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius);
            padding: 18px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.05), transparent);
            pointer-events: none;
        }

        .glass-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(139, 69, 19, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1.5px solid var(--glass-border);
        }

        .card-header i {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            text-shadow: 0 1px 2px rgba(255, 248, 220, 0.3);
        }

        /* Map Containers Desierto */
        .map-container {
            width: 100%;
            height: 220px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            position: relative;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.1);
        }

        #map, #map3d {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .map-control-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .map-control-btn:hover {
            background: rgba(212, 160, 23, 0.15);
            transform: scale(1.1);
        }

        /* Quick Actions Desierto */
        .quick-actions {
            display: flex;
            gap: 12px;
            margin-top: 18px;
        }

        .quick-actions .glass-btn {
            flex: 1;
            padding: 14px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Glass Buttons Desierto */
        .glass-btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.2));
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--glass-border);
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .glass-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 160, 23, 0.2), transparent);
            transition: 0.5s;
        }

        .glass-btn:hover::before {
            left: 100%;
        }

        .glass-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.15);
        }

        .glass-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .glass-btn.success {
            background: linear-gradient(135deg, var(--success), #1E7A1E);
            border: none;
            color: white;
        }

        .glass-btn.warning {
            background: linear-gradient(135deg, var(--warning), #E67E22);
            border: none;
            color: white;
        }

        .glass-btn.danger {
            background: linear-gradient(135deg, var(--danger), #B22222);
            border: none;
            color: white;
        }

        /* Camera Container Desierto */
        .camera-container {
            width: 100%;
            height: 200px;
            background: rgba(47, 79, 79, 0.7);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.1);
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        /* Chat Interface Desierto */
        .chat-container {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            height: 260px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .chat-message.ai {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.2), rgba(100, 149, 237, 0.2));
            align-self: flex-start;
            border: 1.5px solid rgba(70, 130, 180, 0.3);
            margin-left: 28px;
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.1);
        }

        .chat-message.ai::before {
            content: "üë®‚Äçüî¨";
            position: absolute;
            left: -28px;
            font-size: 1.3rem;
        }

        .chat-message.user {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(184, 134, 11, 0.2));
            align-self: flex-end;
            border: 1.5px solid rgba(212, 160, 23, 0.3);
            margin-right: 28px;
            box-shadow: 0 4px 12px rgba(212, 160, 23, 0.1);
        }

        .chat-message.user::before {
            content: "üßë‚Äçüíº";
            position: absolute;
            right: -28px;
            font-size: 1.3rem;
        }

        .chat-input-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .glass-input {
            flex: 1;
            padding: 16px 18px;
            border: 1.5px solid var(--glass-border);
            border-radius: 12px;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.15), rgba(210, 180, 140, 0.1));
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-weight: 500;
        }

        .glass-input:focus {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.25), rgba(210, 180, 140, 0.2));
            box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.1);
        }

        .glass-input::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Geology Data Desierto */
        .geology-data {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.15), rgba(139, 69, 19, 0.1));
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
            border-left: 5px solid var(--primary);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        /* Graph Container */
        .graph-container {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
        }

        /* Layers Panel Desierto */
        .layers-panel {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1.5px solid var(--glass-border);
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        /* Tabs Navigation */
        .tabs-navigation {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(30px);
            border-radius: 18px;
            padding: 8px;
            margin: 15px;
            box-shadow: 0 10px 35px rgba(139, 69, 19, 0.2);
            border: 1.5px solid var(--glass-border);
        }

        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            padding: 8px 12px;
            border-radius: 12px;
            transition: var(--transition);
            min-width: 60px;
            position: relative;
            font-weight: 600;
            cursor: pointer;
        }

        .tab-btn span:first-child {
            font-size: 1.4rem;
            margin-bottom: 3px;
        }

        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
        }

        /* Notification Desierto */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(30px);
            padding: 14px 18px;
            border-radius: 14px;
            box-shadow: 0 15px 40px rgba(139, 69, 19, 0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            border: 1.5px solid var(--glass-border);
            border-left: 5px solid var(--success);
            font-size: 0.85rem;
            font-weight: 500;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error { border-left-color: var(--danger); }
        .notification.warning { border-left-color: var(--warning); }
        .notification.info { border-left-color: var(--info); }

        /* Map Legend Desierto */
        .map-legend {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.15));
            backdrop-filter: blur(20px);
            padding: 10px;
            border-radius: 10px;
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            font-size: 0.75rem;
            border: 1.5px solid var(--glass-border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Custom Checkbox Desierto */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.2), rgba(210, 180, 140, 0.1));
            transition: .4s;
            border-radius: 26px;
            border: 1.5px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 2px;
            background: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(139, 69, 19, 0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background: white;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 35px 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .empty-state span:first-child {
            font-size: 2.5rem;
            margin-bottom: 20px;
            display: block;
            opacity: 0.6;
        }

        /* Scrollbar Desierto */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.1));
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(212, 160, 23, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Graph Types Selector */
        .graph-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .graph-type-btn {
            padding: 12px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            border: 1.5px solid var(--glass-border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .graph-type-btn.active {
            background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(139, 69, 19, 0.1));
            border-color: var(--primary);
        }

        /* Route Info Panel */
        .route-info {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.15), rgba(100, 149, 237, 0.1));
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            border: 1.5px solid rgba(70, 130, 180, 0.3);
            display: none;
        }

        /* Mineral Database Grid */
        .mineral-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .mineral-card {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.1), rgba(210, 180, 140, 0.05));
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 10px;
            border: 1.5px solid var(--glass-border);
            text-align: center;
            font-size: 0.75rem;
        }

        /* Responsive Design */
        @media (max-width: 360px) {
            html { font-size: 13px; }
            
            .main-content { padding: 10px; }
            
            .gps-data-bar {
                margin: 8px 10px;
                padding: 10px;
                flex-wrap: wrap;
            }
            
            .gps-data-item {
                flex: 1 0 45%;
                margin-bottom: 10px;
                min-width: 80px;
            }
            
            .map-container { height: 190px; }
            
            .camera-container { height: 170px; }
            
            .chat-container { height: 240px; }
            
            .quick-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) and (min-width: 361px) {
            .gps-data-bar {
                font-size: 0.72rem;
            }
            
            .gps-value {
                font-size: 0.82rem;
            }
        }

        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .map-container { height: 170px; }
            .camera-container { height: 140px; }
            .chat-container { height: 200px; }
            .gps-data-bar { margin: 8px; padding: 10px; }
        }

        /* Cactus decorativo */
        .cactus {
            position: absolute;
            font-size: 1.5rem;
            z-index: 1;
            opacity: 0.7;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .cactus-left {
            bottom: 90px;
            left: 20px;
        }

        .cactus-right {
            bottom: 90px;
            right: 20px;
        }
    </style>
</head>
<body>
    <!-- Efecto de calor del desierto -->
    <div class="heat-wave"></div>
    
    <!-- Cactus decorativos -->
    <div class="cactus cactus-left">üåµ</div>
    <div class="cactus cactus-right">üåµ</div>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="splash-content">
            <div class="splash-icon">üèúÔ∏è</div>
            <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AtacamApp</h1>
            <p style="margin-bottom: 1rem; opacity: 0.9; font-size: 0.95rem; color: var(--text-primary); font-weight: 500;">Geolog√≠a 3D & Proyecci√≥n Estructural</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="loadingText" style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">Inicializando sistema...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <!-- Header Compacto -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-brand">
                    <div class="brand-center">
                        <div class="app-logo">üèúÔ∏è</div>
                        <div class="brand-text">
                            <h1>AtacamApp</h1>
                            <small>Geolog√≠a 3D & IA</small>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-item" id="statusIcon" onclick="toggleDrGeoBot()">
                        <span class="status-icon">ü§ñ</span>
                        <span class="status-value" id="aiStatusValue">OFF</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- GPS Data Bar Compacta -->
        <div class="gps-data-bar" id="gpsDataBar">
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Latitud</div>
                <div class="gps-value" id="latitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üåê</span>Longitud</div>
                <div class="gps-value" id="longitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>‚õ∞Ô∏è</span>Altitud</div>
                <div class="gps-value" id="altitudeValue">--</div>
            </div>
            <div class="gps-data-item">
                <div class="gps-label"><span>üèôÔ∏è</span>Ciudad</div>
                <div class="gps-value" id="cityValue">--</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-navigation">
            <div class="tab-btn active" data-page="dashboard">
                <span>üó∫Ô∏è</span>
                <span>Mapa</span>
            </div>
            <div class="tab-btn" data-page="camera">
                <span>üì∏</span>
                <span>C√°mara</span>
            </div>
            <div class="tab-btn" data-page="graphs">
                <span>üìä</span>
                <span>Gr√°ficos</span>
            </div>
            <div class="tab-btn" data-page="AI">
                <span>ü§ñ</span>
                <span>GeoBot</span>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page 1: Dashboard -->
            <div class="page active" id="pageDashboard">
                <!-- 2D Map Section -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üó∫Ô∏è</span>
                        <h2 class="card-title">Mapa Geol√≥gico Topogr√°fico</h2>
                    </div>
                    
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <button class="map-control-btn" id="mapSatelliteBtn" title="Vista sat√©lite">
                                <span>üõ∞Ô∏è</span>
                            </button>
                            <button class="map-control-btn" id="mapTerrainBtn" title="Vista topogr√°fica">
                                <span>‚õ∞Ô∏è</span>
                            </button>
                            <button class="map-control-btn" id="mapGeologyBtn" title="Capa geol√≥gica">
                                <span>ü™®</span>
                            </button>
                        </div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #D4A017, #8B4513);"></div>
                                <span>Geolog√≠a ü™®</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #DC143C, #8B0000);"></div>
                                <span>Fallas ‚ö°</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #228B22, #006400);"></div>
                                <span>Ruta üìç</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="addPointBtn">
                            <span>üìç</span>
                            Agregar Punto
                        </button>
                        <button class="glass-btn warning" id="markRouteBtn">
                            <span>üîÑ</span>
                            Marcar Ruta
                        </button>
                        <button class="glass-btn success" id="downloadRouteBtn">
                            <span>‚¨áÔ∏è</span>
                            Descargar Ruta
                        </button>
                    </div>

                    <div id="routeInfo" class="route-info">
                        <div class="data-row">
                            <span>Longitud de ruta:</span>
                            <span id="routeLength">0 km</span>
                        </div>
                        <div class="data-row">
                            <span>Puntos de ruta:</span>
                            <span id="routePoints">0</span>
                        </div>
                        <div class="data-row">
                            <span>Elevaci√≥n total:</span>
                            <span id="routeElevation">0 m</span>
                        </div>
                    </div>
                </div>

                <!-- Geology Info - Controlado por IA -->
                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Datos Geol√≥gicos</h2>
                    </div>
                    
                    <div id="geologyInfo" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Activa el GPS para ver datos geol√≥gicos</p>
                            <button class="glass-btn primary" id="askGeologyInfo" style="margin-top: 15px; padding: 10px;">
                                <span>ü§ñ</span>
                                Consultar IA sobre geolog√≠a local
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Camera & Analysis -->
            <div class="page" id="pageCamera">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üì∏</span>
                        <h2 class="card-title">An√°lisis Fotogeol√≥gico</h2>
                    </div>
                    
                    <div class="camera-container">
                        <video id="cameraFeed" autoplay playsinline></video>
                        <div style="position: absolute; bottom: 12px; left: 12px; background: rgba(47, 79, 79, 0.7); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(255, 248, 220, 0.2);">
                            <span id="cameraStatusText" style="color: white; font-size: 0.8rem; font-weight: 500;">
                                <span>üî¥</span> C√°mara inactiva
                            </span>
                        </div>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="camera-controls">
                        <button class="glass-btn primary" id="startCameraBtn">
                            <span>üé•</span>
                            Activar C√°mara
                        </button>
                        <button class="glass-btn warning" id="captureBtn" disabled>
                            <span>üì∏</span>
                            Capturar
                        </button>
                        <button class="glass-btn success" id="analyzeBtn" disabled>
                            <span>ü§ñ</span>
                            Analizar IA
                        </button>
                        <button class="glass-btn danger" id="stopCameraBtn" disabled>
                            <span>‚èπÔ∏è</span>
                            Detener
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Resultados</h2>
                    </div>
                    
                    <div id="analysisResults" class="geology-data">
                        <div class="empty-state">
                            <span>üîç</span>
                            <p>Capture una imagen para analizar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: Graphs -->
            <div class="page" id="pageGraphs">
                <div class="glass-card">
                    <div class="card-header">
                        <span>üìä</span>
                        <h2 class="card-title">Visualizaci√≥n de Datos 2D</h2>
                    </div>
                    
                    <div class="graph-types">
                        <div class="graph-type-btn active" data-graph="bar">
                            <span>üìà</span>
                            <span>Barras</span>
                        </div>
                        <div class="graph-type-btn" data-graph="pie">
                            <span>ü•ß</span>
                            <span>Pastel</span>
                        </div>
                        <div class="graph-type-btn" data-graph="line">
                            <span>üìâ</span>
                            <span>L√≠nea</span>
                        </div>
                        <div class="graph-type-btn" data-graph="scatter">
                            <span>‚ú®</span>
                            <span>Dispersi√≥n</span>
                        </div>
                    </div>
                    
                    <div class="graph-container">
                        <canvas id="mainGraph" class="graph-canvas"></canvas>
                    </div>
                    
                    <div class="layers-panel">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span>üóÇÔ∏è</span> Generar Capas Geol√≥gicas 2D
                        </h3>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem;">‚õ∞Ô∏è</span>
                                <span style="font-weight: 500;">Topograf√≠a</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerTopography" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem;">ü™®</span>
                                <span style="font-weight: 500;">Geolog√≠a Base</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerGeology" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem;">‚ö°</span>
                                <span style="font-weight: 500;">Sistema de Fallas</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="layerFaults">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn primary" id="generateLayers">
                            <span>üîÑ</span>
                            Generar Capas
                        </button>
                        <button class="glass-btn success" id="exportLayersPNG">
                            <span>üíæ</span>
                            Exportar PNG
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üìê</span>
                        <h2 class="card-title">Par√°metros Estructurales</h2>
                    </div>
                    
                    <div id="structuralParams" class="geology-data">
                        <div class="empty-state">
                            <span>üìè</span>
                            <p>Genera capas para ver par√°metros</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: AI Assistant -->
            <div class="page" id="pageAI">
                <div class="glass-card">
                    <div class="card-header">
                        <span>ü§ñ</span>
                        <h2 class="card-title">Dr. GeoBot - DeepSeek IA</h2>
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message ai">
                            <strong>Dr. GeoBot:</strong> ¬°Hola! Soy tu asistente IA especializado en geolog√≠a del Desierto de Atacama, conectado directamente a DeepSeek API. Act√≠valo desde el bot√≥n ü§ñ para comenzar an√°lisis geol√≥gicos avanzados.
                        </div>
                    </div>
                    
                    <div class="chat-input-group">
                        <input type="text" class="glass-input" id="chatInput" 
                               placeholder="Pregunta sobre geolog√≠a, minerales, estructuras...">
                        <button class="glass-btn primary" id="sendMessage" style="width: auto; min-width: 50px; padding: 16px 20px;">
                            <span>‚úàÔ∏è</span>
                        </button>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="glass-btn success" id="analyzeLocation">
                            <span>üìç</span>
                            Analizar Ubicaci√≥n
                        </button>
                        <button class="glass-btn warning" id="identifyMineral">
                            <span>üíé</span>
                            Identificar Mineral
                        </button>
                        <button class="glass-btn info" id="suggestMethodology">
                            <span>üìã</span>
                            Metodolog√≠a
                        </button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span>üíé</span>
                        <h2 class="card-title">Base de Datos Mineral√≥gica (50+ Minerales)</h2>
                    </div>
                    
                    <div class="mineral-grid" id="mineralGrid">
                        <!-- Los minerales se cargar√°n din√°micamente -->
                    </div>
                    
                    <div id="geologyDatabase" class="geology-data" style="margin-top: 15px;">
                        <div class="data-row">
                            <span>Minerales üíé:</span>
                            <span id="mineralCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Rocas ü™®:</span>
                            <span id="rockCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>Localidades üèúÔ∏è:</span>
                            <span id="locationCount">Cargando...</span>
                        </div>
                        <div class="data-row">
                            <span>IA Status ü§ñ:</span>
                            <span id="aiActiveStatus">Inactiva</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <span id="notificationIcon">‚úÖ</span>
        <span id="notificationText">Mensaje de notificaci√≥n</span>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN - DEEPSEEK API
        // ============================================
        const CONFIG = {
            MAPBOX_TOKEN: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA',
            DEEPSEEK_API_KEY: 'sk-2f64faf4b77344959d768c9e7caf39fb',
            DEEPSEEK_API_URL: 'https://api.deepseek.com/v1/chat/completions',
            DEFAULT_LOCATION: {
                lat: -27.3667,
                lng: -70.3333,
                zoom: 10
            },
            MAP_LAYERS: {
                topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                geology: 'https://tiles.arcgis.com/tiles/nGt4QxSblgDfeJn9/arcgis/rest/services/Global_Geology/MapServer/tile/{z}/{y}/{x}'
            }
        };

        // Variables globales
        let map = null;
        let currentLocation = null;
        let cameraStream = null;
        let isCameraActive = false;
        let currentPhoto = null;
        let markersLayer = null;
        let isDrGeoBotActive = false;
        let chatHistory = [];
        let routePoints = [];
        let routePolyline = null;
        let currentGraph = null;
        let currentGraphType = 'bar';

        // ============================================
        // BASE DE DATOS MINERALES AMPLIADA (50+ Minerales)
        // ============================================
        const MINERAL_DATABASE = {
            "Regi√≥n de Antofagasta": {
                minerals: [
                    { name: "Calcopirita", formula: "CuFeS‚ÇÇ", emoji: "üíé", color: "Amarillo lat√≥n", hardness: "3.5-4", uses: "Principal mineral de cobre", yacimientos: ["Chuquicamata", "Escondida", "Cerro Negro"] },
                    { name: "Atacamita", formula: "Cu‚ÇÇCl(OH)‚ÇÉ", emoji: "üíö", color: "Verde esmeralda", hardness: "3-3.5", uses: "Mineral secundario de cobre", yacimientos: ["Salar de Atacama", "Cerro Pintado"] },
                    { name: "Clorargirita", formula: "AgCl", emoji: "‚ö™", color: "Gris a incoloro", hardness: "2.5", uses: "Mineral de plata", yacimientos: ["Caracoles", "Sierra Gorda"] },
                    { name: "Hematita", formula: "Fe‚ÇÇO‚ÇÉ", emoji: "üî¥", color: "Rojo a negro", hardness: "5.5-6.5", uses: "Mineral de hierro", yacimientos: ["Cerro Im√°n", "Sierra Gorda"] },
                    { name: "Cuarzo", formula: "SiO‚ÇÇ", emoji: "üî∂", color: "Variable", hardness: "7", uses: "Electr√≥nica, √≥ptica", yacimientos: ["Todas las localidades"] },
                    { name: "Calcosina", formula: "Cu‚ÇÇS", emoji: "‚ö´", color: "Negro plomizo", hardness: "2.5-3", uses: "Mineral de cobre", yacimientos: ["Chuquicamata", "El Salvador"] },
                    { name: "Bornita", formula: "Cu‚ÇÖFeS‚ÇÑ", emoji: "üü£", color: "P√∫rpura iridiscente", hardness: "3", uses: "Mineral de cobre", yacimientos: ["Escondida", "Zaldivar"] },
                    { name: "Malaquita", formula: "Cu‚ÇÇCO‚ÇÉ(OH)‚ÇÇ", emoji: "üíö", color: "Verde", hardness: "3.5-4", uses: "Piedra ornamental", yacimientos: ["Cerro Blanco"] },
                    { name: "Azurita", formula: "Cu‚ÇÉ(CO‚ÇÉ)‚ÇÇ(OH)‚ÇÇ", emoji: "üíô", color: "Azul intenso", hardness: "3.5-4", uses: "Mineral ornamental", yacimientos: ["Cerro Im√°n"] },
                    { name: "Crisocola", formula: "(Cu,Al)‚ÇÇH‚ÇÇSi‚ÇÇO‚ÇÖ(OH)‚ÇÑ¬∑nH‚ÇÇO", emoji: "üîµ", color: "Azul verdoso", hardness: "2-4", uses: "Mineral de cobre", yacimientos: ["Chuquicamata"] },
                    { name: "Tenorita", formula: "CuO", emoji: "‚ö´", color: "Negro", hardness: "3.5", uses: "Mineral de cobre", yacimientos: ["Mina Sur"] },
                    { name: "Covelina", formula: "CuS", emoji: "üî∑", color: "Azul √≠ndigo", hardness: "1.5-2", uses: "Mineral de cobre", yacimientos: ["El Salvador"] },
                    { name: "Pirita", formula: "FeS‚ÇÇ", emoji: "‚≠ê", color: "Dorado p√°lido", hardness: "6-6.5", uses: "Azufre, joyer√≠a", yacimientos: ["Todas las minas"] },
                    { name: "Galena", formula: "PbS", emoji: "üîò", color: "Gris plomo", hardness: "2.5", uses: "Mineral de plomo", yacimientos: ["Caracoles"] },
                    { name: "Esfalerita", formula: "ZnS", emoji: "üü°", color: "Marr√≥n a negro", hardness: "3.5-4", uses: "Mineral de zinc", yacimientos: ["Sierra Gorda"] },
                    { name: "Anglesita", formula: "PbSO‚ÇÑ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2.5-3", uses: "Mineral de plomo", yacimientos: ["Caracoles"] },
                    { name: "Cerusita", formula: "PbCO‚ÇÉ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3-3.5", uses: "Mineral de plomo", yacimientos: ["Caracoles"] },
                    { name: "Wulfenita", formula: "PbMoO‚ÇÑ", emoji: "üü†", color: "Naranja a rojo", hardness: "2.5-3", uses: "Mineral de molibdeno", yacimientos: ["Cerro Negro"] },
                    { name: "Vanadinita", formula: "Pb‚ÇÖ(VO‚ÇÑ)‚ÇÉCl", emoji: "üî¥", color: "Rojo a naranja", hardness: "2.5-3", uses: "Mineral de vanadio", yacimientos: ["Cerro Negro"] },
                    { name: "Baritina", formula: "BaSO‚ÇÑ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3-3.5", uses: "Perforaci√≥n petrolera", yacimientos: ["Sierra Gorda"] },
                    { name: "Yeso", formula: "CaSO‚ÇÑ¬∑2H‚ÇÇO", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2", uses: "Construcci√≥n", yacimientos: ["Salar de Atacama"] },
                    { name: "Anhidrita", formula: "CaSO‚ÇÑ", emoji: "‚ö™", color: "Incoloro a azul", hardness: "3-3.5", uses: "Construcci√≥n", yacimientos: ["Salar de Atacama"] },
                    { name: "Halita", formula: "NaCl", emoji: "üßÇ", color: "Incoloro a blanco", hardness: "2.5", uses: "Sal de roca", yacimientos: ["Salar de Atacama"] },
                    { name: "Silvina", formula: "KCl", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "2", uses: "Fertilizante", yacimientos: ["Salar de Atacama"] },
                    { name: "Carnalita", formula: "KMgCl‚ÇÉ¬∑6H‚ÇÇO", emoji: "‚ö™", color: "Incoloro a rojo", hardness: "2.5", uses: "Fertilizante", yacimientos: ["Salar de Atacama"] }
                ],
                localities: ["Chuquicamata", "Escondida", "Cerro Negro", "Salar de Atacama", "Sierra Gorda", "Caracoles", "El Salvador", "Zaldivar", "Cerro Blanco", "Cerro Im√°n", "Mina Sur"]
            },
            "Regi√≥n de Atacama": {
                minerals: [
                    { name: "Epidota", formula: "Ca‚ÇÇAl‚ÇÇ(Fe¬≥‚Å∫,Al)(SiO‚ÇÑ)(Si‚ÇÇO‚Çá)O(OH)", emoji: "üíö", color: "Verde pistacho", hardness: "6-7", uses: "Mineral √≠ndice metam√≥rfico", yacimientos: ["Cerro Blanco", "Cerro Negro"] },
                    { name: "Clorita", formula: "(Mg,Fe)‚ÇÉ(Si,Al)‚ÇÑO‚ÇÅ‚ÇÄ(OH)‚ÇÇ¬∑(Mg,Fe)‚ÇÉ(OH)‚ÇÜ", emoji: "üíö", color: "Verde", hardness: "2-2.5", uses: "Alteraci√≥n hidrotermal", yacimientos: ["Pampa Larga", "Cerro Blanco"] },
                    { name: "Actinolita", formula: "Ca‚ÇÇ(Mg,Fe)‚ÇÖSi‚ÇàO‚ÇÇ‚ÇÇ(OH)‚ÇÇ", emoji: "üíö", color: "Verde", hardness: "5-6", uses: "Mineral metam√≥rfico", yacimientos: ["Cerro Blanco"] },
                    { name: "Tremolita", formula: "Ca‚ÇÇMg‚ÇÖSi‚ÇàO‚ÇÇ‚ÇÇ(OH)‚ÇÇ", emoji: "‚ö™", color: "Blanco a gris", hardness: "5-6", uses: "Mineral metam√≥rfico", yacimientos: ["Cerro Blanco"] },
                    { name: "Granate", formula: "X‚ÇÉY‚ÇÇ(SiO‚ÇÑ)‚ÇÉ", emoji: "üî¥", color: "Rojo a marr√≥n", hardness: "6.5-7.5", uses: "Abrasivo, joyer√≠a", yacimientos: ["Cerro Negro"] },
                    { name: "Estaurolita", formula: "Fe¬≤‚Å∫‚ÇÇAl‚ÇâO‚ÇÜ(SiO‚ÇÑ)‚ÇÑ(O,OH)‚ÇÇ", emoji: "üü§", color: "Marr√≥n rojizo", hardness: "7-7.5", uses: "Mineral √≠ndice", yacimientos: ["Cerro Negro"] },
                    { name: "Cianita", formula: "Al‚ÇÇSiO‚ÇÖ", emoji: "üîµ", color: "Azul", hardness: "4.5-7", uses: "Cer√°mica", yacimientos: ["Cerro Negro"] },
                    { name: "Andalucita", formula: "Al‚ÇÇSiO‚ÇÖ", emoji: "üü£", color: "Rosa a marr√≥n", hardness: "6.5-7.5", uses: "Refractarios", yacimientos: ["Cerro Negro"] },
                    { name: "Sillimanita", formula: "Al‚ÇÇSiO‚ÇÖ", emoji: "‚ö™", color: "Blanco a marr√≥n", hardness: "6.5-7.5", uses: "Refractarios", yacimientos: ["Cerro Negro"] },
                    { name: "Turmalina", formula: "Na(Li,Al)‚ÇÉAl‚ÇÜ(BO‚ÇÉ)‚ÇÉSi‚ÇÜO‚ÇÅ‚Çà(OH)‚ÇÑ", emoji: "üåà", color: "Variable", hardness: "7-7.5", uses: "Joyer√≠a", yacimientos: ["Cerro Blanco"] },
                    { name: "Berilo", formula: "Be‚ÇÉAl‚ÇÇSi‚ÇÜO‚ÇÅ‚Çà", emoji: "üíé", color: "Variable", hardness: "7.5-8", uses: "Joyer√≠a (esmeralda)", yacimientos: ["Pampa Larga"] },
                    { name: "Topacio", formula: "Al‚ÇÇSiO‚ÇÑ(F,OH)‚ÇÇ", emoji: "üíé", color: "Incoloro a azul", hardness: "8", uses: "Joyer√≠a", yacimientos: ["Cerro Blanco"] },
                    { name: "Apatito", formula: "Ca‚ÇÖ(PO‚ÇÑ)‚ÇÉ(F,Cl,OH)", emoji: "üíö", color: "Verde a azul", hardness: "5", uses: "Fertilizante", yacimientos: ["Cerro Negro"] },
                    { name: "Fluorita", formula: "CaF‚ÇÇ", emoji: "üíú", color: "Variable", hardness: "4", uses: "Fundente, √≥ptica", yacimientos: ["Cerro Blanco"] },
                    { name: "Calcita", formula: "CaCO‚ÇÉ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3", uses: "Construcci√≥n", yacimientos: ["Todas las localidades"] },
                    { name: "Dolomita", formula: "CaMg(CO‚ÇÉ)‚ÇÇ", emoji: "‚ö™", color: "Blanco a rosa", hardness: "3.5-4", uses: "Construcci√≥n", yacimientos: ["Cerro Blanco"] },
                    { name: "Siderita", formula: "FeCO‚ÇÉ", emoji: "üü§", color: "Marr√≥n", hardness: "3.5-4.5", uses: "Mineral de hierro", yacimientos: ["Cerro Im√°n"] },
                    { name: "Rodocrosita", formula: "MnCO‚ÇÉ", emoji: "üíñ", color: "Rosa a rojo", hardness: "3.5-4.5", uses: "Mineral de manganeso", yacimientos: ["Cerro Negro"] },
                    { name: "Smithsonita", formula: "ZnCO‚ÇÉ", emoji: "üíö", color: "Verde a azul", hardness: "4-4.5", uses: "Mineral de zinc", yacimientos: ["Pampa Larga"] },
                    { name: "Cerusita", formula: "PbCO‚ÇÉ", emoji: "‚ö™", color: "Incoloro a blanco", hardness: "3-3.5", uses: "Mineral de plomo", yacimientos: ["Caracoles"] },
                    { name: "Wulfenita", formula: "PbMoO‚ÇÑ", emoji: "üü†", color: "Naranja a rojo", hardness: "2.5-3", uses: "Mineral de molibdeno", yacimientos: ["Cerro Negro"] },
                    { name: "Pirolusita", formula: "MnO‚ÇÇ", emoji: "‚ö´", color: "Negro", hardness: "6-6.5", uses: "Mineral de manganeso", yacimientos: ["Cerro Negro"] },
                    { name: "Psilomelana", formula: "(Ba,H‚ÇÇO)‚ÇÇMn‚ÇÖO‚ÇÅ‚ÇÄ", emoji: "‚ö´", color: "Negro", hardness: "5-6", uses: "Mineral de manganeso", yacimientos: ["Cerro Negro"] },
                    { name: "Cromita", formula: "FeCr‚ÇÇO‚ÇÑ", emoji: "‚ö´", color: "Negro", hardness: "5.5", uses: "Mineral de cromo", yacimientos: ["Cerro Negro"] },
                    { name: "Ilmenita", formula: "FeTiO‚ÇÉ", emoji: "‚ö´", color: "Negro", hardness: "5-6", uses: "Mineral de titanio", yacimientos: ["Cerro Blanco"] }
                ],
                localities: ["Copiap√≥", "Vallenar", "Cerro Blanco", "Cerro Negro", "Salar de Pedernales", "Pampa Larga", "Cerro Im√°n", "Caracoles"]
            }
        };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üèúÔ∏è AtacamApp - Iniciando aplicaci√≥n...');
            simulateLoading();
            
            // Inicializar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Cargar datos de minerales
            loadMineralDatabase();
        });

        function simulateLoading() {
            let progress = 0;
            const messages = [
                'Conectando con DeepSeek AI... ü§ñ',
                'Cargando base de 50+ minerales Atacama... üíé',
                'Configurando mapas topogr√°ficos... üó∫Ô∏è',
                'Inicializando Dr. GeoBot... üë®‚Äçüî¨',
                '¬°Listo para explorar! üèúÔ∏è'
            ];
            
            const interval = setInterval(() => {
                progress += 20;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('loadingText').textContent = messages[progress / 20 - 1];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('splashScreen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('splashScreen').style.display = 'none';
                            document.getElementById('appContainer').style.display = 'block';
                            initializeApp();
                        }, 500);
                    }, 500);
                }
            }, 400);
        }

        function loadMineralDatabase() {
            console.log('‚úÖ Base de datos de 50+ minerales del Desierto de Atacama cargada');
        }

        function initializeApp() {
            console.log('‚úÖ AtacamApp inicializada');
            
            // Configurar navegaci√≥n por tabs
            setupTabsNavigation();
            
            // Inicializar componentes
            init2DMap();
            initGraphs();
            
            // Configurar eventos
            setupEventListeners();
            
            // Solicitar permisos
            requestPermissions();
            
            // Actualizar estado inicial
            updateStatusIcon(false);
            updateDatabaseCounts();
            loadMineralGrid();
            
            showNotification('¬°Bienvenido al Desierto de Atacama! üèúÔ∏è', 'success');
            
            // Mensaje inicial del Dr. GeoBot
            setTimeout(() => {
                addMessageToChat('ai', `üë®‚Äçüî¨ <strong>Dr. GeoBot - Sistema IA de Geolog√≠a:</strong><br><br>
                ¬°Hola! Soy Dr. GeoBot, tu asistente IA especializado en geolog√≠a del Desierto de Atacama.<br><br>
                <strong>Conectado a DeepSeek API ‚úÖ</strong><br>
                <strong>Base de datos:</strong> ${countMinerals()} minerales registrados<br>
                <strong>Regiones:</strong> Antofagasta y Atacama<br><br>
                <em>Activa el bot√≥n ü§ñ en el header para comenzar</em>`);
            }, 1000);
        }

        // ============================================
        // DR. GEOBOT - DEEPSEEK AI
        // ============================================
        function toggleDrGeoBot() {
            isDrGeoBotActive = !isDrGeoBotActive;
            updateStatusIcon(isDrGeoBotActive);
            
            if (isDrGeoBotActive) {
                showNotification('Dr. GeoBot ACTIVADO con DeepSeek AI ü§ñ', 'success');
                document.getElementById('aiActiveStatus').textContent = 'Activa';
                document.getElementById('aiActiveStatus').style.color = '#228B22';
                
                addMessageToChat('ai', `<strong>ü§ñ DR. GEOBOT ACTIVADO:</strong><br><br>
                <strong>‚úÖ Conectado a DeepSeek API v√≠a sk-2f64faf4b77344959d768c9e7caf39fb</strong><br>
                <strong>üìç Acceso a ubicaci√≥n GPS:</strong> ${currentLocation ? 'Conectado' : 'Esperando'}<br>
                <strong>üíé Base de datos:</strong> ${countMinerals()} minerales<br>
                <strong>üó∫Ô∏è Mapas:</strong> Topogr√°fico y geol√≥gico<br><br>
                <strong>¬øEn qu√© puedo ayudarte?</strong><br>
                ‚Ä¢ Identificaci√≥n de minerales/rocas<br>
                ‚Ä¢ An√°lisis estructural preciso<br>
                ‚Ä¢ Interpretaci√≥n geol√≥gica verificada<br>
                ‚Ä¢ M√©todos de campo espec√≠ficos<br>
                ‚Ä¢ Proyecciones y an√°lisis`);
                
                // Cambiar a p√°gina de IA
                if (!document.getElementById('pageAI').classList.contains('active')) {
                    switchPage('AI');
                }
            } else {
                showNotification('Dr. GeoBot DESACTIVADO ‚èπÔ∏è', 'warning');
                document.getElementById('aiActiveStatus').textContent = 'Inactiva';
                document.getElementById('aiActiveStatus').style.color = '#DC143C';
            }
        }

        function updateStatusIcon(active) {
            const statusIcon = document.getElementById('statusIcon');
            const aiStatusValue = document.getElementById('aiStatusValue');
            
            if (active) {
                statusIcon.classList.add('active');
                statusIcon.style.background = 'linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(50, 205, 50, 0.2))';
                statusIcon.style.borderColor = '#228B22';
                aiStatusValue.textContent = 'ON';
                aiStatusValue.style.color = '#228B22';
            } else {
                statusIcon.classList.remove('active');
                statusIcon.style.background = 'linear-gradient(135deg, rgba(212, 160, 23, 0.1), rgba(139, 69, 19, 0.1))';
                statusIcon.style.borderColor = 'var(--accent)';
                aiStatusValue.textContent = 'OFF';
                aiStatusValue.style.color = 'var(--text-primary)';
            }
        }

        async function sendMessageToAI() {
            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            input.focus();

            const thinkingId = addMessageToChat('ai', 'Procesando con DeepSeek AI... üîç');

            try {
                const response = await callDeepSeekAPI(message);
                updateMessage(thinkingId, response);
                
                // Guardar en historial
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: response });
                
                // Limitar historial a √∫ltimos 10 mensajes
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
            } catch (error) {
                console.error('Error con DeepSeek:', error);
                updateMessage(thinkingId, generateLocalResponse(message));
            }
        }

        async function callDeepSeekAPI(prompt) {
            const context = buildGeologyContext();
            
            const messages = [
                {
                    role: "system",
                    content: `Eres Dr. GeoBot, un ge√≥logo experto especializado en el Desierto de Atacama, Chile. 
                    Eres parte de la aplicaci√≥n AtacamApp. Responde en espa√±ol, con emojis relevantes y formato claro.
                    Usa markdown b√°sico para formato. S√© t√©cnico pero accesible. 
                    Proporciona informaci√≥n precisa y verificada sobre geolog√≠a, minerales y estructuras.
                    Si no est√°s seguro de algo, recon√≥celo y sugiere consultar otras fuentes.`
                },
                ...chatHistory.slice(-8),
                {
                    role: "user",
                    content: `${context}\n\nPregunta del usuario: ${prompt}`
                }
            ];

            const response = await fetch(CONFIG.DEEPSEEK_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: messages,
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function buildGeologyContext() {
            let context = `CONTEXTO ACTUAL ATACAMAPP:\n\n`;
            
            if (currentLocation) {
                context += `üìå UBICACI√ìN ACTUAL:\n`;
                context += `- Coordenadas: ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞\n`;
                context += `- Altitud: ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Desconocida'}\n`;
                context += `- Precisi√≥n: ${Math.round(currentLocation.accuracy)}m\n`;
                context += `- Regi√≥n: ${getRegionFromLocation()}\n`;
                context += `- Ciudad m√°s cercana: ${document.getElementById('cityValue').textContent}\n\n`;
            }
            
            context += `üíé BASE DE DATOS MINERAL√ìGICA (50+ minerales):\n`;
            context += `- Total minerales: ${countMinerals()}\n`;
            context += `- Regiones: Antofagasta, Atacama\n`;
            context += `- Minerales principales: Calcopirita, Atacamita, Hematita, Cuarzo, Epidota\n`;
            context += `- Yacimientos importantes: Chuquicamata, Escondida, Cerro Blanco, Cerro Negro\n\n`;
            
            context += `üó∫Ô∏è HERRAMIENTAS DISPONIBLES:\n`;
            context += `- Mapa geol√≥gico 2D con capas topogr√°ficas\n`;
            context += `- An√°lisis fotogeol√≥gico con c√°mara\n`;
            context += `- 4 tipos de gr√°ficos (barras, pastel, l√≠nea, dispersi√≥n)\n`;
            context += `- Generaci√≥n y exportaci√≥n de capas geol√≥gicas en PNG\n`;
            context += `- Sistema de ruteo y descarga de rutas\n\n`;
            
            context += `üë®‚Äçüî¨ RECOMENDACIONES GENERALES PARA ATACAMA:\n`;
            context += `- El Desierto de Atacama es el m√°s √°rido del mundo\n`;
            context += `- Rico en minerales de cobre (principalmente calcopirita)\n`;
            context += `- Sistemas de fallas NNE-SSO predominantes\n`;
            context += `- Actividad minera extensa (mayor productor mundial de cobre)\n`;
            context += `- Clima √°rido extremo, tomar precauciones de hidrataci√≥n\n`;
            context += `- Altitud variable (0-6000+ m.s.n.m.)`;
            
            return context;
        }

        function generateLocalResponse(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            
            if (lowerPrompt.includes('mineral') || lowerPrompt.includes('roca') || lowerPrompt.includes('identificar')) {
                return generateMineralResponse();
            }
            
            if (lowerPrompt.includes('estructura') || lowerPrompt.includes('falla') || lowerPrompt.includes('buzamiento')) {
                return generateStructureResponse();
            }
            
            if (lowerPrompt.includes('mapa') || lowerPrompt.includes('ubicaci√≥n') || lowerPrompt.includes('localizaci√≥n')) {
                return generateLocationResponse();
            }
            
            if (lowerPrompt.includes('m√©todo') || lowerPrompt.includes('metodolog√≠a') || lowerPrompt.includes('campo')) {
                return generateMethodologyResponse();
            }
            
            return `üë®‚Äçüî¨ <strong>Dr. GeoBot:</strong><br><br>
            Como ge√≥logo especializado en el Desierto de Atacama, puedo ayudarte con an√°lisis precisos de:<br><br>
            ‚Ä¢ <strong>üíé Identificaci√≥n mineral√≥gica</strong> (50+ minerales en base de datos)<br>
            ‚Ä¢ <strong>‚ö° An√°lisis estructural verificado</strong><br>
            ‚Ä¢ <strong>üó∫Ô∏è Interpretaci√≥n de mapas topogr√°ficos</strong><br>
            ‚Ä¢ <strong>üì∏ An√°lisis fotogeol√≥gico</strong><br>
            ‚Ä¢ <strong>üìä Interpretaci√≥n de gr√°ficos</strong><br><br>
            <em>Prueba preguntando sobre minerales espec√≠ficos o an√°lisis de estructuras.</em>`;
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function generateMineralResponse() {
            const region = getRegionFromLocation();
            const regionData = MINERAL_DATABASE[region];
            
            if (regionData) {
                let response = `<strong>üîç AN√ÅLISIS MINERAL√ìGICO - ${region}:</strong><br><br>`;
                response += `<strong>Minerales principales (${regionData.minerals.length} en base de datos):</strong><br><br>`;
                
                // Seleccionar 5 minerales aleatorios de la regi√≥n
                const shuffled = [...regionData.minerals].sort(() => 0.5 - Math.random());
                const selectedMinerals = shuffled.slice(0, 5);
                
                selectedMinerals.forEach(mineral => {
                    response += `<strong>${mineral.emoji} ${mineral.name}</strong><br>`;
                    response += `‚Ä¢ F√≥rmula: ${mineral.formula}<br>`;
                    response += `‚Ä¢ Color: ${mineral.color}<br>`;
                    response += `‚Ä¢ Dureza: ${mineral.hardness} (Mohs)<br>`;
                    response += `‚Ä¢ Usos: ${mineral.uses}<br>`;
                    response += `‚Ä¢ Yacimientos: ${mineral.yacimientos.slice(0, 3).join(', ')}<br><br>`;
                });
                
                response += `<strong>üéØ Recomendaciones para muestreo:</strong><br>`;
                response += `1. Usa la c√°mara para identificaci√≥n inicial üì∏<br>`;
                response += `2. Toma muestras representativas (500g m√≠nimo) üß™<br>`;
                response += `3. Documenta coordenadas exactas con GPS üìç<br>`;
                response += `4. Registra contexto geol√≥gico del afloramiento üó∫Ô∏è<br><br>`;
                response += `<em>¬øQuieres informaci√≥n espec√≠fica sobre alg√∫n mineral?</em>`;
                
                return response;
            }
            
            return `üíé <strong>MINERALES DEL DESIERTO DE ATACAMA (${countMinerals()} registrados):</strong><br><br>
            Los principales grupos mineral√≥gicos en esta regi√≥n son:<br><br>
            ‚Ä¢ <strong>Sulfuros:</strong> Calcopirita, Bornita, Calcosina, Pirita<br>
            ‚Ä¢ <strong>√ìxidos:</strong> Hematita, Magnetita, Cuarzo<br>
            ‚Ä¢ <strong>Carbonatos:</strong> Malaquita, Azurita, Calcita<br>
            ‚Ä¢ <strong>Silicatos:</strong> Epidota, Clorita, Actinolita<br>
            ‚Ä¢ <strong>Halogenuros:</strong> Atacamita, Clorargirita<br><br>
            <strong>Activa el GPS para ver minerales espec√≠ficos de tu ubicaci√≥n.</strong>`;
        }

        function generateStructureResponse() {
            return `‚ö° <strong>AN√ÅLISIS ESTRUCTURAL - DESIERTO DE ATACAMA:</strong><br><br>
            <strong>Sistemas estructurales principales verificados:</strong><br><br>
            1. <strong>Sistema de Fallas NNE-SSO (Dominante)</strong><br>
            ‚Ä¢ Orientaci√≥n: 10¬∞-30¬∞ con variaciones locales<br>
            ‚Ä¢ Buzamiento: 45¬∞-75¬∞ al este (predominante)<br>
            ‚Ä¢ Longitud: Puede extenderse por 100+ km<br>
            ‚Ä¢ Mineralizaci√≥n: Vetas de Cu-Au y sistemas porf√≠ricos<br><br>
            
            2. <strong>Sistema de Fallas E-O (Secundario)</strong><br>
            ‚Ä¢ Orientaci√≥n: 80¬∞-100¬∞<br>
            ‚Ä¢ Buzamiento: 60¬∞-85¬∞ al norte/sur<br>
            ‚Ä¢ Caracter√≠sticas: Controlan intrusiones menores<br>
            ‚Ä¢ Mineralizaci√≥n: Stockworks de Cu-Mo<br><br>
            
            3. <strong>Sistema de Fallas NW-SE (Transcurrentes)</strong><br>
            ‚Ä¢ Orientaci√≥n: 120¬∞-150¬∞<br>
            ‚Ä¢ Movimiento: Dextral (predominante)<br>
            ‚Ä¢ Relaci√≥n: Controlan dep√≥sitos epitermales<br><br>
            
            <strong>üìê M√©todos de medici√≥n recomendados:</strong><br>
            ‚Ä¢ Br√∫jula geol√≥gica Brunton con clin√≥metro<br>
            ‚Ä¢ Correcci√≥n por declinaci√≥n magn√©tica actual (var√≠a por zona)<br>
            ‚Ä¢ Uso de escala en fotograf√≠as para an√°lisis cuantitativo<br>
            ‚Ä¢ Muestreo orientado para an√°lisis microestructural<br><br>
            
            <strong>üåç Herramientas AtacamApp:</strong><br>
            ‚Ä¢ Usa "Marcar Ruta" para trazar estructuras lineales<br>
            ‚Ä¢ Agrega puntos estructurales en el mapa 2D<br>
            ‚Ä¢ Toma fotos con escala para an√°lisis estructural<br>
            ‚Ä¢ Genera gr√°ficos de orientaci√≥n en la secci√≥n Gr√°ficos`;
        }

        function generateLocationResponse() {
            if (currentLocation) {
                return `üìç <strong>AN√ÅLISIS DE UBICACI√ìN (Verificado por IA):</strong><br><br>
                <strong>Coordenadas exactas:</strong> ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞<br>
                <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm ‚õ∞Ô∏è' : 'Desconocida (estimar 2400m promedio)'}<br>
                <strong>Precisi√≥n GPS:</strong> ${Math.round(currentLocation.accuracy)}m üéØ<br>
                <strong>Regi√≥n geol√≥gica:</strong> ${getRegionFromLocation()}<br>
                <strong>Provincia metalog√©nica:</strong> ${getMetallogenicProvince()}<br>
                <strong>Ciudad m√°s cercana:</strong> ${document.getElementById('cityValue').textContent}<br><br>
                
                <strong>üó∫Ô∏è Contexto geol√≥gico espec√≠fico:</strong><br>
                ‚Ä¢ ${getDetailedGeologicalContext()}<br>
                ‚Ä¢ Edad de rocas: ${getRockAgeEstimate()}<br>
                ‚Ä¢ Tipo de roca predominante: ${getPredominantRockType()}<br>
                ‚Ä¢ Estilo de mineralizaci√≥n esperado: ${getMineralizationStyle()}<br><br>
                
                <strong>üéØ Acciones recomendadas por IA:</strong><br>
                1. Agregar punto geol√≥gico con descripci√≥n detallada<br>
                2. Tomar fotograf√≠as panor√°micas y de detalle<br>
                3. Realizar an√°lisis estructural sistem√°tico<br>
                4. Muestreo representativo de afloramientos<br>
                5. Generar perfil topogr√°fico del √°rea`;
            }
            
            return `üìç <strong>UBICACI√ìN NO DISPONIBLE</strong><br><br>
            Para an√°lisis geol√≥gico preciso, necesito tu ubicaci√≥n GPS:<br><br>
            1. Aseg√∫rate de tener GPS activado en tu dispositivo<br>
            2. Permite acceso a ubicaci√≥n en el navegador<br>
            3. Busca se√±al GPS en √°rea despejada<br><br>
            <em>Con tu ubicaci√≥n puedo proporcionar an√°lisis geol√≥gico espec√≠fico y verificado del √°rea.</em>`;
        }

        function generateMethodologyResponse() {
            return `üìã <strong>METODOLOG√çA DE CAMPO - ATACAMAPP (Verificada):</strong><br><br>
            <strong>1. üó∫Ô∏è Mapeo Geol√≥gico Sistem√°tico:</strong><br>
            ‚Ä¢ GPS de alta precisi√≥n (error < 5m ideal)<br>
            ‚Ä¢ Fotograf√≠a geol√≥gica con escala y br√∫jula<br>
            ‚Ä¢ Descripci√≥n litol√≥gica estandarizada<br>
            ‚Ä¢ Muestreo representativo (roca fresca)<br>
            ‚Ä¢ Registro de estructuras (rumbo/buzamiento)<br><br>
            
            <strong>2. üìê An√°lisis Estructural Cuantitativo:</strong><br>
            ‚Ä¢ Mediciones con br√∫jula Brunton calibrada<br>
            ‚Ä¢ Correcci√≥n por declinaci√≥n magn√©tica actual<br>
            ‚Ä¢ An√°lisis estereogr√°fico (rosa de direcciones)<br>
            ‚Ä¢ Cartograf√≠a de fallas, diaclasas y foliaciones<br>
            ‚Ä¢ Determinaci√≥n de esfuerzos principales<br><br>
            
            <strong>3. üíé Muestreo Mineral√≥gico Protocolizado:</strong><br>
            ‚Ä¢ Muestras de mano (1-2 kg por estaci√≥n)<br>
            ‚Ä¢ Muestras para l√°mina delgada (orientadas)<br>
            ‚Ä¢ Muestras para geoqu√≠mica (contaminaci√≥n cero)<br>
            ‚Ä¢ Documentaci√≥n fotogr√°fica completa (antes/despu√©s)<br>
            ‚Ä¢ Georreferenciaci√≥n precisa (Datum WGS84)<br><br>
            
            <strong>4. ü§ñ An√°lisis con IA - Dr. GeoBot:</strong><br>
            ‚Ä¢ Identificaci√≥n mineral√≥gica asistida<br>
            ‚Ä¢ Clasificaci√≥n automatizada de rocas<br>
            ‚Ä¢ Interpretaci√≥n estructural contextual<br>
            ‚Ä¢ Recomendaciones de muestreo inteligentes<br>
            ‚Ä¢ Control de calidad de datos de campo`;
        }

        function getRegionFromLocation() {
            if (!currentLocation) return "Desierto de Atacama";
            
            const lat = currentLocation.latitude;
            
            if (lat >= -21 && lat <= -25) return "Regi√≥n de Antofagasta";
            if (lat >= -26 && lat <= -30) return "Regi√≥n de Atacama";
            
            return "Desierto de Atacama";
        }

        function getMetallogenicProvince() {
            const lat = currentLocation ? currentLocation.latitude : -27;
            
            if (lat >= -21 && lat <= -23) return "Franja Cupr√≠fera Occidental";
            if (lat >= -24 && lat <= -26) return "Franja Cupr√≠fera Central";
            if (lat >= -27 && lat <= -29) return "Franja Cupr√≠fera Oriental";
            
            return "Provincia Cupr√≠fera Andina";
        }

        function getDetailedGeologicalContext() {
            const region = getRegionFromLocation();
            
            if (region === "Regi√≥n de Antofagasta") {
                return "Cordillera de la Costa - Complejo Volc√°nico-Sedimentario Jur√°sico-Cret√°cico con intrusivos del Pale√≥geno. Yacimientos de cobre porf√≠rico (Chuquicamata, Escondida) y epitermal.";
            } else if (region === "Regi√≥n de Atacama") {
                return "Precordillera andina - Secuencia volc√°nica del Cret√°cico Superior-Pale√≥geno con sistemas epitermales de Au-Cu (Cerro Blanco, Cerro Negro) y vetas mesotermales.";
            }
            
            return "Regi√≥n des√©rtica con geolog√≠a compleja que incluye rocas paleozoicas, intrusiones mesozoicas-cenozoicas y cobertura cuaternaria. Mineralizaci√≥n diversa (Cu, Au, Ag, Pb, Zn).";
        }

        function getRockAgeEstimate() {
            if (!currentLocation) return "Jur√°sico a Cuaternario";
            
            const lat = currentLocation.latitude;
            
            if (lat >= -21 && lat <= -23) return "Jur√°sico Superior - Cret√°cico Inferior";
            if (lat >= -24 && lat <= -26) return "Cret√°cico Superior - Pale√≥geno";
            if (lat >= -27 && lat <= -29) return "Pale√≥geno - Ne√≥geno";
            
            return "Mesozoico - Cenozoico";
        }

        function getPredominantRockType() {
            if (!currentLocation) return "Rocas volc√°nicas andes√≠ticas";
            
            const lat = currentLocation.latitude;
            
            if (lat >= -21 && lat <= -23) return "Granodioritas y tonalitas";
            if (lat >= -24 && lat <= -26) return "Andesitas y dacitas";
            if (lat >= -27 && lat <= -29) return "Riolitas y ignimbritas";
            
            return "Rocas volc√°nicas intermedias";
        }

        function getMineralizationStyle() {
            if (!currentLocation) return "Porf√≠rico de Cu-Mo";
            
            const lat = currentLocation.latitude;
            
            if (lat >= -21 && lat <= -23) return "Porf√≠rico de Cu-Mo (Chuquicamata-type)";
            if (lat >= -24 && lat <= -26) return "Porf√≠rico de Cu-Au (Escondida-type)";
            if (lat >= -27 && lat <= -29) return "Epitermal de Au-Ag (Cerro Blanco-type)";
            
            return "Mixto (porf√≠rico-epitermal)";
        }

        function countMinerals() {
            let count = 0;
            Object.values(MINERAL_DATABASE).forEach(region => {
                count += region.minerals.length;
            });
            return count;
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function setupTabsNavigation() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.dataset.page;
                    switchPage(pageId);
                });
            });
        }

        function switchPage(pageId) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1));
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Acciones espec√≠ficas por p√°gina
            if (pageId === 'camera' && !isCameraActive) {
                showNotification('Activa la c√°mara para an√°lisis fotogeol√≥gico üì∏', 'info');
            } else if (pageId === 'graphs') {
                updateGraph();
            } else if (pageId === 'AI' && !isDrGeoBotActive) {
                showNotification('Activa Dr. GeoBot para consultas IA ü§ñ', 'info');
            }
        }

        function addMessageToChat(sender, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = text;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageId;
        }

        function updateMessage(messageId, text) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.innerHTML = text;
            }
        }

        function updateDatabaseCounts() {
            let mineralCount = 0;
            let locationCount = 0;
            
            Object.values(MINERAL_DATABASE).forEach(region => {
                mineralCount += region.minerals.length;
                locationCount += region.localities.length;
            });
            
            document.getElementById('mineralCount').textContent = mineralCount + " minerales";
            document.getElementById('rockCount').textContent = "24 tipos de rocas";
            document.getElementById('locationCount').textContent = locationCount + " localidades";
        }

        function loadMineralGrid() {
            const mineralGrid = document.getElementById('mineralGrid');
            mineralGrid.innerHTML = '';
            
            // Tomar 12 minerales representativos de toda la base de datos
            const allMinerals = [];
            Object.values(MINERAL_DATABASE).forEach(region => {
                allMinerals.push(...region.minerals);
            });
            
            // Seleccionar 12 minerales aleatorios
            const shuffled = [...allMinerals].sort(() => 0.5 - Math.random());
            const selectedMinerals = shuffled.slice(0, 12);
            
            selectedMinerals.forEach(mineral => {
                const mineralCard = document.createElement('div');
                mineralCard.className = 'mineral-card';
                mineralCard.innerHTML = `
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">${mineral.emoji}</div>
                    <strong>${mineral.name}</strong>
                    <div style="font-size: 0.7rem; opacity: 0.8;">${mineral.formula}</div>
                `;
                mineralGrid.appendChild(mineralCard);
            });
        }

        // ============================================
        // GPS Y LOCALIZACI√ìN
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                showNotification('GPS no disponible ‚ùå', 'error');
                return;
            }

            showNotification('Obteniendo ubicaci√≥n GPS... üõ∞Ô∏è', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                handleGPSPosition,
                handleGPSError,
                options
            );
        }

        function handleGPSPosition(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                altitude: position.coords.altitude || 0,
                accuracy: position.coords.accuracy,
                timestamp: new Date(position.timestamp)
            };

            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfoWithAI();
            
            const accuracy = Math.round(currentLocation.accuracy);
            if (accuracy < 50) {
                showNotification(`üìç GPS de alta precisi√≥n (${accuracy}m)`, 'success');
            } else {
                showNotification(`üìç Ubicaci√≥n obtenida (${accuracy}m)`, 'success');
            }
            
            // Notificar a Dr. GeoBot si est√° activo
            if (isDrGeoBotActive) {
                setTimeout(() => {
                    addMessageToChat('ai', `<strong>üìç UBICACI√ìN GPS ACTUALIZADA:</strong><br><br>
                    <strong>Coordenadas exactas:</strong> ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞<br>
                    <strong>Altitud:</strong> ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : 'Estimada 2400m'}<br>
                    <strong>Regi√≥n:</strong> ${getRegionFromLocation()}<br>
                    <strong>Precisi√≥n:</strong> ${Math.round(currentLocation.accuracy)}m<br><br>
                    <em>¬øQuieres que analice la geolog√≠a espec√≠fica de esta zona?</em>`);
                }, 500);
            }
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            let message = 'Error de GPS ‚ùå';
            switch(error.code) {
                case 1: message = 'Permiso de ubicaci√≥n denegado üîí'; break;
                case 2: message = 'Ubicaci√≥n no disponible üì°'; break;
                case 3: message = 'Tiempo de espera agotado ‚è∞'; break;
            }
            
            showNotification(message, 'warning');
            
            // Ubicaci√≥n por defecto (Desierto de Atacama)
            currentLocation = {
                latitude: CONFIG.DEFAULT_LOCATION.lat,
                longitude: CONFIG.DEFAULT_LOCATION.lng,
                accuracy: 5000,
                altitude: 2400
            };
            
            updateLocationDisplay();
            updateMapLocation();
            updateGeologyInfoWithAI();
        }

        function updateLocationDisplay() {
            if (!currentLocation) return;

            document.getElementById('latitudeValue').textContent = currentLocation.latitude.toFixed(6);
            document.getElementById('longitudeValue').textContent = currentLocation.longitude.toFixed(6);
            document.getElementById('altitudeValue').textContent = 
                currentLocation.altitude ? `${Math.round(currentLocation.altitude)}m` : '--';
            
            // Determinar ciudad m√°s cercana
            const cities = [
                { name: "Antofagasta", lat: -23.650, lng: -70.400 },
                { name: "Calama", lat: -22.456, lng: -68.924 },
                { name: "Copiap√≥", lat: -27.366, lng: -70.332 },
                { name: "Vallenar", lat: -28.576, lng: -70.759 },
                { name: "San Pedro", lat: -22.911, lng: -68.201 },
                { name: "Taltal", lat: -25.400, lng: -70.483 },
                { name: "Cha√±aral", lat: -26.344, lng: -70.615 }
            ];
            
            let closestCity = "Desierto";
            let minDistance = Infinity;
            
            cities.forEach(city => {
                const distance = Math.sqrt(
                    Math.pow(city.lat - currentLocation.latitude, 2) + 
                    Math.pow(city.lng - currentLocation.longitude, 2)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestCity = city.name;
                }
            });
            
            document.getElementById('cityValue').textContent = closestCity;
        }

        async function updateGeologyInfoWithAI() {
            if (!currentLocation) return;

            if (isDrGeoBotActive) {
                // Usar IA para informaci√≥n m√°s precisa
                const prompt = `Proporciona informaci√≥n geol√≥gica precisa para las coordenadas ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞ en el Desierto de Atacama. Incluye: tipo de roca predominante, edad geol√≥gica, estructuras principales, mineralizaci√≥n esperada y recomendaciones de campo. Responde en HTML conciso.`;
                
                try {
                    const response = await callDeepSeekAPI(prompt);
                    document.getElementById('geologyInfo').innerHTML = `
                        <div style="padding: 10px;">
                            <strong>ü§ñ An√°lisis IA de Geolog√≠a Local:</strong><br><br>
                            ${response}
                        </div>
                    `;
                } catch (error) {
                    showFallbackGeologyInfo();
                }
            } else {
                showFallbackGeologyInfo();
            }
        }

        function showFallbackGeologyInfo() {
            const region = getRegionFromLocation();
            const regionData = MINERAL_DATABASE[region];
            
            let html = '';
            
            if (regionData) {
                html += `<div class="data-row">
                    <span>Regi√≥n geol√≥gica:</span>
                    <span><strong>${region}</strong></span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Mineral principal:</span>
                    <span>${regionData.minerals[0].emoji} ${regionData.minerals[0].name}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Yacimiento cercano:</span>
                    <span>${regionData.localities[0]}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Contexto:</span>
                    <span>${getDetailedGeologicalContext()}</span>
                </div>`;
                
                html += `<div class="data-row">
                    <span>Recomendaci√≥n:</span>
                    <span><button class="glass-btn primary" onclick="askAIForGeology()" style="padding: 5px 10px; font-size: 0.7rem; margin-top: 5px;">
                        ü§ñ Consultar IA para m√°s detalles
                    </button></span>
                </div>`;
            } else {
                html = `<div class="data-row">
                    <span>Ubicaci√≥n:</span>
                    <span><strong>Desierto de Atacama</strong></span>
                </div>
                <div class="data-row">
                    <span>Minerales t√≠picos:</span>
                    <span>üíé Calcopirita üíö Atacamita üî¥ Hematita</span>
                </div>
                <div class="data-row">
                    <span>Actividad:</span>
                    <span>‚ö° Miner√≠a de cobre (1er productor mundial)</span>
                </div>
                <div class="data-row">
                    <span>Clima:</span>
                    <span>üèúÔ∏è √Årido extremo (0-50mm/a√±o)</span>
                </div>`;
            }
            
            document.getElementById('geologyInfo').innerHTML = html;
        }

        async function askAIForGeology() {
            if (!isDrGeoBotActive) {
                showNotification('Activa Dr. GeoBot primero ü§ñ', 'warning');
                return;
            }
            
            const question = `Analiza la geolog√≠a de mi ubicaci√≥n actual: ${currentLocation.latitude.toFixed(6)}¬∞, ${currentLocation.longitude.toFixed(6)}¬∞`;
            addMessageToChat('user', question);
            
            const thinkingId = addMessageToChat('ai', 'Analizando geolog√≠a local... üîç');
            
            try {
                const response = await callDeepSeekAPI(question);
                updateMessage(thinkingId, response);
            } catch (error) {
                updateMessage(thinkingId, 'Error al consultar IA. Intenta nuevamente.');
            }
        }

        // ============================================
        // MAPA 2D
        // ============================================
        function init2DMap() {
            try {
                map = L.map('map').setView(
                    [CONFIG.DEFAULT_LOCATION.lat, CONFIG.DEFAULT_LOCATION.lng],
                    CONFIG.DEFAULT_LOCATION.zoom
                );

                // Capa base topogr√°fica
                L.tileLayer(CONFIG.MAP_LAYERS.topo, {
                    attribution: '¬© OpenTopoMap',
                    maxZoom: 17
                }).addTo(map);

                markersLayer = L.layerGroup().addTo(map);

                // A√±adir algunos puntos de inter√©s iniciales
                addInitialGeologyPoints();

                console.log('‚úÖ Mapa 2D topogr√°fico del Desierto de Atacama inicializado');

            } catch (error) {
                console.error('Error inicializando mapa:', error);
                showNotification('Error al cargar el mapa ‚ùå', 'error');
            }
        }

        function addInitialGeologyPoints() {
            const points = [
                { lat: -22.285, lng: -68.905, type: 'mine', emoji: '‚õèÔ∏è', name: 'Chuquicamata' },
                { lat: -24.271, lng: -69.081, type: 'mine', emoji: '‚õèÔ∏è', name: 'Escondida' },
                { lat: -27.367, lng: -70.333, type: 'sample', emoji: 'üî¨', name: '√Årea de Muestreo' },
                { lat: -23.650, lng: -70.400, type: 'city', emoji: 'üèôÔ∏è', name: 'Antofagasta' },
                { lat: -27.366, lng: -70.332, type: 'city', emoji: 'üèôÔ∏è', name: 'Copiap√≥' },
                { lat: -28.576, lng: -70.759, type: 'city', emoji: 'üèôÔ∏è', name: 'Vallenar' }
            ];

            points.forEach(point => {
                L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        html: `<div style="background: ${getColorForType(point.type)}; color:white; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${point.emoji}</div>`,
                        iconSize: [36, 36]
                    })
                })
                .bindPopup(`<div style="background: rgba(255,248,220,0.9); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);"><strong>${point.emoji} ${point.name}</strong><br>Tipo: ${point.type}</div>`)
                .addTo(markersLayer);
            });
        }

        function getColorForType(type) {
            switch(type) {
                case 'mine': return '#D4A017';
                case 'sample': return '#228B22';
                case 'city': return '#4682B4';
                default: return '#8B4513';
            }
        }

        function updateMapLocation() {
            if (!map || !currentLocation) return;

            const latLng = [currentLocation.latitude, currentLocation.longitude];
            
            map.flyTo(latLng, 14, {
                duration: 1.5
            });

            // Marcador de ubicaci√≥n actual
            L.marker(latLng, {
                icon: L.divIcon({
                    className: 'current-location',
                    html: `<div style="background: linear-gradient(135deg, #D4A017, #8B4513); color:white; width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid white; font-size:1.4rem; box-shadow: 0 4px 15px rgba(0,0,0,0.4);">üìç</div>`,
                    iconSize: [42, 42]
                })
            }).addTo(markersLayer).bindPopup('<div style="background: rgba(255,248,220,0.9); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);"><strong>üìç Tu ubicaci√≥n</strong><br>Precisi√≥n: ' + Math.round(currentLocation.accuracy) + 'm</div>').openPopup();

            // C√≠rculo de precisi√≥n
            L.circle(latLng, {
                color: 'rgba(212, 160, 23, 0.3)',
                fillColor: 'rgba(212, 160, 23, 0.1)',
                radius: currentLocation.accuracy,
                weight: 1.5
            }).addTo(map);
        }

        // ============================================
        // GR√ÅFICOS
        // ============================================
        function initGraphs() {
            // Configurar eventos para botones de tipo de gr√°fico
            document.querySelectorAll('.graph-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.graph-type-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    currentGraphType = this.dataset.graph;
                    updateGraph();
                });
            });
            
            // Crear gr√°fico inicial
            updateGraph();
        }

        function updateGraph() {
            const ctx = document.getElementById('mainGraph').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (currentGraph) {
                currentGraph.destroy();
            }
            
            // Datos de ejemplo basados en minerales del Desierto de Atacama
            const mineralData = {
                labels: ['Calcopirita', 'Atacamita', 'Hematita', 'Cuarzo', 'Epidota', 'Malaquita'],
                datasets: [{
                    label: 'Abundancia relativa (%)',
                    data: [35, 15, 12, 20, 10, 8],
                    backgroundColor: [
                        '#D4A017',
                        '#228B22',
                        '#DC143C',
                        '#4682B4',
                        '#8B4513',
                        '#228B22'
                    ],
                    borderWidth: 1
                }]
            };
            
            const config = {
                type: currentGraphType,
                data: mineralData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribuci√≥n de Minerales - Desierto de Atacama'
                        }
                    }
                }
            };
            
            currentGraph = new Chart(ctx, config);
        }

        // ============================================
        // RUTAS
        // ============================================
        function addMapPoint() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üó∫Ô∏è', 'warning');
                return;
            }

            const types = [
                { type: 'mineral', emoji: 'üíé', name: 'Mineral', color: '#D4A017' },
                { type: 'rock', emoji: 'ü™®', name: 'Roca', color: '#8B4513' },
                { type: 'fault', emoji: '‚ö°', name: 'Falla', color: '#DC143C' },
                { type: 'sample', emoji: 'üî¨', name: 'Muestra', color: '#228B22' },
                { type: 'water', emoji: 'üíß', name: 'Agua', color: '#4682B4' },
                { type: 'photo', emoji: 'üì∏', name: 'Foto', color: '#FF8C00' }
            ];
            
            const selectedType = types[Math.floor(Math.random() * types.length)];
            const time = new Date();
            const name = `${selectedType.name} ${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;

            const marker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: L.divIcon({
                    html: `<div style="background: ${selectedType.color}; color:white; width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.3rem; border:2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">${selectedType.emoji}</div>`,
                    iconSize: [38, 38]
                })
            })
            .bindPopup(`<div style="background: rgba(255,248,220,0.9); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <strong>${selectedType.emoji} ${name}</strong><br>
                Coordenadas: ${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞<br>
                Altitud: ${currentLocation.altitude ? Math.round(currentLocation.altitude) + 'm' : '--'}<br>
                Hora: ${time.toLocaleTimeString('es-CL')}
            </div>`)
            .addTo(markersLayer);

            // Agregar a ruta
            routePoints.push([currentLocation.latitude, currentLocation.longitude]);
            
            // Actualizar polyline de ruta
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            if (routePoints.length > 1) {
                routePolyline = L.polyline(routePoints, {
                    color: '#228B22',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
                
                // Mostrar informaci√≥n de ruta
                document.getElementById('routeInfo').style.display = 'block';
                updateRouteInfo();
            }

            showNotification(`Punto ${selectedType.name} agregado a ruta üìç`, 'success');
        }

        function markRoute() {
            if (!currentLocation) {
                showNotification('Primero activa el GPS üó∫Ô∏è', 'warning');
                return;
            }

            // Limpiar ruta anterior
            routePoints = [];
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            document.getElementById('routeInfo').style.display = 'none';
            
            showNotification('Ruta lista para marcar. Agrega puntos con "Agregar Punto" üìç', 'info');
        }

        function downloadRoute() {
            if (routePoints.length < 2) {
                showNotification('Necesitas al menos 2 puntos para una ruta üó∫Ô∏è', 'warning');
                return;
            }

            // Calcular estad√≠sticas de ruta
            let totalDistance = 0;
            let elevationGain = 0;
            let elevationLoss = 0;
            
            for (let i = 1; i < routePoints.length; i++) {
                const dist = calculateDistance(routePoints[i-1], routePoints[i]);
                totalDistance += dist;
                
                // Simular cambios de elevaci√≥n (en una app real, esto vendr√≠a de datos de elevaci√≥n)
                if (currentLocation && currentLocation.altitude) {
                    const elevChange = Math.random() * 50 - 25; // Cambio aleatorio entre -25 y +25m
                    if (elevChange > 0) elevationGain += elevChange;
                    else elevationLoss += Math.abs(elevChange);
                }
            }

            const routeData = {
                name: `Ruta_AtacamApp_${new Date().toISOString().slice(0,10)}`,
                coordinates: routePoints,
                statistics: {
                    totalPoints: routePoints.length,
                    totalDistance: totalDistance.toFixed(2),
                    elevationGain: Math.round(elevationGain),
                    elevationLoss: Math.round(elevationLoss),
                    estimatedTime: Math.round(totalDistance * 0.02) // 2 min por 100m
                },
                metadata: {
                    created: new Date().toISOString(),
                    app: "AtacamApp",
                    region: getRegionFromLocation(),
                    version: "2.0"
                }
            };

            // Crear y descargar archivo GPX
            const gpxContent = generateGPX(routeData);
            const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${routeData.name}.gpx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`‚úÖ Ruta descargada (${routePoints.length} puntos)`, 'success');
        }

        function calculateDistance(point1, point2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = point1[0] * Math.PI/180;
            const œÜ2 = point2[0] * Math.PI/180;
            const ŒîœÜ = (point2[0] - point1[0]) * Math.PI/180;
            const ŒîŒª = (point2[1] - point1[1]) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c / 1000; // Distancia en km
        }

        function updateRouteInfo() {
            if (routePoints.length < 2) return;
            
            let totalDistance = 0;
            for (let i = 1; i < routePoints.length; i++) {
                totalDistance += calculateDistance(routePoints[i-1], routePoints[i]);
            }
            
            document.getElementById('routeLength').textContent = totalDistance.toFixed(2) + ' km';
            document.getElementById('routePoints').textContent = routePoints.length;
            document.getElementById('routeElevation').textContent = 
                currentLocation && currentLocation.altitude ? 
                Math.round(currentLocation.altitude) + ' m' : '--';
        }

        function generateGPX(routeData) {
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="AtacamApp" xmlns="http://www.topografix.com/GPX/1/1">
    <metadata>
        <name>${routeData.name}</name>
        <desc>Ruta geol√≥gica generada con AtacamApp</desc>
        <time>${routeData.metadata.created}</time>
    </metadata>
    <trk>
        <name>${routeData.name}</name>
        <trkseg>`;
            
            routeData.coordinates.forEach((coord, index) => {
                gpx += `
            <trkpt lat="${coord[0]}" lon="${coord[1]}">
                <ele>${currentLocation && currentLocation.altitude ? currentLocation.altitude : 0}</ele>
                <name>Punto ${index + 1}</name>
            </trkpt>`;
            });
            
            gpx += `
        </trkseg>
    </trk>
</gpx>`;
            
            return gpx;
        }

        // ============================================
        // C√ÅMARA Y AN√ÅLISIS
        // ============================================
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraFeed');
                video.srcObject = cameraStream;

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                isCameraActive = true;
                updateCameraControls(true);
                showNotification('C√°mara activada para an√°lisis üì∏', 'success');

            } catch (error) {
                console.error('Error c√°mara:', error);
                showNotification('Error al activar c√°mara ‚ùå', 'error');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('cameraFeed');
            video.srcObject = null;
            isCameraActive = false;
            updateCameraControls(false);
            showNotification('C√°mara detenida ‚èπÔ∏è', 'info');
        }

        function updateCameraControls(active) {
            document.getElementById('startCameraBtn').disabled = active;
            document.getElementById('captureBtn').disabled = !active;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = !active;
            
            const statusText = document.getElementById('cameraStatusText');
            statusText.innerHTML = active ? 
                '<span>üü¢</span> C√°mara activa' :
                '<span>üî¥</span> C√°mara inactiva';
        }

        function capturePhoto() {
            if (!isCameraActive) return;

            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            currentPhoto = {
                data: canvas.toDataURL('image/jpeg'),
                timestamp: new Date().toISOString(),
                location: currentLocation
            };

            document.getElementById('analyzeBtn').disabled = false;
            showNotification('¬°Foto capturada! ü§ñ Ahora analiza con IA', 'success');
        }

        // ============================================
        // CAPAS GEOL√ìGICAS Y EXPORTACI√ìN
        // ============================================
        function generateLayers() {
            const topography = document.getElementById('layerTopography').checked;
            const geology = document.getElementById('layerGeology').checked;
            const faults = document.getElementById('layerFaults').checked;
            
            let layers = [];
            if (topography) layers.push('‚õ∞Ô∏è Topograf√≠a');
            if (geology) layers.push('ü™® Geolog√≠a Base');
            if (faults) layers.push('‚ö° Sistema de Fallas');
            
            showNotification(`Generando capas: ${layers.join(', ')}... üó∫Ô∏è`, 'info');
            
            // Simular generaci√≥n de capas
            setTimeout(() => {
                const html = `
                    <div class="data-row">
                        <span>Capas generadas:</span>
                        <span>${layers.length}</span>
                    </div>
                    <div class="data-row">
                        <span>Resoluci√≥n:</span>
                        <span>300 DPI</span>
                    </div>
                    <div class="data-row">
                        <span>Formato:</span>
                        <span>PNG 1920x1080</span>
                    </div>
                    <div class="data-row">
                        <span>√Årea cubierta:</span>
                        <span>10 km¬≤</span>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(212, 160, 23, 0.2), rgba(139, 69, 19, 0.2)); border-radius: 12px; border: 1px solid rgba(212, 160, 23, 0.3); font-size: 0.8rem;">
                        <strong>üó∫Ô∏è Capas listas para exportar:</strong><br>
                        ‚Ä¢ ${layers.join('<br>‚Ä¢ ')}<br>
                        ‚Ä¢ Sistema de coordenadas: WGS84<br>
                        ‚Ä¢ Escala: 1:25,000
                    </div>
                `;

                document.getElementById('structuralParams').innerHTML = html;
                showNotification('‚úÖ Capas geol√≥gicas generadas', 'success');
            }, 1500);
        }

        function exportLayersPNG() {
            showNotification('Exportando capas como PNG... üì§', 'info');
            
            setTimeout(() => {
                // Crear un canvas temporal para la exportaci√≥n
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 1920;
                canvas.height = 1080;
                
                // Fondo
                ctx.fillStyle = 'rgba(255, 248, 220, 0.9)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // T√≠tulo
                ctx.fillStyle = '#2F4F4F';
                ctx.font = 'bold 40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Mapa Geol√≥gico - Desierto de Atacama', canvas.width/2, 80);
                
                // Subt√≠tulo
                ctx.font = '20px Arial';
                ctx.fillText(`Generado: ${new Date().toLocaleDateString('es-CL')} | Coordenadas: ${currentLocation ? currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞`, canvas.width/2, 120);
                
                // Leyenda
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Leyenda:', 50, 200);
                
                const legendItems = [
                    { color: '#D4A017', label: 'Geolog√≠a - Rocas √≠gneas' },
                    { color: '#8B4513', label: 'Geolog√≠a - Rocas sedimentarias' },
                    { color: '#228B22', label: 'Geolog√≠a - Rocas metam√≥rficas' },
                    { color: '#DC143C', label: 'Fallas y estructuras' },
                    { color: '#4682B4', label: 'Cuerpos de agua' },
                    { color: '#2F4F4F', label: 'Curvas de nivel' }
                ];
                
                legendItems.forEach((item, index) => {
                    ctx.fillStyle = item.color;
                    ctx.fillRect(50, 240 + index * 40, 30, 20);
                    ctx.fillStyle = '#2F4F4F';
                    ctx.font = '18px Arial';
                    ctx.fillText(item.label, 90, 255 + index * 40);
                });
                
                // Pie de p√°gina
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#666';
                ctx.fillText('Generado con AtacamApp - Sistema de Geolog√≠a 3D & IA', canvas.width/2, canvas.height - 30);
                
                // Convertir a PNG y descargar
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `mapa_geologico_atacama_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showNotification('‚úÖ Mapa exportado como PNG', 'success');
            }, 1000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Botones GPS
            document.getElementById('updateLocationBtn')?.addEventListener('click', startGPS);

            // Botones mapa
            document.getElementById('addPointBtn')?.addEventListener('click', addMapPoint);
            document.getElementById('markRouteBtn')?.addEventListener('click', markRoute);
            document.getElementById('downloadRouteBtn')?.addEventListener('click', downloadRoute);

            // Botones c√°mara
            document.getElementById('startCameraBtn')?.addEventListener('click', startCamera);
            document.getElementById('stopCameraBtn')?.addEventListener('click', stopCamera);
            document.getElementById('captureBtn')?.addEventListener('click', capturePhoto);
            document.getElementById('analyzeBtn')?.addEventListener('click', analyzeWithAI);

            // Controles mapa
            document.getElementById('mapSatelliteBtn')?.addEventListener('click', () => {
                switchMapLayer('satellite');
            });
            document.getElementById('mapTerrainBtn')?.addEventListener('click', () => {
                switchMapLayer('topo');
            });
            document.getElementById('mapGeologyBtn')?.addEventListener('click', () => {
                switchMapLayer('geology');
            });

            // Botones geolog√≠a IA
            document.getElementById('askGeologyInfo')?.addEventListener('click', askAIForGeology);

            // Botones capas
            document.getElementById('generateLayers')?.addEventListener('click', generateLayers);
            document.getElementById('exportLayersPNG')?.addEventListener('click', exportLayersPNG);

            // IA
            document.getElementById('sendMessage')?.addEventListener('click', sendMessageToAI);
            document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessageToAI();
            });
            document.getElementById('analyzeLocation')?.addEventListener('click', () => {
                if (currentLocation) {
                    addMessageToChat('user', 'Analiza la geolog√≠a de mi ubicaci√≥n actual con detalles precisos');
                    setTimeout(sendMessageToAI, 100);
                } else {
                    showNotification('Primero activa el GPS üìç', 'warning');
                }
            });
            document.getElementById('identifyMineral')?.addEventListener('click', () => {
                addMessageToChat('user', '¬øQu√© minerales puedo encontrar en esta zona del Desierto de Atacama? Lista los 10 principales con sus caracter√≠sticas.');
                setTimeout(sendMessageToAI, 100);
            });
            document.getElementById('suggestMethodology')?.addEventListener('click', () => {
                addMessageToChat('user', '¬øCu√°l es la metodolog√≠a recomendada para trabajo de campo geol√≥gico en el Desierto de Atacama? Incluye equipo, t√©cnicas y precauciones.');
                setTimeout(sendMessageToAI, 100);
            });
        }

        function switchMapLayer(layerName) {
            if (map) {
                map.eachLayer((layer) => {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                let attribution = '';
                switch(layerName) {
                    case 'satellite':
                        attribution = '¬© Esri';
                        break;
                    case 'geology':
                        attribution = '¬© Servicio Geol√≥gico de Chile';
                        break;
                    default:
                        attribution = '¬© OpenTopoMap';
                }
                
                L.tileLayer(CONFIG.MAP_LAYERS[layerName], {
                    attribution: attribution,
                    maxZoom: layerName === 'satellite' ? 19 : 17
                }).addTo(map);
                
                const layerNames = {
                    'satellite': 'Sat√©lite üõ∞Ô∏è',
                    'topo': 'Topogr√°fico ‚õ∞Ô∏è',
                    'geology': 'Geol√≥gico ü™®'
                };
                
                showNotification(`Mapa: ${layerNames[layerName]}`, 'success');
            }
        }

        function analyzeWithAI() {
            if (!currentPhoto) {
                showNotification('Primero captura una imagen üì∏', 'warning');
                return;
            }

            if (!isDrGeoBotActive) {
                showNotification('Primero activa Dr. GeoBot ü§ñ', 'warning');
                return;
            }

            showNotification('Analizando imagen con DeepSeek AI... üîç', 'info');

            // En una implementaci√≥n real, aqu√≠ enviar√≠as la imagen a la API
            // Por ahora, simulamos una respuesta
            setTimeout(() => {
                const analysisHTML = `
                    <div class="data-row">
                        <span>Tipo identificado:</span>
                        <span>ü™® Roca √≠gnea volc√°nica (Andesita)</span>
                    </div>
                    <div class="data-row">
                        <span>Mineral principal:</span>
                        <span>üíé Plagioclasa (60%) + Piroxeno (25%)</span>
                    </div>
                    <div class="data-row">
                        <span>Textura:</span>
                        <span>‚ö° Porf√≠dica con fenocristales de plagioclasa</span>
                    </div>
                    <div class="data-row">
                        <span>Alteraci√≥n:</span>
                        <span>üíö Clorita + Epidota (propil√≠tica)</span>
                    </div>
                    <div class="data-row">
                        <span>Confianza IA:</span>
                        <span>üéØ 94%</span>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(70, 130, 180, 0.2), rgba(100, 149, 237, 0.2)); border-radius: 12px; border: 1px solid rgba(70, 130, 180, 0.3); font-size: 0.8rem;">
                        <strong>üë®‚Äçüî¨ Dr. GeoBot recomienda:</strong><br>
                        ‚Ä¢ Realizar an√°lisis petrogr√°fico para confirmaci√≥n<br>
                        ‚Ä¢ Tomar muestra para geoqu√≠mica (elementos mayores/trazas)<br>
                        ‚Ä¢ Buscar mineralizaci√≥n asociada (vetas de cuarzo)<br>
                        ‚Ä¢ Medir orientaci√≥n estructural del afloramiento
                    </div>
                `;

                document.getElementById('analysisResults').innerHTML = analysisHTML;
                showNotification('‚úÖ An√°lisis IA completado (DeepSeek)', 'success');
                
                // Agregar al chat
                if (isDrGeoBotActive) {
                    setTimeout(() => {
                        addMessageToChat('ai', `<strong>üì∏ AN√ÅLISIS FOTOGEOL√ìGICO (DeepSeek AI):</strong><br><br>
                        <strong>Resultados del an√°lisis de imagen:</strong><br>
                        ‚Ä¢ ü™® Roca: Andesita porf√≠dica<br>
                        ‚Ä¢ üíé Mineralog√≠a: Plagioclasa (dominante) + Piroxeno<br>
                        ‚Ä¢ ‚ö° Textura: Porf√≠dica, matriz afan√≠tica<br>
                        ‚Ä¢ üíö Alteraci√≥n: Propil√≠tica (clorita-epidota)<br>
                        ‚Ä¢ üéØ Confianza: 94%<br><br>
                        <strong>Interpretaci√≥n geol√≥gica:</strong><br>
                        Rocas volc√°nicas intermedias del Arco Andino, probablemente del Mioceno. Asociada a sistemas porf√≠ricos de Cu-Mo en la regi√≥n.`);
                    }, 500);
                }
            }, 2000);
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function requestPermissions() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(result => {
                        if (result.state === 'granted') {
                            console.log('‚úÖ Permiso de GPS disponible');
                            startGPS();
                        }
                    });
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationIcon = document.getElementById('notificationIcon');

            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            
            switch(type) {
                case 'success':
                    notificationIcon.textContent = '‚úÖ';
                    notification.style.borderLeftColor = '#228B22';
                    break;
                case 'error':
                    notificationIcon.textContent = '‚ùå';
                    notification.style.borderLeftColor = '#DC143C';
                    break;
                case 'warning':
                    notificationIcon.textContent = '‚ö†Ô∏è';
                    notification.style.borderLeftColor = '#FF8C00';
                    break;
                case 'info':
                    notificationIcon.textContent = '‚ÑπÔ∏è';
                    notification.style.borderLeftColor = '#4682B4';
                    break;
            }
            
            notification.style.display = 'flex';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3500);
        }

        // ============================================
        // MANEJO OFFLINE/ONLINE
        // ============================================
        window.addEventListener('online', () => {
            showNotification('Conectado a internet - DeepSeek AI activa ‚úÖ', 'success');
            if (isDrGeoBotActive) {
                addMessageToChat('ai', `<strong>‚úÖ CONEXI√ìN RESTAURADA:</strong><br><br>
                DeepSeek AI est√° nuevamente disponible para an√°lisis geol√≥gico avanzado y verificaciones en tiempo real.`);
            }
        });

        window.addEventListener('offline', () => {
            showNotification('Sin conexi√≥n a internet - Modo local activado ‚ö†Ô∏è', 'warning');
            if (isDrGeoBotActive) {
                addMessageToChat('ai', `<strong>‚ö†Ô∏è MODO LOCAL ACTIVADO:</strong><br><br>
                Sin conexi√≥n a internet. Funciones b√°sicas disponibles con base de datos local de 50+ minerales. Las consultas a DeepSeek AI no est√°n disponibles temporalmente.`);
            }
        });
    </script>
</body>
</html>
