<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AtacamApp - Geolog√≠a 3D & IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <style>
        :root {
            --primary: #c45c26;
            --secondary: #d9a066;
            --accent: #e6b800;
            --danger: #c0392b;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #f5e6ca;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5e6ca 0%, #e8d1a3 100%);
            position: relative;
        }

        /* Fondo des√©rtico */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(230, 184, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 20%, rgba(196, 92, 38, 0.1) 0%, transparent 20%);
            z-index: -1;
        }

        /* Sol desierto */
        body::after {
            content: "‚òÄÔ∏è";
            position: fixed;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            opacity: 0.3;
            z-index: -1;
            animation: sunGlow 8s infinite alternate;
        }

        @keyframes sunGlow {
            0% { opacity: 0.2; transform: scale(1); }
            100% { opacity: 0.4; transform: scale(1.1); }
        }

        /* Splash Screen */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #c45c26 0%, #d9a066 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        .splash-content {
            text-align: center;
            animation: fadeIn 1s ease;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            width: 250px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            margin: 20px auto;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        /* Main App */
        #appContainer {
            display: none;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* Header - M√°s compacto */
        .app-header {
            background: rgba(196, 92, 38, 0.95);
            color: white;
            padding: 10px 15px;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-bottom: 2px solid var(--accent);
            height: 70px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .app-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-brand i {
            color: var(--accent);
            font-size: 1.5rem;
        }

        .app-brand h2 {
            font-size: 1.2rem;
            line-height: 1;
        }

        .app-brand small {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .action-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content - Optimizado para m√≥vil */
        .main-content {
            height: calc(100vh - 140px); /* 70px header + 70px nav */
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        /* Cards - M√°s compactas */
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(196, 92, 38, 0.1);
            position: relative;
        }

        .card::before {
            content: "üèúÔ∏è";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2rem;
            opacity: 0.1;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .card-title i {
            color: var(--accent);
            font-size: 1.1rem;
        }

        /* GPS Data - Grid m√°s compacto */
        .gps-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .gps-data-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #eee;
            transition: transform 0.3s;
        }

        .gps-data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .gps-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }

        .gps-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Buttons - M√°s compactos */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #a34c20;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Camera Container - Tama√±o ajustado */
        .camera-container {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
            border: 2px solid var(--primary);
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            color: white;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.5);
            padding: 5px 8px;
            border-radius: 4px;
        }

        /* Map Containers - Tama√±o optimizado */
        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 2px solid var(--primary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #map3d {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 2px solid var(--primary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        /* AI Chat - M√°s compacto */
        .ai-chat-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            height: 250px;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid #ddd;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 85%;
            position: relative;
            font-size: 0.9rem;
        }

        .chat-message::before {
            position: absolute;
            top: -4px;
            font-size: 0.7rem;
        }

        .chat-message.ai::before {
            content: "üë®‚Äçüî¨";
            left: -20px;
        }

        .chat-message.user::before {
            content: "üßë‚Äçüíº";
            right: -20px;
        }

        .chat-message.ai {
            background: #e3f2fd;
            margin-right: auto;
            border-bottom-left-radius: 0;
            border-left: 2px solid var(--info);
        }

        .chat-message.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
            border-right: 2px solid var(--accent);
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        /* 2D Layers Control - Mejorado */
        .layers-control-2d {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
        }

        .layer-item-2d {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .layer-item-2d:last-child {
            border-bottom: none;
        }

        .layer-item-2d:hover {
            background: #e9ecef;
            border-radius: 4px;
        }

        .layer-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        /* Bottom Navigation - M√°s compacta */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
            z-index: 100;
            border-top: 2px solid var(--primary);
            height: 70px;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            font-size: 0.75rem;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.3s;
            width: 22%;
            height: 100%;
            justify-content: center;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
        }

        .nav-btn.active::after {
            content: "‚¨ÜÔ∏è";
            position: absolute;
            top: -12px;
            font-size: 0.7rem;
        }

        .nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Geological Data Display */
        .geology-data {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
            position: relative;
        }

        .geology-data::before {
            content: "‚õèÔ∏è";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1rem;
            opacity: 0.3;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        /* Button Grids */
        .button-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        /* Notification - M√°s peque√±o */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--success);
            max-width: 300px;
            font-size: 0.9rem;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification::before {
            font-size: 1rem;
        }

        .notification.success::before {
            content: "‚úÖ";
        }

        .notification.error::before {
            content: "‚ùå";
            border-left-color: var(--danger);
        }

        .notification.warning::before {
            content: "‚ö†Ô∏è";
            border-left-color: var(--warning);
        }

        .notification.info::before {
            content: "‚ÑπÔ∏è";
            border-left-color: var(--info);
        }

        /* Emoticones decorativos - Menos intrusivos */
        .emoji-decor {
            position: absolute;
            font-size: 1rem;
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
        }

        /* Geological Legend */
        .legend-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        /* Responsive Optimizations */
        @media (max-width: 480px) {
            .gps-data-grid {
                grid-template-columns: 1fr;
            }
            
            .button-grid-2 {
                grid-template-columns: 1fr;
            }
            
            .camera-container {
                height: 200px;
            }
            
            .map-container, #map3d {
                height: 250px;
            }
            
            .ai-chat-container {
                height: 200px;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .card {
                padding: 12px;
            }
            
            .nav-btn span {
                font-size: 0.7rem;
            }
            
            .nav-btn i {
                font-size: 1rem;
            }
        }

        @media (max-width: 360px) {
            .app-brand h2 {
                font-size: 1rem;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.85rem;
            }
        }

        /* Scrollbar personalizado */
        .main-content::-webkit-scrollbar {
            width: 6px;
        }

        .main-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .ai-chat-container::-webkit-scrollbar {
            width: 4px;
        }

        .ai-chat-container::-webkit-scrollbar-thumb {
            background: var(--info);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Emoticones decorativos sutiles -->
    <div class="emoji-decor" style="top: 10%; left: 5%;">üèîÔ∏è</div>
    <div class="emoji-decor" style="top: 20%; right: 10%;">üåµ</div>
    <div class="emoji-decor" style="bottom: 30%; left: 15%;">ü™®</div>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="splash-content">
            <div style="font-size: 3rem; margin-bottom: 15px;">üèúÔ∏è</div>
            <h1 style="font-size: 1.8rem; margin-bottom: 8px;">AtacamApp</h1>
            <p style="margin-bottom: 20px; opacity: 0.9; font-size: 0.9rem;">Geolog√≠a 3D & Proyecci√≥n Estructural</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="loadingText" style="margin-top: 15px; font-size: 0.85rem;">Inicializando sistema... üöÄ</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-top">
                <div class="app-brand">
                    <div style="font-size: 1.5rem;">üèúÔ∏è</div>
                    <div>
                        <h2>AtacamApp</h2>
                        <small>Geolog√≠a 3D & IA</small>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="action-btn" id="gpsBtn" title="GPS">
                        <i class="fas fa-satellite"></i>
                    </button>
                    <button class="action-btn" id="cameraBtn" title="C√°mara">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page 1: Dashboard -->
            <div class="page active" id="pageDashboard">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-satellite"></i>
                        Ubicaci√≥n GPS üõ∞Ô∏è
                    </h3>
                    
                    <div class="gps-data-grid">
                        <div class="gps-data-item">
                            <div class="gps-label">Latitud üåê</div>
                            <div class="gps-value" id="latitudeValue">--</div>
                        </div>
                        <div class="gps-data-item">
                            <div class="gps-label">Longitud üåê</div>
                            <div class="gps-value" id="longitudeValue">--</div>
                        </div>
                        <div class="gps-data-item">
                            <div class="gps-label">Altitud ‚õ∞Ô∏è</div>
                            <div class="gps-value" id="altitudeValue">--</div>
                        </div>
                        <div class="gps-data-item">
                            <div class="gps-label">Precisi√≥n üéØ</div>
                            <div class="gps-value" id="accuracyValue">--</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="connectGPSBtn">
                        <i class="fas fa-satellite"></i>
                        Conectar GPS üì°
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-map-marked-alt"></i>
                        Mapa 2D Geol√≥gico üó∫Ô∏è
                    </h3>
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                    
                    <!-- Controles de capas 2D -->
                    <div class="layers-control-2d">
                        <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 0.9rem;">
                            <i class="fas fa-layer-group"></i> Capas Geol√≥gicas 2D
                        </h4>
                        <div class="layer-item-2d" data-layer="geology">
                            <input type="checkbox" id="layerGeology2D" checked>
                            <label for="layerGeology2D">Geolog√≠a Base ü™®</label>
                            <div class="layer-color" style="background: #c45c26;"></div>
                        </div>
                        <div class="layer-item-2d" data-layer="faults">
                            <input type="checkbox" id="layerFaults2D" checked>
                            <label for="layerFaults2D">Sistema de Fallas ‚ö°</label>
                            <div class="layer-color" style="background: #c0392b;"></div>
                        </div>
                        <div class="layer-item-2d" data-layer="mineralization">
                            <input type="checkbox" id="layerMineralization2D">
                            <label for="layerMineralization2D">Zonas Mineralizadas üíé</label>
                            <div class="layer-color" style="background: #e6b800;"></div>
                        </div>
                        <div class="layer-item-2d" data-layer="sampling">
                            <input type="checkbox" id="layerSampling2D">
                            <label for="layerSampling2D">Puntos de Muestreo üî¨</label>
                            <div class="layer-color" style="background: #3498db;"></div>
                        </div>
                    </div>
                    
                    <div class="legend-container">
                        <div class="legend-item">
                            <div class="layer-color" style="background: #c45c26;"></div>
                            <span>Rocas sedimentarias</span>
                        </div>
                        <div class="legend-item">
                            <div class="layer-color" style="background: #8B4513;"></div>
                            <span>Rocas √≠gneas</span>
                        </div>
                        <div class="legend-item">
                            <div class="layer-color" style="background: #556B2F;"></div>
                            <span>Rocas metam√≥rficas</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Camera & Analysis -->
            <div class="page" id="pageCamera">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-camera"></i>
                        An√°lisis Fotogeol√≥gico üì∏
                    </h3>
                    
                    <div class="camera-container">
                        <video id="cameraFeed" autoplay playsinline></video>
                        <div class="camera-overlay">
                            <div>
                                <i class="fas fa-crosshairs"></i> Apunte a formaci√≥n geol√≥gica
                            </div>
                            <div id="cameraStatusText">
                                <i class="fas fa-circle" style="color: #ff4444;"></i> Inactiva
                            </div>
                        </div>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="button-grid-2">
                        <button class="btn btn-primary" id="startCameraBtn">
                            <i class="fas fa-video"></i> Activar C√°mara
                        </button>
                        <button class="btn btn-warning" id="captureBtn" disabled>
                            <i class="fas fa-camera"></i> Capturar
                        </button>
                        <button class="btn btn-success" id="analyzeBtn" disabled>
                            <i class="fas fa-robot"></i> Analizar IA
                        </button>
                        <button class="btn btn-danger" id="stopCameraBtn" disabled>
                            <i class="fas fa-stop"></i> Detener
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        Resultados del An√°lisis üìä
                    </h3>
                    <div id="analysisResults" class="geology-data">
                        <p style="text-align: center; color: #666; padding: 15px; font-size: 0.9rem;">
                            <i class="fas fa-microscope"></i><br>
                            Capture una imagen para iniciar el an√°lisis üîç
                        </p>
                    </div>
                </div>
            </div>

            <!-- Page 3: 3D Map -->
            <div class="page" id="page3DMap">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-globe-americas"></i>
                        Mapa 3D - Proyecci√≥n Geol√≥gica üåç
                    </h3>
                    
                    <div id="map3d"></div>
                    
                    <div class="button-grid-2">
                        <button class="btn btn-primary" id="generate3D">
                            <i class="fas fa-cube"></i> Generar 3D
                        </button>
                        <button class="btn btn-success" id="export3D">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-ruler-combined"></i>
                        Par√°metros Estructurales üìê
                    </h3>
                    <div id="structuralParams" class="geology-data">
                        <div class="data-item">
                            <span>Rumbo üß≠:</span>
                            <span id="paramRumbo">N.45¬∞E</span>
                        </div>
                        <div class="data-item">
                            <span>Buzamiento üìè:</span>
                            <span id="paramBuzamiento">30¬∞SE</span>
                        </div>
                        <div class="data-item">
                            <span>Espesor Estrato üìä:</span>
                            <span id="paramThickness">15.2 m</span>
                        </div>
                        <div class="data-item">
                            <span>Inclinaci√≥n üìê:</span>
                            <span id="paramInclination">22¬∞</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: AI Assistant -->
            <div class="page" id="pageAI">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-robot"></i>
                        Dr. GeoBot - Doctor en Geolog√≠a üë®‚Äçüî¨
                    </h3>
                    
                    <div class="ai-chat-container" id="chatContainer">
                        <div class="chat-message ai">
                            <strong>Dr. GeoBot üë®‚Äçüî¨:</strong> ¬°Hola! Soy el Dr. GeoBot, Doctor en Geolog√≠a especializado en Mineralog√≠a y Proyecci√≥n de Labores Mineras. ¬øEn qu√© puedo ayudarte hoy? üéØ
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" 
                               placeholder="Escribe tu consulta geol√≥gica...">
                        <button class="btn btn-primary" id="sendMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <div class="button-grid-2">
                        <button class="btn btn-success" id="analyzeLocation">
                            <i class="fas fa-map-marker-alt"></i> Analizar Ubicaci√≥n
                        </button>
                        <button class="btn btn-warning" id="suggestMethodology">
                            <i class="fas fa-flask"></i> Sugerir Metodolog√≠a
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-database"></i>
                        Base de Datos Geol√≥gica üíæ
                    </h3>
                    <div id="geologyDatabase" class="geology-data">
                        <div class="data-item">
                            <span>Rocas Identificadas ü™®:</span>
                            <span id="rockCount">12</span>
                        </div>
                        <div class="data-item">
                            <span>Minerales üíé:</span>
                            <span id="mineralCount">24</span>
                        </div>
                        <div class="data-item">
                            <span>Estructuras ‚ö°:</span>
                            <span id="structureCount">8</span>
                        </div>
                        <div class="data-item">
                            <span>Muestras Analizadas üî¨:</span>
                            <span id="sampleCount">5</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-btn active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>Inicio</span>
            </a>
            <a href="#" class="nav-btn" data-page="camera">
                <i class="fas fa-camera"></i>
                <span>C√°mara</span>
            </a>
            <a href="#" class="nav-btn" data-page="3DMap">
                <i class="fas fa-globe"></i>
                <span>3D</span>
            </a>
            <a href="#" class="nav-btn" data-page="AI">
                <i class="fas fa-robot"></i>
                <span>IA</span>
            </a>
        </nav>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <span id="notificationText">Mensaje de notificaci√≥n</span>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script>
        // ============================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ============================================
        const CONFIG = {
            MAPBOX_TOKEN: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA',
            GEOLOGY_DATABASE: {
                rocks: [
                    { name: 'Granito', type: '√çgnea', hardness: 7, color: '#8B4513' },
                    { name: 'Basalto', type: '√çgnea', hardness: 6, color: '#2F4F4F' },
                    { name: 'Esquisto', type: 'Metam√≥rfica', hardness: 4, color: '#556B2F' },
                    { name: 'M√°rmol', type: 'Metam√≥rfica', hardness: 3, color: '#D3D3D3' },
                    { name: 'Arenisca', type: 'Sedimentaria', hardness: 6, color: '#D2B48C' },
                    { name: 'Caliza', type: 'Sedimentaria', hardness: 3, color: '#F5F5DC' }
                ],
                minerals: [
                    { name: 'Cuarzo', formula: 'SiO‚ÇÇ', hardness: 7, color: 'Incoloro' },
                    { name: 'Feldespato', formula: 'KAlSi‚ÇÉO‚Çà', hardness: 6, color: 'Blanco/Rosa' },
                    { name: 'Mica', formula: 'KAl‚ÇÇ(AlSi‚ÇÉO‚ÇÅ‚ÇÄ)(OH)‚ÇÇ', hardness: 2.5, color: 'Negro/Plateado' },
                    { name: 'Calcita', formula: 'CaCO‚ÇÉ', hardness: 3, color: 'Incoloro/Blanco' },
                    { name: 'Hematita', formula: 'Fe‚ÇÇO‚ÇÉ', hardness: 6, color: 'Rojo/Marr√≥n' },
                    { name: 'Magnetita', formula: 'Fe‚ÇÉO‚ÇÑ', hardness: 6, color: 'Negro' }
                ]
            }
        };

        let map = null;
        let map3d = null;
        let currentLocation = null;
        let cameraStream = null;
        let isCameraActive = false;
        let watchId = null;
        let currentPhoto = null;
        
        // Capas 2D
        let geologyLayer = null;
        let faultsLayer = null;
        let mineralizationLayer = null;
        let samplingLayer = null;

        // ============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ AtacamApp - Iniciando aplicaci√≥n...');
            simulateLoading();
        });

        function simulateLoading() {
            let progress = 0;
            const messages = [
                'Cargando m√≥dulo GPS... üõ∞Ô∏è',
                'Inicializando c√°mara... üì∏',
                'Configurando mapas... üó∫Ô∏è',
                'Conectando con Dr. GeoBot... üë®‚Äçüî¨',
                'Cargando base de datos... üíæ',
                '¬°Listo para explorar! üèúÔ∏è'
            ];
            
            const interval = setInterval(() => {
                progress += 20;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('loadingText').textContent = messages[progress / 20 - 1];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('splashScreen').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        initializeApp();
                    }, 500);
                }
            }, 300);
        }

        function initializeApp() {
            console.log('‚úÖ Aplicaci√≥n cargada - Inicializando componentes...');
            
            // Inicializar navegaci√≥n
            setupNavigation();
            
            // Inicializar mapas
            init2DMap();
            init3DMap();
            
            // Configurar eventos
            setupEventListeners();
            
            // Solicitar permisos iniciales
            setTimeout(() => {
                showNotification('¬°Bienvenido a AtacamApp! üèúÔ∏è', 'success');
            }, 1000);
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.dataset.page;
                    switchPage(pageId);
                });
            });
        }

        function switchPage(pageId) {
            // Ocultar todas las p√°ginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar p√°gina seleccionada
            const targetPage = document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1));
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Actualizar navegaci√≥n
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active');
                }
            });
            
            // Acciones espec√≠ficas por p√°gina
            switch(pageId) {
                case 'camera':
                    if (!isCameraActive) {
                        showNotification('Activa la c√°mara para an√°lisis üì∏', 'info');
                    }
                    break;
                case '3DMap':
                    if (currentLocation && map3d) {
                        update3DMapLocation();
                    }
                    break;
            }
        }

        // ============================================
        // GPS - CONEXI√ìN SIMPLIFICADA
        // ============================================
        function setupEventListeners() {
            // Bot√≥n GPS simplificado
            document.getElementById('gpsBtn').addEventListener('click', toggleGPS);
            document.getElementById('connectGPSBtn').addEventListener('click', toggleGPS);

            // Bot√≥n c√°mara
            document.getElementById('cameraBtn').addEventListener('click', toggleCamera);

            // Controles de c√°mara
            document.getElementById('startCameraBtn').addEventListener('click', () => toggleCamera(true));
            document.getElementById('stopCameraBtn').addEventListener('click', () => toggleCamera(false));
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeWithAI);

            // Controles 3D
            document.getElementById('generate3D').addEventListener('click', generate3DProjection);
            document.getElementById('export3D').addEventListener('click', export3DModel);

            // IA
            document.getElementById('sendMessage').addEventListener('click', sendMessageToAI);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessageToAI();
            });
            document.getElementById('analyzeLocation').addEventListener('click', analyzeLocationWithAI);
            document.getElementById('suggestMethodology').addEventListener('click', suggestMethodology);

            // Controles de capas 2D
            document.querySelectorAll('.layer-item-2d input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', update2DLayers);
            });
        }

        function toggleGPS() {
            if (!navigator.geolocation) {
                showNotification('GPS no soportado ‚ùå', 'error');
                return;
            }
            
            const gpsBtn = document.getElementById('gpsBtn');
            const connectBtn = document.getElementById('connectGPSBtn');
            
            if (currentLocation) {
                // Desconectar GPS
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                currentLocation = null;
                gpsBtn.classList.remove('active');
                connectBtn.innerHTML = '<i class="fas fa-satellite"></i> Conectar GPS üì°';
                updateLocationDisplay();
                showNotification('GPS desconectado üì°', 'info');
            } else {
                // Conectar GPS
                gpsBtn.innerHTML = '<span class="loading"></span>';
                gpsBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading"></span>';
                connectBtn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        handleGPSPosition(position);
                        gpsBtn.innerHTML = '<i class="fas fa-satellite"></i>';
                        gpsBtn.classList.add('active');
                        gpsBtn.disabled = false;
                        connectBtn.innerHTML = '<i class="fas fa-satellite"></i> Desconectar GPS üì°';
                        connectBtn.disabled = false;
                        startGPSWatching();
                    },
                    (error) => {
                        handleGPSError(error);
                        gpsBtn.innerHTML = '<i class="fas fa-satellite"></i>';
                        gpsBtn.disabled = false;
                        connectBtn.innerHTML = '<i class="fas fa-satellite"></i> Conectar GPS üì°';
                        connectBtn.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        }

        function handleGPSPosition(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                altitude: position.coords.altitude || 0,
                accuracy: position.coords.accuracy,
                heading: position.coords.heading || 0,
                speed: position.coords.speed || 0,
                timestamp: new Date(position.timestamp)
            };

            updateLocationDisplay();
            update2DMapLocation();
            update3DMapLocation();
            updateGeologicalData();

            showNotification(`GPS conectado (${Math.round(currentLocation.accuracy)}m) üéØ`, 'success');
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            let message = 'Error GPS: ';
            switch(error.code) {
                case 1:
                    message += 'Permiso denegado üîí';
                    break;
                case 2:
                    message += 'Posici√≥n no disponible üì°';
                    break;
                case 3:
                    message += 'Timeout ‚è∞';
                    break;
                default:
                    message += 'Error desconocido ‚ùå';
            }
            
            showNotification(message, 'error');
        }

        function startGPSWatching() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            watchId = navigator.geolocation.watchPosition(
                handleGPSPosition,
                handleGPSError,
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function updateLocationDisplay() {
            if (!currentLocation) {
                document.getElementById('latitudeValue').textContent = '--';
                document.getElementById('longitudeValue').textContent = '--';
                document.getElementById('altitudeValue').textContent = '--';
                document.getElementById('accuracyValue').textContent = '--';
                return;
            }

            document.getElementById('latitudeValue').textContent = currentLocation.latitude.toFixed(6);
            document.getElementById('longitudeValue').textContent = currentLocation.longitude.toFixed(6);
            document.getElementById('altitudeValue').textContent = 
                currentLocation.altitude ? `${currentLocation.altitude.toFixed(0)} m` : '--';
            document.getElementById('accuracyValue').textContent = `${Math.round(currentLocation.accuracy)} m`;
        }

        // ============================================
        // C√ÅMARA
        // ============================================
        async function toggleCamera(activate = null) {
            const cameraBtn = document.getElementById('cameraBtn');
            
            if (activate === null) {
                activate = !isCameraActive;
            }
            
            if (activate && !isCameraActive) {
                // Activar c√°mara
                cameraBtn.innerHTML = '<span class="loading"></span>';
                cameraBtn.disabled = true;
                
                const success = await startCamera();
                if (success) {
                    cameraBtn.innerHTML = '<i class="fas fa-camera"></i>';
                    cameraBtn.classList.add('active');
                    cameraBtn.disabled = false;
                } else {
                    cameraBtn.innerHTML = '<i class="fas fa-camera"></i>';
                    cameraBtn.disabled = false;
                }
            } else if (!activate && isCameraActive) {
                // Desactivar c√°mara
                stopCamera();
                cameraBtn.classList.remove('active');
            }
        }

        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraFeed');
                video.srcObject = cameraStream;

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                document.getElementById('captureBtn').disabled = false;
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('stopCameraBtn').disabled = false;
                document.getElementById('startCameraBtn').disabled = true;

                document.getElementById('cameraStatusText').innerHTML = 
                    '<i class="fas fa-circle" style="color:#00ff00;"></i> ACTIVA';

                isCameraActive = true;
                showNotification('C√°mara activada üì∏', 'success');
                return true;

            } catch (error) {
                console.error('Error c√°mara:', error);
                showNotification('Error al activar c√°mara ‚ùå', 'error');
                return false;
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('cameraFeed');
            video.srcObject = null;

            document.getElementById('captureBtn').disabled = true;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = true;
            document.getElementById('startCameraBtn').disabled = false;

            document.getElementById('cameraStatusText').innerHTML = 
                '<i class="fas fa-circle" style="color:#ff4444;"></i> INACTIVA';

            isCameraActive = false;
            showNotification('C√°mara detenida üì∑', 'info');
        }

        function capturePhoto() {
            if (!isCameraActive) {
                showNotification('Activa la c√°mara primero üì∏', 'warning');
                return;
            }

            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            currentPhoto = {
                data: canvas.toDataURL('image/jpeg'),
                timestamp: new Date().toISOString(),
                location: currentLocation,
                analysis: null
            };

            showNotification('Foto capturada! Analiza con IA ü§ñ', 'success');
            document.getElementById('analyzeBtn').focus();
        }

        // ============================================
        // MAPA 2D - MEJORADO CON CAPAS GEOL√ìGICAS
        // ============================================
        function init2DMap() {
            try {
                map = L.map('map').setView([-27.3667, -70.3333], 10);

                // Capa base OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap',
                    maxZoom: 19
                }).addTo(map);

                // Capa satelital
                const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    attribution: 'Google Satellite',
                    maxZoom: 20
                });

                // Capas base
                const baseLayers = {
                    "Mapa üó∫Ô∏è": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                    "Sat√©lite üõ∞Ô∏è": satelliteLayer
                };

                L.control.layers(baseLayers).addTo(map);

                // Inicializar capas geol√≥gicas
                initGeologicalLayers();

                console.log('‚úÖ Mapa 2D inicializado');

            } catch (error) {
                console.error('Error inicializando mapa 2D:', error);
                showNotification('Error al cargar mapa ‚ùå', 'error');
            }
        }

        function initGeologicalLayers() {
            // Capa de geolog√≠a
            geologyLayer = L.layerGroup();
            
            // Capa de fallas
            faultsLayer = L.layerGroup();
            
            // Capa de mineralizaci√≥n
            mineralizationLayer = L.layerGroup();
            
            // Capa de muestreo
            samplingLayer = L.layerGroup();
            
            // A√±adir capas al mapa
            geologyLayer.addTo(map);
            faultsLayer.addTo(map);
            
            // Capas de control
            const overlayLayers = {
                "Geolog√≠a ü™®": geologyLayer,
                "Fallas ‚ö°": faultsLayer,
                "Mineralizaci√≥n üíé": mineralizationLayer,
                "Muestreo üî¨": samplingLayer
            };
            
            L.control.layers(null, overlayLayers).addTo(map);
        }

        function update2DMapLocation() {
            if (!map || !currentLocation) return;

            const latLng = [currentLocation.latitude, currentLocation.longitude];
            map.setView(latLng, 15);

            // Limpiar marcadores
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer._icon && layer._icon.className.includes('current-marker')) {
                    map.removeLayer(layer);
                }
            });

            // A√±adir marcador actual
            L.marker(latLng, {
                icon: L.divIcon({
                    className: 'current-marker',
                    html: '<div style="background:#c45c26;color:white;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [35, 35],
                    iconAnchor: [17, 35]
                })
            }).addTo(map).bindPopup('Ubicaci√≥n actual üéØ');

            // Actualizar datos geol√≥gicos
            updateGeologicalData2D();
        }

        function updateGeologicalData2D() {
            if (!map || !currentLocation || !geologyLayer) return;

            // Limpiar capas existentes
            geologyLayer.clearLayers();
            faultsLayer.clearLayers();
            mineralizationLayer.clearLayers();
            samplingLayer.clearLayers();

            const centerLat = currentLocation.latitude;
            const centerLng = currentLocation.longitude;

            // Generar datos geol√≥gicos simulados
            for (let i = 0; i < 15; i++) {
                const lat = centerLat + (Math.random() - 0.5) * 0.015;
                const lng = centerLng + (Math.random() - 0.5) * 0.015;
                
                // Puntos geol√≥gicos
                L.circleMarker([lat, lng], {
                    color: '#c45c26',
                    fillColor: '#c45c26',
                    radius: 4,
                    fillOpacity: 0.7
                }).addTo(geologyLayer);

                // L√≠neas de falla
                if (i % 3 === 0) {
                    const lat2 = lat + Math.random() * 0.008;
                    const lng2 = lng + Math.random() * 0.008;
                    L.polyline([[lat, lng], [lat2, lng2]], {
                        color: '#c0392b',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '5, 5'
                    }).addTo(faultLayer);
                }

                // Zonas mineralizadas
                if (i % 5 === 0) {
                    L.circle([lat, lng], {
                        color: '#e6b800',
                        fillColor: '#e6b800',
                        fillOpacity: 0.2,
                        radius: 80
                    }).addTo(mineralizationLayer);
                }

                // Puntos de muestreo
                if (i % 4 === 0) {
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'sample-marker',
                            html: '<div style="background:#3498db;color:white;width:25px;height:25px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;">üî¨</div>',
                            iconSize: [25, 25],
                            iconAnchor: [12, 25]
                        })
                    }).addTo(samplingLayer).bindPopup(`Muestra ${i+1}<br>Coords: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                }
            }

            // A√±adir c√≠rculo de precisi√≥n GPS
            L.circle([centerLat, centerLng], {
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.1,
                radius: currentLocation.accuracy
            }).addTo(map);
        }

        function update2DLayers() {
            const layers = {
                'geology': document.getElementById('layerGeology2D').checked,
                'faults': document.getElementById('layerFaults2D').checked,
                'mineralization': document.getElementById('layerMineralization2D').checked,
                'sampling': document.getElementById('layerSampling2D').checked
            };

            // Mostrar/ocultar capas
            if (geologyLayer) {
                if (layers.geology) {
                    map.addLayer(geologyLayer);
                } else {
                    map.removeLayer(geologyLayer);
                }
            }
            
            if (faultsLayer) {
                if (layers.faults) {
                    map.addLayer(faultsLayer);
                } else {
                    map.removeLayer(faultsLayer);
                }
            }
            
            if (mineralizationLayer) {
                if (layers.mineralization) {
                    map.addLayer(mineralizationLayer);
                } else {
                    map.removeLayer(mineralizationLayer);
                }
            }
            
            if (samplingLayer) {
                if (layers.sampling) {
                    map.addLayer(samplingLayer);
                } else {
                    map.removeLayer(samplingLayer);
                }
            }
        }

        // ============================================
        // MAPA 3D
        // ============================================
        function init3DMap() {
            try {
                mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;

                map3d = new mapboxgl.Map({
                    container: 'map3d',
                    style: 'mapbox://styles/mapbox/satellite-v9',
                    center: [-70.3333, -27.3667],
                    zoom: 10,
                    pitch: 45,
                    bearing: 0
                });

                map3d.on('load', () => {
                    console.log('‚úÖ Mapa 3D inicializado');
                    
                    map3d.addSource('mapbox-dem', {
                        'type': 'raster-dem',
                        'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        'tileSize': 512,
                        'maxzoom': 14
                    });
                    
                    map3d.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                });

            } catch (error) {
                console.error('Error inicializando mapa 3D:', error);
            }
        }

        function update3DMapLocation() {
            if (!map3d || !currentLocation) return;

            map3d.flyTo({
                center: [currentLocation.longitude, currentLocation.latitude],
                zoom: 14,
                pitch: 60,
                bearing: 0,
                duration: 1500
            });
        }

        function generate3DProjection() {
            if (!currentLocation) {
                showNotification('Conecta GPS primero üõ∞Ô∏è', 'warning');
                return;
            }

            showNotification('Generando proyecci√≥n 3D... üîÑ', 'info');

            setTimeout(() => {
                updateStructuralParameters();
                showNotification('Proyecci√≥n 3D generada! üåç', 'success');
            }, 1500);
        }

        function updateStructuralParameters() {
            if (!currentLocation) return;

            const rumbos = ['N.45¬∞E', 'N.30¬∞E', 'N.60¬∞E', 'N.15¬∞W'];
            const buzamientos = ['30¬∞SE', '45¬∞NW', '25¬∞SW', '60¬∞NE'];
            const espesores = ['15.2 m', '22.8 m', '8.5 m', '31.6 m'];
            const inclinaciones = ['22¬∞', '35¬∞', '18¬∞', '42¬∞'];

            const index = Math.floor(Math.random() * 4);

            document.getElementById('paramRumbo').textContent = rumbos[index];
            document.getElementById('paramBuzamiento').textContent = buzamientos[index];
            document.getElementById('paramThickness').textContent = espesores[index];
            document.getElementById('paramInclination').textContent = inclinaciones[index];
        }

        function export3DModel() {
            if (!currentLocation) {
                showNotification('Genera proyecci√≥n 3D primero üåç', 'warning');
                return;
            }

            showNotification('Exportando modelo 3D... üì§', 'info');

            setTimeout(() => {
                const data = {
                    location: currentLocation,
                    parameters: {
                        rumbo: document.getElementById('paramRumbo').textContent,
                        buzamiento: document.getElementById('paramBuzamiento').textContent,
                        espesor: document.getElementById('paramThickness').textContent,
                        inclinacion: document.getElementById('paramInclination').textContent
                    },
                    timestamp: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modelo_3d_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Modelo exportado! üíæ', 'success');
            }, 1000);
        }

        // ============================================
        // IA - DR. GEOBOT
        // ============================================
        async function sendMessageToAI() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            input.focus();

            const thinkingId = addMessageToChat('ai', 'Analizando... üîç');

            setTimeout(() => {
                const response = generateAIResponse(message);
                updateMessage(thinkingId, 'ai', response);
            }, 1200);
        }

        function addMessageToChat(sender, text) {
            const chatContainer = document.getElementById('chatContainer');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = `<strong>${sender === 'ai' ? 'Dr. GeoBot üë®‚Äçüî¨:' : 'T√∫ üßë‚Äçüíº:'}</strong> ${text}`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageId;
        }

        function updateMessage(messageId, sender, text) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.innerHTML = `<strong>${sender === 'ai' ? 'Dr. GeoBot üë®‚Äçüî¨:' : 'T√∫ üßë‚Äçüíº:'}</strong> ${text}`;
            }
        }

        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('roca') || lowerMessage.includes('identificar')) {
                return `üèúÔ∏è <strong>An√°lisis Litol√≥gico:</strong><br><br>
                ‚Ä¢ <strong>Andesita:</strong> Volc√°nica, plagioclasa + piroxeno<br>
                ‚Ä¢ <strong>Granito:</strong> √çgnea intrusiva, textura faner√≠tica<br>
                ‚Ä¢ <strong>Esquisto:</strong> Metam√≥rfica, foliaci√≥n marcada<br>
                ‚Ä¢ <strong>Arenisca:</strong> Sedimentaria, clastos de cuarzo<br><br>
                <strong>Recomendaci√≥n:</strong> An√°lisis petrogr√°fico üî¨`;
            }
            
            if (lowerMessage.includes('falla') || lowerMessage.includes('estructura')) {
                return `‚ö° <strong>An√°lisis Estructural:</strong><br><br>
                ‚Ä¢ <strong>Orientaci√≥n:</strong> NNE-SSO predominante<br>
                ‚Ä¢ <strong>Tipo:</strong> Falla inversa con componente dextral<br>
                ‚Ä¢ <strong>Buzamiento:</strong> 45-60¬∞ hacia el SE<br>
                ‚Ä¢ <strong>Mineralizaci√≥n:</strong> Control estructural de vetas Cu-Mo<br><br>
                <strong>Metodolog√≠a:</strong> Mapeo + estereograma üìê`;
            }
            
            if (lowerMessage.includes('mineral') || lowerMessage.includes('yacimiento')) {
                return `üíé <strong>An√°lisis Mineral√≥gico:</strong><br><br>
                ‚Ä¢ <strong>Parag√©nesis:</strong> Cuarzo + Calcopirita + Bornita<br>
                ‚Ä¢ <strong>Temperatura:</strong> 250-350¬∞C (inclusiones fluidas)<br>
                ‚Ä¢ <strong>Ley estimada:</strong> 0.8-1.2% Cu, 0.3-0.5 g/t Au<br>
                ‚Ä¢ <strong>Potencial:</strong> P√≥rfido cupr√≠fero econ√≥mico<br><br>
                <strong>Recomendaci√≥n:</strong> Perforaci√≥n diamantina ‚õèÔ∏è`;
            }
            
            return `üë®‚Äçüî¨ <strong>Dr. GeoBot:</strong><br><br>
            Especialista en:<br>
            ‚Ä¢ Geolog√≠a econ√≥mica y mineralog√≠a<br>
            ‚Ä¢ Proyecci√≥n 3D de yacimientos<br>
            ‚Ä¢ Dise√±o de labores mineras<br>
            ‚Ä¢ An√°lisis estructural avanzado<br><br>
            ¬øEn qu√© aspecto necesitas ayuda? üéØ`;
        }

        function analyzeLocationWithAI() {
            if (!currentLocation) {
                showNotification('Conecta GPS primero üõ∞Ô∏è', 'warning');
                return;
            }

            const message = addMessageToChat('ai', 'Analizando ubicaci√≥n... üó∫Ô∏è');

            setTimeout(() => {
                const response = `üìç <strong>An√°lisis de Ubicaci√≥n:</strong><br><br>
                <strong>Coordenadas:</strong> ${currentLocation.latitude.toFixed(4)}¬∞S, ${currentLocation.longitude.toFixed(4)}¬∞W<br>
                <strong>Contexto:</strong> Desierto de Atacama - Cordillera de los Andes<br>
                <strong>Litolog√≠a:</strong> Volc√°nicos andes√≠ticos + sedimentos terciarios<br>
                <strong>Estructuras:</strong> Sistema de fallas NNE-SSO<br>
                <strong>Potencial:</strong> Mineralizaci√≥n cupr√≠fera tipo p√≥rfido<br><br>
                <strong>Recomendaciones:</strong><br>
                1. Mapeo geol√≥gico detallado<br>
                2. Geoqu√≠mica de suelos<br>
                3. Perforaci√≥n exploratoria`;
                
                updateMessage(message, 'ai', response);
            }, 1500);
        }

        function suggestMethodology() {
            const message = addMessageToChat('ai', 'Generando metodolog√≠a... üìã');

            setTimeout(() => {
                const response = `üî¨ <strong>Metodolog√≠a de Campo:</strong><br><br>
                <strong>1. Mapeo:</strong><br>
                ‚Ä¢ GPS alta precisi√≥n (¬±1m)<br>
                ‚Ä¢ Fotograf√≠a geol√≥gica con escala<br>
                ‚Ä¢ Descripci√≥n litol√≥gica detallada<br><br>
                <strong>2. Muestreo:</strong><br>
                ‚Ä¢ Sistem√°tico cada 50m<br>
                ‚Ä¢ Muestras de mano (500g)<br>
                ‚Ä¢ Documentaci√≥n fotogr√°fica<br><br>
                <strong>3. An√°lisis:</strong><br>
                ‚Ä¢ Petrogr√°fico (l√°minas delgadas)<br>
                ‚Ä¢ Geoqu√≠mico (ICP-MS)<br>
                ‚Ä¢ Estructural (estereograma)<br><br>
                <strong>Equipo:</strong> Br√∫jula, martillo, lupa, GPS`;
                
                updateMessage(message, 'ai', response);
            }, 1200);
        }

        function analyzeWithAI() {
            if (!currentPhoto) {
                showNotification('Captura una imagen primero üì∏', 'warning');
                return;
            }

            showNotification('Analizando imagen... ü§ñ', 'info');

            setTimeout(() => {
                const rockTypes = CONFIG.GEOLOGY_DATABASE.rocks;
                const minerals = CONFIG.GEOLOGY_DATABASE.minerals;
                
                const randomRock = rockTypes[Math.floor(Math.random() * rockTypes.length)];
                const randomMineral = minerals[Math.floor(Math.random() * minerals.length)];
                const confidence = (90 + Math.random() * 8).toFixed(1);

                const analysisHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>üéØ An√°lisis IA - ${confidence}% Confianza</strong>
                    </div>
                    <div class="data-item">
                        <span>Roca:</span>
                        <span>${randomRock.name} (${randomRock.type})</span>
                    </div>
                    <div class="data-item">
                        <span>Mineral:</span>
                        <span>${randomMineral.name}</span>
                    </div>
                    <div class="data-item">
                        <span>Dureza:</span>
                        <span>${randomRock.hardness}/10</span>
                    </div>
                    <div class="data-item">
                        <span>Ubicaci√≥n:</span>
                        <span>${currentLocation ? `${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞` : '--'}</span>
                    </div>
                `;

                document.getElementById('analysisResults').innerHTML = analysisHTML;
                showNotification('An√°lisis completado! ‚úÖ', 'success');

                updateDatabaseCounts();
            }, 2000);
        }

        function updateGeologicalData() {
            if (!currentLocation) return;
            updateDatabaseCounts();
        }

        function updateDatabaseCounts() {
            document.getElementById('rockCount').textContent = CONFIG.GEOLOGY_DATABASE.rocks.length;
            document.getElementById('mineralCount').textContent = CONFIG.GEOLOGY_DATABASE.minerals.length;
            document.getElementById('structureCount').textContent = '8';
            
            if (currentPhoto) {
                const currentCount = parseInt(document.getElementById('sampleCount').textContent);
                document.getElementById('sampleCount').textContent = currentCount + 1;
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function showNotification(message, type = 'info', permanent = false) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');

            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            notification.style.display = 'flex';

            if (!permanent) {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 2500);
            }
        }

        // ============================================
        // INICIALIZACI√ìN AUTOM√ÅTICA
        // ============================================
        setTimeout(() => {
            addMessageToChat('ai', `üë®‚Äçüî¨ <strong>Dr. GeoBot:</strong><br><br>
            ¬°Bienvenido a AtacamApp! üèúÔ∏è<br><br>
            <strong>Para comenzar:</strong><br>
            1. üì° Conecta GPS para ubicaci√≥n<br>
            2. üì∏ Activa c√°mara para an√°lisis<br>
            3. üó∫Ô∏è Explora capas geol√≥gicas 2D<br>
            4. üåç Genera proyecciones 3D<br><br>
            <strong>¬°Listo para explorar el desierto!</strong> üöÄ`);
        }, 1500);
    </script>
</body>
</html>
