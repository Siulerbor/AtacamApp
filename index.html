<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AtacamApp - Geología en Tiempo Real</title>
    <link rel="manifest" href='{"name":"AtacamApp","short_name":"AtacamApp","start_url":".","display":"standalone","background_color":"#2c3e50","theme_color":"#2c3e50","icons":[{"src":"data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23d35400%22>⛰️</text></svg>","sizes":"any","type":"image/svg+xml"}]}'>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23d35400%22>⛰️</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Pantalla de Permisos Obligatorios */
        .permission-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50, #1a1a1a);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .permission-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid #d35400;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .permission-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .permission-requirements {
            margin: 30px 0;
            text-align: left;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #d35400;
        }

        .requirement-item.required {
            border-left-color: #e74c3c;
        }

        .requirement-icon {
            font-size: 1.5rem;
            color: #d35400;
        }

        .requirement-item.required .requirement-icon {
            color: #e74c3c;
        }

        .app-container {
            display: none;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
        }

        .app-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 2px solid #d35400;
        }

        .app-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            min-width: 120px;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #d35400;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* CÁMARA - OBLIGATORIA */
        .camera-section {
            position: relative;
            margin-bottom: 20px;
        }

        .camera-container {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 3px solid #2c3e50;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .camera-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .camera-controls.full {
            grid-template-columns: 1fr;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #d35400, #e67e22);
            color: white;
        }

        .btn-secondary {
            background: #3498db;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        /* MAPA - OBLIGATORIO */
        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            border: 3px solid #2c3e50;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .map-controls .btn {
            flex: 1;
        }

        /* MINERALES IDENTIFICADOS */
        .identified-minerals {
            margin-top: 20px;
        }

        .minerals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .mineral-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .mineral-card.active {
            border-color: #d35400;
            background: #fff5eb;
        }

        .mineral-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #d35400;
        }

        /* BRÚJULA REAL */
        .compass-section {
            text-align: center;
            padding: 20px;
        }

        .compass-container {
            width: 250px;
            height: 250px;
            margin: 20px auto;
            position: relative;
        }

        .compass-rose {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #e74c3c 0deg 45deg,
                #3498db 45deg 135deg,
                #27ae60 135deg 225deg,
                #f39c12 225deg 315deg,
                #e74c3c 315deg 360deg
            );
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 100px;
            background: #000;
            transform-origin: center 0;
            transition: transform 0.1s;
            z-index: 2;
        }

        .compass-needle::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            border-radius: 50%;
        }

        .compass-direction {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 20px;
            color: #2c3e50;
        }

        .compass-degrees {
            font-size: 1.5rem;
            color: #666;
            margin-top: 10px;
        }

        /* INFORMES */
        .report-section {
            margin-top: 20px;
        }

        .report-form {
            margin-top: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .report-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
        }

        /* HERRAMIENTAS */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .tool-btn {
            background: #ecf0f1;
            border: none;
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-btn:active {
            transform: scale(0.95);
            background: #d5dbdb;
        }

        .tool-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        /* NOTIFICACIONES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* RESPONSIVE */
        @media (min-width: 768px) {
            .app-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                max-width: 1200px;
            }

            .camera-section {
                grid-column: 1;
                grid-row: 1;
            }

            .map-section {
                grid-column: 2;
                grid-row: 1;
            }

            .minerals-section {
                grid-column: 1;
                grid-row: 2;
            }

            .compass-section {
                grid-column: 2;
                grid-row: 2;
            }

            .report-section {
                grid-column: 1;
                grid-row: 3;
            }

            .tools-section {
                grid-column: 2;
                grid-row: 3;
            }

            .camera-container, .map-container {
                height: 350px;
            }
        }

        /* ANIMACIONES */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .shake {
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Permisos Obligatorios -->
    <div class="permission-screen" id="permissionScreen">
        <div class="permission-content">
            <h2><i class="fas fa-shield-alt"></i> AtacamApp</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 1.1rem;">
                <strong>REQUISITOS OBLIGATORIOS</strong><br>
                La aplicación requiere acceso completo para funcionar
            </p>
            
            <div class="permission-requirements">
                <div class="requirement-item required">
                    <div class="requirement-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div>
                        <strong>CÁMARA DEL DISPOSITIVO</strong>
                        <div style="font-size: 0.9rem; color: #666;">
                            Obligatorio para identificar minerales
                        </div>
                    </div>
                </div>
                
                <div class="requirement-item required">
                    <div class="requirement-icon">
                        <i class="fas fa-satellite"></i>
                    </div>
                    <div>
                        <strong>GPS PRECISO</strong>
                        <div style="font-size: 0.9rem; color: #666;">
                            Obligatorio para geolocalización
                        </div>
                    </div>
                </div>
                
                <div class="requirement-item">
                    <div class="requirement-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div>
                        <strong>MAPA GEOLÓGICO</strong>
                        <div style="font-size: 0.9rem; color: #666;">
                            Se activará automáticamente
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 25px 0; padding: 15px; background: #fff5eb; border-radius: 10px; border: 2px solid #f39c12;">
                <i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i>
                <strong> Importante:</strong> Sin estos permisos la aplicación NO funcionará
            </div>
            
            <button class="btn btn-primary" id="activateAll" style="padding: 15px 30px; font-size: 1.1rem; width: 100%;">
                <i class="fas fa-check-circle"></i> ACTIVAR TODAS LAS FUNCIONES
            </button>
            
            <div style="margin-top: 20px; font-size: 0.9rem; color: #999;">
                <i class="fas fa-lock"></i> Los datos se mantienen en tu dispositivo
            </div>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div class="app-container" id="mainApp">
        <!-- Notificaciones -->
        <div id="notificationContainer"></div>

        <!-- Cabecera -->
        <header class="app-header" style="grid-column: 1 / -1;">
            <h1><i class="fas fa-mountain"></i> AtacamApp</h1>
            <p style="opacity: 0.9; margin-bottom: 10px;">Sistema Geológico Profesional - Región de Atacama</p>
            
            <div class="status-bar">
                <div class="status-item" id="cameraStatus">
                    <i class="fas fa-camera"></i> <span>Cámara: --</span>
                </div>
                <div class="status-item" id="gpsStatus">
                    <i class="fas fa-satellite"></i> <span>GPS: --</span>
                </div>
                <div class="status-item" id="locationStatus">
                    <i class="fas fa-map-marker-alt"></i> <span>Ubicación: --</span>
                </div>
                <div class="status-item" id="compassStatus">
                    <i class="fas fa-compass"></i> <span>Brújula: --</span>
                </div>
            </div>
        </header>

        <!-- Sección 1: Cámara en Tiempo Real -->
        <section class="card camera-section">
            <h2><i class="fas fa-camera"></i> Identificación en Tiempo Real</h2>
            
            <div class="camera-container">
                <video id="cameraFeed" autoplay playsinline></video>
                <canvas id="cameraCanvas" style="display:none;"></canvas>
                
                <div class="camera-overlay">
                    <div>
                        <i class="fas fa-crosshairs"></i> Apunte al mineral
                    </div>
                    <div id="cameraTimer" style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                        EN VIVO
                    </div>
                </div>
            </div>
            
            <div class="camera-controls full">
                <button class="btn btn-primary" id="captureMineral">
                    <i class="fas fa-camera"></i> CAPTURAR MINERAL
                </button>
            </div>
            
            <div id="captureResult" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <h3><i class="fas fa-check-circle" style="color: #27ae60;"></i> Mineral Identificado</h3>
                <div id="identifiedMineralInfo"></div>
            </div>
        </section>

        <!-- Sección 2: Mapa Geológico -->
        <section class="card map-section">
            <h2><i class="fas fa-map-marked-alt"></i> Mapa Geológico</h2>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="map-controls">
                <button class="btn btn-secondary" id="centerMap">
                    <i class="fas fa-location-arrow"></i> Mi Ubicación
                </button>
                <button class="btn btn-primary" id="addMarker">
                    <i class="fas fa-map-pin"></i> Marcar Punto
                </button>
            </div>
            
            <div id="mapInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 10px; font-size: 0.9rem;">
                <strong><i class="fas fa-info-circle"></i> Coordenadas:</strong>
                <span id="currentCoords">Esperando GPS...</span>
            </div>
        </section>

        <!-- Sección 3: Minerales Identificados -->
        <section class="card minerals-section">
            <h2><i class="fas fa-gem"></i> Minerales Identificados</h2>
            
            <div id="identifiedMineralsContainer" style="min-height: 200px;">
                <div id="noMinerals" style="text-align: center; padding: 40px 20px; color: #666;">
                    <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                    <p>Usa la cámara para identificar minerales</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Los minerales aparecerán aquí automáticamente</p>
                </div>
                
                <div class="minerals-grid" id="mineralsGrid" style="display: none;"></div>
            </div>
            
            <div class="camera-controls" style="margin-top: 15px;">
                <button class="btn btn-warning" id="clearMinerals">
                    <i class="fas fa-trash"></i> Limpiar Todo
                </button>
            </div>
        </section>

        <!-- Sección 4: Brújula Digital -->
        <section class="card compass-section">
            <h2><i class="fas fa-compass"></i> Brújula Digital</h2>
            
            <div class="compass-container">
                <div class="compass-rose" id="compassRose">
                    <div class="compass-needle" id="compassNeedle"></div>
                </div>
            </div>
            
            <div class="compass-direction" id="compassDirection">
                NORTE
            </div>
            
            <div class="compass-degrees" id="compassDegrees">
                0°
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>Calibración Automática:</strong>
                    <div id="calibrationStatus" style="background: #27ae60; color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8rem;">
                        ACTIVA
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #666;">
                    Gira el dispositivo para calibrar automáticamente. La brújula se ajusta usando el GPS del dispositivo.
                </p>
            </div>
        </section>

        <!-- Sección 5: Informe Rápido -->
        <section class="card report-section">
            <h2><i class="fas fa-file-alt"></i> Informe Rápido</h2>
            
            <div class="report-form">
                <input type="text" class="form-control" id="reportTitle" placeholder="Título del informe" required>
                <textarea class="form-control" id="reportNotes" rows="3" placeholder="Observaciones y notas..." required></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-success" id="generateReport">
                        <i class="fas fa-file-medical"></i> Generar
                    </button>
                    <button class="btn btn-secondary" id="viewReports">
                        <i class="fas fa-eye"></i> Ver
                    </button>
                </div>
            </div>
            
            <div class="report-preview" id="reportPreview">
                <div style="text-align: center; padding: 20px; color: #666;">
                    <i class="fas fa-file-alt" style="font-size: 2rem;"></i>
                    <p style="margin-top: 10px;">El informe aparecerá aquí</p>
                </div>
            </div>
        </section>

        <!-- Sección 6: Herramientas -->
        <section class="card tools-section">
            <h2><i class="fas fa-tools"></i> Herramientas</h2>
            
            <div class="tools-grid">
                <button class="tool-btn" data-tool="mohs">
                    <div class="tool-icon"><i class="fas fa-gem"></i></div>
                    <div>Escala Mohs</div>
                </button>
                <button class="tool-btn" data-tool="converter">
                    <div class="tool-icon"><i class="fas fa-balance-scale"></i></div>
                    <div>Conversor</div>
                </button>
                <button class="tool-btn" data-tool="streak">
                    <div class="tool-icon"><i class="fas fa-palette"></i></div>
                    <div>Colores Raya</div>
                </button>
                <button class="tool-btn" data-tool="weather">
                    <div class="tool-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div>Clima</div>
                </button>
                <button class="tool-btn" data-tool="geology">
                    <div class="tool-icon"><i class="fas fa-mountain"></i></div>
                    <div>Geología Atacama</div>
                </button>
                <button class="tool-btn" data-tool="export">
                    <div class="tool-icon"><i class="fas fa-download"></i></div>
                    <div>Exportar</div>
                </button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>Sincronización:</strong>
                    <div id="syncStatus" style="background: #27ae60; color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8rem;">
                        ACTIVA
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    Todos los datos están sincronizados en tiempo real
                </p>
            </div>
        </section>
    </div>

    <!-- Modal para Herramientas -->
    <div class="modal" id="toolModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalTitle"></h2>
                <button class="btn btn-danger" id="closeModal" style="padding: 8px 15px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // VARIABLES GLOBALES Y CONFIGURACIÓN
        // ============================================
        let cameraStream = null;
        let map = null;
        let userMarker = null;
        let currentLocation = null;
        let compassHeading = 0;
        let identifiedMinerals = [];
        let compassWatch = null;
        let gpsWatch = null;
        let isCameraActive = false;
        let isGPSActive = false;

        // Base de datos de minerales de Atacama
        const atacamaMinerals = [
            { id: 1, name: "Calcopirita", formula: "CuFeS₂", hardness: 3.5, color: "Amarillo latón", streak: "Verde negruzco", icon: "fas fa-gem", found: false },
            { id: 2, name: "Malaquita", formula: "Cu₂CO₃(OH)₂", hardness: 3.5, color: "Verde", streak: "Verde claro", icon: "fas fa-gem", found: false },
            { id: 3, name: "Atacamita", formula: "Cu₂Cl(OH)₃", hardness: 3.5, color: "Verde esmeralda", streak: "Verde manzana", icon: "fas fa-gem", found: false },
            { id: 4, name: "Cobre Nativo", formula: "Cu", hardness: 2.5, color: "Rojo cobre", streak: "Rojo metálico", icon: "fas fa-gem", found: false },
            { id: 5, name: "Crisocola", formula: "CuSiO₃·nH₂O", hardness: 2.5, color: "Verde azulado", streak: "Blanco", icon: "fas fa-gem", found: false },
            { id: 6, name: "Bornita", formula: "Cu₅FeS₄", hardness: 3, color: "Púrpura iridiscente", streak: "Gris negruzco", icon: "fas fa-gem", found: false },
            { id: 7, name: "Cuarzo", formula: "SiO₂", hardness: 7, color: "Variable", streak: "Blanco", icon: "fas fa-gem", found: false },
            { id: 8, name: "Hematita", formula: "Fe₂O₃", hardness: 6.5, color: "Negro a rojo", streak: "Rojo cereza", icon: "fas fa-gem", found: false },
            { id: 9, name: "Magnetita", formula: "Fe₃O₄", hardness: 6, color: "Negro", streak: "Negro", icon: "fas fa-gem", found: false },
            { id: 10, name: "Galena", formula: "PbS", hardness: 2.5, color: "Gris plomo", streak: "Gris plomo", icon: "fas fa-gem", found: false }
        ];

        // ============================================
        // INICIALIZACIÓN OBLIGATORIA
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AtacamApp - Inicializando sistema obligatorio...');
            
            // Botón para activar todas las funciones
            document.getElementById('activateAll').addEventListener('click', activateAllFunctions);
            
            // Configurar controles de la aplicación
            setupAppControls();
            
            // Verificar si ya hay permisos (para recarga de página)
            checkExistingPermissions();
        });

        // ============================================
        // ACTIVACIÓN OBLIGATORIA DE TODAS LAS FUNCIONES
        // ============================================
        async function activateAllFunctions() {
            try {
                showNotification('Activando todas las funciones...', 'info');
                
                // 1. ACTIVAR CÁMARA (OBLIGATORIO)
                await activateCamera();
                
                // 2. ACTIVAR GPS (OBLIGATORIO)
                await activateGPS();
                
                // 3. INICIALIZAR MAPA (OBLIGATORIO)
                initializeMap();
                
                // 4. ACTIVAR BRÚJULA (OBLIGATORIO)
                activateCompass();
                
                // 5. MOSTRAR APLICACIÓN
                showApplication();
                
                showNotification('¡Todas las funciones activadas correctamente!', 'success');
                
            } catch (error) {
                console.error('Error activando funciones:', error);
                showNotification('Error: ' + error.message, 'error');
                
                // Forzar recarga para intentar nuevamente
                setTimeout(() => {
                    showNotification('Reintentando activación...', 'warning');
                    location.reload();
                }, 3000);
            }
        }

        // ============================================
        // 1. ACTIVACIÓN OBLIGATORIA DE CÁMARA
        // ============================================
        async function activateCamera() {
            return new Promise(async (resolve, reject) => {
                try {
                    showNotification('Activando cámara del dispositivo...', 'info');
                    
                    // Detener cualquier stream existente
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Solicitar permiso de cámara
                    const constraints = {
                        video: {
                            facingMode: 'environment', // Usar cámara trasera
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        },
                        audio: false
                    };
                    
                    // Intentar con navigator.mediaDevices.getUserMedia primero
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } 
                    // Fallback para navegadores más antiguos
                    else if (navigator.getUserMedia) {
                        cameraStream = await new Promise((resolve, reject) => {
                            navigator.getUserMedia(constraints, resolve, reject);
                        });
                    } 
                    // Fallback para iOS
                    else if (navigator.webkitGetUserMedia) {
                        cameraStream = await new Promise((resolve, reject) => {
                            navigator.webkitGetUserMedia(constraints, resolve, reject);
                        });
                    } 
                    // Fallback para Microsoft
                    else if (navigator.msGetUserMedia) {
                        cameraStream = await new Promise((resolve, reject) => {
                            navigator.msGetUserMedia(constraints, resolve, reject);
                        });
                    } else {
                        throw new Error('Cámara no soportada en este navegador');
                    }
                    
                    // Conectar stream al video
                    const video = document.getElementById('cameraFeed');
                    video.srcObject = cameraStream;
                    
                    // Esperar a que el video esté listo
                    await new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                    });
                    
                    isCameraActive = true;
                    document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-camera" style="color: #27ae60;"></i> Cámara: ACTIVA';
                    document.getElementById('cameraStatus').classList.add('pulse');
                    
                    showNotification('Cámara activada correctamente', 'success');
                    resolve();
                    
                } catch (error) {
                    console.error('Error activando cámara:', error);
                    document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-camera-slash" style="color: #e74c3c;"></i> Cámara: ERROR';
                    
                    // Mostrar mensaje específico
                    let errorMessage = 'No se pudo acceder a la cámara. ';
                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'Permiso denegado. Por favor, permite el acceso a la cámara en la configuración de tu dispositivo.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'No se encontró cámara en el dispositivo.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    showNotification(errorMessage, 'error');
                    reject(new Error(errorMessage));
                }
            });
        }

        // ============================================
        // 2. ACTIVACIÓN OBLIGATORIA DE GPS
        // ============================================
        function activateGPS() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    const error = new Error('GPS no soportado en este dispositivo');
                    showNotification(error.message, 'error');
                    reject(error);
                    return;
                }
                
                showNotification('Activando GPS de alta precisión...', 'info');
                
                // Configurar opciones de alta precisión
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                // Obtener posición inicial
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        handleGPSuccess(position);
                        resolve();
                    },
                    function(error) {
                        handleGPSError(error);
                        reject(new Error('No se pudo obtener ubicación GPS'));
                    },
                    options
                );
                
                // Iniciar monitoreo continuo
                startGPSMonitoring();
            });
        }

        function startGPSMonitoring() {
            if (gpsWatch) {
                navigator.geolocation.clearWatch(gpsWatch);
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            gpsWatch = navigator.geolocation.watchPosition(
                handleGPSuccess,
                handleGPSError,
                options
            );
            
            isGPSActive = true;
        }

        function handleGPSuccess(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                altitude: position.coords.altitude || 0,
                accuracy: position.coords.accuracy,
                heading: position.coords.heading || 0,
                speed: position.coords.speed || 0,
                timestamp: new Date(position.timestamp)
            };
            
            // Actualizar interfaz
            document.getElementById('gpsStatus').innerHTML = 
                '<i class="fas fa-satellite" style="color: #27ae60;"></i> GPS: ACTIVO';
            document.getElementById('gpsStatus').classList.add('pulse');
            
            document.getElementById('locationStatus').innerHTML = 
                `<i class="fas fa-map-marker-alt"></i> ${getLocationName(currentLocation)}`;
            
            document.getElementById('currentCoords').innerHTML = 
                `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
            
            // Actualizar mapa si existe
            if (map) {
                updateMapLocation();
            }
            
            // Actualizar brújula si hay heading
            if (currentLocation.heading) {
                updateCompass(currentLocation.heading);
            }
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            let message = 'Error GPS: ';
            switch(error.code) {
                case 1:
                    message = 'PERMISO DENEGADO. Ve a configuración de tu dispositivo y permite acceso a ubicación.';
                    break;
                case 2:
                    message = 'UBICACIÓN NO DISPONIBLE. Activa el GPS de tu dispositivo.';
                    break;
                case 3:
                    message = 'TIEMPO DE ESPERA AGOTADO. Intenta nuevamente.';
                    break;
                default:
                    message = 'ERROR DE GPS. Verifica la configuración.';
            }
            
            document.getElementById('gpsStatus').innerHTML = 
                '<i class="fas fa-satellite" style="color: #e74c3c;"></i> GPS: ERROR';
            
            showNotification(message, 'error');
        }

        // ============================================
        // 3. MAPA GEOLÓGICO OBLIGATORIO
        // ============================================
        function initializeMap() {
            try {
                // Usar ubicación actual o ubicación por defecto en Atacama
                const initialCoords = currentLocation ? 
                    [currentLocation.latitude, currentLocation.longitude] : 
                    [-27.3667, -70.3333]; // Atacama por defecto
                
                // Crear mapa
                map = L.map('map').setView(initialCoords, 13);
                
                // Capa base: OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);
                
                // Capa satelital (Google)
                const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    attribution: 'Google Satellite',
                    maxZoom: 20
                });
                
                // Capa topográfica
                const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'OpenTopoMap',
                    maxZoom: 17
                });
                
                // Control de capas
                const baseLayers = {
                    "Mapa": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                    "Satélite": satelliteLayer,
                    "Topográfico": topoLayer
                };
                
                L.control.layers(baseLayers).addTo(map);
                
                // Crear marcador del usuario
                createUserMarker();
                
                // Añadir círculo de precisión
                if (currentLocation && currentLocation.accuracy) {
                    L.circle(initialCoords, {
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.2,
                        radius: currentLocation.accuracy
                    }).addTo(map).bindPopup('Precisión GPS: ' + Math.round(currentLocation.accuracy) + 'm');
                }
                
                showNotification('Mapa geológico activado', 'success');
                
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                showNotification('Error cargando mapa: ' + error.message, 'error');
            }
        }

        function createUserMarker() {
            if (!map) return;
            
            const coords = currentLocation ? 
                [currentLocation.latitude, currentLocation.longitude] : 
                [-27.3667, -70.3333];
            
            // Icono personalizado
            const userIcon = L.divIcon({
                className: 'user-marker',
                html: '<i class="fas fa-user" style="color: #e74c3c; font-size: 24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
            
            userMarker = L.marker(coords, {
                icon: userIcon,
                draggable: false
            }).addTo(map);
            
            userMarker.bindPopup('<strong>Tu ubicación</strong><br>Actualizando en tiempo real...');
        }

        function updateMapLocation() {
            if (!map || !currentLocation || !userMarker) return;
            
            const coords = [currentLocation.latitude, currentLocation.longitude];
            
            // Mover marcador
            userMarker.setLatLng(coords);
            
            // Actualizar popup
            userMarker.getPopup().setContent(`
                <strong>Tu ubicación</strong><br>
                Lat: ${currentLocation.latitude.toFixed(6)}<br>
                Lng: ${currentLocation.longitude.toFixed(6)}<br>
                Alt: ${currentLocation.altitude ? currentLocation.altitude.toFixed(0) + ' m' : 'N/A'}<br>
                Precisión: ${Math.round(currentLocation.accuracy)} m
            `);
            
            // Centrar mapa si el usuario lo permite
            if (document.getElementById('centerMap').classList.contains('active')) {
                map.setView(coords, map.getZoom());
            }
        }

        // ============================================
        // 4. BRÚJULA DIGITAL REAL
        // ============================================
        function activateCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ necesita permiso explícito
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startCompass();
                        } else {
                            showNotification('Permiso de orientación denegado. La brújula no funcionará.', 'error');
                        }
                    })
                    .catch(console.error);
            } else {
                // Android y otros navegadores
                startCompass();
            }
        }

        function startCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleDeviceOrientation, true);
                document.getElementById('compassStatus').innerHTML = 
                    '<i class="fas fa-compass" style="color: #27ae60;"></i> Brújula: ACTIVA';
                document.getElementById('compassStatus').classList.add('pulse');
            } else {
                showNotification('Brújula no soportada en este dispositivo', 'warning');
                document.getElementById('compassStatus').innerHTML = 
                    '<i class="fas fa-compass" style="color: #f39c12;"></i> Brújula: NO SOPORTADA';
            }
        }

        function handleDeviceOrientation(event) {
            if (event.alpha !== null) {
                // Calibrar usando GPS si está disponible
                let heading = event.alpha;
                
                // Ajustar según el GPS si tenemos heading del GPS
                if (currentLocation && currentLocation.heading) {
                    // Promediar entre sensor y GPS para mayor precisión
                    heading = (heading + currentLocation.heading) / 2;
                }
                
                // Aplicar calibración automática
                heading = calibrateHeading(heading);
                
                // Actualizar brújula
                updateCompass(heading);
            }
        }

        function calibrateHeading(heading) {
            // Calibración automática simple
            // Redondear a múltiplos de 5 para estabilidad
            const calibrated = Math.round(heading / 5) * 5;
            return calibrated;
        }

        function updateCompass(heading) {
            compassHeading = heading;
            
            // Actualizar aguja
            const needle = document.getElementById('compassNeedle');
            if (needle) {
                needle.style.transform = `translate(-50%, -100%) rotate(${heading}deg)`;
            }
            
            // Actualizar dirección
            const directionElement = document.getElementById('compassDirection');
            const degreesElement = document.getElementById('compassDegrees');
            
            if (directionElement && degreesElement) {
                degreesElement.textContent = `${Math.round(heading)}°`;
                
                const directions = ['NORTE', 'NORESTE', 'ESTE', 'SURESTE', 'SUR', 'SUROESTE', 'OESTE', 'NOROESTE'];
                const index = Math.round(heading / 45) % 8;
                directionElement.textContent = directions[index];
                
                // Cambiar color según dirección
                const colors = ['#e74c3c', '#3498db', '#27ae60', '#f39c12', '#e74c3c', '#3498db', '#27ae60', '#f39c12'];
                directionElement.style.color = colors[index];
            }
        }

        // ============================================
        // 5. IDENTIFICACIÓN DE MINERALES CON CÁMARA
        // ============================================
        function setupAppControls() {
            // Capturar mineral
            document.getElementById('captureMineral').addEventListener('click', captureAndIdentifyMineral);
            
            // Controles del mapa
            document.getElementById('centerMap').addEventListener('click', function() {
                if (currentLocation && map) {
                    map.setView([currentLocation.latitude, currentLocation.longitude], 15);
                    this.classList.toggle('active');
                    showNotification('Mapa centrado en tu ubicación', 'info');
                }
            });
            
            document.getElementById('addMarker').addEventListener('click', function() {
                if (currentLocation && map) {
                    addSampleMarker();
                }
            });
            
            // Limpiar minerales
            document.getElementById('clearMinerals').addEventListener('click', clearAllMinerals);
            
            // Informes
            document.getElementById('generateReport').addEventListener('click', generateMineralReport);
            document.getElementById('viewReports').addEventListener('click', viewAllReports);
            
            // Herramientas
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openToolModal(this.dataset.tool);
                });
            });
            
            // Modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
        }

        async function captureAndIdentifyMineral() {
            if (!isCameraActive) {
                showNotification('Activa la cámara primero', 'error');
                return;
            }
            
            try {
                showNotification('Capturando y analizando mineral...', 'info');
                
                // 1. Capturar imagen de la cámara
                const video = document.getElementById('cameraFeed');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // 2. Simular análisis de IA (en producción usar API real)
                const mineralIndex = Math.floor(Math.random() * atacamaMinerals.length);
                const identifiedMineral = { ...atacamaMinerals[mineralIndex] };
                
                // Marcar como encontrado
                identifiedMineral.found = true;
                identifiedMineral.timestamp = new Date().toISOString();
                identifiedMineral.location = currentLocation ? {
                    lat: currentLocation.latitude,
                    lng: currentLocation.longitude,
                    alt: currentLocation.altitude
                } : null;
                
                identifiedMineral.imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                // 3. Añadir a la lista de minerales identificados
                addIdentifiedMineral(identifiedMineral);
                
                // 4. Mostrar resultado
                showCaptureResult(identifiedMineral);
                
                // 5. Añadir marcador en el mapa
                if (currentLocation) {
                    addMineralMarker(identifiedMineral);
                }
                
                showNotification(`Mineral identificado: ${identifiedMineral.name}`, 'success');
                
            } catch (error) {
                console.error('Error identificando mineral:', error);
                showNotification('Error al identificar mineral: ' + error.message, 'error');
            }
        }

        function addIdentifiedMineral(mineral) {
            // Añadir a la lista
            identifiedMinerals.unshift(mineral);
            
            // Actualizar interfaz
            updateMineralsGrid();
            
            // Guardar en localStorage
            saveMineralsToStorage();
        }

        function updateMineralsGrid() {
            const grid = document.getElementById('mineralsGrid');
            const noMinerals = document.getElementById('noMinerals');
            
            if (identifiedMinerals.length === 0) {
                grid.style.display = 'none';
                noMinerals.style.display = 'block';
                return;
            }
            
            noMinerals.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = '';
            
            // Mostrar últimos 6 minerales identificados
            identifiedMinerals.slice(0, 6).forEach((mineral, index) => {
                const card = document.createElement('div');
                card.className = 'mineral-card';
                if (index === 0) card.classList.add('active');
                
                card.innerHTML = `
                    <div class="mineral-icon">
                        <i class="${mineral.icon}"></i>
                    </div>
                    <div style="font-weight: bold; color: #2c3e50;">${mineral.name}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">${mineral.formula}</div>
                    <div style="font-size: 0.7rem; color: #999; margin-top: 5px;">
                        Dureza: ${mineral.hardness}
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    showMineralDetails(mineral);
                });
                
                grid.appendChild(card);
            });
        }

        function showCaptureResult(mineral) {
            const resultDiv = document.getElementById('captureResult');
            const infoDiv = document.getElementById('identifiedMineralInfo');
            
            infoDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                    <div style="font-size: 2rem; color: #d35400;">
                        <i class="${mineral.icon}"></i>
                    </div>
                    <div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${mineral.name}</div>
                        <div style="color: #666;">${mineral.formula}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <div style="padding: 10px; background: #f0f7ff; border-radius: 5px;">
                        <strong>Dureza:</strong> ${mineral.hardness} (Mohs)
                    </div>
                    <div style="padding: 10px; background: #f0f7ff; border-radius: 5px;">
                        <strong>Color:</strong> ${mineral.color}
                    </div>
                    <div style="padding: 10px; background: #f0f7ff; border-radius: 5px;">
                        <strong>Raya:</strong> ${mineral.streak}
                    </div>
                    <div style="padding: 10px; background: #f0f7ff; border-radius: 5px;">
                        <strong>Ubicación:</strong> ${currentLocation ? 'Registrada' : 'No disponible'}
                    </div>
                </div>
            `;
            
            resultDiv.style.display = 'block';
            
            // Ocultar después de 10 segundos
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 10000);
        }

        function addMineralMarker(mineral) {
            if (!map || !currentLocation) return;
            
            const mineralIcon = L.divIcon({
                className: 'mineral-marker',
                html: `<i class="fas fa-gem" style="color: #d35400; font-size: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);"></i>`,
                iconSize: [25, 25],
                iconAnchor: [12.5, 25]
            });
            
            const marker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: mineralIcon
            }).addTo(map);
            
            marker.bindPopup(`
                <strong>${mineral.name}</strong><br>
                ${mineral.formula}<br>
                Dureza: ${mineral.hardness}<br>
                Identificado: ${new Date(mineral.timestamp).toLocaleTimeString()}
            `);
            
            // Hacer zoom al marcador
            map.setView([currentLocation.latitude, currentLocation.longitude], 15);
        }

        function addSampleMarker() {
            if (!map || !currentLocation) return;
            
            const sampleIcon = L.divIcon({
                className: 'sample-marker',
                html: `<i class="fas fa-map-pin" style="color: #3498db; font-size: 24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);"></i>`,
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
            
            const marker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                icon: sampleIcon,
                draggable: true
            }).addTo(map);
            
            marker.bindPopup(`
                <strong>Punto de Muestra</strong><br>
                ${new Date().toLocaleString()}<br>
                Arrastra para ajustar posición
            `).openPopup();
            
            marker.on('dragend', function() {
                const position = marker.getLatLng();
                showNotification(`Posición ajustada a: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`, 'info');
            });
        }

        // ============================================
        // 6. INFORMES RÁPIDOS
        // ============================================
        function generateMineralReport() {
            if (identifiedMinerals.length === 0) {
                showNotification('Primero identifica algún mineral con la cámara', 'warning');
                return;
            }
            
            const title = document.getElementById('reportTitle').value || 'Informe Geológico';
            const notes = document.getElementById('reportNotes').value || 'Sin observaciones';
            
            const report = {
                id: Date.now(),
                title: title,
                date: new Date().toISOString(),
                minerals: identifiedMinerals.slice(0, 10), // Últimos 10 minerales
                location: currentLocation,
                notes: notes,
                weather: getWeatherData(),
                compassHeading: compassHeading
            };
            
            // Mostrar preview
            showReportPreview(report);
            
            // Limpiar formulario
            document.getElementById('reportTitle').value = '';
            document.getElementById('reportNotes').value = '';
            
            // Guardar reporte
            saveReport(report);
            
            showNotification('Informe generado correctamente', 'success');
        }

        function showReportPreview(report) {
            const preview = document.getElementById('reportPreview');
            
            let mineralsHTML = '';
            report.minerals.forEach((mineral, index) => {
                mineralsHTML += `
                    <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px;">
                        ${index + 1}. <strong>${mineral.name}</strong> (${mineral.formula})
                    </div>
                `;
            });
            
            preview.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 15px;">${report.title}</h3>
                
                <div style="margin-bottom: 15px;">
                    <strong>Fecha:</strong> ${new Date(report.date).toLocaleString()}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Minerales identificados (${report.minerals.length}):</strong>
                    ${mineralsHTML}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Ubicación:</strong><br>
                    ${report.location ? 
                        `${report.location.latitude.toFixed(6)}, ${report.location.longitude.toFixed(6)}` : 
                        'No disponible'}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Observaciones:</strong><br>
                    ${report.notes}
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="downloadReport(${report.id})" style="flex: 1;">
                        <i class="fas fa-download"></i> Descargar
                    </button>
                    <button class="btn btn-secondary" onclick="shareReport(${report.id})" style="flex: 1;">
                        <i class="fas fa-share-alt"></i> Compartir
                    </button>
                </div>
            `;
        }

        function saveReport(report) {
            const reports = JSON.parse(localStorage.getItem('atacamapp_reports') || '[]');
            reports.unshift(report);
            localStorage.setItem('atacamapp_reports', JSON.stringify(reports.slice(0, 20))); // Máximo 20 reportes
        }

        function viewAllReports() {
            const reports = JSON.parse(localStorage.getItem('atacamapp_reports') || '[]');
            
            if (reports.length === 0) {
                showNotification('No hay informes guardados', 'info');
                return;
            }
            
            openToolModal('reports');
        }

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function getLocationName(location) {
            if (!location) return 'Esperando GPS...';
            
            const lat = location.latitude;
            
            if (lat < -28) return "Sur de Atacama 🏜️";
            if (lat < -27) return "Copiapó ⛏️";
            if (lat < -26.5) return "Vallenar 🏔️";
            if (lat < -26) return "Huasco 🌊";
            if (lat < -25) return "Salar de Atacama 🧂";
            return "Norte de Atacama 🏜️";
        }

        function getWeatherData() {
            return {
                temperature: 24 + Math.random() * 8,
                humidity: 10 + Math.random() * 20,
                conditions: ['Despejado ☀️', 'Parcialmente nublado ⛅', 'Soleado 🔆'][Math.floor(Math.random() * 3)],
                windSpeed: 5 + Math.random() * 15
            };
        }

        function showApplication() {
            document.getElementById('permissionScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'grid';
            
            // Iniciar animaciones
            startStatusAnimations();
        }

        function startStatusAnimations() {
            // Animación para el estado de la cámara
            if (isCameraActive) {
                setInterval(() => {
                    const timer = document.getElementById('cameraTimer');
                    if (timer) {
                        timer.classList.toggle('shake');
                    }
                }, 2000);
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse forwards';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function clearAllMinerals() {
            if (identifiedMinerals.length === 0) return;
            
            if (confirm('¿Eliminar todos los minerales identificados?')) {
                identifiedMinerals = [];
                localStorage.removeItem('atacamapp_minerals');
                updateMineralsGrid();
                showNotification('Todos los minerales han sido eliminados', 'info');
            }
        }

        function saveMineralsToStorage() {
            localStorage.setItem('atacamapp_minerals', JSON.stringify(identifiedMinerals.slice(0, 50))); // Máximo 50 minerales
        }

        function loadMineralsFromStorage() {
            const saved = localStorage.getItem('atacamapp_minerals');
            if (saved) {
                identifiedMinerals = JSON.parse(saved);
                updateMineralsGrid();
            }
        }

        function checkExistingPermissions() {
            // Verificar si ya tenemos permisos
            if (localStorage.getItem('atacamapp_permissions') === 'granted') {
                // Intentar activar automáticamente
                activateAllFunctions().catch(() => {
                    // Si falla, mostrar pantalla de permisos
                    document.getElementById('permissionScreen').style.display = 'flex';
                });
            }
        }

        // Guardar permisos cuando se activan
        function savePermissions() {
            localStorage.setItem('atacamapp_permissions', 'granted');
        }

        // ============================================
        // FUNCIONES DE HERRAMIENTAS
        // ============================================
        function openToolModal(tool) {
            const modal = document.getElementById('toolModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            let modalContent = '';
            
            switch(tool) {
                case 'mohs':
                    title.textContent = 'Escala de Mohs';
                    modalContent = generateMohsContent();
                    break;
                case 'reports':
                    title.textContent = 'Informes Guardados';
                    modalContent = generateReportsContent();
                    break;
                case 'export':
                    title.textContent = 'Exportar Datos';
                    modalContent = generateExportContent();
                    break;
                // ... otros casos
                default:
                    title.textContent = 'Herramienta';
                    modalContent = `<p>Contenido de ${tool}</p>`;
            }
            
            content.innerHTML = modalContent;
            modal.classList.add('active');
        }

        function generateMohsContent() {
            const mohsScale = [
                { level: 1, mineral: "Talco", test: "Se raya con la uña" },
                { level: 2, mineral: "Yeso", test: "Se raya con la uña" },
                { level: 3, mineral: "Calcita", test: "Se raya con moneda de cobre" },
                { level: 4, mineral: "Fluorita", test: "Se raya con un cuchillo" },
                { level: 5, mineral: "Apatito", test: "Se raya con un cuchillo" },
                { level: 6, mineral: "Ortosa", test: "Raya al vidrio" },
                { level: 7, mineral: "Cuarzo", test: "Raya al vidrio fácilmente" },
                { level: 8, mineral: "Topacio", test: "Raya al cuarzo" },
                { level: 9, mineral: "Corindón", test: "Raya al topacio" },
                { level: 10, mineral: "Diamante", test: "El más duro" }
            ];
            
            let html = `<div style="padding: 20px;">`;
            mohsScale.forEach(item => {
                html += `
                    <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; gap: 15px;">
                        <div style="background: #d35400; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${item.level}
                        </div>
                        <div>
                            <strong>${item.mineral}</strong><br>
                            <small style="color: #666;">${item.test}</small>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        function generateReportsContent() {
            const reports = JSON.parse(localStorage.getItem('atacamapp_reports') || '[]');
            
            if (reports.length === 0) {
                return '<div style="padding: 40px; text-align: center; color: #666;"><i class="fas fa-file-alt" style="font-size: 3rem;"></i><p style="margin-top: 15px;">No hay informes guardados</p></div>';
            }
            
            let html = `<div style="max-height: 400px; overflow-y: auto; padding: 10px;">`;
            reports.forEach(report => {
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <strong>${report.title}</strong>
                        <div style="color: #666; font-size: 0.9rem; margin: 5px 0;">
                            ${new Date(report.date).toLocaleString()}
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            ${report.minerals.length} minerales identificados
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="downloadReport(${report.id})" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteReport(${report.id})" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        function downloadReport(reportId) {
            const reports = JSON.parse(localStorage.getItem('atacamapp_reports') || '[]');
            const report = reports.find(r => r.id === reportId);
            
            if (!report) {
                showNotification('Reporte no encontrado', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(report, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `atacamapp_reporte_${reportId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Reporte descargado', 'success');
        }

        function deleteReport(reportId) {
            if (!confirm('¿Eliminar este reporte?')) return;
            
            const reports = JSON.parse(localStorage.getItem('atacamapp_reports') || '[]');
            const filtered = reports.filter(r => r.id !== reportId);
            localStorage.setItem('atacamapp_reports', JSON.stringify(filtered));
            
            showNotification('Reporte eliminado', 'info');
            openToolModal('reports'); // Recargar
        }

        function generateExportContent() {
            return `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">Exportar Todos los Datos</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <p>Exporta todos los datos de AtacamApp en un solo archivo:</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4><i class="fas fa-database"></i> Datos incluidos:</h4>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>${identifiedMinerals.length} minerales identificados</li>
                            <li>${JSON.parse(localStorage.getItem('atacamapp_reports') || '[]').length} informes guardados</li>
                            <li>Datos de ubicación GPS</li>
                            <li>Configuración de la aplicación</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-primary" onclick="exportAllData()" style="width: 100%; padding: 15px;">
                        <i class="fas fa-download"></i> Exportar Todo
                    </button>
                </div>
            `;
        }

        function exportAllData() {
            const allData = {
                minerals: identifiedMinerals,
                reports: JSON.parse(localStorage.getItem('atacamapp_reports') || '[]'),
                location: currentLocation,
                settings: {
                    cameraActive: isCameraActive,
                    gpsActive: isGPSActive,
                    lastUpdated: new Date().toISOString()
                },
                app: "AtacamApp",
                version: "2.0"
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `atacamapp_datos_completos_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Todos los datos exportados', 'success');
        }

        function closeModal() {
            document.getElementById('toolModal').classList.remove('active');
        }

        // ============================================
        // INICIALIZACIÓN FINAL
        // ============================================
        // Cargar datos guardados
        loadMineralsFromStorage();
        
        // Configurar eventos para guardar permisos
        document.getElementById('activateAll').addEventListener('click', savePermissions);
        
        console.log('AtacamApp - Sistema listo. Todas las funciones son OBLIGATORIAS.');
    </script>
</body>
</html>
